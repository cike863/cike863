# 1ã€æ€»ä½“å®ç°

## 1. æ¦‚è¿°

ä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Dubbo çš„åºåˆ—åŒ–çš„å®ç°ã€‚åœ¨ [ã€ŠDubbo å¼€å‘æŒ‡å— â€”â€” åºåˆ—åŒ–æ‰©å±•ã€‹](http://dubbo.apache.org/zh-cn/docs/dev/impls/serialize.html) ï¼Œå¯¹åºåˆ—åŒ–å®šä¹‰å¦‚ä¸‹ï¼š

> å°†å¯¹è±¡è½¬æˆå­—èŠ‚æµï¼Œç”¨äºç½‘ç»œä¼ è¾“ï¼Œä»¥åŠå°†å­—èŠ‚æµè½¬ä¸ºå¯¹è±¡ï¼Œç”¨äºåœ¨æ”¶åˆ°å­—èŠ‚æµæ•°æ®åè¿˜åŸæˆå¯¹è±¡ã€‚

- æ‰€ä»¥ï¼Œåºåˆ—åŒ–å®é™…ä¸ŠåŒ…å«**ä¸¤éƒ¨åˆ†**ã€‚
- æœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬éœ€è¦**å¼ºè°ƒ**ä¸€ä¸‹ï¼šåè®®å’Œåºåˆ—åŒ–ï¼Œæ˜¯ä¸¤ä»¶äº‹æƒ…ã€‚ä¸¾ä¸ªä¾‹å­ï¼ŒHTTP æ˜¯ä¸€ç§åè®®ï¼Œå¯ä»¥æœ‰ XML å’Œ JSON **ç­‰ç­‰**åºåˆ—åŒ–( æ•°æ®äº¤æ¢ )çš„æ–¹å¼ã€‚åŒæ—¶ï¼ŒXML å’Œ JSON ä¸ä»…ä»…å¯ä»¥ç”¨åœ¨ HTTP åè®®ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨ HTTPS ç­‰ç­‰åè®®ä¸­ã€‚**æ‰€ä»¥ï¼Œåè®®å’Œåºåˆ—åŒ–ä¸æ˜¯åŒ…å«çš„å…³ç³»ï¼Œè€Œæ˜¯ç»„åˆçš„å…³ç³»**ã€‚

åºåˆ—åŒ–åœ¨ `dubbo-common` é¡¹ç›®çš„ `serialize` æ¨¡å—å®ç°ã€‚ä»£ç ç»“æ„å¦‚ä¸‹å›¾ï¼š

> ğŸ™‚ åœ¨æœ€æ–°ç‰ˆæœ¬çš„ Dubbo é¡¹ç›®ä¸­ï¼Œ`serialize` æ¨¡å—ï¼Œå·²ç»**ç‹¬ç«‹**æˆ `dubbo-serialize` é¡¹ç›®ã€‚

[![ä»£ç ç»“æ„](http://static.iocoder.cn/images/Dubbo/2019_02_15/01.png)](http://static.iocoder.cn/images/Dubbo/2019_02_15/01.png)ä»£ç ç»“æ„

- æœ€å¤–å±‚ï¼Œå®šä¹‰äº† API **æ¥å£**ã€‚
- `support` åŒ…ï¼Œæä¾›äº†å¤šç§åºåˆ—åŒ–çš„**å®ç°**ã€‚

## 2. API å®šä¹‰

API æ¥å£ï¼Œç±»å›¾å¦‚ä¸‹ï¼š

[![ç±»å›¾](http://static.iocoder.cn/images/Dubbo/2019_02_15/02.png)](http://static.iocoder.cn/images/Dubbo/2019_02_15/02.png)ç±»å›¾

#### 2.1 Serialization

`com.alibaba.dubbo.common.serialize.Serialization` ï¼Œ**åºåˆ—åŒ–**æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@SPI("hessian2")
public interface Serialization {

    /**
     * get content type id
     *
     * è·å¾—å†…å®¹ç±»å‹ç¼–å·
     *
     * @return content type id
     */
    byte getContentTypeId();

    /**
     * get content type
     *
     * è·å¾—å†…å®¹ç±»å‹å
     *
     * @return content type
     */
    String getContentType();

    /**
     * create serializer
     *
     * åˆ›å»º ObjectOutput å¯¹è±¡ï¼Œåºåˆ—åŒ–è¾“å‡ºåˆ° OutputStream
     *
     * @param url URL
     * @param output è¾“å‡ºæµ
     * @return serializer
     * @throws IOException å½“å‘ç”Ÿ IO å¼‚å¸¸æ—¶
     */
    @Adaptive
    ObjectOutput serialize(URL url, OutputStream output) throws IOException;

    /**
     * create deserializer
     *
     * åˆ›å»º ObjectInput å¯¹è±¡ï¼Œä» InputStream ååºåˆ—åŒ–
     *
     * @param url URL
     * @param input è¾“å…¥æµ
     * @return deserializer
     * @throws IOException å½“å‘ç”Ÿ IO å¼‚å¸¸æ—¶
     */
    @Adaptive
    ObjectInput deserialize(URL url, InputStream input) throws IOException;

}
```

- `@SPI("hessian2")` æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œé»˜è®¤ä¸º `"hessian2"` ï¼Œå³æœªé…ç½®æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Hessian è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ– ã€‚

- `#getContentTypeId()`,`#getContentType()` æ–¹æ³•ï¼Œè·å¾—å†…å®¹ç±»å‹ç¼–å·å’Œåå­—ã€‚

- `#serialize(...)`,`#deserialize(...)` æ–¹æ³•ï¼ŒğŸ™‚ å…·ä½“çœ‹æ³¨é‡Šã€‚

  - è™½ç„¶æ·»åŠ äº† `@Adaptive` æ³¨è§£ï¼Œ ä½†æ˜¯å®é™…ä¸Šï¼Œä¸ä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œè€Œæ˜¯ä»£ç ä¸­ï¼Œç›´æ¥è·å–ã€‚ä¾‹å¦‚ï¼š

    ```
    // CodecSupport.java
    public static Serialization getSerialization(URL url) {
        return ExtensionLoader.getExtensionLoader(Serialization.class).getExtension(
                url.getParameter(Constants.SERIALIZATION_KEY, Constants.DEFAULT_REMOTING_SERIALIZATION));
    }
    ```

    - x

  - Serialization å®ç°ç±»ï¼Œå®ç°è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ›å»ºå¯¹åº”çš„ ObjectOutput å’Œ ObjectInput **å®ç°ç±»**çš„å¯¹è±¡ã€‚

#### 2.2 DataInput

`com.alibaba.dubbo.common.serialize.DataInput` ï¼Œæ•°æ®**è¾“å…¥**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
boolean readBool() throws IOException;

byte readByte() throws IOException;
short readShort() throws IOException;
int readInt() throws IOException;
long readLong() throws IOException;
float readFloat() throws IOException;
double readDouble() throws IOException;

String readUTF() throws IOException;

byte[] readBytes() throws IOException;
```

- ä» InputStream ä¸­ï¼Œè¯»å–**åŸºæœ¬ç±»å‹**çš„æ•°æ®ã€‚

###### 2.2.1 ObjectInput

`com.alibaba.dubbo.common.serialize.ObjectInput` ï¼Œå®ç° DataInput æ¥å£ï¼Œå¯¹è±¡**è¾“å…¥**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
Object readObject() throws IOException, ClassNotFoundException;
<T> T readObject(Class<T> cls) throws IOException, ClassNotFoundException;
<T> T readObject(Class<T> cls, Type type) throws IOException, ClassNotFoundException;
```

- åœ¨ DataInput çš„åŸºç¡€ä¸Šï¼Œå¢åŠ è¯»å–å¯¹è±¡çš„æ•°æ®ã€‚

#### 2.3 DataOutput

> DataOutput å’Œ DataInput ç›¸åã€‚

`com.alibaba.dubbo.common.serialize.DataOutput` ï¼Œæ•°æ®**è¾“å‡º**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
void writeBool(boolean v) throws IOException;
    
void writeByte(byte v) throws IOException;
void writeShort(short v) throws IOException;
void writeInt(int v) throws IOException;
void writeLong(long v) throws IOException;
void writeFloat(float v) throws IOException;
void writeDouble(double v) throws IOException;

void writeUTF(String v) throws IOException;

void writeBytes(byte[] v) throws IOException;
void writeBytes(byte[] v, int off, int len) throws IOException;

// Flush buffer.
void flushBuffer() throws IOException;
```

- å‘ InputStream ä¸­ï¼Œå†™å…¥**åŸºæœ¬ç±»å‹**çš„æ•°æ®ã€‚

###### 2.3.1 ObjectOutput

`com.alibaba.dubbo.common.serialize.ObjectOutput` ï¼Œå®ç° DataOutput æ¥å£ï¼Œå¯¹è±¡**è¾“å‡º**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
void writeObject(Object obj) throws IOException;
```

- åœ¨ DataOutput çš„åŸºç¡€ä¸Šï¼Œå¢åŠ å†™å…¥å¯¹è±¡çš„æ•°æ®ã€‚

#### 2.4 Cleanable

`com.alibaba.dubbo.common.serialize.Cleanable` ï¼Œ**æ¸…ç†**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
void cleanup();
```

- éƒ¨åˆ† Serialize å®ç°ç±»ï¼Œå®Œæˆåºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ï¼Œéœ€è¦åšæ¸…ç†ã€‚é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œæ‰§è¡Œæ¸…ç†çš„é€»è¾‘ã€‚

#### 2.5 Optimizer ç›¸å…³

###### 2.5.1 SerializationOptimizer

`com.alibaba.dubbo.common.serialize.support.SerializationOptimizer` ï¼Œåºåˆ—åŒ–ä¼˜åŒ–å™¨æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
public interface SerializationOptimizer {

    /**
     * @return éœ€è¦ä½¿ç”¨ä¼˜åŒ–çš„ç±»çš„é›†åˆ
     */
    Collection<Class> getSerializableClasses();

}
```

åœ¨ Kryo ã€FST ä¸­ï¼Œæ”¯æŒ**é…ç½®**éœ€è¦ä¼˜åŒ–çš„ç±»ã€‚ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œå¯ä»¥å®ç°è‡ªå®šä¹‰çš„ SerializationOptimizer å­ç±»ï¼Œè¿›è¡Œé…ç½®ã€‚å½“ç„¶ï¼Œä½¿ç”¨æ–‡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªé€‰æ‹©ï¼ŒDubbo åœ¨å®ç°è€ƒè™‘å–èˆçš„åŸå› å¦‚ä¸‹ï¼š

> FROM ç±»æ³¨é‡Š
>
> This class can be replaced with the contents in config file, but for now I think the class is easier to write
>
> è¿™ä¸ªç±»å¯ä»¥æ›¿æ¢ä¸ºé…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œä½†æ˜¯ç°åœ¨æˆ‘è®¤ä¸ºè¿™ä¸ªç±»æ›´å®¹æ˜“ç¼–å†™ã€‚

###### 2.5.2 SerializableClassRegistry

`com.alibaba.dubbo.common.serialize.support.SerializableClassRegistry` ï¼Œåºåˆ—åŒ–ä¼˜åŒ–ç±»çš„æ³¨å†Œè¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public abstract class SerializableClassRegistry {

    private static final Set<Class> registrations = new LinkedHashSet<Class>();

    /**
     * only supposed to be called at startup time
     */
    public static void registerClass(Class clazz) {
        registrations.add(clazz);
    }

    public static Set<Class> getRegisteredClasses() {
        return registrations;
    }

}
```

- `#registerClass(clazz)` **é™æ€**æ–¹æ³•ï¼Œæ³¨å†Œã€‚åœ¨ `SerializationOptimizer#getSerializableClasses()` æ–¹æ³•ï¼Œè·å¾—çš„ç±»çš„é›†åˆï¼Œä¼šæ³¨å†Œåˆ° SerializableClassRegistry ä¸­ã€‚
- `#getRegisteredClasses()` **é™æ€**æ–¹æ³•ï¼Œè·å¾—ã€‚åœ¨ Kryo ã€FST ä¸­ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè·å¾—éœ€è¦ä½¿ç”¨ä¼˜åŒ–çš„ç±»çš„é›†åˆã€‚

###### 2.5.3 åˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨

åœ¨ `DubboProtocol#optimizeSerialization()` æ–¹æ³•ä¸­ï¼Œåˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
/**
 * å·²åˆå§‹åŒ–çš„ SerializationOptimizer å®ç°ç±»åçš„é›†åˆ
 */
private final Set<String> optimizers = new ConcurrentHashSet<String>();

private void optimizeSerialization(URL url) throws RpcException {
    // è·å¾— `"optimizer"` é…ç½®é¡¹
    String className = url.getParameter(Constants.OPTIMIZER_KEY, "");
    if (StringUtils.isEmpty(className) || optimizers.contains(className)) { // å·²æ³¨å†Œ
        return;
    }

    logger.info("Optimizing the serialization process for Kryo, FST, etc...");

    try {
        // åŠ è½½ SerializationOptimizer å®ç°ç±»
        Class clazz = Thread.currentThread().getContextClassLoader().loadClass(className);
        if (!SerializationOptimizer.class.isAssignableFrom(clazz)) {
            throw new RpcException("The serialization optimizer " + className + " isn't an instance of " + SerializationOptimizer.class.getName());
        }

        // åˆ›å»º SerializationOptimizer å¯¹è±¡
        SerializationOptimizer optimizer = (SerializationOptimizer) clazz.newInstance();
        if (optimizer.getSerializableClasses() == null) {
            return;
        }

        // æ³¨å†Œåˆ° SerializableClassRegistry ä¸­
        for (Class c : optimizer.getSerializableClasses()) {
            SerializableClassRegistry.registerClass(c);
        }

        // æ·»åŠ åˆ° optimizers ä¸­
        optimizers.add(className);
    } catch (ClassNotFoundException e) {
        throw new RpcException("Cannot find the serialization optimizer class: " + className, e);
    } catch (InstantiationException e) {
        throw new RpcException("Cannot instantiate the serialization optimizer class: " + className, e);
    } catch (IllegalAccessException e) {
        throw new RpcException("Cannot instantiate the serialization optimizer class: " + className, e);
    }
}
```

- ğŸ™‚ èƒ–å‹ï¼Œç›´æ¥çœ‹ä»£ç æ³¨é‡Šã€‚

## 3. Dubbo å®ç°

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” åºåˆ—åŒ–ï¼ˆäºŒï¼‰ä¹‹ Dubbo å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/serialize-2-dubbo?self) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

## 4. Kryo å®ç°

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” åºåˆ—åŒ–ï¼ˆä¸‰ï¼‰ä¹‹ Kryo å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/serialize-3-kryo?self) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

## 5. FST å®ç°

> FST fast-serialization æ˜¯é‡æ–°å®ç°çš„ Java å¿«é€Ÿå¯¹è±¡åºåˆ—åŒ–çš„å¼€å‘åŒ…ã€‚åºåˆ—åŒ–é€Ÿåº¦æ›´å¿«ï¼ˆ2-10å€ï¼‰ã€ä½“ç§¯æ›´å°ï¼Œè€Œä¸”å…¼å®¹ JDK åŸç”Ÿçš„åºåˆ—åŒ–ã€‚è¦æ±‚ JDK 1.7 æ”¯æŒã€‚

ğŸ™‚ æ–‡æœ«ï¼Œæœ‰**æ€§èƒ½**ç›¸å…³æµ‹è¯•çš„åˆ†äº«ã€‚

#### 4.1 FstFactory

`com.alibaba.dubbo.common.serialize.support.fst.FstFactory` ï¼ŒFST å·¥å‚ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class FstFactory {

    /**
     * å•ä¾‹
     */
    private static final FstFactory factory = new FstFactory();

    /**
     * é…ç½®å¯¹è±¡
     */
    private final FSTConfiguration conf = FSTConfiguration.createDefaultConfiguration();

    public static FstFactory getDefaultFactory() {
        return factory;
    }

    public FstFactory() {
        // æ³¨å†Œ
        for (Class clazz : SerializableClassRegistry.getRegisteredClasses()) {
            conf.registerClass(clazz);
        }
    }

    public FSTObjectOutput getObjectOutput(OutputStream outputStream) {
        return conf.getObjectOutput(outputStream);
    }

    public FSTObjectInput getObjectInput(InputStream inputStream) {
        return conf.getObjectInput(inputStream);
    }

}
```

- `factory` **é™æ€**å±æ€§ï¼Œå•ä¾‹ã€‚

- `conf` å±æ€§ï¼ŒFST é…ç½®å¯¹è±¡ã€‚åœ¨**æ„é€ æ–¹æ³•**ä¸­ï¼Œå°† SerializableClassRegistry æ³¨å†Œè¡¨éœ€è¦ä½¿ç”¨**ä¼˜åŒ–**çš„ç±»ï¼Œæ³¨å†Œåˆ° FSTConfiguration ä¸­ã€‚`SerializableClassRegistry#registerClass(Class ... c)` æ–¹æ³•ï¼Œæ³¨é‡Šå¦‚ä¸‹ï¼š

  ```
  /**
   *
   * Preregister a class (use at init time). This avoids having to write class names.
   * Its a very simple and effective optimization (frequently > 2 times faster for small objects).
   * é¢„æ³¨å†Œä¸€ä¸ªç±»(åœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨)ã€‚è¿™æ ·å¯ä»¥é¿å…ç¼–å†™ç±»åã€‚
   * å®ƒæ˜¯ä¸€ç§éå¸¸ç®€å•æœ‰æ•ˆçš„ä¼˜åŒ–(å¯¹äºå°å¯¹è±¡æ¥è¯´ï¼Œé€šå¸¸æ˜¯>çš„2å€)ã€‚
   *  
   * Read and write side need to have classes preregistered in the exact same order.
   * å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éœ€è¦é¢„å…ˆä»¥å®Œå…¨ç›¸åŒçš„é¡ºåºæ³¨å†Œã€‚
   *
   * 
   * The list does not have to be complete. Just add your most frequently serialized classes here
   * to get significant gains in speed and smaller serialized representation size.
   *
   * è¿™ä¸ªåˆ—è¡¨å¹¶ä¸ä¸€å®šè¦å®Œæ•´ã€‚åªéœ€åœ¨è¿™é‡Œæ·»åŠ æœ€å¸¸è§çš„åºåˆ—åŒ–ç±»ï¼Œä»¥è·å¾—é€Ÿåº¦å’Œè¾ƒå°çš„åºåˆ—åŒ–è¡¨ç¤ºå¤§å°çš„æ˜¾è‘—æé«˜ã€‚
   */
  ```

- `#getObjectOutput()` æ–¹æ³•ï¼Œè·å¾— `org.nustaq.serialization.FSTObjectOutput` å¯¹è±¡ï¼Œè¢« FstObjectOutput è°ƒç”¨ã€‚

- `#getObjectInput()` æ–¹æ³•ï¼Œè·å¾— `org.nustaq.serialization.FSTObjectInput` å¯¹è±¡ï¼Œè¢« FstObjectInput è°ƒç”¨ã€‚

#### 4.2 FstSerialization

`com.alibaba.dubbo.common.serialize.support.fst.FstSerialization` ï¼Œå®ç° Serialization æ¥å£ï¼ŒFST **åºåˆ—åŒ–**å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class FstSerialization implements Serialization {

    @Override
    public byte getContentTypeId() {
        return 9;
    }

    @Override
    public String getContentType() {
        return "x-application/fst";
    }

    @Override
    public ObjectOutput serialize(URL url, OutputStream out) throws IOException {
        return new FstObjectOutput(out);
    }

    @Override
    public ObjectInput deserialize(URL url, InputStream is) throws IOException {
        return new FstObjectInput(is);
    }

}
```

- `"x-application/fst"` ï¼Œç±»ä¼¼ HTTP åè®® çš„ **Content-Types** çš„ Header ã€‚åœ¨ [ã€6. JSON å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/#) ç±»ä¸­ï¼Œè¿”å›çš„æ˜¯ `"text/json"` ã€‚

#### 4.3 FstObjectInput

[`com.alibaba.dubbo.common.serialize.support.fst.FstObjectInput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/fst/FstObjectInput.java) ï¼Œå®ç° ObjectInput æ¥å£ï¼ŒFST å¯¹è±¡**è¾“å…¥**å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
private FSTObjectInput input;

public FstObjectInput(InputStream inputStream) {
    input = FstFactory.getDefaultFactory().getObjectInput(inputStream);
}
```

- `input` å±æ€§ï¼Œè°ƒç”¨ `FstFactory#getObjectInput(inputStream)` æ–¹æ³•ï¼Œè·å¾—ã€‚

**å®ç°æ–¹æ³•**

æ¯ä¸ªå®ç°æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ FSTObjectInput å¯¹åº”çš„æ–¹æ³•ã€‚æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ï¼Œ`#readBytes()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Override
public byte[] readBytes() throws IOException {
    int len = input.readInt();
    // æ•°ç»„ä¸ºç©º
    if (len < 0) {
        return null;
    // æ•°ç»„ä¸ºé›¶
    } else if (len == 0) {
        return new byte[]{};
    // æ•°ç»„ > 0
    } else {
        byte[] b = new byte[len];
        input.readFully(b);
        return b;
    }
}
```

- [ å­—èŠ‚æ•°ç»„é•¿åº¦, å­—èŠ‚æ•°ç»„å†…å®¹ ]

#### 4.4 FstObjectOutput

[`com.alibaba.dubbo.common.serialize.support.fst.FstObjectOutput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/fst/FstObjectOutput.java) ï¼Œå®ç° ObjectOutput æ¥å£ï¼ŒFST å¯¹è±¡**è¾“å‡º**å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
private FSTObjectOutput output;

public FstObjectOutput(OutputStream outputStream) {
    output = FstFactory.getDefaultFactory().getObjectOutput(outputStream);
}
```

- `output` å±æ€§ï¼Œè°ƒç”¨ `FstFactory#getObjectInput(outputStream)` æ–¹æ³•ï¼Œè·å¾—ã€‚

**å®ç°æ–¹æ³•**

æ¯ä¸ªå®ç°æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ FSTObjectInput å¯¹åº”çš„æ–¹æ³•ã€‚æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ï¼Œ`#writeBytes(byte[] v)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Override
public void writeBytes(byte[] v) throws IOException {
    // ç©ºï¼Œå†™å…¥ -1
    if (v == null) {
        output.writeInt(-1);
    // æœ‰æ•°ç»„
    } else {
        writeBytes(v, 0, v.length);
    }
}
```

- [ å­—èŠ‚æ•°ç»„é•¿åº¦, å­—èŠ‚æ•°ç»„å†…å®¹ ]

## 6. JSON å®ç°

åŸºäº FastJSON å®ç°ã€‚

> fastjson æ˜¯ä¸€ä¸ªæ€§èƒ½å¾ˆå¥½çš„ Java è¯­è¨€å®ç°çš„ JSON è§£æå™¨å’Œç”Ÿæˆå™¨ï¼Œæ¥è‡ªé˜¿é‡Œå·´å·´çš„å·¥ç¨‹å¸ˆå¼€å‘ã€‚
>
> ä¸»è¦ç‰¹ç‚¹ï¼š
>
> - å¿«é€ŸFAST (æ¯”å…¶å®ƒä»»ä½•åŸºäºJavaçš„è§£æå™¨å’Œç”Ÿæˆå™¨æ›´å¿«ï¼ŒåŒ…æ‹¬ [jackson](https://www.oschina.net/p/jackson)ï¼‰
> - å¼ºå¤§ï¼ˆæ”¯æŒæ™®é€šJDKç±»åŒ…æ‹¬ä»»æ„Java Bean Classã€Collectionã€Mapã€Date æˆ– enumï¼‰
> - é›¶ä¾èµ–ï¼ˆæ²¡æœ‰ä¾èµ–å…¶å®ƒä»»ä½•ç±»åº“é™¤äº†JDKï¼‰

ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ [ã€5. FST å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/#) ç±»ä¼¼ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼š

- [`com.alibaba.dubbo.common.serialize.support.json.FastJsonSerialization`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/json/FastJsonSerialization.java)
- [`com.alibaba.dubbo.common.serialize.support.json.FastJsonObjectInput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/json/FastJsonObjectInput.java)
- [`com.alibaba.dubbo.common.serialize.support.json.FastJsonObjectOutput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/json/FastJsonObjectOutput.java)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`FastJsonObjectOutput#writeObject(Object)` æ–¹æ³•çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Override
public void writeObject(Object obj) throws IOException {
    SerializeWriter out = new SerializeWriter();
    // åºåˆ—åŒ–ï¼Œå†™å…¥å¯¹è±¡
    JSONSerializer serializer = new JSONSerializer(out);
    serializer.config(SerializerFeature.WriteEnumUsingToString, true); // æšä¸¾è½¬å­—ç¬¦ä¸²
    serializer.write(obj);
    // å†™åˆ°ï¼Œè¾“å‡ºæµ
    out.writeTo(writer);
    out.close(); // for reuse SerializeWriter buf
    writer.println(); // æ¢è¡Œ
    writer.flush();
}
```

## 7. Hessian2 å®ç°

> å’Œå…¶ä»– Web æœåŠ¡çš„å®ç°æ¡†æ¶ä¸åŒçš„æ˜¯ï¼ŒHessian æ˜¯ä¸€ä¸ªä½¿ç”¨äºŒè¿›åˆ¶ Web æœåŠ¡åè®®çš„æ¡†æ¶ï¼Œå®ƒçš„å¥½å¤„åœ¨äºå…é™¤äº†ä¸€å¤§å †é™„åŠ çš„APIåŒ…ï¼Œä¾‹å¦‚ XML çš„å¤„ç†ä¹‹ç±»çš„ jar åŒ…ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Web æœåŠ¡å®ç°æ¡†æ¶çš„åŸå› ï¼Œè¿™ä¸ªåŸå› è¿˜åœ¨äºæ‰‹æœºä¸Šçš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ Hessian æä¾›çš„ API å¾ˆæ–¹ä¾¿çš„è®¿é—® Hessian çš„ Web æœåŠ¡ã€‚

ä»ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒHessian è‡ªå·±æœ‰è‡ªå·±çš„**åºåˆ—åŒ–**çš„å®ç°ã€‚ä½†æ˜¯ï¼ŒHessian åœ¨å®ç°ä¸Šï¼Œå­˜åœ¨ä¸€äº› Bug å’Œéœ€è¦æ€§èƒ½ä¼˜åŒ–çš„ç‚¹ã€‚ä¾‹å¦‚ï¼š

> **BigDecimal çš„ååºåˆ—åŒ–**
>
> ä½¿ç”¨ Hessian åºåˆ—åŒ–åŒ…å« BigDecimal å­—æ®µçš„å¯¹è±¡æ—¶ä¼šå¯¼è‡´å…¶å€¼ä¸€ç›´ä¸º0ï¼Œä¸æ³¨æ„è¿™ä¸ªbugä¼šå¯¼è‡´å¾ˆå¤§çš„é—®é¢˜ï¼Œåœ¨æœ€æ–°çš„4.0.51ç‰ˆæœ¬ä»ç„¶å¯ä»¥å¤ç°ã€‚è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼ŒæŒ‡å®š BigDecimal çš„åºåˆ—åŒ–å™¨å³å¯ã€‚

æ‰€ä»¥ Dubbo ç»´æŠ¤äº†è‡ªå·±çš„ [`hessian-lite`](https://github.com/alibaba/dubbo/tree/4bbc0ddddacc915ddc8ff292dd28745bbc0031fd/hessian-lite) ï¼Œå¯¹ [Hessian 2](http://hessian.caucho.com/) çš„ **åºåˆ—åŒ–** éƒ¨åˆ†çš„ç²¾ç®€ã€æ”¹è¿›ã€BugFix ã€‚
æäº¤å†å²å¦‚ä¸‹ï¼š
[![hessian-lite æäº¤å†å²](http://static.iocoder.cn/images/Dubbo/2018_01_04/23.png)](http://static.iocoder.cn/images/Dubbo/2018_01_04/23.png)hessian-lite æäº¤å†å²

ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ [ã€5. FST å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/#) ç±»ä¼¼ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼š

- [`com.alibaba.dubbo.common.serialize.support.hessian.Hessian2SerializerFactory`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/hessian/Hessian2SerializerFactory.java)
- [`com.alibaba.dubbo.common.serialize.support.hessian.Hessian2Serialization`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/hessian/Hessian2Serialization.java)
- [`com.alibaba.dubbo.common.serialize.support.hessian.Hessian2ObjectInput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/hessian/Hessian2ObjectInput.java)
- [`com.alibaba.dubbo.common.serialize.support.hessian.Hessian2ObjectOutput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/hessian/Hessian2ObjectOutput.java)

## 8. NativeJava å®ç°

> æ—ç™½å›ï¼šç”±äºè‰¿è‰¿å¯¹ Java åŸç”Ÿçš„åºåˆ—åŒ–ï¼Œäº†è§£çš„æ¯”è¾ƒç²—æµ…ï¼Œæœ¬å°èŠ‚æ›´å¤šçš„æ˜¯æŠŠä»£ç æ¢³ç†å¹²å‡€ã€‚

`nativejava` ï¼ŒåŸºäº Java **åŸç”Ÿ**( è‡ªå¸¦ )çš„ Java åºåˆ—åŒ–å®ç°ï¼Œå³ä½¿ç”¨ `java.io.ObjectInputStream` å’Œ `java.io.ObjectOutputStream` è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ [ã€5. FST å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/#) ç±»ä¼¼ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼š

- [`com.alibaba.dubbo.common.serialize.support.nativejava.NativeJavaSerialization`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/nativejava/NativeJavaSerialization.java)
- [`com.alibaba.dubbo.common.serialize.support.nativejava.NativeJavaObjectInput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/nativejava/NativeJavaObjectInput.java)
- [`com.alibaba.dubbo.common.serialize.support.nativejava.NativeJavaObjectOutput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/nativejava/NativeJavaObjectOutput.java)

#### 8.1 Java å®ç°

`java` ï¼Œåœ¨ [ã€8. NativeJava å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/#) çš„åŸºç¡€ä¸Šï¼Œå®ç°äº†å¯¹ç©ºå­—ç¬¦ä¸²å’Œç©ºå¯¹è±¡çš„å¤„ç†ã€‚å¦‚ä¸‹æ˜¯ JavaObjectOutput å¯¹ç©ºå­—ç¬¦ä¸²å’Œç©ºå¯¹è±¡çš„åºåˆ—åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// ã€æ³¨æ„ã€‘JavaObjectOutput extends NativeJavaObjectOutput ï¼ï¼ï¼

@Override
public void writeUTF(String v) throws IOException {
    if (v == null) { // ç©ºå­—ç¬¦ä¸²
        getObjectOutputStream().writeInt(-1);
    } else {
        getObjectOutputStream().writeInt(v.length()); // é•¿åº¦
        getObjectOutputStream().writeUTF(v); // å­—ç¬¦ä¸²
    }
}

@Override
public void writeObject(Object obj) throws IOException {
    if (obj == null) { // ç©º
        getObjectOutputStream().writeByte(0); // ç©º
    } else {
        getObjectOutputStream().writeByte(1); // éç©º
        getObjectOutputStream().writeObject(obj); // å¯¹è±¡
    }
}
```

ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ [ã€NativeJava å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/#) ç±»ä¼¼ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼š

- [`com.alibaba.dubbo.common.serialize.support.java.JavaSerialization`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/JavaSerialization.java)
- [`com.alibaba.dubbo.common.serialize.support.java.JavaObjectInput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/JavaObjectInput.java)
- [`com.alibaba.dubbo.common.serialize.support.java.JavaObjectOutput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/JavaObjectOutput.java)

#### 8.2 CompactedJava

`compactedjava` ï¼Œåœ¨ [ã€8.1 Java å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/#) çš„åŸºç¡€ä¸Šï¼Œå®ç°äº†å¯¹ **ClassDescriptor** çš„å¤„ç†ã€‚å¦‚ä¸‹æ˜¯ CompactedObjectOutputStream å¯¹ **ClassDescriptor** çš„å†™å…¥ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// ã€æ³¨æ„ã€‘CompactedObjectOutputStream extends ObjectOutputStream ï¼ï¼ï¼

@Override
protected void writeClassDescriptor(ObjectStreamClass desc) throws IOException {
    Class<?> clazz = desc.forClass();
    if (clazz.isPrimitive() || clazz.isArray()) {
        write(0);
        super.writeClassDescriptor(desc);
    } else {
        write(1);
        writeUTF(desc.getName());
    }
}
```

- åœ¨ JavaObjectOutput çš„åˆ›å»ºæ—¶ï¼Œæ ¹æ® `compact = true` æ—¶ï¼Œä½¿ç”¨ CompactedObjectOutputStream è¾“å‡ºæµã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  public JavaObjectOutput(OutputStream os, boolean compact) throws IOException {
      super(compact ? new CompactedObjectOutputStream(os) : new ObjectOutputStream(os));
  }
  ```

ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼š

- [`com.alibaba.dubbo.common.serialize.support.java.CompactedJavaSerialization`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/CompactedJavaSerialization.java)
- [`com.alibaba.dubbo.common.serialize.support.java.CompactedObjectInputStream`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/CompactedObjectInputStream.java)
- [`com.alibaba.dubbo.common.serialize.support.java.CompactedObjectOutputStream`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/CompactedObjectOutputStream.java)



æ¨èé˜…è¯»ï¼š

- [ã€Šåœ¨Dubboä¸­ä½¿ç”¨é«˜æ•ˆçš„Javaåºåˆ—åŒ–ï¼ˆKryoå’ŒFSTï¼‰ã€‹](https://dangdangdotcom.github.io/dubbox/serialization.html)
- [ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡â€“æ€»ç»“ç¯‡ã€‹](https://www.cnkirito.moe/2017/12/11/rpc-serialize-2/)
- [ã€Šåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‹](https://tech.meituan.com/serialization_vs_deserialization.html)

# 2ã€Dubbo å®ç°

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«åŸºäº Dubbo **è‡ªå·±å®ç°**çš„åºåˆ—åŒ–æ‹“å±•ã€‚è¦å®ç°åºåˆ—åŒ–çš„é«˜æ€§èƒ½ï¼Œéœ€è¦è€ƒè™‘ä¸¤æ–¹é¢ï¼š

- åºåˆ—åŒ–å’Œååºåˆ—åŒ–**é€Ÿåº¦å¿«**
- ä»**ä¼ è¾“**è§’åº¦ï¼Œæ•°æ®å‹ç¼©æ•ˆæœå¥½ï¼Œå³åºåˆ—åŒ–åçš„æ•°æ®é‡**ä½“ç§¯å°**

> æ—ç™½å›ï¼šä»ä»¥ä¸‹å¼€å§‹ï¼Œ**Dubbo æŒ‡çš„æ˜¯ Dubbo åºåˆ—åŒ–æ‹“å±•**ï¼Œè€Œä¸æ˜¯ Dubbo PRC æ¡†æ¶ã€‚è¯·æ³¨æ„ã€‚

åœ¨ [ã€Šç”¨æˆ·æŒ‡å— â€”â€” æ€§èƒ½æµ‹è¯•æŠ¥å‘Šã€‹](http://dubbo.apache.org/zh-cn/docs/user/perf-test.html) å’Œ [ã€Šåœ¨Dubboä¸­ä½¿ç”¨é«˜æ•ˆçš„Javaåºåˆ—åŒ–ï¼ˆKryoå’ŒFSTï¼‰ã€‹](https://dangdangdotcom.github.io/dubbox/serialization.html) ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒDubbo æ˜¯ä¸€ç§ç›¸å¯¹ä¼˜ç§€çš„å®ç°æ–¹å¼ã€‚è™½ç„¶ï¼Œåœ¨æœ€æ–°ç‰ˆæœ¬çš„ Dubbo é¡¹ç›®ä¸­ï¼Œ`dubbo-serialize` æ¨¡å—å·²ç»å»é™¤äº† Dubbo åºåˆ—åŒ–çš„å®ç°ï¼ŒçŒœæµ‹å› ä¸ºå¼•å…¥ Kryo å’Œ FST ï¼Œç›¸æ¯”æ¥è¯´æ›´ä¼˜ç§€ã€‚

å½“ç„¶ï¼Œå³ä½¿å¦‚æ­¤ï¼Œè‰¿è‰¿è§‰å¾—äº†è§£ä¸‹ Dubbo åºåˆ—åŒ–æ˜¯å¦‚ä½•å®ç°çš„ï¼Œ**æ˜¯ä¸€ç§éå¸¸æ£’çš„çœ¼ç•Œæå‡**ï¼Œç‰¹åˆ«æ˜¯åºåˆ—åŒ–çš„æ•°æ®å‹ç¼©ï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹éƒ½ä¼šä½¿ç”¨ï¼Œä¾‹å¦‚ Lucene çš„æ•°æ®å­˜å‚¨ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬è·Ÿç€ä»£ç ï¼Œä¸€èµ·æ„‰å¿«çš„ç©è€æŠŠã€‚æœ¬æ–‡æ¶‰åŠä»£ç å¦‚ä¸‹ï¼š

[![ç±»å›¾](http://static.iocoder.cn/images/Dubbo/2019_02_18/01.png)](http://static.iocoder.cn/images/Dubbo/2019_02_18/01.png)ç±»å›¾

> å†™çš„æœ‰ç‚¹åŒ†å¿™ï¼Œä¹Ÿæœ‰ç‚¹ç€æ€¥ï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œæˆ–è€…ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œè¯·å¾€æ­»é‡ŒæŠ½ï¼ˆå‘Šè¯‰ï¼‰æˆ‘ã€‚å“ˆå“ˆå“ˆã€‚

## 2. GenericDataFlags

Dubbo ï¼Œæ˜¯ä¸€ç§**æœ‰åºã€ç´§å‡‘**çš„åºåˆ—åŒ–æ–¹å¼ã€‚å¦‚ä¸‹æ˜¯åºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æ•°æ®æµçš„ç¤ºæ„å›¾ï¼š

[![äºŒè¿›åˆ¶æ•°æ®æµ](http://static.iocoder.cn/images/Dubbo/2019_02_18/02.png)](http://static.iocoder.cn/images/Dubbo/2019_02_18/02.png)äºŒè¿›åˆ¶æ•°æ®æµ

- ä¸åŒäº JSON / XML ç­‰åºåˆ—åŒ–æ–¹å¼ï¼Œæ— éœ€åºåˆ—åŒ–æ¯ä¸ª

  å±æ€§å

  ã€‚é€šè¿‡ Builder å¯¹è±¡ï¼Œåˆ›å»ºæ¯ä¸ªç±»çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„

  å…·ä½“

  ä»£ç ã€‚

  - è¿™æ ·ï¼Œæˆ‘ä»¬å°±é¿å…äº†**å±æ€§å**çš„åºåˆ—åŒ–ï¼Œæå‡äº†é€Ÿåº¦ï¼Œå‡å°‘äº†æ•°æ®çš„ä½“ç§¯ã€‚
  - å½“ç„¶ï¼Œåè¿‡æ¥è¯´ï¼Œå¦‚æœå¯¹è±¡å‘ç”Ÿäº†**å˜åŒ–**( å¢åŠ æˆ–åˆ é™¤å±æ€§ )ï¼Œå¯èƒ½ä¼šå‡ºç° Client å’Œ Server åºåˆ—åŒ–çš„**ä¸å…¼å®¹**ï¼Œå› ä¸ºå±æ€§çš„**é¡ºåº**å‘ç”Ÿäº†å˜åŒ–ã€‚

- å±æ€§å€¼å’Œå±æ€§å€¼ä¹‹é—´**æ— é—´éš”**ï¼Œé€šè¿‡å±æ€§å€¼çš„**æ ‡å¿—ä½** Flag ä¿è¯ï¼Œä¹Ÿå°±æ˜¯æœ¬å°èŠ‚è¦åˆ†äº«çš„ GenericDataFlags ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ [`com.alibaba.dubbo.common.serialize.support.dubbo.GenericDataFlags`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericDataFlags.java) ï¼Œé€šç”¨æ•°æ®**æ ‡è®°ä½**æšä¸¾ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public interface GenericDataFlags {

    // prefix three bits
    byte VARINT = 0, // 0 æ•°å­—
        OBJECT = (byte) 0x80; // -128 å¯¹è±¡

    // varint tag
    byte VARINT8 = VARINT, VARINT16 = VARINT | 1, VARINT24 = VARINT | 2, VARINT32 = VARINT | 3;
    byte VARINT40 = VARINT | 4, VARINT48 = VARINT | 5, VARINT56 = VARINT | 6, VARINT64 = VARINT | 7;

    // varint contants
    byte VARINT_NF = VARINT | 10, VARINT_NE = VARINT | 11, VARINT_ND = VARINT | 12;
    byte VARINT_NC = VARINT | 13, VARINT_NB = VARINT | 14, VARINT_NA = VARINT | 15, VARINT_N9 = VARINT | 16;
    byte VARINT_N8 = VARINT | 17, VARINT_N7 = VARINT | 18, VARINT_N6 = VARINT | 19, VARINT_N5 = VARINT | 20;
    byte VARINT_N4 = VARINT | 21, VARINT_N3 = VARINT | 22, VARINT_N2 = VARINT | 23, VARINT_N1 = VARINT | 24;
    byte VARINT_0 = VARINT | 25, VARINT_1 = VARINT | 26, VARINT_2 = VARINT | 27, VARINT_3 = VARINT | 28;
    byte VARINT_4 = VARINT | 29, VARINT_5 = VARINT | 30, VARINT_6 = VARINT | 31, VARINT_7 = VARINT | 32;
    byte VARINT_8 = VARINT | 33, VARINT_9 = VARINT | 34, VARINT_A = VARINT | 35, VARINT_B = VARINT | 36;
    byte VARINT_C = VARINT | 37, VARINT_D = VARINT | 38, VARINT_E = VARINT | 39, VARINT_F = VARINT | 40;
    byte VARINT_10 = VARINT | 41, VARINT_11 = VARINT | 42, VARINT_12 = VARINT | 43, VARINT_13 = VARINT | 44;
    byte VARINT_14 = VARINT | 45, VARINT_15 = VARINT | 46, VARINT_16 = VARINT | 47, VARINT_17 = VARINT | 48;
    byte VARINT_18 = VARINT | 49, VARINT_19 = VARINT | 50, VARINT_1A = VARINT | 51, VARINT_1B = VARINT | 52;
    byte VARINT_1C = VARINT | 53, VARINT_1D = VARINT | 54, VARINT_1E = VARINT | 55, VARINT_1F = VARINT | 56;

    // object tag
    byte OBJECT_REF = OBJECT | 1, OBJECT_STREAM = OBJECT | 2, OBJECT_BYTES = OBJECT | 3;
    byte OBJECT_VALUE = OBJECT | 4, OBJECT_VALUES = OBJECT | 5, OBJECT_MAP = OBJECT | 6;
    byte OBJECT_DESC = OBJECT | 10, OBJECT_DESC_ID = OBJECT | 11;

    // object constants
    byte OBJECT_NULL = OBJECT | 20, OBJECT_DUMMY = OBJECT | 21;

}
```

ğŸ˜œ æ˜¯ä¸æ˜¯æœ‰ç‚¹ä¸€è„¸æ‡µé€¼ï¼Ÿï¼æˆ‘ä»¬æŠŠæšä¸¾åšä¸€æ¬¡è§„æ•´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![åè®®æ•´ç†](http://static.iocoder.cn/images/Dubbo/2019_02_18/09.png)](http://static.iocoder.cn/images/Dubbo/2019_02_18/09.png)åè®®æ•´ç†

- åœ¨æ¯ä¸ªå±æ€§å€¼( å³ field )çš„

  é¦–ä¸ª Byte ä½

  ï¼Œç§°ä¸º

  æ ‡å¿—ä½ Flag

   

  ã€‚ç›®å‰æˆ‘ä»¬åˆ†æˆä¸¤å¤§ç±»( å›¾ä¸­ï¼Œç»¿è‰²éƒ¨åˆ† )ï¼š

  - Varint ï¼Œ**å˜é•¿æ•°å­—**ï¼Œå ç”¨ Byte å€¼çš„ `[0, 128)` åŒºé—´ã€‚
  - Object ï¼Œ**å¯¹è±¡**ï¼Œå ç”¨ Byte å€¼çš„ `[-128, 0)` åŒºé—´ã€‚

- æ ‡å¿—ä½ Flag æ ¹æ®

  ç”¨é€”

  ï¼Œå¯ä»¥åˆ†æˆä¸¤ç§

  ç±»å‹

  ï¼ˆæ³¨æ„ï¼Œå€¼æ˜¯

  ä¸é‡å 

  çš„ï¼‰ï¼š

  - Tag ï¼Œ

    æ ‡ç­¾

    ( å›¾ä¸­ï¼Œæ©™è‰²éƒ¨åˆ† )ã€‚

    - ä»¥ VarInt ä¸¾ä¾‹å­ï¼Œ**æ•°å­—**åˆ†æˆ BYTEã€SHORTã€INTã€LONG å››ç§æ•°æ®ç±»å‹ã€‚ é€šè¿‡æ ‡è®°ä½ï¼Œè¡¨ç¤ºæ•°å­—å ç”¨**å¤šå°‘** Byte ï¼Œä»è€Œå®ç°**å˜é•¿**ï¼ŒèŠ‚çœ Byte çš„å ç”¨ã€‚ä¾‹å¦‚ï¼Œå±æ€§å€¼ç±»å‹ä¸º **Long** ï¼Œä½†æ˜¯å€¼æ˜¯ **100L** ï¼Œé‚£ä¹ˆåªéœ€è¦è¦ 1 Byte( æ ‡è®°ä½ä¸º **VARINT8** ) + 1 Byte( **100L** ) = 2 Byte ã€‚
    - å½“ç„¶ï¼Œè¿™ç§æ–¹å¼ä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå¯¹äº**å¤§æ•´æ•°**ï¼Œä¼šå¤šå ç”¨ä¸€ä¸ª**æ ‡è®°ä½**ï¼Œä¾‹å¦‚ `Integer.MAX_VALUE` ã€‚ä»ç»Ÿè®¡ä¸Šæ¥è¯´ï¼Œä¸šåŠ¡ç³»ç»Ÿæ›´å¤šçš„æ˜¯**å°æ•´æ•°**ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªç¼ºç‚¹ä¹Ÿæ˜¯èƒ½å¤Ÿæ¥å—çš„ã€‚

  - CONSTANTS ï¼Œ

     

    æšä¸¾

    ( å›¾ä¸­ï¼Œé»„è‰²éƒ¨åˆ† )ï¼Œç”¨äº

    å¸¸ç”¨

    å±æ€§å€¼ã€‚

    - ä»¥ Varint ä¸¾ä¾‹å­ï¼Œåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œ`[ -15, 31 ]` æ˜¯**éå¸¸å¸¸ç”¨**ã€‚é€šè¿‡æšä¸¾ï¼Œè¿›ä¸€æ­¥å‡å°‘æ•°æ®æåŠï¼Œæå‡åºåˆ—åŒ–é€Ÿåº¦ã€‚æ‰€ä»¥ Varint çš„äºŒè¿›åˆ¶æ•°æ®æµç¤ºæ„å›¾å¦‚ä¸‹ï¼š[![äºŒè¿›åˆ¶æ•°æ®æµ](http://static.iocoder.cn/images/Dubbo/2019_02_18/10.png)](http://static.iocoder.cn/images/Dubbo/2019_02_18/10.png)äºŒè¿›åˆ¶æ•°æ®æµ

å¯èƒ½æœ‰èƒ–å‹ä¼šé—®ï¼Œä¸Šé¢åªæåˆ°äº†æ•°å­—æ€ä¹ˆåºåˆ—åŒ–ï¼Œ**é‚£ä¹ˆå¯¹è±¡æ€ä¹ˆåºåˆ—åŒ–å‘¢**ï¼Ÿæˆ‘ä»¬ä»¥ POJO ä¸ºä¾‹å­ï¼Œç®€å•è¯´ä¸‹ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå¯¹è±¡ç†è§£æˆ**ä¸€ä¸ªå±æ€§å€¼çš„é›†åˆ**ï¼Œé€šè¿‡ä¸‹é¢ä¼šçœ‹åˆ°çš„ Builder ç±»ï¼Œç”Ÿæˆè¯¥å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹çš„ä»£ç å³å¯ã€‚

å½“ç„¶ï¼Œå¯¹è±¡ä¸ä»…ä»…æœ‰ POJO ï¼Œè¿˜æœ‰ MAPï¼Œæ•°ç»„ç­‰ç­‰ï¼Œä¸‹é¢æˆ‘ä»¬éƒ½ä¼šçœ‹åˆ°å…·ä½“çš„å¤„ç†ä»£ç ã€‚

ğŸ™‚ å—¯ï¼Œå“”å“”äº†è¿™ä¹ˆå¤šï¼Œè®©æˆ‘ä»¬æ„‰å¿«çš„å¼€å§‹çœ‹ä»£ç æŠŠã€‚

## 3. Data

#### 3.1 GenericDataOutput

[`com.alibaba.dubbo.common.serialize.support.dubbo.GenericDataOutput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericDataOutput.java) ï¼Œå®ç° DataOutputï¼ŒGenericDataFlags æ¥å£ï¼ŒDubbo æ•°æ®è¾“å‡ºå®ç°ç±»ã€‚

###### 3.1.1 æ„é€ æ–¹æ³•

```
/**
 * é»˜è®¤ {@link #mCharBuf} å¤§å°
 */
private static final int CHAR_BUF_SIZE = 256;
/**
 * åºåˆ—åŒ–å­—ç¬¦ä¸²çš„ä¸´æ—¶ç»“æœçš„ Buffer æ•°ç»„ï¼Œç”¨äº {@link #writeUTF(String)} ä¸­ã€‚
 */
private final char[] mCharBuf = new char[CHAR_BUF_SIZE];

/**
 * åºåˆ—åŒ– Varint çš„ä¸´æ—¶ç»“æœçš„ Buffer æ•°ç»„ï¼Œç”¨äº {@link #writeVarint32(int)} å’Œ {@link #writeVarint64(long)} ä¸­ã€‚
 */
private final byte[] mTemp = new byte[9];

/**
 * åºåˆ—åŒ–ç»“æœçš„ Buffer æ•°ç»„
 */
private final byte[] mBuffer;
/**
 * {@link #mBuffer} å®¹é‡å¤§å°
 */
private final int mLimit;
/**
 * {@link #mBuffer} å½“å‰å†™å…¥ä½ç½®
 */
private int mPosition = 0;

/**
 * ç»“æœè¾“å‡º
 */
private final OutputStream mOutput;
```

- ```
  mCharBuf
  ```

   

  å±æ€§ï¼Œåºåˆ—åŒ–

  å­—ç¬¦ä¸²

  çš„ä¸´æ—¶ç»“æœçš„ Buffer æ•°ç»„ï¼Œç”¨äº

   

  ```
  #writeUTF(String v)
  ```

   

  æ–¹æ³•ä¸­ã€‚

  - `#CHAR_BUF_SIZE` **é™æ€**å±æ€§ï¼Œé»˜è®¤å¤§å°ã€‚

- ```
  mTemp
  ```

   

  å±æ€§ï¼Œåºåˆ—åŒ–

   

  Varint

   

  çš„ä¸´æ—¶ç»“æœçš„ Buffer æ•°ç»„ï¼Œç”¨äº

   

  ```
  #writeVarint32(int)
  ```

   

  å’Œ

   

  ```
  #writeVarint64(long)
  ```

   

  æ–¹æ³•ä¸­ã€‚

  - æ•°ç»„å¤§å°ä¸º 9 ï¼Œå› ä¸º Varint æœ€å¤§å ç”¨ 9 å­—èŠ‚ï¼ŒTag( 1 Byte ) + Long( 8 Bytes ) ã€‚

- ```
  mBuffer
  ```

   

  å±æ€§ï¼Œåºåˆ—åŒ–

  ç»“æœ

  çš„ Buffer æ•°ç»„ã€‚

  - `mPosition` å±æ€§ï¼Œ**å½“å‰**å†™å…¥ä½ç½®ã€‚
  - `mLimit` å±æ€§ï¼Œå®¹é‡å¤§å°ã€‚
  - `mOutput` å±æ€§ï¼Œç»“æœè¾“å‡ºï¼Œ`mBuffer => mOutput` ä¸­ã€‚

###### 3.1.2 writeBool

```
@Override
public void writeBool(boolean v) throws IOException {
    write0(v ? VARINT_1 : VARINT_0);
}
```

- é€šè¿‡ 1 è¡¨ç¤º TRUE ï¼Œ0 è¡¨ç¤º FALSE ã€‚å ç”¨ 1 Byte ï¼Œä½¿ç”¨ **CONSTANTS**( VARINT_1ã€VARINT_0 ) å³å¯ã€‚

- è°ƒç”¨ `#write0(byte b)` æ–¹æ³•ï¼Œå†™å…¥ `mBuffer` ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  protected void write0(byte b) throws IOException {
      // è¶…è¿‡ mBuffer å®¹é‡ä¸Šé™ï¼Œåˆ·å…¥ mOutput ä¸­
      if (mPosition == mLimit) {
          flushBuffer();
      }
      // å†™å…¥ mBuffer ä¸­ã€‚
      mBuffer[mPosition++] = b;
  }
  ```

  - `#flushBuffer()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

    ```
    @Override
    public void flushBuffer() throws IOException {
        if (mPosition > 0) {
            // å†™å…¥ mOutput
            mOutput.write(mBuffer, 0, mPosition);
            // é‡ç½®å½“å‰å†™å…¥ä½ç½®
            mPosition = 0;
        }
    }
    ```

###### 3.1.3 writeByte

```
 1: @Override
 2: public void writeByte(byte v) throws IOException {
 3:     switch (v) {
 4:         // TODO ã€8034ã€‘ä¸ºä»€ä¹ˆæ²¡æœ‰è´Ÿæ•°çš„æšä¸¾
 5:         // ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œå†™å…¥å¯¹åº”çš„æšä¸¾å€¼
 6:         case 0:
 7:             write0(VARINT_0);
 8:             break;
 9:         // ... çœç•¥ä¸­é—´ï¼Œ[1, 30] é‡å¤çš„ case å¤„ç†
10:         case 31:
11:             write0(VARINT_1F);
12:             break;
13:         // ä¸ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œå†™å…¥ Tag + å…·ä½“å€¼
14:         default:
15:             // å†™å…¥ VARINT8
16:             write0(VARINT8);
17:             // å†™å…¥ BYTE å…·ä½“å€¼
18:             write0(v);
19:     }
20: }
```

- ç¬¬ 4 è¡Œï¼š// TODO ã€8034ã€‘ä¸ºä»€ä¹ˆæ²¡æœ‰è´Ÿæ•°çš„æšä¸¾
- ç¬¬ 5 è‡³ 12 è¡Œï¼šç¬¦åˆ Varint **CONSTANTS** ï¼Œå†™å…¥å¯¹åº”çš„ **CONSTANTS**ã€‚
- ç¬¬ 13 è‡³ 19 è¡Œï¼šä¸ç¬¦åˆ Varint CONSTANTS ï¼Œè°ƒç”¨ä¸¤æ¬¡ `#write0(byte b)` æ–¹æ³•ï¼Œå†™å…¥ **VARINT8** + å…·ä½“å€¼ `v` ã€‚

###### 3.1.4 writeShort

```
@Override
public void writeShort(short v) throws IOException {
    writeVarint32(v);
}
```

- è°ƒç”¨ `#writeVarint32(int v)` æ–¹æ³•ï¼Œå†™å…¥ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: private void writeVarint32(int v) throws IOException {
 2:     switch (v) {
 3:         // ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œå†™å…¥å¯¹åº”çš„æšä¸¾å€¼
 4:         case -15:
 5:             write0(VARINT_NF);
 6:             break;
 7:         // ... çœç•¥ä¸­é—´ï¼Œ[-14, 30] é‡å¤çš„ case å¤„ç†
 8:         case 31:
 9:             write0(VARINT_1F);
10:             break;
11:         // ä¸ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œå†™å…¥ Tag + å…·ä½“å€¼
12:         default:
13:             int t = v, // å€¼
14:                 ix = 0; // å½“å‰å†™å…¥ä½ç½®
15:             byte[] b = mTemp;
16:             // é¡ºåºè¯»å–å­—èŠ‚ï¼Œå­˜åˆ° mTemp ä¸­
17:             while (true) {
18:                 b[++ix] = (byte) (v & 0xff); // å¤§äºç­‰äº 128 æ—¶ï¼Œä¼šæˆªå–åˆ°æœ€é«˜ä½çš„ 1 ï¼Œå˜æˆè´Ÿæ•°ã€‚
19:                 if ((v >>>= 8) == 0) { // æ— å¯è¯»å­—èŠ‚
20:                     break;
21:                 }
22:             }
23: 
24:             if (t > 0) { // æ­£æ•°
25:                 // [ 0a e2 => 0a e2 00 ] [ 92 => 92 00 ]
26:                 // æœ€åä¸€æ¬¡å–ä½™ï¼Œå¤§äºç­‰äº 128 æ—¶ï¼Œåœ¨ (byte) è½¬æ¢åï¼Œå˜æˆäº†è´Ÿæ•°ï¼Œéœ€è¦è¡¥ä¸€ä¸ª 0 çš„ BYTE åˆ° mTemp ä¸­ï¼Œå¦åˆ™ååºåˆ—åŒ–åä¼šè¢«è¯¯è®¤ä¸ºè´Ÿæ•°ã€‚
27:                 if (b[ix] < 0) {
28:                     b[++ix] = 0;
29:                 }
30:             } else { // è´Ÿæ•°
31:                 // [ 01 ff ff ff => 01 ff ] [ e0 ff ff ff => e0 ]
32:                 // è´Ÿæ•°ä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼Œé«˜ä½æ˜¯å¤§é‡çš„ 1 ï¼Œéœ€è¦å»é™¤ã€‚
33:                 // å¦å¤–ï¼ŒLONG çš„ä½æ•°æ¯” INT æ›´å¤šï¼Œæ‰€ä»¥ï¼Œç›¸åŒæ•°å­—ï¼ŒLONG å‹ä¼šæ¯” INT å‹æ›´å¤šï¼Œä¾‹å¦‚ long v = -662L å’Œ int v = -662 ã€‚
34:                 while (b[ix] == (byte) 0xff && b[ix - 1] < 0) {
35:                     ix--;
36:                 }
37:             }
38: 
39:             // å†™å…¥ Tag ï¼Œåˆ°é¦– Byte ä½
40:             b[0] = (byte) (VARINT + ix - 1);
41:             // å†™å…¥ Tag + Bytes åˆ° mBuffer ä¸­
42:             write0(b, 0, ix + 1);
43:     }
44: }
```

- ç¬¬ 5 è‡³ 12 è¡Œï¼šç¬¦åˆ Varint **CONSTANTS** ï¼Œå†™å…¥å¯¹åº”çš„ **CONSTANTS**ã€‚

- ç¬¬ 11 è‡³ 43 è¡Œï¼šä¸ç¬¦åˆ Varint CONSTANTS ï¼Œå†™å…¥ **TAG** + å…·ä½“å€¼ ã€‚

  - ç¬¬ 16 è‡³ 22 è¡Œï¼šé¡ºåº

    å¾ªç¯

    è¯»å–

    æ¯ä¸ªå­—èŠ‚

    ï¼Œå­˜åˆ°

     

    ```
    b
    ```

     

    æ•°ç»„ä¸­ã€‚

    - ç¬¬ 18 è¡Œï¼šå…ˆ `0xff` åš `%256` å–ä½™ï¼Œè·å–åˆ°**ä¸€ä¸ªå­—èŠ‚**ã€‚å† **(byte)** è½¬æ¢æˆ BYTE å€¼ã€‚å› ä¸ºï¼ŒBYTE æ•°æ®èŒƒå›´ä¸º `[-128, 127]` ï¼Œæ‰€ä»¥å–ä½™çš„ç»“æœä¸º `[128, 255]` èŒƒå›´æ—¶ï¼Œåˆ™ä¼šè¢«**é«˜ä½æˆªå–**ï¼Œå˜æˆè´Ÿæ•°ã€‚ä¾‹å¦‚ï¼Œ255 ä¼šå˜æˆ -1 ã€‚ä¹Ÿå› æ­¤ï¼Œ**ååºåˆ—åŒ–**æ—¶ï¼Œéœ€è¦åšä¸€æ¬¡ `0xff |` æ“ä½œï¼Œæ¥è¡¥é½**é«˜ä½çš„ 1**ã€‚
    - ç¬¬ 18 è¡Œï¼š`b[++ix]` ï¼Œå…ˆå¢åŠ  `ix` çš„å€¼ï¼Œåœ¨å†™å…¥ `b` æ•°ç»„ä¸­ã€‚å› ä¸ºï¼Œé¦– Byte ä½ä¸º **TAG** ã€‚
    - ç¬¬ 19 è‡³ 21 è¡Œï¼šæ— å¯è¯»å­—èŠ‚ï¼Œç»“æŸå¾ªç¯ã€‚

  - ç¬¬ 24 è‡³ 29 è¡Œï¼šæœ€åä¸€æ¬¡å–ä½™ï¼Œå¤§äºç­‰äº 128 æ—¶ï¼Œåœ¨ **(byte)** è½¬æ¢åï¼Œå˜æˆäº†è´Ÿæ•°ï¼Œéœ€è¦è¡¥ä¸€ä¸ª 0 åˆ° `b` ä¸­ï¼Œå¦åˆ™ååºåˆ—åŒ–åä¼šè¢«è¯¯è®¤ä¸ºè´Ÿæ•°ã€‚ä¾‹å¦‚ï¼š`v = 255` ã€‚

  - ç¬¬ 30 è‡³ 37 è¡Œï¼šè´Ÿæ•°ä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼Œé«˜ä½æ˜¯å¤§é‡çš„ 1 ï¼Œéœ€è¦**å¾ªç¯**å»é™¤ã€‚å¦å¤–ï¼ŒLONG çš„ä½æ•°æ¯” INT æ›´å¤šï¼Œæ‰€ä»¥ï¼Œç›¸åŒæ•°å­—ï¼ŒLONG å‹ä¼šæ¯” INT å‹æ›´å¤šï¼Œä¾‹å¦‚ `long v = -662L` å’Œ `int v = -662` ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

    ```
    INT
    -110 -3 -1 -1
    
    LONG
    -110 -3 -1 -1 -1 -1 -1 -1
    ```

    - x

  - æ¶‰åŠå¤§é‡çš„**ä½æ“ä½œ**ï¼Œä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œè¯· Google å¤ä¹ ä¸‹å¤§å­¦è¯¾ç¨‹ã€‚ğŸ˜ˆ

  - ç¬¬ 40 è¡Œï¼šå†™å…¥ **TAG** ï¼Œåˆ° `b` çš„é¦–ä½ã€‚

  - ç¬¬ 42 è¡Œï¼šè°ƒç”¨ `#write0(byte[] b, int off, int le)` æ–¹æ³•ï¼Œ**æ‰¹é‡**å†™å…¥ `mBuffer` ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
    protected void write0(byte[] b, int off, int len) throws IOException {
        int rem = mLimit - mPosition;
        // æœªè¶…è¿‡ mBuffer å®¹é‡ä¸Šé™ï¼Œæ‰¹é‡å†™å…¥ mBuffer ä¸­
        if (rem > len) {
            System.arraycopy(b, off, mBuffer, mPosition, len);
            mPosition += len;
        } else {
            // éƒ¨åˆ†æ‰¹é‡å†™æ»¡ mBuffer ä¸­
            System.arraycopy(b, off, mBuffer, mPosition, rem);
            mPosition = mLimit;
            // åˆ·å…¥ mOutput ä¸­
            flushBuffer();
    
            off += rem; // æ–°çš„å¼€å§‹ä½ç½®
            len -= rem; // æ–°çš„é•¿åº¦
    
            // æœªè¶…è¿‡ mBuffer å®¹é‡ä¸Šé™ï¼Œæ‰¹é‡å†™å…¥ mBuffer ä¸­
            if (mLimit > len) {
                System.arraycopy(b, off, mBuffer, 0, len);
                mPosition = len;
            // è¶…è¿‡ mBuffer å®¹é‡ä¸Šé™ï¼Œæ‰¹é‡å†™å…¥ mOutput ä¸­
            } else {
                mOutput.write(b, off, len);
            }
        }
    }
    ```

###### 3.1.5 writeInt

```
@Override
public void writeInt(int v) throws IOException {
    writeVarint32(v);
}
```

###### 3.1.6 writeLong

```
@Override
public void writeInt(int v) throws IOException {
    writeVarint64(v);
}
```

- è°ƒç”¨ `#writeVarint64(long v)` æ–¹æ³•ï¼Œå†™å…¥ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: private void writeVarint64(long v) throws IOException {
 2:     // æ•°æ®èŒƒå›´åœ¨ INT å†…
 3:     int i = (int) v;
 4:     if (v == i) {
 5:         writeVarint32(i);
 6:     // æ•°æ®èŒƒå›´åœ¨ LONG å†…ï¼Œä¸ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œå†™å…¥ Tag + å…·ä½“å€¼ã€‚å’Œ writeVarint32 æ˜¯ä¸€è‡´çš„
 7:     } else {
 8:         long t = v;
 9:         int ix = 0;
10:         byte[] b = mTemp;
11: 
12:         while (true) {
13:             b[++ix] = (byte) (v & 0xff);
14:             if ((v >>>= 8) == 0)
15:                 break;
16:         }
17: 
18:         if (t > 0) {
19:             // [ 0a e2 => 0a e2 00 ] [ 92 => 92 00 ]
20:             if (b[ix] < 0)
21:                 b[++ix] = 0;
22:         } else {
23:             // [ 01 ff ff ff => 01 ff ] [ e0 ff ff ff => e0 ]
24:             while (b[ix] == (byte) 0xff && b[ix - 1] < 0)
25:                 ix--;
26:         }
27: 
28:         b[0] = (byte) (VARINT + ix - 1);
29:         write0(b, 0, ix + 1);
30:     }
31: }
```

- ç¬¬ 2 è‡³ 5 è¡Œï¼šå½“ `v` æ•°æ®èŒƒå›´åœ¨ INT å†…æ—¶ï¼Œè°ƒç”¨ `#writeVarint32(int v)` å¤„ç†ã€‚
- ç¬¬ 7 è‡³ 30 è¡Œï¼šå½“ `v` æ•°æ®èŒƒå›´åœ¨ LONG å†…æ—¶ï¼Œ ä¸ç¬¦åˆ Varint **CONSTANTS** ï¼Œå†™å…¥ **TAG** + å…·ä½“å€¼ï¼Œå’Œ `#writeVarint32(int v)` **ååŠæ®µ**çš„ä»£ç æ˜¯ä¸€è‡´çš„ã€‚

###### 3.1.7 writeFloat

```
@Override
public void writeFloat(float v) throws IOException {
    writeVarint32(Float.floatToRawIntBits(v));
}
```

###### 3.1.8 writeDouble

```
@Override
public void writeDouble(double v) throws IOException {
    writeVarint64(Double.doubleToRawLongBits(v));
}
```

###### 3.1.9 writeUInt

```
public void writeUInt(int v) throws IOException {
    byte tmp;
    // å¾ªç¯å†™å…¥
    while (true) {
        // è·å¾—æœ€å 7 Bits
        tmp = (byte) (v & 0x7f);
        // æ— åç»­çš„ Byte ï¼Œä¿®æ”¹ tmp é¦– Bit ä¸º 1 ï¼Œå†™å…¥ mBuffer ä¸­ï¼Œå¹¶ç»“æŸã€‚
        if ((v >>>= 7) == 0) {
            write0((byte) (tmp | 0x80));
            return;
        // æœ‰åç»­çš„ Byte ï¼Œå†™å…¥ mBuffer ä¸­
        } else {
            write0(tmp);
        }
    }
}
```

- UInt ï¼ŒUnsingned Int ï¼Œæ— ç¬¦å·æ•´æ•°( **æ­£æ•°** )ã€‚è¢«ç”¨äºè¡¨ç¤ºå­—ç¬¦ä¸²ã€æ•°ç»„çš„é•¿åº¦ã€‚åºåˆ—åŒ–æ—¶ï¼Œå’Œä¸Šæ–‡æˆ‘ä»¬çœ‹åˆ°çš„ Varint ä¸€æ ·ï¼Œä¹Ÿæ˜¯**å˜é•¿æ•°å­—**ï¼Œä½†æ˜¯æ–¹å¼**ä¸åŒ**ã€‚å› ä¸ºæ˜¯**æ­£æ•´æ•°**ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ **Byte æœ€é«˜ä½çš„ 1** ï¼ŒåŸæ¥ç”¨æ¥è¡¨ç¤ºè´Ÿæ•°ï¼Œç°åœ¨æ¥è¡¨ç¤ºæ˜¯å¦æœ‰**åç»­çš„ BYTE** ï¼Œä¹Ÿæ˜¯æ­£æ•´æ•°çš„ä¸€éƒ¨åˆ†ã€‚
- ğŸ™‚ ä»£ç å·²ç»æ·»åŠ æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±çœ‹çœ‹å“ˆã€‚
- æ¨èé˜…è¯» [ã€Šæ•°å€¼å‹ç¼©å­˜å‚¨æ–¹æ³•Varintã€‹](https://www.cnblogs.com/smark/archive/2012/05/03/2480034.html) ï¼Œé‡Œé¢ Varint å’Œ UInt ä¸€æ ·é‡‡ç”¨æœ€é«˜ä½æ¥è¡¨ç¤ºæ˜¯å¦æœ‰åç»­æ•°å­—ï¼Œä½†æ˜¯æ›´åŠ å¼ºå¤§é€šç”¨ï¼Œä½¿ç”¨ **Zag ç®—æ³•**è§£å†³è´Ÿæ•°é—®é¢˜ï¼Œåœ¨ Protobuf ä¸­é‡‡ç”¨è¯¥æ–¹å¼ã€‚ğŸ˜ˆ æ–‡ç« ä¸­çš„ Varint å’Œæœ¬æ–‡æˆ‘ä»¬çœ‹åˆ°çš„ Varint **ä¸åŒ**ã€‚å¦‚æœèƒ–å‹å¯¹ Protobuf çš„å®ç°æ„Ÿå…´è¶£ï¼Œæ¨èé˜…è¯» [ã€Š Protocol Buffer åºåˆ—åŒ–åŸç†å¤§æ­ç§˜ - ä¸ºä»€ä¹ˆProtocol Bufferæ€§èƒ½è¿™ä¹ˆå¥½ï¼Ÿã€‹](https://blog.csdn.net/carson_ho/article/details/70568606) ã€‚

###### 3.1.10 writeBytes

```
 1: @Override
 2: public void writeBytes(byte[] b) throws IOException {
 3:     // NULL ï¼Œä½¿ç”¨ OBJECT_NULL å†™å…¥ mBuffer
 4:     if (b == null) {
 5:         write0(OBJECT_NULL);
 6:     // å…¶ä»–ï¼Œå†™å…¥ mBuffer
 7:     } else {
 8:         writeBytes(b, 0, b.length);
 9:     }
10: }
11: 
12: @Override
13: public void writeBytes(byte[] b, int off, int len) throws IOException {
14:     // ç©ºæ•°ç»„ï¼Œä½¿ç”¨ OBJECT_DUMMY å†™å…¥ mBuffer
15:     if (len == 0) {
16:         write0(OBJECT_DUMMY);
17:     // æ•°ç»„éç©ºï¼Œå†™å…¥ OBJECT_BYTES + Length + å…·ä½“æ•°æ®åˆ° mBuffer
18:     } else {
19:         write0(OBJECT_BYTES);
20:         writeUInt(len); // UInt
21:         write0(b, off, len);
22:     }
23: }
```

[![writeBytes](http://static.iocoder.cn/images/Dubbo/2019_02_18/03.png)](http://static.iocoder.cn/images/Dubbo/2019_02_18/03.png)writeBytes

###### 3.1.11 writeUTF

```
 1: @Override
 2: public void writeUTF(String v) throws IOException {
 3:     // NULL ï¼Œä½¿ç”¨ OBJECT_NULL å†™å…¥ mBuffer
 4:     if (v == null) {
 5:         write0(OBJECT_NULL);
 6:     } else {
 7:         // ç©ºå­—ç¬¦ä¸²ï¼Œä½¿ç”¨ OBJECT_DUMMY å†™å…¥ mBuffer
 8:         int len = v.length();
 9:         if (len == 0) {
10:             write0(OBJECT_DUMMY);
11:         // å­—ç¬¦ä¸²éç©ºï¼Œå†™å…¥ OBJECT_BYTES + Length + å…·ä½“æ•°æ®åˆ° mBuffer
12:         } else {
13:             // å†™å…¥ OBJECT_BYTES åˆ° mBuffer ä¸­
14:             write0(OBJECT_BYTES);
15:             // å†™å…¥ Length åˆ° mBuffer ä¸­
16:             writeUInt(len);
17: 
18:             int off = 0,
19:                 limit = mLimit - 3, // -3 çš„åŸå› ï¼Œå› ä¸ºè‹¥ Char åœ¨ [2048, 65536) èŒƒå›´å†…ï¼Œéœ€è¦å ç”¨ä¸‰ä¸ªå­—èŠ‚ï¼Œäº‹å…ˆæ— æ³•å¾—çŸ¥ã€‚
20:                 size;
21:             char[] buf = mCharBuf;
22:             do {
23:                 // è¯»å–æ•°é‡ï¼Œä¸è¶…è¿‡ CHAR_BUF_SIZE ä¸Šé™ï¼ŒåŒæ—¶ä¸è¶…è¿‡å¯è¯»ä¸Šé™
24:                 size = Math.min(len - off, CHAR_BUF_SIZE);
25:                 // è¯»å–å­—ç¬¦ä¸²åˆ° buf ä¸­
26:                 v.getChars(off, off + size, buf, 0);
27: 
28:                 // å†™å…¥æ•°æ®åˆ° mBuffer ä¸­
29:                 for (int i = 0; i < size; i++) {
30:                     char c = buf[i];
31:                     // Java Character æ•°æ®èŒƒå›´ä¸º [0, 65535]
32:                     if (mPosition > limit) {
33:                         if (c < 0x80) { // [0, 128) ASCII ç 
34:                             // 0X80 => 10 00 00 00 å–ä¸ƒä½ [0, 64)
35: 
36:                             write0((byte) c);
37:                         } else if (c < 0x800) { // [128, 2048)
38:                             // 0xC0 => 11 00 00 00 å–å…­ä½ [0, 32)
39:                             // 0x80 => 10 00 00 00 å–ä¸ƒä½ [0, 64)
40: 
41:                             // 0x1F => 00 01 11 11
42:                             // 0x3F => 00 11 11 11
43: 
44:                             write0((byte) (0xC0 | ((c >> 6) & 0x1F)));
45:                             write0((byte) (0x80 | (c & 0x3F)));
46:                         } else { // [2048, 65536)
47:                             // 0xE0 => 11 10 00 00 å–äº”ä½ [0, 15]
48:                             // 0x80 => 10 00 00 00 å–ä¸ƒä½ [0, 63]
49:                             // 0x80 => 10 00 00 00 å–ä¸ƒä½ [0, 63]
50: 
51:                             // 0x0F => 00 00 11 11
52:                             // 0x3F => 00 11 11 11
53:                             // 0x3F => 00 11 11 11
54: 
55:                             write0((byte) (0xE0 | ((c >> 12) & 0x0F)));
56:                             write0((byte) (0x80 | ((c >> 6) & 0x3F)));
57:                             write0((byte) (0x80 | (c & 0x3F)));
58:                         }
59:                     } else {
60:                         if (c < 0x80) {
61:                             mBuffer[mPosition++] = (byte) c;
62:                         } else if (c < 0x800) {
63:                             mBuffer[mPosition++] = (byte) (0xC0 | ((c >> 6) & 0x1F));
64:                             mBuffer[mPosition++] = (byte) (0x80 | (c & 0x3F));
65:                         } else {
66:                             mBuffer[mPosition++] = (byte) (0xE0 | ((c >> 12) & 0x0F));
67:                             mBuffer[mPosition++] = (byte) (0x80 | ((c >> 6) & 0x3F));
68:                             mBuffer[mPosition++] = (byte) (0x80 | (c & 0x3F));
69:                         }
70:                     }
71:                 }
72: 
73:                 // è®¡ç®— buf æ–°çš„å¼€å§‹è¯»å–ä½ç½®ã€‚
74:                 off += size;
75:             } while (off < len);
76:         }
77:     }
78: }
```

- å­—ç¬¦ä¸²å’Œå­—èŠ‚æ•°ç»„ï¼Œ**äºŒè¿›åˆ¶æ•°æ®æµ**çš„ç»“æ„æ˜¯ä¸€è‡´çš„ï¼Œå·®å¼‚ç‚¹åœ¨å­—ç¬¦ä¸²çš„**æ¯ä¸ªå­—ç¬¦**ï¼Œå†™å…¥åˆ° `mBuffer` ä¸­ï¼Œå³ã€ç¬¬ 18 è‡³ 75 è¡Œã€‘ã€‚

- ç¬¬ 19 è¡Œï¼š`-3` çš„åŸå› ï¼Œå› ä¸ºæ¯ä¸ª**å­—ç¬¦**æœ€å¤šéœ€è¦å ç”¨**ä¸‰ä¸ª**å­—èŠ‚ï¼Œäº‹å…ˆæ— æ³•å¾—çŸ¥ã€‚è€Œã€ç¬¬ 32 è‡³ 58 è¡Œã€‘å’Œã€ç¬¬ 59 è‡³ 69 è¡Œã€‘ï¼Œé€»è¾‘ä¸Šæ˜¯**ä¸€è‡´**çš„ï¼Œç›¸æ¯”æ¥è¯´ã€ç¬¬ 32 è‡³ 58 è¡Œã€‘çš„ `#write0(byte b)` æ–¹æ³•ï¼Œå¤š**ä¸€ä¸ªåˆ¤æ–­**ï¼Œè€ƒè™‘åˆ°æ€§èƒ½ï¼Œå°±åˆ†æˆäº†**ä¸¤æ®µ**çš„é€»è¾‘ï¼Œä¹Ÿå°±å› æ­¤ï¼Œå¤šäº†è¿™é‡Œçš„ `-3` ã€‚

- ç¬¬ 22 è‡³ 25 è¡Œï¼š**å¾ªç¯**è¯»å–å­—ç¬¦åˆ° `buf` ä¸­ã€‚å› ä¸ºæ¯æ¬¡è¯»å–æœ‰ `CHAR_BUF_SIZE` æœ€å¤§é™åˆ¶ï¼Œæ‰€ä»¥è¶…è¿‡æ—¶ï¼Œéœ€è¦**å¤šæ¬¡**è¯»å–ã€‚è¯»å–å®Œä¸€æ‰¹ï¼Œå¤„ç†å®Œä¸€æ‰¹ï¼Œä¸æ–­**é‡ç”¨** `buf` æ•°ç»„ã€‚

- ç¬¬ 28 è‡³ 71 è¡Œï¼šå†™å…¥

   

  ```
  buf
  ```

   

  åˆ°

   

  ```
  mBuffer
  ```

   

  ä¸­ã€‚å› ä¸º Java

   

  Character

   

  çš„æ•°æ®èŒƒå›´ä¸º

   

  ```
  [0, 65535]
  ```

   

  ï¼Œè¶…è¿‡

   

  BYTE

   

  ä¸Šé™ã€‚æ‰€ä»¥å†™å…¥æ¯ä¸ªå­—ç¬¦æ—¶ï¼Œåˆ†æˆ

  ä¸‰ç§

  æƒ…å†µï¼š

  - ç¬¬ 33 è‡³ 36 è¡Œï¼š`[0, 128)` ï¼Œå ç”¨ä¸€ä¸ªå­—ç¬¦ã€‚å–ä¸ƒä½ï¼Œ2 çš„ ä¸ƒæ¬¡æ–¹ä¸º 128 ï¼Œä»è€Œæ»¡è¶³æ•°æ®èŒƒå›´ã€‚
  - ç¬¬ 37 è‡³ 45 è¡Œï¼š`[128, 2048)` ï¼Œå ç”¨ä¸¤ä¸ªå­—ç¬¦ã€‚å–å…­ä½ã€ä¸ƒä½ï¼Œ2 çš„åä¸‰æ¬¡æ–¹ä¸º 2048 ï¼Œä»è€Œæ»¡è¶³æ•°æ®èŒƒå›´ã€‚
  - ç¬¬ 46 è‡³ 58 è¡Œï¼š`[2048, 65536)` ï¼Œå ç”¨ä¸‰ä¸ªå­—ç¬¦ã€‚å–äº”ä½ã€ä¸ƒä½ã€ä¸ƒä½ï¼Œ2 çš„åä¹æ¬¡æ–¹ä¸º 65536 ï¼Œä»è€Œæ»¡è¶³æ•°æ®èŒƒå›´ã€‚
  - **ä¸ºä»€ä¹ˆé¦–ä½å–çš„ä¸åŒçš„ä½æ•°å‘¢**ï¼Ÿåœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¯ä»¥æ ¹æ®é¦–ä½æ•°çš„**é«˜ä½**æ¥åˆ¤æ–­ï¼Œåˆ°åº•å®Œæ•´çš„å­—ç¬¦ï¼Œå ç”¨äº†å‡ ä¸ªå­—èŠ‚ã€‚ğŸ™‚ æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£æˆï¼Œ**è¿™æ˜¯ä¸€ç§é’ˆå¯¹å½“å‰åœºæ™¯å®ç°çš„å˜é•¿æ•´æ•°**ã€‚

- ç¬¬ 74 è¡Œï¼šè®¡ç®— `buf` æ–°çš„å¼€å§‹**è¯»å–**ä½ç½®ã€‚

#### 3.2 GenericDataInput

[`com.alibaba.dubbo.common.serialize.support.dubbo.GenericDataInput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericDataInput.java) ï¼Œå®ç° DataInputï¼ŒGenericDataFlags æ¥å£ï¼ŒDubbo æ•°æ®è¾“å…¥å®ç°ç±»ã€‚

###### 3.2.1 æ„é€ æ–¹æ³•

```
/**
 * ç©ºå­—ç¬¦ä¸²
 */
private static final String EMPTY_STRING = "";

/**
 * ç©ºå­—èŠ‚æ•°ç»„
 */
private static final byte[] EMPTY_BYTES = {};

/**
 * è¾“å…¥æµ
 */
private final InputStream mInput;
/**
 * è¯»å– Buffer æ•°ç»„
 */
private final byte[] mBuffer;
/**
 * {@link #mBuffer} å½“å‰è¯»å–ä½ç½®
 */
private int mRead = 0;
/**
 * {@link #mBuffer} æœ€å¤§å¯è¯»å–ä½ç½®
 */
private int mPosition = 0;

public GenericDataInput(InputStream is) {
    this(is, 1024);
}

public GenericDataInput(InputStream is, int buffSize) {
    mInput = is;
    mBuffer = new byte[buffSize];
}
```

- ```
  mBuffer
  ```

   

  å±æ€§ï¼Œè¯»å– Buffer æ•°ç»„ã€‚

  - `mRead` å±æ€§ï¼Œå½“å‰è¯»å–ä½ç½®ã€‚
  - `mPosition` å±æ€§ï¼Œæœ€å¤§å¯è¯»å–ä½ç½®ã€‚
  - `mInput` å±æ€§ï¼Œè¾“å…¥æµã€‚

###### 3.2.2 readBool

```
@Override
public boolean readBool() throws IOException {
    // è¯»å–å­—èŠ‚
    byte b = read0();
    // åˆ¤æ–­ true / false
    switch (b) {
        case VARINT_0: // false
            return false;
        case VARINT_1: // true
            return true;
        default: // éæ³•
            throw new IOException("Tag error, expect BYTE_TRUE|BYTE_FALSE, but get " + b);
    }
}
```

- è°ƒç”¨ `#read0()` æ–¹æ³•ï¼Œè¯»å–å­—èŠ‚ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  protected byte read0() throws IOException {
      // è¯»å–åˆ°è¾¾ä¸Šé™ï¼Œä» mInput è¯»å–åˆ° mBuffer ä¸­ã€‚
      if (mPosition == mRead) {
          fillBuffer();
      }
      // ä» mBuffer ä¸­ï¼Œè¯»å–å­—èŠ‚ã€‚
      return mBuffer[mPosition++];
  }
  ```

  - `#fillBuffer()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

    ```
    private void fillBuffer() throws IOException {
        // é‡ç½® mPosition
        mPosition = 0;
        // è¯»å– mInput åˆ° mBuffer ä¸­
        mRead = mInput.read(mBuffer);
        // æœªè¯»å–åˆ°ï¼ŒæŠ›å‡º EOFException å¼‚å¸¸
        if (mRead == -1) {
            mRead = 0;
            throw new EOFException();
        }
    }
    ```

###### 3.2.3 readByte

```
 1: @Override
 2: public byte readByte() throws IOException {
 3:     // è¯»å–å­—èŠ‚
 4:     byte b = read0();
 5:     switch (b) {
 6:         // ä¸ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œè¯»å–å­—èŠ‚è¿”å›
 7:         case VARINT8:
 8:             return read0();
 9:         // ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œè¿”å›å¯¹åº”çš„å€¼
10:         case VARINT_0:
11:             return 0;
12:         // ... çœç•¥ä¸­é—´ï¼Œ[1, 30] é‡å¤çš„ case å¤„ç†
13:         case VARINT_1F:
14:             return 31;
15:         default: // éæ³•ï¼ŒæŠ›å‡º IOException å¼‚å¸¸
16:             throw new IOException("Tag error, expect VARINT, but get " + b);
17:     }
18: }
```

- ç¬¬ 4 è¡Œï¼šè°ƒç”¨ `#read0()` æ–¹æ³•ï¼Œè¯»å–å­—èŠ‚ã€‚
- ç¬¬ 6 è‡³ 8 è¡Œï¼šä¸ç¬¦åˆ Varint **CONSTANTS** ï¼Œè°ƒç”¨ `#read0()` æ–¹æ³•ï¼Œè¯»å–å­—èŠ‚è¿”å›ã€‚
- ç¬¬ 9 è‡³ 14 è¡Œï¼šç¬¦åˆ Varint CONSTANTSï¼Œè¿”å›å¯¹åº”çš„å€¼ã€‚

###### 3.2.4 readShort

```
@Override
public short readShort() throws IOException {
    return (short) readVarint32();
}
```

- è°ƒç”¨ `#readVarint32()` æ–¹æ³•ï¼Œè¯»å–ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: private int readVarint32() throws IOException {
 2:     // è¯»å–é¦–ä½ Byte å­—èŠ‚
 3:     byte b = read0();
 4:     // 
 5:     switch (b) {
 6:         // ä¸ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œè¯»å– Tag + å…·ä½“å€¼
 7:         case VARINT8:
 8:             return read0();
 9:         case VARINT16: {
10:             byte b1 = read0(), b2 = read0();
11:             return (short) ((b1 & 0xff) |
12:                     ((b2 & 0xff) << 8));
13:         }
14:         case VARINT24: {
15:             byte b1 = read0(), b2 = read0(), b3 = read0();
16:             int ret = (b1 & 0xff) |
17:                     ((b2 & 0xff) << 8) |
18:                     ((b3 & 0xff) << 16);
19:             if (b3 < 0) { // è¡¥é½è´Ÿæ•°çš„é«˜ä½
20:                 return ret | 0xff000000;
21:             }
22:             return ret;
23:         }
24:         case VARINT32: {
25:             byte b1 = read0(), b2 = read0(), b3 = read0(), b4 = read0();
26:             return ((b1 & 0xff) |
27:                     ((b2 & 0xff) << 8) |
28:                     ((b3 & 0xff) << 16) |
29:                     ((b4 & 0xff) << 24));
30:         }
31:         // ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œè¿”å›å¯¹åº”çš„å€¼
32:         case VARINT_NF:
33:             return -15;
34:         // ... çœç•¥ä¸­é—´ï¼Œ[-14, 30] é‡å¤çš„ case å¤„ç†
35:         case VARINT_1F:
36:             return 31;
37:         default:
38:             throw new IOException("Tag error, expect VARINT, but get " + b);
39:     }
40: }
```

- ç¬¬ 3 è¡Œï¼šè°ƒç”¨ `#read0()` æ–¹æ³•ï¼Œè¯»å–**é¦–ä½** Byte å­—èŠ‚ã€‚

- ç¬¬ 6 è‡³ 30 è¡Œï¼šä¸ç¬¦åˆ Varint

   

  CONSTANTS

  ï¼Œè¯»å–

   

  TAG

   

  \+ å…·ä½“å€¼ã€‚

  - `& 0xff` æ“ä½œï¼Œè¡¥å›**è¢«æˆªå–æœ€é«˜çš„ 1**ï¼Œä»è€Œæ¢å¤**åŸæ•°**ï¼Œå¯¹åº” `#writeVarint32(int v)` æ–¹æ³•çš„ã€ç¬¬ 18 ä½ã€‘ã€‚
  - `| 0xff000000` æ“ä½œï¼Œè¡¥é½è´Ÿæ•°çš„**é«˜ä½**ï¼Œå¯¹åº” `#writeVarint32(int v)` æ–¹æ³•çš„ã€ç¬¬ 30 è‡³ 36 ä½ã€‘ã€‚

- ç¬¬ 31 è‡³ 36 è¡Œï¼šç¬¦åˆ Varint **CONSTANTS**ï¼Œè¿”å›å¯¹åº”çš„å€¼ã€‚

###### 3.2.5 readInt

```
@Override
public int readInt() throws IOException {
    return readVarint32();
}
```

###### 3.2.6 readLong

```
@Override
public long readLong() throws IOException {
    return readVarint64();
}
```

- [`#readVarint64()`](https://github.com/YunaiV/dubbo/blob/335c72aeb45923681148d1a706f24ee2e6ba1020/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericDataInput.java#L386-L555) å’Œ `#readVarint32()` åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚

###### 3.2.7 readFloat

```
@Override
public float readFloat() throws IOException {
    return Float.intBitsToFloat(readVarint32());
}
```

###### 3.2.8 readDouble

```
@Override
public double readDouble() throws IOException {
    return Double.longBitsToDouble(readVarint64());
}
```

###### 3.2.9 readUInt

```
public int readUInt() throws IOException {
    // è¯»å–å­—èŠ‚
    byte tmp = read0(); // ç”¨äºæš‚å­˜å½“å‰è¯»å–ç»“æœ
    // ã€ç¬¬ä¸€æ¬¡ã€‘
    if (tmp < 0) { // è´Ÿæ•°ï¼Œæ„å‘³ç€æ— åç»­
        return tmp & 0x7f;
    }
    int ret = tmp & 0x7f; // æœ€ç»ˆç»“æœ
    // ã€ç¬¬äºŒæ¬¡ã€‘
    if ((tmp = read0()) < 0) { // è´Ÿæ•°ï¼Œæ„å‘³ç€æ— åç»­
        ret |= (tmp & 0x7f) << 7; // æ‹¼æ¥ tmp + ret
    } else {
        ret |= tmp << 7;
        // ã€ç¬¬ä¸‰æ¬¡ã€‘
        if ((tmp = read0()) < 0) { // è´Ÿæ•°ï¼Œæ„å‘³ç€æ— åç»­
            ret |= (tmp & 0x7f) << 14;
        } else {
            ret |= tmp << 14;
            // ã€ç¬¬å››æ¬¡ã€‘
            if ((tmp = read0()) < 0) { // è´Ÿæ•°ï¼Œæ„å‘³ç€æ— åç»­
                ret |= (tmp & 0x7f) << 21;
            // ã€ç¬¬äº”æ¬¡ã€‘5 * 7 > 32 ï¼Œæ‰€ä»¥å¯ä»¥ç»“æŸ
            } else {
                ret |= tmp << 21;
                ret |= (read0() & 0x7f) << 28;
            }
        }
    }
    return ret;
}
```

###### 3.2.10 readBytes

```
@Override
public byte[] readBytes() throws IOException {
    // è¯»å–å­—èŠ‚
    byte b = read0();
    switch (b) {
        case OBJECT_BYTES: // æ•°ç»„éç©º
            return read0(readUInt());
        case OBJECT_NULL: // NULL
            return null;
        case OBJECT_DUMMY: // æ•°ç»„ä¸ºç©º
            return EMPTY_BYTES;
        default:
            throw new IOException("Tag error, expect BYTES|BYTES_NULL|BYTES_EMPTY, but get " + b);
    }
}
```

- `#read0(int len)` æ–¹æ³•ï¼Œæ‰¹é‡è¯»å–å­—èŠ‚ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  protected byte[] read0(int len) throws IOException {
      int rem = mRead - mPosition;
      byte[] ret = new byte[len];
      // æœªè¶…è¿‡ mBuffer å‰©ä½™å¯è¯»å–ï¼Œæ‰¹é‡å†™å…¥ mBuffer ä¸­ã€‚mBuffer => ret
      if (len <= rem) {
          System.arraycopy(mBuffer, mPosition, ret, 0, len);
          mPosition += len;
      } else {
          // éƒ¨åˆ†æ‰¹é‡å†™å…¥ ref ä¸­ã€‚mBuffer => ret
          System.arraycopy(mBuffer, mPosition, ret, 0, rem);
          mPosition = mRead;
  
          len -= rem;
          int read, pos = rem; // æ–°çš„ ret è¯»å–èµ·ç‚¹
  
          // mInput => ret
          while (len > 0) {
              read = mInput.read(ret, pos, len);
              if (read == -1) {
                  throw new EOFException();
              }
              pos += read; // æ–°çš„ ret è¯»å–èµ·ç‚¹
              len -= read;
          }
      }
      return ret;
  }
  ```

###### 3.2.11 readUTF

```
 1: @Override
 2: public String readUTF() throws IOException {
 3:     // è¯»å–å­—èŠ‚
 4:     byte b = read0();
 5:     switch (b) {
 6:         // å­—ç¬¦ä¸²éç©º
 7:         case OBJECT_BYTES:
 8:             // è¯»å–é•¿åº¦
 9:             int len = readUInt();
10:             // ååºåˆ—åŒ–å‡ºå­—ç¬¦ä¸²
11:             StringBuilder sb = new StringBuilder();
12:             for (int i = 0; i < len; i++) {
13:                 // è¯»å–é¦–ä½
14:                 byte b1 = read0();
15:                 if ((b1 & 0x80) == 0) { // [0, 128) ASCII ç 
16:                     sb.append((char) b1);
17:                 } else if ((b1 & 0xE0) == 0xC0) { // [128, 2048)
18:                     byte b2 = read0();
19:                     sb.append((char) (((b1 & 0x1F) << 6) | (b2 & 0x3F)));
20:                 } else if ((b1 & 0xF0) == 0xE0) { // [2048, 65536)
21:                     byte b2 = read0(), b3 = read0();
22:                     sb.append((char) (((b1 & 0x0F) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F)));
23:                 } else
24:                     throw new UTFDataFormatException("Bad utf-8 encoding at " + b1);
25:             }
26:             return sb.toString();
27:         // NULL
28:         case OBJECT_NULL:
29:             return null;
30:         // å­—ç¬¦ä¸²ä¸ºç©º
31:         case OBJECT_DUMMY:
32:             return EMPTY_STRING;
33:         default:
34:             throw new IOException("Tag error, expect BYTES|BYTES_NULL|BYTES_EMPTY, but get " + b);
35:     }
36: }
```

- ç¬¬ 13 è‡³ 25 è¡Œï¼šååºåˆ—åŒ–

  æ¯ä¸ªå­—ç¬¦

  ï¼Œé€šè¿‡é¦–ä½æ•°çš„

  é«˜ä½

  æ¥åˆ¤æ–­ï¼Œåˆ°åº•å®Œæ•´çš„å­—ç¬¦ï¼Œå ç”¨äº†å‡ ä¸ªå­—èŠ‚:

  - ç¬¬ 15 è‡³ 16 è¡Œï¼šæ•°æ®èŒƒå›´æ˜¯ `[0, 128)` ï¼Œæœ€å¤§æ•° 127 çš„äºŒè¿›åˆ¶ä¸º `01 11 11 11` ï¼Œä½¿ç”¨ `& 0x80` è¿ç®—åï¼Œä¼šç­‰äº 0 ã€‚

  - ç¬¬ 17 è‡³ 19 è¡Œï¼šæ•°æ®èŒƒå›´æ˜¯

     

    ```
    [128, 2048)
    ```

     

    ï¼Œå› ä¸ºé¦–ä½æ•°å–å…­ä½ï¼Œå¹¶ä¸”ä½¿ç”¨

     

    ```
    0xC0 |
    ```

     

    è¿ç®—åï¼Œæ‰€ä»¥äºŒè¿›åˆ¶ä¸º

     

    ```
    11 XX XX XX
    ```

     

    ï¼Œä½¿ç”¨

     

    ```
    & 0xE0
    ```

     

    è¿ç®—åï¼Œä¼šç­‰äº

     

    ```
    0XC0
    ```

     

    ã€‚

    - ã€ç¬¬ 15 è‡³ 16 è¡Œã€‘å¦‚æœä½¿ç”¨

       

      ```
      & 0x80
      ```

       

      è¿ç®—ï¼Œ ä¸ä¼šç­‰äº 0 ï¼Œä¸ç¬¦åˆè¦æ±‚ã€‚

      - ç¬¬ 20 è‡³ 22 è¡Œï¼šæ•°æ®èŒƒå›´æ˜¯ `[2048, 65536)` ï¼Œå› ä¸ºé¦–ä½æ•°å–äº”ä½ï¼Œå¹¶ä¸”ä½¿ç”¨ `0xE0 |` è¿ç®—åï¼Œæ‰€ä»¥äºŒè¿›åˆ¶ä¸º `11 1X XX XX` ï¼Œä½¿ç”¨ `& 0xF0` è¿ç®—åï¼Œä¼šç­‰äº `0xE0` ã€‚

    - ã€ç¬¬ 15 è‡³ 16 è¡Œã€‘å¦‚æœä½¿ç”¨ `& 0x80` è¿ç®—ï¼Œ ä¸ä¼šç­‰äº 0 ï¼Œä¸ç¬¦åˆè¦æ±‚ã€‚

    - ã€ç¬¬ 17 è‡³ 19 è¡Œã€‘å¦‚æœä½¿ç”¨ `& 0xE0` è¿ç®—ï¼Œä¸ä¼šç­‰äº `0xC0` ï¼Œä¸ç¬¦åˆè¦æ±‚ã€‚

## 4. Object

#### 4.1 GenericObjectOutput

[`com.alibaba.dubbo.common.serialize.support.dubbo.GenericObjectOutput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericObjectOutput.java) ï¼Œå®ç° ObjectOutput æ¥å£ï¼Œç»§æ‰¿ GenericObjectOutput ç±»ï¼ŒDubbo å¯¹è±¡è¾“å‡ºå®ç°ç±»ã€‚

###### 4.1.1 æ„é€ æ–¹æ³•

```
/**
 * å¯¹è±¡æ˜¯å¦å…è®¸ä¸å®ç° {@link java.io.Serializable} æ¥å£
 */
private final boolean isAllowNonSerializable;
/**
 * ç±»æè¿°åŒ¹é…å™¨
 */
private ClassDescriptorMapper mMapper;
/**
 * å¾ªç¯å¼•ç”¨é›†åˆ
 *
 * KEY ï¼šå¯¹è±¡
 * VALUE ï¼šå¼•ç”¨ç¼–å·
 */
private Map<Object, Integer> mRefs = new ConcurrentHashMap<Object, Integer>();
```

- `isAllowNonSerializable` å±æ€§ï¼Œå¯¹è±¡æ˜¯å¦å…è®¸ä¸å®ç° Serializable æ¥å£ã€‚Dubbo åºåˆ—åŒ–æ— éœ€å¼ºåˆ¶å®ç° Serializable æ¥å£ã€‚è€ƒè™‘åˆ°é€šç”¨æ€§ï¼Œé»˜è®¤ `false` **ä¸å…è®¸**ã€‚
- `mMapper` å±æ€§ï¼Œç±»æè¿°åŒ¹é…å™¨ã€‚é€šè¿‡è¯¥åŒ¹é…å™¨ï¼Œå¯ä»¥å°†ç±»æè¿°ï¼Œè½¬æ¢æˆå¯¹åº”çš„æè¿°ç¼–å·ï¼Œä»è€ŒåŠ é€Ÿåºåˆ—åŒ–çš„é€Ÿåº¦ï¼Œå‡å°‘ä½“ç§¯ï¼Œç±»ä¼¼ Kryo çš„**æ³¨å†Œ**ã€‚é»˜è®¤ä½¿ç”¨ Builder çš„ **DEFAULT_CLASS_DESCRIPTOR_MAPPER** å®ç°ç±»ã€‚
- `mRefs` å±æ€§ï¼Œå¾ªç¯å¼•ç”¨é›†åˆï¼Œå’Œ FastJSON çš„ [ã€Šå¾ªç¯å¼•ç”¨ã€‹](https://github.com/alibaba/fastjson/wiki/å¾ªç¯å¼•ç”¨) ä¸Šï¼Œæ¦‚å¿µæ˜¯ä¸€è‡´çš„ã€‚åœ¨ AbstractObjectBuilder ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°**å¾ªç¯å¼•ç”¨**çš„å®ç°ã€‚

###### 4.1.2 writeObject

```
 1: @Override
 2: @SuppressWarnings({"unchecked", "rawtypes"})
 3: public void writeObject(Object obj) throws IOException {
 4:     // NULL ï¼Œä½¿ç”¨ OBJECT_NULL å†™å…¥ mBuffer
 5:     if (obj == null) {
 6:         write0(OBJECT_NULL);
 7:         return;
 8:     }
 9:     // ç©ºå¯¹è±¡ï¼Œä½¿ç”¨ OBJECT_DUMMY å†™å…¥ mBuffer
10:     Class<?> c = obj.getClass();
11:     if (c == Object.class) {
12:         write0(OBJECT_DUMMY);
13:     } else {
14:         // è·å¾—ç±»æè¿°
15:         String desc = ReflectUtils.getDesc(c);
16:         // æŸ¥è¯¢ç±»æè¿°ç¼–å·
17:         int index = mMapper.getDescriptorIndex(desc);
18:         // ä¸å­˜åœ¨ï¼Œä½¿ç”¨ OBJECT_DESC + ç±»æè¿° å†™å…¥ mBuffer
19:         if (index < 0) {
20:             write0(OBJECT_DESC);
21:             writeUTF(desc);
22:         // å­˜åœ¨ï¼Œä½¿ç”¨ OBJECT_DESC_ID + ç±»æè¿°ç¼–å· å†™å…¥ mBuffer
23:         } else {
24:             write0(OBJECT_DESC_ID);
25:             writeUInt(index);
26:         }
27:         // è·å¾—ç±»å¯¹åº”çš„åºåˆ—åŒ– Builder
28:         Builder b = Builder.register(c, isAllowNonSerializable);
29:         // åºåˆ—åŒ–åˆ° mBuffer ä¸­
30:         b.writeTo(obj, this);
31:     }
32: }
```

- ã€ç¬¬ä¸€ç§ã€‘ç¬¬ 4 è‡³ 8 è¡Œï¼šå¯¹è±¡ä¸º NULL ï¼Œå†™å…¥ **OBJECT_NULL** åˆ° `mBuffer` ã€‚

- ã€ç¬¬äºŒç§ã€‘ç¬¬ 9 è‡³ 12 è¡Œï¼šå¯¹è±¡ä¸º Object ç±»å‹ï¼Œå†™å…¥ **OBJECT_DUMMY** åˆ° `mBuffer` ã€‚

- ã€ç¬¬ä¸‰ç§ã€‘ç¬¬ 13 è‡³ 30 è¡Œï¼šå¯¹è±¡éç©ºï¼Œå†™å…¥ **ç±»æè¿° + å¯¹è±¡** åˆ° `mBuffer` ã€‚

  - ç¬¬ 15 è¡Œï¼šè°ƒç”¨ `ReflectUtils#getDesc(c)` æ–¹æ³•ï¼Œè·å¾—ç±»æè¿°ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
        public static String getDesc(Class<?> c) {
        StringBuilder ret = new StringBuilder();
        // Array
        while (c.isArray()) {
            ret.append('[');
            c = c.getComponentType();
        }
        // åŸºæœ¬ç±»å‹
        if (c.isPrimitive()) {
            String t = c.getName();
            if ("void".equals(t)) ret.append(JVM_VOID);
            else if ("boolean".equals(t)) ret.append(JVM_BOOLEAN);
            else if ("byte".equals(t)) ret.append(JVM_BYTE);
            else if ("char".equals(t)) ret.append(JVM_CHAR);
            else if ("double".equals(t)) ret.append(JVM_DOUBLE);
            else if ("float".equals(t)) ret.append(JVM_FLOAT);
            else if ("int".equals(t)) ret.append(JVM_INT);
            else if ("long".equals(t)) ret.append(JVM_LONG);
            else if ("short".equals(t)) ret.append(JVM_SHORT);
        // ç±»
        } else {
            ret.append('L');
            ret.append(c.getName().replace('.', '/'));
            ret.append(';');
        }
        return ret.toString();
    }
    ```

    - x

  - ç¬¬ 17 è¡Œï¼šè°ƒç”¨

     

    ```
    ClassDescriptorMapper#getDescriptorIndex(desc)
    ```

     

    æ–¹æ³•ï¼Œè·å¾—ç±»æè¿°

    ç¼–å·

    ã€‚

    - ã€ä¸å­˜åœ¨ã€‘ç¬¬18 è‡³ 21 è¡Œï¼šå†™å…¥ **OBJECT_DESC** + **ç±»æè¿°**(å­—ç¬¦ä¸²) åˆ° `mBuffer` ä¸­ã€‚
    - ã€å·²å­˜åœ¨ã€‘ç¬¬ 22 è‡³ 26 è¡Œï¼šå†™å…¥ **OBJECT_DESC_ID** + **ç±»æè¿°ç¼–å·**(ç¼–å·) åˆ° `mBuffer` ä¸­ã€‚
    - ğŸ™‚ å¾ˆæ˜æ˜¾ï¼Œç¬¬äºŒç§çš„æ€§èƒ½å’Œä½“ç§¯éƒ½æ›´å¥½ã€‚å½“ç„¶ï¼Œéœ€è¦ä¿è¯ Server å’Œ Client çš„ç±»æè¿°ç¼–å·æ˜¯ä¸€è‡´çš„ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªæ³¨å†Œ**å¸¸ç”¨**çš„æ•°æ®ç±»å‹åˆ° ClassDescriptorMapper ä¸­ã€‚

  - ç¬¬ 28 è¡Œï¼šè°ƒç”¨ `Builder#register(Class<T> c, boolean isAllowNonSerializable)` æ–¹æ³•ï¼Œè·å¾—ç±»**å¯¹åº”**çš„ Builder å¯¹è±¡ã€‚

  - ç¬¬ 30 è¡Œï¼šè°ƒç”¨ `Builder#writeToT obj, GenericObjectOutput out)` æ–¹æ³•ï¼Œ**åºåˆ—åŒ–**å¯¹è±¡åˆ° GenericObjectOutput ä¸­çš„è¾“å‡ºæµã€‚**ä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆåš**ï¼Ÿçœ‹å®Œ [ã€Œ6. Builderã€](http://svip.iocoder.cn/Dubbo/serialize-2-dubbo/#) çš„åˆ†äº«ï¼Œèƒ–å‹å°±ä¼šæ‰¾åˆ°ç­”æ¡ˆã€‚ğŸ™‚ å–ä¸ªå°å…³å­ã€‚

###### 4.1.3 addRef

```
/**
 * æ·»åŠ å¾ªç¯å¼•ç”¨
 *
 * @param obj å¯¹è±¡
 */
public void addRef(Object obj) {
    mRefs.put(obj, mRefs.size() /** å¼•ç”¨ç¼–å· **/ );
}
```

###### 4.1.4 getRef

```
/**
 * è·å¾—å¾ªç¯å¼•ç”¨ç¼–å·
 *
 * @param obj å¯¹è±¡
 * @return å¼•ç”¨ç¼–å·
 */
public int getRef(Object obj) {
    Integer ref = mRefs.get(obj);
    if (ref == null) {
        return -1;
    }
    return ref;
}
```

#### 4.2 GenericObjectInput

[`com.alibaba.dubbo.common.serialize.support.dubbo.GenericObjectInput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericObjectInput.java) ï¼Œå®ç° ObjectInput æ¥å£ï¼Œç»§æ‰¿ GenericDataInput ç±»ï¼ŒDubbo å¯¹è±¡**è¾“å…¥**å®ç°ç±»ã€‚

###### 4.2.1 æ„é€ æ–¹æ³•

```
/**
 * {@link #skipAny()} ç©ºå¯¹è±¡
 */
private static Object SKIPPED_OBJECT = new Object();
/**
 * ç±»æè¿°åŒ¹é…å™¨
 */
private ClassDescriptorMapper mMapper;
/**
 * å¾ªç¯å¼•ç”¨æ•°ç»„
 */
private List<Object> mRefs = new ArrayList<Object>();
```

###### 4.2.2 readObject

```
 1: @Override
 2: public Object readObject() throws IOException {
 3:     String desc;
 4:     // è¯»å–å­—èŠ‚
 5:     byte b = read0();
 6:     switch (b) {
 7:         case OBJECT_NULL: // NULL
 8:             return null;
 9:         case OBJECT_DUMMY: // ç©ºå¯¹è±¡
10:             return new Object();
11:         case OBJECT_DESC: { // ç±»æè¿°
12:             desc = readUTF();
13:             break;
14:         }
15:         case OBJECT_DESC_ID: { // ç±»æè¿°ç¼–å·
16:             // è¯»å–ç±»æè¿°ç¼–å·
17:             int index = readUInt();
18:             // è·å¾—ç±»æè¿°
19:             desc = mMapper.getDescriptor(index);
20:             if (desc == null) {
21:                 throw new IOException("Can not find desc id: " + index);
22:             }
23:             break;
24:         }
25:         default:
26:             throw new IOException("Flag error, expect OBJECT_NULL|OBJECT_DUMMY|OBJECT_DESC|OBJECT_DESC_ID, get " + b);
27:     }
28:     try {
29:         // è·å¾—ç±»
30:         Class<?> c = ReflectUtils.desc2class(desc);
31:         // è·å¾—ç±»å¯¹åº”çš„åºåˆ—åŒ– Builder
32:         // ååºåˆ—åŒ–æˆå¯¹è±¡è¿”å›
33:         return Builder.register(c).parseFrom(this);
34:     } catch (ClassNotFoundException e) {
35:         throw new IOException("Read object failed, class not found. " + StringUtils.toString(e));
36:     }
37: }
```

- ç¬¬ 30 è¡Œï¼šè°ƒç”¨ `ReflectUtils#desc2class(desc)` æ–¹æ³•ï¼Œè·å¾—ç±»ã€‚
- ç¬¬ 33 è¡Œï¼šè°ƒç”¨ `Builder#register(Class<T> c, boolean isAllowNonSerializable)` æ–¹æ³•ï¼Œè·å¾—ç±»**å¯¹åº”**çš„ Builder å¯¹è±¡ã€‚
- ç¬¬ 33 è¡Œï¼šè°ƒç”¨ `Builder#parseFrom(GenericObjectInput)` æ–¹æ³•ï¼Œååºåˆ—åŒ–æˆ**å¯¹è±¡**è¿”å›ã€‚

###### 4.2.3 addRef

```
/**
 * æ·»åŠ å¾ªç¯å¼•ç”¨
 *
 * @param obj å¯¹è±¡
 */
public void addRef(Object obj) {
    mRefs.add(obj);
}
```

###### 4.2.4 getRef

```
/**
 * è·å¾—å¾ªç¯å¼•ç”¨
 *
 * @param index å¼•ç”¨ç¼–å·
 * @return å¯¹è±¡
 * @throws IOException å½“å‘ç”Ÿ IO å¼‚å¸¸æ—¶
 */
public Object getRef(int index) throws IOException {
    if (index < 0 || index >= mRefs.size()) {
        return null;
    }
    // è·å¾—å¯¹è±¡
    Object ret = mRefs.get(index);
    // åœ¨ skyAny() è®¾ç½®
    if (ret == SKIPPED_OBJECT) {
        throw new IOException("Ref skipped-object.");
    }
    return ret;
}
```

###### 4.2.5 skipAny

ã€TODO 8035ã€‘1ã€å·²ç»é™åˆ¶çš„å¤§å°ï¼Œè¿™å—ä»£ç æ²¡ç”¨äº†å•Šï¼Ÿï¼

èƒ–å‹å¯å…ˆæ— è§†è¿™ä¸ªæ–¹æ³•ã€‚

## 5. ClassDescriptorMapper

`com.alibaba.dubbo.common.serialize.support.dubbo.ClassDescriptorMapper` ï¼Œç±»æè¿°åŒ¹é…å™¨æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
// æ ¹æ®ç±»æè¿°ç¼–å·ï¼Œè·å¾—ç±»æè¿°
String getDescriptor(int index);

// æ ¹æ®ç±»æè¿°ï¼Œè·å¾—ç±»æè¿°ç¼–å·
int getDescriptorIndex(String desc);
```

#### 5.1 DEFAULT_CLASS_DESCRIPTOR_MAPPER

> DEFAULT_CLASS_DESCRIPTOR_MAPPER æ˜¯ Builder çš„å†…éƒ¨å±æ€§ã€‚

```
/**
 * ç±»æè¿°æ•°ç»„
 */
private static final List<String> mDescList = new ArrayList<String>();
/**
 * ç±»æè¿°æ˜ å°„
 */
private static final Map<String, Integer> mDescMap = new ConcurrentHashMap<String, Integer>();

/**
 * ClassDescriptorMapper é»˜è®¤å®ç°ç±»
 */
public static ClassDescriptorMapper DEFAULT_CLASS_DESCRIPTOR_MAPPER = new ClassDescriptorMapper() {

    @Override
    public String getDescriptor(int index) {
        if (index < 0 || index >= mDescList.size()) {
            return null;
        }
        return mDescList.get(index);
    }

    @Override
    public int getDescriptorIndex(String desc) {
        Integer ret = mDescMap.get(desc);
        return ret == null ? -1 : ret;
    }

};
```

åœ¨ Builder çš„ **static** ä»£ç å—ï¼Œä¼šåˆå§‹åŒ– `mDescMap` å±æ€§ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
static {
    addDesc(boolean[].class);
    addDesc(byte[].class);
    addDesc(char[].class);
    addDesc(short[].class);
    addDesc(int[].class);
    addDesc(long[].class);
    addDesc(float[].class);
    addDesc(double[].class);

    addDesc(Boolean.class);
    addDesc(Byte.class);
    addDesc(Character.class);
    addDesc(Short.class);
    addDesc(Integer.class);
    addDesc(Long.class);
    addDesc(Float.class);
    addDesc(Double.class);

    addDesc(String.class);
    addDesc(String[].class);

    addDesc(ArrayList.class);
    addDesc(HashMap.class);
    addDesc(HashSet.class);
    addDesc(Date.class);
    addDesc(java.sql.Date.class);
    addDesc(java.sql.Time.class);
    addDesc(java.sql.Timestamp.class);
    addDesc(java.util.LinkedList.class);
    addDesc(java.util.LinkedHashMap.class);
    addDesc(java.util.LinkedHashSet.class);

    // ... çœç•¥æ— å…³ä»£ç 
}

private static void addDesc(Class<?> c) {
    String desc = ReflectUtils.getDesc(c); // ä¾‹å¦‚ï¼Œjava.lang.Byte ä¸º Ljava/lang/Byte;
    // æ·»åŠ åˆ°é›†åˆä¸­
    int index = mDescList.size();
    mDescList.add(desc);
    mDescMap.put(desc, index);
}
```

## 6. Builder

[`com.alibaba.dubbo.common.serialize.support.dubbo.Builder`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/Builder.java) ï¼Œå®ç° GenericDataFlags æ¥å£ï¼Œå¯¹è±¡åºåˆ—åŒ–ä»£ç æ„å»ºå™¨**æŠ½è±¡ç±»**ã€‚åŠŸèƒ½å¦‚ä¸‹ï¼š

- 1. ç±»çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„**æŠ½è±¡å®šä¹‰**ã€‚
- 1. æä¾›**å¸¸ç”¨ç±»**( ä¾‹å¦‚ Integer ã€Long ã€Map ç­‰ç­‰ )çš„ Builder å®ç°ç±»ã€‚
- 1. åŸºäº **Javassist** è‡ªåŠ¨å®ç°**è‡ªå®šä¹‰ç±»**( ä¾‹å¦‚ User ã€Student ç­‰ç­‰ )çš„ Builder å®ç°ç±»ã€‚

ğŸ™‚ å¤§ä½“çš„ç±»ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![ç±»å›¾](http://static.iocoder.cn/images/Dubbo/2019_02_18/04.png)](http://static.iocoder.cn/images/Dubbo/2019_02_18/04.png)ç±»å›¾

#### 6.1 æŠ½è±¡æ–¹æ³•

```
/**
 * @return Builder å¯¹åº”çš„ç±»
 */
abstract public Class<T> getType();

/**
 * åºåˆ—åŒ–å¯¹è±¡åˆ° GenericObjectOutput ä¸­çš„è¾“å‡ºæµã€‚
 *
 * @param obj å¯¹è±¡
 * @param out GenericObjectOutput å¯¹è±¡
 * @throws IOException å½“å‘ç”Ÿ IO å¼‚å¸¸æ—¶ã€‚
 */
abstract public void writeTo(T obj, GenericObjectOutput out) throws IOException;
// â†‘â†‘â†‘ è°ƒç”¨ä¸Šé¢æ–¹æ³•
public void writeTo(T obj, OutputStream os) throws IOException {
    // å°† OutputStream å°è£…æˆ GenericObjectOutput å¯¹è±¡
    GenericObjectOutput out = new GenericObjectOutput(os);
    // å†™å…¥
    writeTo(obj, out);
    // åˆ·å…¥
    out.flushBuffer();
}

/**
 * ååºåˆ—åŒ– GenericObjectInput æˆå¯¹è±¡
 *
 * @param in GenericObjectInput å¯¹è±¡
 * @return å¯¹è±¡
 * @throws IOException å½“ IO å‘ç”Ÿå¼‚å¸¸æ—¶
 */
abstract public T parseFrom(GenericObjectInput in) throws IOException;
// â†‘â†‘â†‘ è°ƒç”¨ä¸Šé¢æ–¹æ³•
public T parseFrom(InputStream is) throws IOException {
    return parseFrom(new GenericObjectInput(is)); // å°† InputStream å°è£…æˆ GenericObjectInput å¯¹è±¡
}
// â†‘â†‘â†‘ è°ƒç”¨ä¸Šé¢æ–¹æ³•
public T parseFrom(byte[] b) throws IOException {
    return parseFrom(new UnsafeByteArrayInputStream(b)); // å°† byte[] å°è£…æˆ InputStream å¯¹è±¡
}
```

**ä¸‰ä¸ª**æŠ½è±¡æ–¹æ³•ï¼š

- å¯¹åº”ç±»
- åºåˆ—åŒ–
- ååºåˆ—åŒ–

#### 6.2 register

```
/**
 * å®ç° Serializable æ¥å£çš„ç±»çš„ Builder å¯¹è±¡ç¼“å­˜
 */
private static final Map<Class<?>, Builder<?>> BuilderMap = new ConcurrentHashMap<Class<?>, Builder<?>>();
/**
 * æœªå®ç° Serializable æ¥å£çš„ç±»çš„ Builder å¯¹è±¡ç¼“å­˜
 */
private static final Map<Class<?>, Builder<?>> nonSerializableBuilderMap = new ConcurrentHashMap<Class<?>, Builder<?>>();

  1: public static <T> Builder<T> register(Class<T> c, boolean isAllowNonSerializable) {
  2:     // Object ç±»ï¼Œæˆ–è€…æ¥å£ï¼Œä½¿ç”¨ GenericBuilder
  3:     if (c == Object.class || c.isInterface()) {
  4:         return (Builder<T>) GenericBuilder;
  5:     }
  6:     // Array ç±»å‹ï¼Œä½¿ç”¨ GenericArrayBuilder
  7:     if (c == Object[].class) {
  8:         return (Builder<T>) GenericArrayBuilder;
  9:     }
 10:
 11:     // è·å¾— Builder å¯¹è±¡
 12:     Builder<T> b = (Builder<T>) BuilderMap.get(c);
 13:     if (null != b) {
 14:         return b;
 15:     }
 16:
 17:     // è¦æ±‚å®ç° Serializable æ¥å£ï¼Œä½†æ˜¯å¹¶æœªå®ç°ï¼Œåˆ™æŠ›å‡º IllegalStateException å¼‚å¸¸
 18:     boolean isSerializable = Serializable.class.isAssignableFrom(c);
 19:     if (!isAllowNonSerializable && !isSerializable) {
 20:         throw new IllegalStateException("Serialized class " + c.getName() +
 21:                 " must implement java.io.Serializable (dubbo codec setting: isAllowNonSerializable = false)");
 22:     }
 23:
 24:     // è·å¾— Builder å¯¹è±¡
 25:     b = (Builder<T>) nonSerializableBuilderMap.get(c);
 26:     if (null != b) {
 27:         return b;
 28:     }
 29:
 30:     // ä¸å­˜åœ¨ï¼Œä½¿ç”¨ Javassist ç”Ÿæˆå¯¹åº”çš„ Builder ç±»ï¼Œå¹¶è¿›è¡Œåˆ›å»º Builder å¯¹è±¡ã€‚
 31:     b = newBuilder(c);
 32:
 33:     // æ·»åŠ åˆ° Builder å¯¹è±¡ç¼“å­˜ä¸­
 34:     if (isSerializable) {
 35:         BuilderMap.put(c, b);
 36:     } else {
 37:         nonSerializableBuilderMap.put(c, b);
 38:     }
 39:
 40:     return b;
 41: }
```

- ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹çœ‹ä¸‹æ³¨é‡Šå“ˆã€‚æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ `c.isInterface()` çš„åˆ¤æ–­ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨ `GenericBuilder` å¯¹è±¡ã€‚åœ¨ [ã€Œ6.4 GenericBuilderã€ ](http://svip.iocoder.cn/Dubbo/serialize-2-dubbo/#)ä¼šçœ‹åˆ°ç­”æ¡ˆã€‚

#### 6.3 å¸¸ç”¨æ•°æ®ç±»å‹çš„ Builder å®ç°

åœ¨ **static** ä»£ç å—ï¼Œåˆå§‹åŒ–äº†å¸¸ç”¨æ•°æ®ç±»å‹çš„ Builder å®ç°ï¼Œä»£ç å¦‚ä¸‹å›¾ï¼š

[![å¸¸ç”¨æ•°æ®ç±»å‹çš„ Builder å®ç°](http://static.iocoder.cn/images/Dubbo/2019_02_18/05.png)](http://static.iocoder.cn/images/Dubbo/2019_02_18/05.png)å¸¸ç”¨æ•°æ®ç±»å‹çš„ Builder å®ç°

ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç‚¹å‡» [é“¾æ¥](http://svip.iocoder.cn/Dubbo/serialize-2-dubbo/TODO) ï¼Œè‡ªå·±æŸ¥çœ‹ã€‚è¿™é‡Œæˆ‘ä»¬å°±ä»¥ **HashMap** çš„ Builder ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
register(HashMap.class, new Builder<HashMap>() {

    @Override
    public Class<HashMap> getType() {
        return HashMap.class;
    }

    @Override
    public void writeTo(HashMap obj, GenericObjectOutput out) throws IOException {
        // NULL ï¼Œå†™å…¥ OBJECT_NULL åˆ° mBuffer ä¸­
        if (obj == null) {
            out.write0(OBJECT_NULL);
        // HashMap éç©º
        } else {
            // å†™å…¥ OBJECT_MAP åˆ° mBuffer ä¸­
            out.write0(OBJECT_MAP);
            // å†™å…¥ Length(Map å¤§å°) åˆ° mBuffer ä¸­
            out.writeUInt(obj.size());
            // å†™å…¥ KV åˆ° mBuffer ä¸­
            for (Map.Entry entry : (Set<Map.Entry>) obj.entrySet()) {
                out.writeObject(entry.getKey());
                out.writeObject(entry.getValue());
            }
        }
    }

    @Override
    public HashMap parseFrom(GenericObjectInput in) throws IOException {
        // è¯»å–é¦–ä½å­—èŠ‚
        byte b = in.read0();
        // NULL ï¼Œè¿”å› null
        if (b == OBJECT_NULL) {
            return null;
        }
        if (b != OBJECT_MAP) {
            throw new IOException("Input format error, expect OBJECT_NULL|OBJECT_MAP, get " + b + ".");
        }

        // è¯»å– Length(Map å¤§å°)
        int len = in.readUInt();
        // å¾ªç¯è¯»å– KV åˆ° HashMap
        HashMap ret = new HashMap(len);
        for (int i = 0; i < len; i++) {
            ret.put(in.readObject(), in.readObject());
        }
        return ret;
    }

});
```

#### 6.4 GenericBuilder

`GenericBuilder` ï¼Œå®ç° Builder æ¥å£ï¼Œ**é€šç”¨** Object çš„ Builder å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
static final Builder<Object> GenericBuilder = new Builder<Object>() {

    @Override
    public Class<Object> getType() {
        return Object.class;
    }

    @Override
    public void writeTo(Object obj, GenericObjectOutput out) throws IOException {
        out.writeObject(obj);
    }

    @Override
    public Object parseFrom(GenericObjectInput in) throws IOException {
        return in.readObject();
    }

};
```

é€‚ç”¨äº**æ‰€æœ‰å¯¹è±¡**ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿæˆ‘ä»¬ä»¥ `#writeTo(Object obj, GenericObjectOutput out)` æ–¹æ³•ï¼Œä¸¾ä¾‹å­ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ `GenericObjectOutput#writeObject(obj)` æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šè·å¾— `obj` å¯¹è±¡ï¼ŒçœŸæ­£çš„ Builder å¯¹è±¡ï¼Œä»è€Œåºåˆ—åŒ–ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å¸¸ç”¨æ•°æ®ç±»å‹çš„ Builder å®ç°](http://static.iocoder.cn/images/Dubbo/2019_02_18/05.png)](http://static.iocoder.cn/images/Dubbo/2019_02_18/05.png)å¸¸ç”¨æ•°æ®ç±»å‹çš„ Builder å®ç°

#### 6.5 SerializableBuilder

`SerializableBuilder` å±æ€§ï¼Œå®ç° Builder æ¥å£ï¼Œ**é€šç”¨** Serializable çš„ Builder å¯¹è±¡ï¼Œä½¿ç”¨ **Java åŸç”Ÿåºåˆ—åŒ–**æ–¹å¼å®ç°ã€‚**ç›®å‰**ä½¿ç”¨åœ¨ï¼š

- Throwable å¯¹è±¡ã€‚
- å¸¦æœ‰ **transient** ä¿®é¥°ç¬¦å±æ€§çš„ **Serializable** å®ç°ç±»ã€‚

å› ä¸ºæ˜¯**å¹¿æ³›**åŒ¹é…ï¼Œæ‰€ä»¥ä¸é€‚åˆè°ƒç”¨ `#register(Class<T> c, boolean isAllowNonSerializable)` æ–¹æ³•ï¼Œè¿›è¡Œæ³¨å†Œã€‚è€Œæ˜¯åœ¨ `#newObjectBuilder(Class<?> c)` æ–¹æ³•ï¼Œé€šè¿‡**ç¡¬ç¼–ç **åˆ¤æ–­åŒ¹é…è¿”å›ã€‚

å®ç°ä»£ç å¦‚ä¸‹ï¼š

```
static final Builder<Serializable> SerializableBuilder = new Builder<Serializable>() {

    @Override
    public Class<Serializable> getType() {
        return Serializable.class;
    }

    @Override
    public void writeTo(Serializable obj, GenericObjectOutput out) throws IOException {
        // NULL ï¼Œå†™å…¥ OBJECT_NULL åˆ° mBuffer ä¸­
        if (obj == null) {
            out.write0(OBJECT_NULL);
        // éç©º
        } else {
            // å†™å…¥ OBJECT_STREAM åˆ° mBuffer ä¸­
            out.write0(OBJECT_STREAM);
            // ä½¿ç”¨ compactjava åºåˆ—åŒ–å®ç°ï¼Œè¿›è¡Œåºåˆ—åŒ–
            UnsafeByteArrayOutputStream bos = new UnsafeByteArrayOutputStream();
            CompactedObjectOutputStream oos = new CompactedObjectOutputStream(bos);
            oos.writeObject(obj);
            oos.flush();
            bos.close();
            byte[] b = bos.toByteArray();
            // å†™å…¥ Length( å­—èŠ‚æ•°ç»„é•¿åº¦ ) åˆ° mBuffer ä¸­
            out.writeUInt(b.length);
            // å†™å…¥ å­—èŠ‚æ•°ç»„ åˆ° mBuffer ä¸­
            out.write0(b, 0, b.length);
        }
    }

    @Override
    public Serializable parseFrom(GenericObjectInput in) throws IOException {
        // è¯»å–é¦–ä½å­—èŠ‚
        byte b = in.read0();
        // NULL ï¼Œè¿”å› null
        if (b == OBJECT_NULL) {
            return null;
        }
        if (b != OBJECT_STREAM) {
            throw new IOException("Input format error, expect OBJECT_NULL|OBJECT_STREAM, get " + b + ".");
        }

        // ä½¿ç”¨ compactjava åºåˆ—åŒ–å®ç°ï¼Œè¿›è¡Œååºåˆ—åŒ–
        UnsafeByteArrayInputStream bis = new UnsafeByteArrayInputStream(in.read0(in.readUInt()));
        CompactedObjectInputStream ois = new CompactedObjectInputStream(bis);
        try {
            return (Serializable) ois.readObject();
        } catch (ClassNotFoundException e) {
            throw new IOException(StringUtils.toString(e));
        }
    }

};
```

#### 6.6 AbstractObjectBuilder

AbstractObjectBuilder ï¼Œå®ç° Builder æ¥å£ï¼ŒBuilder **æŠ½è±¡ç±»**ã€‚ä¸»è¦å®ç°äº†**å¾ªç¯å¼•ç”¨**å¯¹è±¡çš„æ”¯æŒã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Override
public void writeTo(T obj, GenericObjectOutput out) throws IOException {
    // NULL ï¼Œå†™å…¥ OBJECT_NULL åˆ° mBuffer ä¸­
    if (obj == null) {
        out.write0(OBJECT_NULL);
    } else {
        // è¯»å–å¾ªç¯å¼•ç”¨å¯¹è±¡ç¼–å·
        int ref = out.getRef(obj);
        if (ref < 0) { // ä¸å­˜åœ¨
            // æ·»åŠ åˆ°å¾ªç¯å¼•ç”¨ä¸­ï¼Œä»è€Œè·å¾—ç¼–å·ã€‚ä¸‹æ¬¡åœ¨å†™å…¥ç›¸ç­‰å¯¹è±¡æ—¶ï¼Œå¯ä½¿ç”¨å¾ªç¯å¼•ç”¨ç¼–å·çš„æ–¹å¼ã€‚
            out.addRef(obj);
            // å†™å…¥ OBJECT åˆ° mBuffer ä¸­
            out.write0(OBJECT);
            // å†™å…¥ å¯¹è±¡ åˆ° mBuffer ä¸­ã€‚
            writeObject(obj, out);
        } else { // å­˜åœ¨
            // å†™å…¥ OBJECT_REF åˆ° mBuffer ä¸­
            out.write0(OBJECT_REF);
            // å†™å…¥ å¾ªç¯å¼•ç”¨å¯¹è±¡ç¼–å· åˆ° mBuffer ä¸­
            out.writeUInt(ref);
        }
    }
}

@Override
public T parseFrom(GenericObjectInput in) throws IOException {
    // è¯»å–é¦–ä½å­—èŠ‚
    byte b = in.read0();
    switch (b) {
        // å¯¹è±¡
        case OBJECT: {
            // åˆ›å»ºå¯¹è±¡
            T ret = newInstance(in);
            // æ·»åŠ åˆ°å¾ªç¯å¼•ç”¨ä¸­ï¼Œä»è€Œè·å¾—ç¼–å·ã€‚ä¸‹æ¬¡åœ¨è¯»å–åˆ°å¾ªç¯å¼•ç”¨å¯¹è±¡ç¼–å·æ—¶ï¼Œå¯ç›´æ¥è·å–åˆ°è¯¥å¯¹è±¡ã€‚
            in.addRef(ret);
            // ååºåˆ—åŒ– GenericObjectInput åˆ°å¯¹è±¡
            readObject(ret, in);
            // è¿”å›
            return ret;
        }
        // å¾ªç¯å¼•ç”¨å¯¹è±¡ç¼–å·
        case OBJECT_REF:
            // è¯»å–å¾ªç¯å¼•ç”¨å¯¹è±¡ç¼–å·
            // è·å¾—å¯¹åº”çš„å¯¹è±¡
            return (T) in.getRef(in.readUInt());
        // NULL ï¼Œè¿”å› null
        case OBJECT_NULL:
            return null;
        default:
            throw new IOException("Input format error, expect OBJECT|OBJECT_REF|OBJECT_NULL, get " + b);
    }
}
```

- å’Œ Builder æä¾›çš„ä¸‰ä¸ª**æŠ½è±¡**æ–¹æ³•**ä¸€ä¸€å¯¹åº”**ï¼ŒAbstractObjectBuilder ä¹Ÿå®šä¹‰äº†**ä¸‰ä¸ªæŠ½è±¡æ–¹æ³•**ï¼š

  ```
  /**
   * åˆ›å»º Builder å¯¹åº”ç±»çš„å¯¹è±¡
   *
   * @param in GenericObjectInput å¯¹è±¡
   * @return å¯¹åº”ç±»çš„å¯¹è±¡
   * @throws IOException å½“ IO å‘ç”Ÿå¼‚å¸¸æ—¶
   */
  abstract protected T newInstance(GenericObjectInput in) throws IOException;
  
  /**
   * åºåˆ—åŒ–å¯¹è±¡åˆ° GenericObjectOutput ä¸­çš„è¾“å‡ºæµã€‚
   *
   * @param obj å¯¹è±¡
   * @param out GenericObjectOutput å¯¹è±¡
   * @throws IOException å½“ IO å‘ç”Ÿå¼‚å¸¸æ—¶
   */
  abstract protected void writeObject(T obj, GenericObjectOutput out) throws IOException;
  
  /**
   * ååºåˆ—åŒ– GenericObjectInput åˆ°å¯¹è±¡
   *
   * @param ret å¯¹è±¡ã€‚
   *            è¯¥å¯¹è±¡åœ¨ {@link #parseFrom(GenericObjectInput)} ä¸­ï¼Œè°ƒç”¨ {@link #newInstance(GenericObjectInput)} åˆ›å»º
   * @param in GenericObjectInput å¯¹è±¡
   * @throws IOException å½“ IO å‘ç”Ÿå¼‚å¸¸æ—¶
   */
  abstract protected void readObject(T ret, GenericObjectInput in) throws IOException;
  ```

###### 6.6.1 GenericArrayBuilder

`GenericArrayBuilder` ï¼Œå®ç° AbstractObjectBuilder æŠ½è±¡ç±»ï¼Œé€šç”¨**æ•°ç»„( Array )** çš„ Builder å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
static final Builder<Object[]> GenericArrayBuilder = new AbstractObjectBuilder<Object[]>() {

    @Override
    public Class<Object[]> getType() {
        return Object[].class;
    }

    @Override
    protected Object[] newInstance(GenericObjectInput in) throws IOException {
        // è¯»å–æ•°ç»„é•¿åº¦ï¼Œå¹¶åˆ›å»ºæ•°ç»„å¯¹è±¡
        return new Object[in.readUInt()];
    }

    @Override
    protected void readObject(Object[] ret, GenericObjectInput in) throws IOException {
        // å¾ªç¯è¯»å–æ¯ä¸ªå¯¹è±¡åˆ° ret ä¸­
        for (int i = 0; i < ret.length; i++) {
            ret[i] = in.readObject();
        }
    }

    @Override
    protected void writeObject(Object[] obj, GenericObjectOutput out) throws IOException {
        // å†™å…¥ Length( æ•°ç»„å¤§å° ) åˆ° mBuffer
        out.writeUInt(obj.length);
        // å¾ªç¯å†™å…¥æ¯ä¸ªå¯¹è±¡åˆ° mBuffer ä¸­
        for (Object item : obj) {
            out.writeObject(item);
        }
    }

};
```

- å› ä¸º `GenericArrayBuilder` å®ç° AbstractObjectBuilder æŠ½è±¡ç±»ï¼Œæ‰€ä»¥ï¼Œè‹¥æ•°ç»„ä¸­æœ‰**ç›¸ç­‰**çš„å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨**å¾ªç¯å¼•ç”¨**çš„åŠŸèƒ½ï¼Œä»è€Œæå‡è§£æé€Ÿåº¦ï¼Œé™ä½ä½“ç§¯ã€‚

###### 6.6.2 å…¶ä»–å­ç±»

åœ¨ `#newObjectBuilder(Class<?> c)` ä¸­ï¼ŒåŸºäº Javassist **è‡ªåŠ¨å®ç°**æ¯ä¸ªç±»çš„ Builder ç±»ï¼Œå®ç°çš„å°±æ˜¯ AbstractObjectBuilder æŠ½è±¡ç±»ã€‚

#### 6.5 newBuilder

```
private static <T> Builder<T> newBuilder(Class<T> c) {
    // åŸºç¡€ç±»å‹ï¼Œå·²ç»å†…ç½®ç›¸åº”çš„ Builder å®ç°ç±»ï¼ŒæŠ›å‡º RuntimeException å¼‚å¸¸ã€‚å› ä¸ºï¼Œå·²ç»åœ¨ GenericDataInput å’Œ GenericDataOutput å®ç°ã€‚
    if (c.isPrimitive()) {
        throw new RuntimeException("Can not create builder for primitive type: " + c);
    }

    if (logger.isInfoEnabled())
        logger.info("create Builder for class: " + c);

    Builder<?> builder;
    // åˆ›å»º Array Builder å¯¹è±¡
    if (c.isArray()) {
        builder = newArrayBuilder(c);
    // åˆ›å»º Object Builder å¯¹è±¡
    } else {
        builder = newObjectBuilder(c);
    }
    return (Builder<T>) builder;
}
```

###### 6.5.1 newObjectBuilder

`#newObjectBuilder(Class<?> c)` ï¼ŒåŸºäº Javassist **è‡ªåŠ¨å®ç°**æ¯ä¸ªç±»çš„ Builder ç±»( ç»§æ‰¿ **AbstractObjectBuilder** æŠ½è±¡ç±» )ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ Builder å¯¹è±¡ã€‚ä»£ç è¶…çº§å†—é•¿ï¼Œè€è‰¿è‰¿å·²ç»æ·»åŠ å¥½äº†è¯¦ç»†çš„ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/dubbo/blob/834ff308bda98adc1832e41e2544c88389eb1f1f/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/Builder.java#L1010-L1422) è‡ªå·±æŸ¥çœ‹ã€‚

å®ç°åŸç†ï¼Œç®€å•çš„è¯´ï¼Œå…¶å®å°±æ˜¯ï¼Œå¾ªç¯ç±»çš„**æ¯ä¸ª**å±æ€§ï¼Œ**æ‹¼æ¥**å¯¹åº”çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„**è¿‡ç¨‹**çš„ä»£ç å­—ç¬¦ä¸²ï¼Œæœ€ç»ˆæäº¤ç»™ Javassist ç”Ÿæˆç±»ã€‚

è‰¯å¿ƒå¦‚æˆ‘ï¼Œå¦‚ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

- Student å’Œ Info ç±» ï¼š

```
package com.alibaba.dubbo.common.serialize.dubbo;
// ... çœç•¥ import

public class YunaiBuilderTest {

    public static class Student implements Serializable {

        public String username;
        public String password;

        public Info info1;
        public Info info2;

        public Student student;

        public final int a = 3;
    }

    public static class Info implements Serializable {

        public String key;

    }
}
```

- Student å¯¹åº”çš„ Builder ç±»ï¼š[![Student å¯¹åº”çš„ Builder ç±»](http://static.iocoder.cn/images/Dubbo/2019_02_18/07.png)](http://static.iocoder.cn/images/Dubbo/2019_02_18/07.png)Student å¯¹åº”çš„ Builder ç±»
- Info å¯¹è±¡çš„ Builder ç±»ï¼š[![Info å¯¹åº”çš„ Builder ç±»](http://static.iocoder.cn/images/Dubbo/2019_02_18/08.png)](http://static.iocoder.cn/images/Dubbo/2019_02_18/08.png)Info å¯¹åº”çš„ Builder ç±»

###### 6.5.2 newEnumBuilder

`#newEnumBuilder(Class<?> c)` ï¼ŒåŸºäº Javassist **è‡ªåŠ¨å®ç°**æ¯ä¸ªç±»çš„ Builder ç±»( ç»§æ‰¿ **Builder** æ¥å£ )ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ Builder å¯¹è±¡ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œè€è‰¿è‰¿å·²ç»æ·»åŠ å¥½äº†è¯¦ç»†çš„ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/dubbo/blob/834ff308bda98adc1832e41e2544c88389eb1f1f/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/Builder.java#L1424-L1461) è‡ªå·±æŸ¥çœ‹ã€‚

å®ç°åŸç†ï¼Œç²—æš´çš„è¯´ï¼Œ**åºåˆ—åŒ–**ä½¿ç”¨ `enum#name()` æ–¹æ³•ï¼Œ**ååºåˆ—åŒ–**ä½¿ç”¨ `Enum#valueOf(Class<T> enumType, String name)` æ–¹æ³•ã€‚

###### 6.5.3 newArrayBuilder

`#newArrayBuilder(Class<?> c)` ï¼ŒåŸºäº Javassist **è‡ªåŠ¨å®ç°**æ¯ä¸ªç±»çš„ Builder ç±»( ç»§æ‰¿ **Builder** æ¥å£ )ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ Builder å¯¹è±¡ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œè€è‰¿è‰¿å·²ç»æ·»åŠ å¥½äº†è¯¦ç»†çš„ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/dubbo/blob/834ff308bda98adc1832e41e2544c88389eb1f1f/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/Builder.java#L899-L1008) è‡ªå·±æŸ¥çœ‹ã€‚

å®ç°åŸç†ï¼Œç›´æ¥çš„è¯´ï¼Œå¾ªç¯æ•°ç»„çš„**æ¯ä¸ª**å…ƒç´ ï¼Œ**æ‹¼æ¥**å¯¹åº”çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„**è¿‡ç¨‹**çš„ä»£ç å­—ç¬¦ä¸²ï¼Œæœ€ç»ˆæäº¤ç»™ Javassist ç”Ÿæˆç±»ã€‚

ğŸ™‚ æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œå¤šç»´æ•°ç»„çš„å¤„ç†ï¼Œä¾‹å¦‚ `int[][][]` ã€‚èƒ–å‹å¯ä»¥æƒ³æƒ³ã€‚å®é™…ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ã€‚

# 3ã€Kryo å®ç°

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«åŸºäº **Kryo** çš„åºåˆ—åŒ–æ‹“å±•å®ç°ã€‚

> **Javaå¯¹è±¡åºåˆ—åŒ–æ¡†æ¶ Kryo**
>
> Kryo æ˜¯ä¸€ä¸ªå¿«é€Ÿé«˜æ•ˆçš„Javaå¯¹è±¡å›¾å½¢åºåˆ—åŒ–æ¡†æ¶ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯æ€§èƒ½ã€é«˜æ•ˆå’Œæ˜“ç”¨ã€‚è¯¥é¡¹ç›®ç”¨æ¥åºåˆ—åŒ–å¯¹è±¡åˆ°æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…ç½‘ç»œã€‚
>
> ç¤ºä¾‹ä»£ç ï¼š

```
Kryo kryo = new Kryo();
// ...
Output output = new Output(new FileOutputStream("file.bin"));
SomeClass someObject = ...
kryo.writeObject(output, someObject);
output.close();
// ...
Input input = new Input(new FileInputStream("file.bin"));
SomeClass someObject = kryo.readObject(input, SomeClass.class);
input.close();
```

æœ¬æ–‡æ¶‰åŠï¼Œç±»å›¾å¦‚ä¸‹ï¼š

[![ç±»å›¾](http://static.iocoder.cn/images/Dubbo/2019_02_21/01.png)](http://static.iocoder.cn/images/Dubbo/2019_02_21/01.png)ç±»å›¾

## 2. KryoSerialization

`com.alibaba.dubbo.common.serialize.support.kryo.KryoSerialization` ï¼Œå®ç° Serialization æ¥å£ï¼ŒKryo **åºåˆ—åŒ–**å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class KryoSerialization implements Serialization {

    @Override
    public byte getContentTypeId() {
        return 8;
    }

    @Override
    public String getContentType() {
        return "x-application/kryo";
    }

    @Override
    public ObjectOutput serialize(URL url, OutputStream out) throws IOException {
        return new KryoObjectOutput(out);
    }

    @Override
    public ObjectInput deserialize(URL url, InputStream is) throws IOException {
        return new KryoObjectInput(is);
    }

}
```

## 3. KryoObjectInput

[`com.alibaba.dubbo.common.serialize.support.kryo.KryoObjectInput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/KryoObjectInput.java) ï¼Œå®ç° ObjectInput, Cleanable æ¥å£ï¼ŒKryo å¯¹è±¡**è¾“å…¥**å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
/**
 * Kryo å¯¹è±¡
 */
private Kryo kryo;
/**
 * Kryo è¾“å…¥
 */
private Input input;

public KryoObjectInput(InputStream inputStream) {
    input = new Input(inputStream);
    this.kryo = KryoUtils.get();
}
```

- `kryo` å±æ€§ï¼Œé€šè¿‡ `KryoUtils#get()` æ–¹æ³•ï¼Œè·å–ã€‚

**ObjectInput å®ç°æ–¹æ³•**

â‘  æ¥è‡ª DataInput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨ `input` å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

```
@Override
public boolean readBool() throws IOException {
    try {
        return input.readBoolean();
    } catch (KryoException e) {
        throw new IOException(e);
    }
}
```

â‘¡ æ¥è‡ª ObjectInput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨ `kryo` å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

```
@Override
public Object readObject() throws IOException, ClassNotFoundException {
    // TODO optimization
    try {
        return kryo.readClassAndObject(input);
    } catch (KryoException e) {
        throw new IOException(e);
    }
}
```

- é€šè¿‡è¯»å–**ç±»**ï¼Œåœ¨æ ¹æ®ç±»è§£æå…·ä½“å¯¹è±¡ï¼Œå­—èŠ‚å†…å®¹â€œ**å¤§ä½“**â€æ˜¯ [ Class, å¯¹è±¡äºŒè¿›åˆ¶æ•°æ® ] ã€‚åœ¨ [ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡ â€“ Kryoã€‹](https://www.cnkirito.moe/2017/11/28/rpc-serialize-1/) çš„ [ã€Œä¸‰ç§è¯»å†™æ–¹å¼ã€](http://svip.iocoder.cn/Dubbo/serialize-3-kryo/#) ï¼Œå¯¹è¿™å—è§£æçš„ç›¸å½“ä¸é”™ã€‚

**Cleanable å®ç°æ–¹æ³•**

```
@Override
public void cleanup() {
    // é‡Šæ”¾ Kryo å¯¹è±¡
    KryoUtils.release(kryo);
    // æ¸…ç©º
    kryo = null;
}
```

## 4. KryoObjectOutput

[`com.alibaba.dubbo.common.serialize.support.kryo.KryoObjectOutput`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/KryoObjectOutput.java) ï¼Œå®ç° ObjectOutput, Cleanable æ¥å£ï¼ŒKryo å¯¹è±¡**è¾“å‡º**å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
/**
 * Kryo å¯¹è±¡
 */
private Kryo kryo;
/**
 * Kryo è¾“å‡º
 */
private Output output;

public KryoObjectOutput(OutputStream outputStream) {
    output = new Output(outputStream);
    this.kryo = KryoUtils.get();
}
```

- `kryo` å±æ€§ï¼Œé€šè¿‡ `KryoUtils#get()` æ–¹æ³•ï¼Œè·å–ã€‚

**ObjectOutput å®ç°æ–¹æ³•**

â‘  æ¥è‡ª DataOutput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨ `input` å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

```
@Override
public void writeBool(boolean v) throws IOException {
    output.writeBoolean(v);
}
```

â‘¡ æ¥è‡ª ObjectOutput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨ `kryo` å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

```
@Override
@Override
public void writeObject(Object v) throws IOException {
    // TODO carries class info every time.
    kryo.writeClassAndObject(output, v);
}
```

- é€šè¿‡å†™å…¥**ç±»** + å…·ä½“å¯¹è±¡ï¼Œå­—èŠ‚å†…å®¹â€œ**å¤§ä½“**â€æ˜¯ [ Class, å¯¹è±¡äºŒè¿›åˆ¶æ•°æ® ] ã€‚åœ¨ [ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡ â€“ Kryoã€‹](https://www.cnkirito.moe/2017/11/28/rpc-serialize-1/) çš„ [ã€Œä¸‰ç§è¯»å†™æ–¹å¼ã€](http://svip.iocoder.cn/Dubbo/serialize-3-kryo/#) ï¼Œå¯¹è¿™å—è§£æçš„ç›¸å½“ä¸é”™ã€‚

**Cleanable å®ç°æ–¹æ³•**

```
@Override
public void cleanup() {
    // é‡Šæ”¾ Kryo å¯¹è±¡
    KryoUtils.release(kryo);
    // æ¸…ç©º
    kryo = null;
}
```

## 5. CompatibleKryo

`com.alibaba.dubbo.common.serialize.support.kryo.CompatibleKryo` ï¼Œå®ç° Kryo ç±»ï¼Œå…¼å®¹**ç©ºæ„é€ **æ–¹æ³•çš„ Kryo å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: @Override
 2: public Serializer getDefaultSerializer(Class type) {
 3:     if (type == null) {
 4:         throw new IllegalArgumentException("type cannot be null.");
 5:     }
 6:     // ç©ºæ„é€ æ–¹æ³•æ—¶ï¼Œä½¿ç”¨ JavaSerializer ï¼ŒJava åŸç”Ÿåºåˆ—åŒ–å®ç°
 7:     if (!type.isArray() && !type.isEnum() && !ReflectionUtils.checkZeroArgConstructor(type)) {
 8:         if (logger.isWarnEnabled()) {
 9:             logger.warn(type + " has no zero-arg constructor and this will affect the serialization performance");
10:         }
11:         return new JavaSerializer();
12:     }
13:     // ä½¿ç”¨ Kryo é»˜è®¤åºåˆ—åŒ–å®ç°
14:     return super.getDefaultSerializer(type);
15: }
```

- ç¬¬ 6 è‡³ 12 è¡Œï¼šKryo ä¸æ”¯æŒä¸åŒ…å«**ç©ºæ„é€ æ–¹æ³•**çš„ç±»çš„åºåˆ—åŒ–ï¼Œå› æ­¤ï¼Œæ­¤æ—¶ä½¿ç”¨ Kryo å°è£… **Java åŸç”Ÿåºåˆ—åŒ–**å®ç°ç±» `com.esotericsoftware.kryo.serializers.JavaSerializer` ã€‚

  - `ReflectionUtils#checkZeroArgConstructor(type)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

    ```
    /**
     * åˆ¤æ–­ç±»æ˜¯å¦æœ‰ç©ºæ„é€ æ–¹æ³•
     *
     * @param clazz ç±»
     * @return æ˜¯å¦
     */
    public static boolean checkZeroArgConstructor(Class clazz) {
        try {
            clazz.getDeclaredConstructor();
            return true;
        } catch (NoSuchMethodException e) {
            return false;
        }
    }
    ```

  - x

- ç¬¬ 14 è¡Œï¼šä½¿ç”¨ Kryo **é»˜è®¤**åºåˆ—åŒ–å®ç°ã€‚

## 6. KryoFactory

#### 6.1 AbstractKryoFactory

[`com.alibaba.dubbo.common.serialize.support.kryo.utils.AbstractKryoFactory`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/utils/AbstractKryoFactory.java) ï¼Œå®ç° `com.esotericsoftware.kryo.pool.KryoFactory` æ¥å£ï¼ŒKryo **å·¥å‚**æŠ½è±¡ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
/**
 * éœ€è¦æ³¨å†Œçš„ç±»çš„é›†åˆ
 */
private final Set<Class> registrations = new LinkedHashSet<Class>();

/**
 * æ˜¯å¦å¼€å¯æ³¨å†Œè¡Œä¸º
 */
private boolean registrationRequired;
/**
 * Kryo æ˜¯å¦å·²ç»åˆ›å»º
 */
private volatile boolean kryoCreated;
```

- `registrations` **é™æ€**å±æ€§ï¼Œéœ€è¦**æ³¨å†Œ**çš„ç±»çš„é›†åˆã€‚é€šè¿‡ `#registerClass(Class)` æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  /**
   * only supposed to be called at startup time
   *
   * later may consider adding support for custom serializer, custom id, etc
   */
  public void registerClass(Class clazz) {
      if (kryoCreated) {
          throw new IllegalStateException("Can't register class after creating kryo instance");
      }
      registrations.add(clazz);
  }
  ```

- `registrationRequired` å±æ€§ï¼Œæ˜¯å¦å¼€å¯**æ³¨å†Œ**è¡Œä¸ºï¼Œé»˜è®¤**å…³é—­**ã€‚

  > Kryo æ”¯æŒå¯¹æ³¨å†Œè¡Œä¸ºï¼Œå¦‚ `kryo.register(SomeClazz.class);` ï¼Œè¿™ä¼šèµ‹äºˆè¯¥ Class ä¸€ä¸ªä» 0 å¼€å§‹çš„ç¼–å·ï¼Œä½† Kryo ä½¿ç”¨æ³¨å†Œè¡Œä¸ºæœ€å¤§çš„é—®é¢˜åœ¨äºï¼Œå…¶ä¸ä¿è¯åŒä¸€ä¸ª Class æ¯ä¸€æ¬¡æ³¨å†Œçš„å·ç ç›¸åŒï¼Œè¿™ä¸æ³¨å†Œçš„é¡ºåºæœ‰å…³ï¼Œä¹Ÿå°±æ„å‘³ç€åœ¨ä¸åŒçš„æœºå™¨ã€åŒä¸€ä¸ªæœºå™¨é‡å¯å‰åéƒ½æœ‰å¯èƒ½æ‹¥æœ‰ä¸åŒçš„ç¼–å·ï¼Œè¿™ä¼šå¯¼è‡´åºåˆ—åŒ–äº§ç”Ÿé—®é¢˜ï¼Œæ‰€ä»¥åœ¨åˆ†å¸ƒå¼é¡¹ç›®ä¸­ï¼Œ**ä¸€èˆ¬å…³é—­æ³¨å†Œè¡Œä¸º**ã€‚

- `kryoCreated` å±æ€§ï¼ŒKryo æ˜¯å¦å·²ç»åˆ›å»ºã€‚

**æŠ½è±¡æ–¹æ³•**

```
/**
 * è¿”è¿˜ Kryo å¯¹è±¡
 *
 * @param kryo Kyro
 */
public abstract void returnKryo(Kryo kryo);

/**
 * è·å¾— Kryo å¯¹è±¡
 *
 * @return Kryo å¯¹è±¡
 */
public abstract Kryo getKryo();
```

**create**

```
 1: @Override
 2: public Kryo create() {
 3:     // æ ‡è®°å·²åˆ›å»º
 4:     if (!kryoCreated) {
 5:         kryoCreated = true;
 6:     }
 7: 
 8:     // åˆ›å»º CompatibleKryo å¯¹è±¡
 9:     Kryo kryo = new CompatibleKryo();
10: 
11:     // TODO
12: //    kryo.setReferences(false);
13:     kryo.setRegistrationRequired(registrationRequired);
14: 
15:     // æ³¨å†Œå¸¸ç”¨ç±»
16:     kryo.register(Collections.singletonList("").getClass(), new ArraysAsListSerializer());
17:     kryo.register(GregorianCalendar.class, new GregorianCalendarSerializer());
18:     kryo.register(InvocationHandler.class, new JdkProxySerializer());
19:     kryo.register(BigDecimal.class, new DefaultSerializers.BigDecimalSerializer());
20:     kryo.register(BigInteger.class, new DefaultSerializers.BigIntegerSerializer());
21:     kryo.register(Pattern.class, new RegexSerializer());
22:     kryo.register(BitSet.class, new BitSetSerializer());
23:     kryo.register(URI.class, new URISerializer());
24:     kryo.register(UUID.class, new UUIDSerializer());
25:     UnmodifiableCollectionsSerializer.registerSerializers(kryo);
26:     SynchronizedCollectionsSerializer.registerSerializers(kryo);
27: 
28:     // æ³¨å†Œå¸¸ç”¨æ•°æ®ç»“æ„
29:     // now just added some very common classes
30:     // TODO optimization
31:     kryo.register(HashMap.class);
32:     kryo.register(ArrayList.class);
33:     kryo.register(LinkedList.class);
34:     kryo.register(HashSet.class);
35:     kryo.register(TreeSet.class);
36:     kryo.register(Hashtable.class);
37:     kryo.register(Date.class);
38:     kryo.register(Calendar.class);
39:     kryo.register(ConcurrentHashMap.class);
40:     kryo.register(SimpleDateFormat.class);
41:     kryo.register(GregorianCalendar.class);
42:     kryo.register(Vector.class);
43:     kryo.register(BitSet.class);
44:     kryo.register(StringBuffer.class);
45:     kryo.register(StringBuilder.class);
46:     kryo.register(Object.class);
47:     kryo.register(Object[].class);
48:     kryo.register(String[].class);
49:     kryo.register(byte[].class);
50:     kryo.register(char[].class);
51:     kryo.register(int[].class);
52:     kryo.register(float[].class);
53:     kryo.register(double[].class);
54: 
55:     // `registrations` çš„æ³¨å†Œ
56:     for (Class clazz : registrations) {
57:         kryo.register(clazz);
58:     }
59: 
60:     // SerializableClassRegistry çš„æ³¨å†Œ
61:     for (Class clazz : SerializableClassRegistry.getRegisteredClasses()) {
62:         kryo.register(clazz);
63:     }
64: 
65:     return kryo;
66: }
```

- ç¬¬ 3 è‡³ 6 è¡Œï¼šæ ‡è®°å·²åˆ›å»º `kryoCreated = true`ã€‚
- ç¬¬ 9 è¡Œï¼šåˆ›å»º CompatibleKryo å¯¹è±¡ã€‚
- ç¬¬ 13 è¡Œï¼šè°ƒç”¨ `Kryo#setRegistrationRequired(registrationRequired)` æ–¹æ³•ï¼Œè®¾ç½®æ˜¯å¦è¦**å¼€å¯**æ³¨å†Œçš„åŠŸèƒ½ã€‚
- ğŸ™‚ å¼€å§‹ä¸€é¡¿æ³¨å†Œã€‚
  - ç¬¬ 15 è‡³ 26 è¡Œï¼šæ³¨å†Œ**å¸¸ç”¨ç±»**åˆ° Kryo å¯¹è±¡ã€‚
  - ç¬¬ 28 è‡³ 53 è¡Œï¼šæ³¨å†Œ**å¸¸ç”¨æ•°æ®ç»“æ„**åˆ° Kryo å¯¹è±¡ã€‚
  - ç¬¬ 55 è‡³ 58 è¡Œï¼šæ³¨å†Œ `registrations` åˆ° Kryo å¯¹è±¡ã€‚
  - ç¬¬ 60 è‡³ 63 è¡Œï¼šæ³¨å†Œ SerializableClassRegistry åˆ° Kryo å¯¹è±¡ã€‚

#### 6.2 ThreadLocalKryoFactory

[`com.alibaba.dubbo.common.serialize.support.kryo.utils.ThreadLocalKryoFactory`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/utils/ThreadLocalKryoFactory.java) ï¼Œå®ç° AbstractKryoFactory æŠ½è±¡ç±»ï¼ŒåŸºäº **ThreadLocal** çš„ Kryo å·¥å‚å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class ThreadLocalKryoFactory extends AbstractKryoFactory {

    private final ThreadLocal<Kryo> holder = new ThreadLocal<Kryo>() {

        @Override
        protected Kryo initialValue() {
            return create(); // åˆ›å»º Kryo
        }

    };

    @Override
    public void returnKryo(Kryo kryo) {
        // do nothing
    }

    @Override
    public Kryo getKryo() {
        return holder.get();
    }

}
```

- Kryo çš„åºåˆ—åŒ–å’Œååºåˆ—çš„è¿‡ç¨‹ï¼Œæ˜¯**éçº¿ç¨‹å®‰å…¨**çš„ã€‚æ‰€ä»¥é€šè¿‡ ThreadLocal æ¥ä¿è¯ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä¸ª Kryo å¯¹è±¡ã€‚

#### 6.3 KryoUtils

[`com.alibaba.dubbo.common.serialize.support.kryo.utils.KryoUtils`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/utils/KryoUtils.java) ï¼ŒKryo å·¥å…·ç±»ï¼Œç›®å‰ä»…ä»…å¯¹ KryoFactory è¿›è¡Œæ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class KryoUtils {

    private static AbstractKryoFactory kryoFactory = new ThreadLocalKryoFactory();

    public static Kryo get() {
        return kryoFactory.getKryo();
    }

    public static void release(Kryo kryo) {
        kryoFactory.returnKryo(kryo);
    }

    public static void register(Class<?> clazz) {
        kryoFactory.registerClass(clazz);
    }

    public static void setRegistrationRequired(boolean registrationRequired) {
        kryoFactory.setRegistrationRequired(registrationRequired);
    }

}
```



æ¨èé˜…è¯»ï¼š

- [ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡ â€“ Kryoã€‹](https://www.cnkirito.moe/2017/11/28/rpc-serialize-1/)
- [ã€ŠKryoå®˜æ–¹æ–‡æ¡£-ä¸­æ–‡ç¿»è¯‘ã€‹](https://blog.csdn.net/fanjunjaden/article/details/72823866)