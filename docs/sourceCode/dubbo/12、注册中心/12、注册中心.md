# æŠ½è±¡ API

## 1. æ¦‚è¿°

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” é¡¹ç›®ç»“æ„ä¸€è§ˆã€‹ã€Œ3.5 dubbo-registryã€](http://svip.iocoder.cn/Dubbo/registry-api/#) ä¸­ï¼Œå¯¹ `dubbo-registry` **æ³¨å†Œä¸­å¿ƒ**è¿™ä¸ªå¤§æ¨¡å—åšäº†å¤§ä½“çš„ä»‹ç»ã€‚é‚£ä¹ˆä»æœ¬æ–‡å¼€å§‹ï¼Œåˆ†äº«æ³¨å†Œä¸­å¿ƒçš„ä»£ç å®ç°ã€‚

æœ¬æ–‡åˆ†äº« `dubbo-registry-api` æ¨¡å—ï¼Œæ³¨å†Œä¸­å¿ƒçš„æŠ½è±¡ API ï¼Œç±»ç»“æ„å¦‚ä¸‹å›¾ï¼š

[![ç±»å›¾](http://static.iocoder.cn/images/Dubbo/2018_08_01/01.png)](http://static.iocoder.cn/images/Dubbo/2018_08_01/01.png)ç±»å›¾

ğŸ˜ˆ æ•´ä½“æ¯”è¾ƒæ˜“æ‡‚ï¼Œç¬”è€…åœ¨è¿™é‡Œå…ˆä¸ä»‹ç»ï¼Œèƒ–å‹å¯ä»¥çœ‹å®Œæœ¬æ–‡ï¼Œå›è¿‡å¤´çœ‹çœ‹ï¼Œè‡ªå·±æ˜¯ä¸æ˜¯ç†è§£äº†ï¼Ÿï¼

ä¸‹é¢ï¼Œæˆ‘ä»¬æŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºï¼Œé€ä¸ªåˆ†äº«ã€‚

## 2. RegistryFactory

[`com.alibaba.dubbo.registry.RegistryFactory`](https://github.com/YunaiV/dubbo/blob/7ece72959dd8c96e17fc240a2b22b40391265bcc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/RegistryFactory.java) ï¼Œæ³¨å†Œä¸­å¿ƒå·¥å‚**æ¥å£**ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@SPI("dubbo")
public interface RegistryFactory {

    /**
     * è¿æ¥æ³¨å†Œä¸­å¿ƒ.
     * <p>
     * è¿æ¥æ³¨å†Œä¸­å¿ƒéœ€å¤„ç†å¥‘çº¦ï¼š<br>
     * 1. å½“è®¾ç½®check=falseæ—¶è¡¨ç¤ºä¸æ£€æŸ¥è¿æ¥ï¼Œå¦åˆ™åœ¨è¿æ¥ä¸ä¸Šæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚<br>
     * 2. æ”¯æŒURLä¸Šçš„username:passwordæƒé™è®¤è¯ã€‚<br>
     * 3. æ”¯æŒbackup=10.20.153.10å¤‡é€‰æ³¨å†Œä¸­å¿ƒé›†ç¾¤åœ°å€ã€‚<br>
     * 4. æ”¯æŒfile=registry.cacheæœ¬åœ°ç£ç›˜æ–‡ä»¶ç¼“å­˜ã€‚<br>
     * 5. æ”¯æŒtimeout=1000è¯·æ±‚è¶…æ—¶è®¾ç½®ã€‚<br>
     * 6. æ”¯æŒsession=60000ä¼šè¯è¶…æ—¶æˆ–è¿‡æœŸè®¾ç½®ã€‚<br>
     *
     * @param url æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä¸å…è®¸ä¸ºç©º
     * @return æ³¨å†Œä¸­å¿ƒå¼•ç”¨ï¼Œæ€»ä¸è¿”å›ç©º
     */
    @Adaptive({"protocol"})
    Registry getRegistry(URL url);

}
```

- RegistryFactory æ˜¯ä¸€ä¸ª Dubbo SPI æ‹“å±•æ¥å£ã€‚

- ```
  #getRegistry(url)
  ```

   

  æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚

  - æ³¨æ„æ–¹æ³•ä¸Šæ³¨é‡Šçš„**å¤„ç†å¥‘çº¦**ã€‚
  - `@Adaptive({"protocol"})` æ³¨è§£ï¼ŒDubbo SPI ä¼šè‡ªåŠ¨å®ç° RegistryFactory$Adaptive ç±»ï¼Œæ ¹æ® `url.protocol` è·å¾—å¯¹åº”çš„ RegistryFactory å®ç°ç±»ã€‚ä¾‹å¦‚ï¼Œ`url.protocol = zookeeper` æ—¶ï¼Œè·å¾— ZookeeperRegistryFactory å®ç°ç±»ã€‚

#### 2.1 AbstractRegistryFactory

[`com.alibaba.dubbo.registry.support.AbstractRegistryFactory`](https://github.com/YunaiV/dubbo/blob/7ece72959dd8c96e17fc240a2b22b40391265bcc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java) ï¼Œå®ç° RegistryFactory æ¥å£ï¼ŒRegistryFactory æŠ½è±¡ç±»ï¼Œå®ç°äº† Registry çš„**å®¹å™¨ç®¡ç†**ã€‚

###### 2.1.1 å±æ€§

```
// The lock for the acquisition process of the registry
private static final ReentrantLock LOCK = new ReentrantLock();

/**
 * Registry é›†åˆ
 *
 * keyï¼š{@link URL#toServiceString()}
 */
// Registry Collection Map<RegistryAddress, Registry>
private static final Map<String, Registry> REGISTRIES = new ConcurrentHashMap<String, Registry>();
```

- `REGISTRIES` é™æ€å±æ€§ï¼ŒRegistry é›†åˆã€‚
- `LOCK` é™æ€å±æ€§ï¼Œé”ï¼Œç”¨äº `#destroyAll()` å’Œ `#getRegistry(url)` æ–¹æ³•ï¼Œå¯¹ `REGISTRIES` è®¿é—®çš„ç«äº‰ã€‚

###### 2.1.2 createRegistry

`#createRegistry(url)` **æŠ½è±¡**æ–¹æ³•ï¼Œåˆ›å»º Registry å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
/**
 * åˆ›å»º Registry å¯¹è±¡
 *
 * @param url æ³¨å†Œä¸­å¿ƒåœ°å€
 * @return Registry å¯¹è±¡
 */
protected abstract Registry createRegistry(URL url);
```

å­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œåˆ›å»ºå…¶å¯¹åº”çš„ Registry å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒZookeeperRegistryFactory çš„è¯¥æ–¹æ³•ï¼Œåˆ›å»º ZookeeperRegistry å¯¹è±¡ã€‚

###### 2.1.3 getRegistry

[`#getRegistry(url)`](https://github.com/YunaiV/dubbo/blob/d7c9cec324901c8285e602fdd3256cc9f5586357/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java#L96-L132) **å®ç°**æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚ä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œå¦åˆ™è¿›è¡Œåˆ›å»ºã€‚

- ğŸ™‚ å®ç°æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ï¼Œæœ‰ä»£ç æ³¨é‡Šã€‚

###### 2.1.4 destroyAll

[`#destroyAll()`](https://github.com/YunaiV/dubbo/blob/d7c9cec324901c8285e602fdd3256cc9f5586357/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java#L65-L94) æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰ Registry å¯¹è±¡ã€‚

- ğŸ™‚ å®ç°æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ï¼Œæœ‰ä»£ç æ³¨é‡Šã€‚

## 3. RegistryService

[`com.alibaba.dubbo.registry.RegistryService`](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/RegistryService.java) ï¼Œæ³¨å†Œä¸­å¿ƒæœåŠ¡**æ¥å£**ï¼Œå®šä¹‰äº†æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢**ä¸‰ç§**æ“ä½œæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

- ```
  #register(url)
  ```

   

  æ–¹æ³•ï¼Œ

  æ³¨å†Œ

  æ•°æ®ï¼Œæ¯”å¦‚ï¼šæä¾›è€…åœ°å€ï¼Œæ¶ˆè´¹è€…åœ°å€ï¼Œè·¯ç”±è§„åˆ™ï¼Œè¦†ç›–è§„åˆ™ï¼Œç­‰æ•°æ®ã€‚

  - `#unregister(url)` æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œã€‚

- `#subscribe(url, NotifyListener)` æ–¹æ³•ï¼Œ**è®¢é˜…**ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œå½“æœ‰æ³¨å†Œæ•°æ®å˜æ›´æ—¶è‡ªåŠ¨æ¨é€ã€‚

  - `#unsubscribe(url, NotifyListener)` æ–¹æ³•ï¼Œå–æ¶ˆè®¢é˜…ã€‚

  - åœ¨

     

    ```
    URL.parameters.category
    ```

     

    å±æ€§ä¸Šï¼Œè¡¨ç¤ºè®¢é˜…çš„æ•°æ®åˆ†ç±»ã€‚ç›®å‰æœ‰å››ç§ç±»å‹ï¼š

    - `consumers` ï¼ŒæœåŠ¡æ¶ˆè´¹è€…åˆ—è¡¨ã€‚
    - `providers` ï¼ŒæœåŠ¡æä¾›è€…åˆ—è¡¨ã€‚
    - `routers` ï¼Œ[è·¯ç”±è§„åˆ™](http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html)åˆ—è¡¨ã€‚
    - `configurations` ï¼Œ[é…ç½®è§„åˆ™](http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html)åˆ—è¡¨ã€‚

- `#lookup(url)` æ–¹æ³•ï¼Œ**æŸ¥è¯¢**ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œä¸è®¢é˜…çš„æ¨æ¨¡å¼ç›¸å¯¹åº”ï¼Œè¿™é‡Œä¸ºæ‹‰æ¨¡å¼ï¼Œåªè¿”å›ä¸€æ¬¡ç»“æœã€‚

psï¼šæ³¨æ„æ–¹æ³•ä¸Šæ³¨é‡Šçš„å¤„ç†å¥‘çº¦ã€‚

#### 3.1 Registry

[`com.alibaba.dubbo.registry.Registry`](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/Registry.java) ï¼Œæ³¨å†Œä¸­å¿ƒ**æ¥å£**ã€‚Registry ç»§æ‰¿äº†ï¼š

- RegistryService æ¥å£ï¼Œæ‹¥æœ‰æ‹¥æœ‰æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢ä¸‰ç§æ“ä½œæ–¹æ³•ã€‚
- [`com.alibaba.dubbo.common.Node`](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-common/src/main/java/com/alibaba/dubbo/common/Node.java) æ¥å£ï¼Œæ‹¥æœ‰èŠ‚ç‚¹ç›¸å…³çš„æ–¹æ³•ã€‚

#### 3.2 AbstractRegistry

[`com.alibaba.dubbo.registry.support.AbstractRegistry`](http://svip.iocoder.cn/Dubbo/registry-api/) ï¼Œå®ç° Registry æ¥å£ï¼ŒRegistry æŠ½è±¡ç±»ï¼Œå®ç°äº†å¦‚ä¸‹æ–¹æ³•ï¼š

- é€šç”¨çš„æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢ã€é€šçŸ¥ç­‰æ–¹æ³•ã€‚
- æŒä¹…åŒ–æ³¨å†Œæ•°æ®åˆ°æ–‡ä»¶ï¼Œä»¥ properties æ ¼å¼å­˜å‚¨ã€‚åº”ç”¨äºï¼Œé‡å¯æ—¶ï¼Œæ— æ³•ä»æ³¨å†Œä¸­å¿ƒåŠ è½½æœåŠ¡æä¾›è€…åˆ—è¡¨ç­‰ä¿¡æ¯æ—¶ï¼Œä»è¯¥æ–‡ä»¶ä¸­è¯»å–ã€‚

###### 3.2.1 å±æ€§

```
 1: // URLåœ°å€åˆ†éš”ç¬¦ï¼Œç”¨äºæ–‡ä»¶ç¼“å­˜ä¸­ï¼ŒæœåŠ¡æä¾›è€…URLåˆ†éš”
 2: // URL address separator, used in file cache, service provider URL separation
 3: private static final char URL_SEPARATOR = ' ';
 4: // URLåœ°å€åˆ†éš”æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨äºè§£ææ–‡ä»¶ç¼“å­˜ä¸­æœåŠ¡æä¾›è€…URLåˆ—è¡¨
 5: // URL address separated regular expression for parsing the service provider URL list in the file cache
 6: private static final String URL_SPLIT = "\\s+";
 7: 
 8: // Log output
 9: protected final Logger logger = LoggerFactory.getLogger(getClass());
10: /**
11:  *  æœ¬åœ°ç£ç›˜ç¼“å­˜ã€‚
12:  *
13:  *  1. å…¶ä¸­ç‰¹æ®Šçš„ key å€¼ .registies è®°å½•æ³¨å†Œä¸­å¿ƒåˆ—è¡¨
14:  *  2. å…¶å®ƒå‡ä¸º {@link #notified} æœåŠ¡æä¾›è€…åˆ—è¡¨
15:  */
16: // Local disk cache, where the special key value.registies records the list of registry centers, and the others are the list of notified service providers
17: private final Properties properties = new Properties();
18: /**
19:  * æ³¨å†Œä¸­å¿ƒç¼“å­˜å†™å…¥æ‰§è¡Œå™¨ã€‚
20:  *
21:  * çº¿ç¨‹æ•°=1
22:  */
23: // File cache timing writing
24: private final ExecutorService registryCacheExecutor = Executors.newFixedThreadPool(1, new NamedThreadFactory("DubboSaveRegistryCache", true));
25: /**
26:  * æ˜¯å¦åŒæ­¥ä¿å­˜æ–‡ä»¶
27:  */
28: // Is it synchronized to save the file
29: private final boolean syncSaveFile;
30: /**
31:  * æ•°æ®ç‰ˆæœ¬å·
32:  *
33:  * {@link #properties}
34:  */
35: private final AtomicLong lastCacheChanged = new AtomicLong();
36: /**
37:  * å·²æ³¨å†Œ URL é›†åˆã€‚
38:  *
39:  * æ³¨æ„ï¼Œæ³¨å†Œçš„ URL ä¸ä»…ä»…å¯ä»¥æ˜¯æœåŠ¡æä¾›è€…çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æ¶ˆè´¹è€…çš„
40:  */
41: private final Set<URL> registered = new ConcurrentHashSet<URL>();
42: /**
43:  * è®¢é˜… URL çš„ç›‘å¬å™¨é›†åˆ
44:  *
45:  * keyï¼šæ¶ˆè´¹è€…çš„ URL ï¼Œä¾‹å¦‚æ¶ˆè´¹è€…çš„ URL
46:  */
47: private final ConcurrentMap<URL, Set<NotifyListener>> subscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();
48: /**
49:  * è¢«é€šçŸ¥çš„ URL é›†åˆ
50:  *
51:  * key1ï¼šæ¶ˆè´¹è€…çš„ URL ï¼Œä¾‹å¦‚æ¶ˆè´¹è€…çš„ URL ï¼Œå’Œ {@link #subscribed} çš„é”®ä¸€è‡´
52:  * key2ï¼šåˆ†ç±»ï¼Œä¾‹å¦‚ï¼šprovidersã€consumersã€routesã€configuratorsã€‚ã€å®é™…æ—  consumers ï¼Œå› ä¸ºæ¶ˆè´¹è€…ä¸ä¼šå»è®¢é˜…å¦å¤–çš„æ¶ˆè´¹è€…çš„åˆ—è¡¨ã€‘
53:  *            åœ¨ {@link Constants} ä¸­ï¼Œä»¥ "_CATEGORY" ç»“å°¾
54:  */
55: private final ConcurrentMap<URL, Map<String, List<URL>>> notified = new ConcurrentHashMap<URL, Map<String, List<URL>>>();
56: /**
57:  * æ³¨å†Œä¸­å¿ƒ URL
58:  */
59: private URL registryUrl;
60: /**
61:  * æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶ï¼Œç¼“å­˜æ³¨å†Œä¸­å¿ƒçš„æ•°æ®
62:  */
63: // Local disk cache file
64: private File file;
65: /**
66:  * æ˜¯å¦é”€æ¯
67:  */
68: private AtomicBoolean destroyed = new AtomicBoolean(false);
69: 
70: public AbstractRegistry(URL url) {
71:     setUrl(url);
72:     // Start file save timer
73:     syncSaveFile = url.getParameter(Constants.REGISTRY_FILESAVE_SYNC_KEY, false);
74:     // è·å¾— `file`
75:     String filename = url.getParameter(Constants.FILE_KEY, System.getProperty("user.home") + "/.dubbo/dubbo-registry-" + url.getParameter(Constants.APPLICATION_KEY) + "-" + url.getAddress() + ".cache");
76:     File file = null;
77:     if (ConfigUtils.isNotEmpty(filename)) {
78:         file = new File(filename);
79:         if (!file.exists() && file.getParentFile() != null && !file.getParentFile().exists()) {
80:             if (!file.getParentFile().mkdirs()) {
81:                 throw new IllegalArgumentException("Invalid registry store file " + file + ", cause: Failed to create directory " + file.getParentFile() + "!");
82:             }
83:         }
84:     }
85:     this.file = file;
86:     // åŠ è½½æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶åˆ°å†…å­˜ç¼“å­˜
87:     loadProperties();
88:     // é€šçŸ¥ç›‘å¬å™¨ï¼ŒURL å˜åŒ–ç»“æœ
89:     notify(url.getBackupUrls());
90: }
```

- `file` å±æ€§ï¼Œ*è§ä»£ç æ³¨é‡Š*ã€‚

- ```
  properties
  ```

   

  å±æ€§ï¼Œ

  è§ä»£ç æ³¨é‡Š

  ã€‚

  - æ•°æ®æµå‘
    - å¯åŠ¨æ—¶ï¼Œä» `file` è¯»å–æ•°æ®åˆ° `properties` ä¸­ã€‚
    - æ³¨å†Œä¸­å¿ƒæ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œé€šçŸ¥åˆ° Registry åï¼Œä¿®æ”¹ `properties` å¯¹åº”çš„å€¼ï¼Œå¹¶å†™å…¥ `file` ã€‚
  - æ•°æ®é”®å€¼
    - å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”®ä¸ºæœåŠ¡æ¶ˆè´¹è€…çš„ URL çš„æœåŠ¡é”®( `URL#serviceKey()` )ï¼Œå¯¹åº”çš„å€¼ä¸ºæœåŠ¡æä¾›è€…åˆ—è¡¨ã€[è·¯ç”±è§„åˆ™](http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html)åˆ—è¡¨ã€[é…ç½®è§„åˆ™](http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html)åˆ—è¡¨ã€‚
    - ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œã€TODO 8019ã€‘.registies
    - å› ä¸ºå€¼ä¼šå­˜åœ¨ä¸ºåˆ—è¡¨çš„æƒ…å†µï¼Œä½¿ç”¨ç©ºæ ¼( `URL_SEPARATOR` ) åˆ†éš”ã€‚

- `syncSaveFile` å±æ€§ï¼Œ`properties` å‘ç”Ÿå˜æ›´æ—¶å€™ï¼Œæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥å†™å…¥ `file` ã€‚

- `registryCacheExecutor` å±æ€§ï¼Œ*è§ä»£ç æ³¨é‡Š*ã€‚

- ```
  lastCacheChanged
  ```

   

  å±æ€§ï¼Œ

  è§ä»£ç æ³¨é‡Š

  ã€‚

  - å› ä¸ºæ¯æ¬¡å†™å…¥ `file` æ˜¯å…¨é‡ï¼Œè€Œä¸æ˜¯å¢é‡å†™å…¥ï¼Œé€šè¿‡ç‰ˆæœ¬å·ï¼Œé¿å…è€ç‰ˆæœ¬è¦†ç›–æ–°ç‰ˆæœ¬ã€‚

- `registered` å±æ€§ï¼Œ*è§ä»£ç æ³¨é‡Š*ã€‚

- `subscribed` å±æ€§ï¼Œ*è§ä»£ç æ³¨é‡Š*ã€‚

- ```
  notified
  ```

   

  å±æ€§ï¼Œ

  è§ä»£ç æ³¨é‡Š

  ã€‚

  - ä»æ•°æ®ä¸Šï¼Œå’Œ `properties` æ¯”è¾ƒç›¸ä¼¼ã€‚ç¬”è€…è®¤ä¸ºæœ‰ä¸¤ç‚¹å·®å¼‚ï¼š1ï¼‰æ•°æ®æ ¼å¼ä¸Šï¼Œ`notified` æ ¹æ®**åˆ†ç±»**åšäº†èšåˆï¼›2ï¼‰ä¸ä» `file` ä¸­è¯»å–ï¼Œéƒ½æ˜¯ä»æ³¨å†Œä¸­å¿ƒè¯»å–çš„æ•°æ®ã€‚

- `registryUrl` å±æ€§ï¼Œ*è§ä»£ç æ³¨é‡Š*ã€‚

- `destroyed` å±æ€§ï¼Œ*è§ä»£ç æ³¨é‡Š*ã€‚

- æ„é€ æ–¹æ³•

  ï¼Œ

  è§ä»£ç æ³¨é‡Š

  ã€‚

  - ç¬¬ 87 è¡Œï¼šè°ƒç”¨

     

    `#loadProperties()`

     

    æ–¹æ³•ï¼ŒåŠ è½½æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶åˆ°å†…å­˜ç¼“å­˜ã€‚

    - ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

  - ç¬¬ 89 è¡Œï¼š// ã€TODO 8020ã€‘ä¸ºä»€ä¹ˆæ„é€ æ–¹æ³•ï¼Œè¦é€šçŸ¥ï¼Œè¿ç›‘å¬å™¨éƒ½æ²¡æ³¨å†Œ

###### 3.2.2 register && unregister

- `#register(url)`
  - ä»å®ç°ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¹¶æœªå‘æ³¨å†Œä¸­å¿ƒå‘èµ·æ³¨å†Œï¼Œä»…ä»…æ˜¯æ·»åŠ åˆ° `registered` ä¸­ï¼Œè¿›è¡ŒçŠ¶æ€çš„ç»´æŠ¤ã€‚å®é™…ä¸Šï¼ŒçœŸæ­£çš„å®ç°åœ¨ FailbackRegistry ç±»ä¸­ã€‚
- `#unregister(url)`
  - å’Œ `#register(url)` çš„**å¤„ç†æ–¹å¼**ç›¸åŒã€‚

###### 3.2.3 subscribe && unsubscribe

- `#subscribe(url, listener)`
  - å’Œ `#register(url)` çš„**å¤„ç†æ–¹å¼**ç›¸åŒã€‚
- `#unsubscribe(url, listener)`
  - å’Œ `#register(url)` çš„**å¤„ç†æ–¹å¼**ç›¸åŒã€‚

###### 3.2.4 notify

[`#notify(url, listener, urls)`](https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L477-L535) æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼ŒURL å˜åŒ–ç»“æœã€‚è¿™é‡Œæˆ‘ä»¬æœ‰ä¸¤ç‚¹è¦æ³¨æ„ä¸‹ï¼š

- ç¬¬ä¸€ï¼Œå‘æ³¨å†Œä¸­å¿ƒå‘èµ·è®¢é˜…åï¼Œä¼šè·å–åˆ°**å…¨é‡**æ•°æ®ï¼Œæ­¤æ—¶ä¼šè¢«è°ƒç”¨ `#notify(...)` æ–¹æ³•ï¼Œå³ Registry è·å–åˆ°äº†å…¨é‡æ•°æ®ã€‚
- ç¬¬äºŒï¼Œæ¯æ¬¡æ³¨å†Œä¸­å¿ƒå‘ç”Ÿå˜æ›´æ—¶ï¼Œä¼šè°ƒç”¨ `#notify(...)` æ–¹æ³•ï¼Œè™½ç„¶å˜åŒ–æ˜¯**å¢é‡**ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æ–¹ï¼Œå·²ç»è¿›è¡Œå¤„ç†ï¼Œä¼ å…¥çš„ `urls` ä¾ç„¶æ˜¯**å…¨é‡**çš„ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```
 1: /**
 2:  * é€šçŸ¥ç›‘å¬å™¨ï¼ŒURL å˜åŒ–ç»“æœã€‚
 3:  *
 4:  * æ•°æ®æµå‘ `urls` => {@link #notified} => {@link #properties} => {@link #file}
 5:  *
 6:  * @param url æ¶ˆè´¹è€… URL
 7:  * @param listener ç›‘å¬å™¨
 8:  * @param urls é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰
 9:  */
10: protected void  notify(URL url, NotifyListener listener, List<URL> urls) {
11:     if (url == null) {
12:         throw new IllegalArgumentException("notify url == null");
13:     }
14:     if (listener == null) {
15:         throw new IllegalArgumentException("notify listener == null");
16:     }
17:     if ((urls == null || urls.isEmpty())
18:             && !Constants.ANY_VALUE.equals(url.getServiceInterface())) {
19:         logger.warn("Ignore empty notify urls for subscribe url " + url);
20:         return;
21:     }
22:     if (logger.isInfoEnabled()) {
23:         logger.info("Notify urls for subscribe url " + url + ", urls: " + urls);
24:     }
25:     // å°† `urls` æŒ‰ç…§ `url.parameter.category` åˆ†ç±»ï¼Œæ·»åŠ åˆ°é›†åˆ
26:     Map<String, List<URL>> result = new HashMap<String, List<URL>>();
27:     for (URL u : urls) {
28:         if (UrlUtils.isMatch(url, u)) {
29:             String category = u.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);
30:             List<URL> categoryList = result.get(category);
31:             if (categoryList == null) {
32:                 categoryList = new ArrayList<URL>();
33:                 result.put(category, categoryList);
34:             }
35:             categoryList.add(u);
36:         }
37:     }
38:     if (result.size() == 0) {
39:         return;
40:     }
41:     // è·å¾—æ¶ˆè´¹è€… URL å¯¹åº”çš„åœ¨ `notified` ä¸­ï¼Œé€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰
42:     Map<String, List<URL>> categoryNotified = notified.get(url);
43:     if (categoryNotified == null) {
44:         notified.putIfAbsent(url, new ConcurrentHashMap<String, List<URL>>());
45:         categoryNotified = notified.get(url);
46:     }
47:     // å¤„ç†é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰
48:     for (Map.Entry<String, List<URL>> entry : result.entrySet()) {
49:         String category = entry.getKey();
50:         List<URL> categoryList = entry.getValue();
51:         // è¦†ç›–åˆ° `notified`
52:         // å½“æŸä¸ªåˆ†ç±»çš„æ•°æ®ä¸ºç©ºæ—¶ï¼Œä¼šä¾ç„¶æœ‰ urls ã€‚å…¶ä¸­ `urls[0].protocol = empty` ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¤„ç†æ‰€æœ‰æœåŠ¡æä¾›è€…ä¸ºç©ºçš„æƒ…å†µã€‚
53:         categoryNotified.put(category, categoryList);
54:         // ä¿å­˜åˆ°æ–‡ä»¶
55:         saveProperties(url);
56:         // é€šçŸ¥ç›‘å¬å™¨
57:         listener.notify(categoryList);
58:     }
59: }
```

- ç¬¬ 25 è‡³ 37 è¡Œï¼šå°†

   

  ```
  urls
  ```

   

  æŒ‰ç…§

   

  ```
  url.parameter.category
  ```

   

  åˆ†ç±»ï¼Œæ·»åŠ åˆ°é›†åˆ

   

  ```
  result
  ```

   

  ä¸­ã€‚

  - ç¬¬ 28 è¡Œï¼šTODO èŠ‹è‰¿
  - è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œæ¯æ¬¡ä¼ å…¥çš„ `urls` çš„â€œ**å…¨é‡**â€ï¼ŒæŒ‡çš„æ˜¯è‡³å°‘è¦æ˜¯**ä¸€ä¸ªåˆ†ç±»**çš„å…¨é‡ï¼Œè€Œä¸ä¸€å®šæ˜¯å…¨éƒ¨æ•°æ®ã€‚

- ç¬¬ 41 è‡³ 46 è¡Œï¼šè·å¾—æ¶ˆè´¹è€… URL å¯¹åº”çš„åœ¨ `notified` ä¸­çš„æ•°æ®ã€‚

- ç¬¬ 47 è‡³ 58 è¡Œï¼šæŒ‰ç…§

  åˆ†ç±»

  ï¼Œå¾ªç¯å¤„ç†é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰ã€‚

  - ç¬¬ 51 è‡³ 53 è¡Œï¼šå°† `result` è¦†ç›–åˆ° `notified` ä¸­ã€‚è¿™é‡Œåˆæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå½“æŸä¸ªåˆ†ç±»çš„æ•°æ®ä¸ºç©ºæ—¶ï¼Œä¼šä¾ç„¶æœ‰ `urls` ã€‚å…¶ä¸­ `urls[0].protocol = empty` ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¤„ç†**æ‰€æœ‰æœåŠ¡æä¾›è€…ä¸ºç©º**çš„æƒ…å†µã€‚

  - ç¬¬ 55 è¡Œï¼šè°ƒç”¨

     

    `#saveProperties(url)`

     

    æ–¹æ³•ï¼Œä¿å­˜åˆ°æ–‡ä»¶ã€‚

    - ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

  - ç¬¬ 57 è¡Œï¼šè°ƒç”¨ `NotifyListener#notify(urls)` æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨å¤„ç†ã€‚ä¾‹å¦‚ï¼Œæœ‰æ–°çš„æœåŠ¡æä¾›è€…å¯åŠ¨æ—¶ï¼Œè¢«é€šçŸ¥ï¼Œåˆ›å»ºæ–°çš„ Invoker å¯¹è±¡ã€‚

###### 3.2.5 recover

- `#recover()`
  - å’Œ `#register(url)` çš„**å¤„ç†æ–¹å¼**ç›¸åŒã€‚

åœ¨æ³¨å†Œä¸­å¿ƒæ–­å¼€ï¼Œé‡è¿æˆåŠŸï¼Œè°ƒç”¨ `#recover()` æ–¹æ³•ï¼Œè¿›è¡Œæ¢å¤æ³¨å†Œå’Œè®¢é˜…ã€‚

###### 3.2.6 destroy

- `#destroy()`
  - å’Œ `#register(url)` çš„**å¤„ç†æ–¹å¼**ç›¸åŒã€‚

åœ¨ JVM å…³é—­æ—¶ï¼Œè°ƒç”¨ `#destroy()` æ–¹æ³•ï¼Œè¿›è¡Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…ã€‚

#### 3.3 FailbackRegistry

[`com.alibaba.dubbo.registry.support.FailbackRegistry`](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java) ï¼Œå®ç° AbstractRegistry æŠ½è±¡ç±»ï¼Œæ”¯æŒå¤±è´¥é‡è¯•çš„ Registry æŠ½è±¡ç±»ã€‚

åœ¨ä¸Šæ–‡ä¸­çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒAbstractRegistry è¿›è¡Œçš„æ³¨å†Œã€è®¢é˜…ç­‰æ“ä½œï¼Œæ›´å¤šçš„æ˜¯ä¿®æ”¹çŠ¶æ€ï¼Œè€Œæ— å’Œæ³¨å†Œä¸­å¿ƒå®é™…çš„æ“ä½œã€‚FailbackRegistry åœ¨ AbstractRegistry çš„åŸºç¡€ä¸Šï¼Œå®ç°äº†å’Œæ³¨å†Œä¸­å¿ƒå®é™…çš„æ“ä½œï¼Œå¹¶ä¸”æ”¯æŒå¤±è´¥é‡è¯•çš„ç‰¹æ€§ã€‚

###### 3.3.1 å±æ€§

```
 1: /**
 2:  * å®šæ—¶ä»»åŠ¡æ‰§è¡Œå™¨
 3:  */
 4: // Scheduled executor service
 5: private final ScheduledExecutorService retryExecutor = Executors.newScheduledThreadPool(1, new NamedThreadFactory("DubboRegistryFailedRetryTimer", true));
 6: 
 7: /**
 8:  * å¤±è´¥é‡è¯•å®šæ—¶å™¨ï¼Œå®šæ—¶æ£€æŸ¥æ˜¯å¦æœ‰è¯·æ±‚å¤±è´¥ï¼Œå¦‚æœ‰ï¼Œæ— é™æ¬¡é‡è¯•
 9:  */
10: // Timer for failure retry, regular check if there is a request for failure, and if there is, an unlimited retry
11: private final ScheduledFuture<?> retryFuture;
12: /**
13:  * å¤±è´¥å‘èµ·æ³¨å†Œå¤±è´¥çš„ URL é›†åˆ
14:  */
15: private final Set<URL> failedRegistered = new ConcurrentHashSet<URL>();
16: /**
17:  * å¤±è´¥å–æ¶ˆæ³¨å†Œå¤±è´¥çš„ URL é›†åˆ
18:  */
19: private final Set<URL> failedUnregistered = new ConcurrentHashSet<URL>();
20: /**
21:  * å¤±è´¥å‘èµ·è®¢é˜…å¤±è´¥çš„ç›‘å¬å™¨é›†åˆ
22:  */
23: private final ConcurrentMap<URL, Set<NotifyListener>> failedSubscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();
24: /**
25:  * å¤±è´¥å–æ¶ˆè®¢é˜…å¤±è´¥çš„ç›‘å¬å™¨é›†åˆ
26:  */
27: private final ConcurrentMap<URL, Set<NotifyListener>> failedUnsubscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();
28: /**
29:  * å¤±è´¥é€šçŸ¥é€šçŸ¥çš„ URL é›†åˆ
30:  */
31: private final ConcurrentMap<URL, Map<NotifyListener, List<URL>>> failedNotified = new ConcurrentHashMap<URL, Map<NotifyListener, List<URL>>>();
32: /**
33:  * æ˜¯å¦é”€æ¯
34:  */
35: private AtomicBoolean destroyed = new AtomicBoolean(false);
36: 
37: public FailbackRegistry(URL url) {
38:     super(url);
39:     // é‡è¯•é¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’
40:     int retryPeriod = url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD);
41:     // åˆ›å»ºå¤±è´¥é‡è¯•å®šæ—¶å™¨
42:     this.retryFuture = retryExecutor.scheduleWithFixedDelay(new Runnable() {
43:         public void run() {
44:             // Check and connect to the registry
45:             try {
46:                 retry();
47:             } catch (Throwable t) { // Defensive fault tolerance
48:                 logger.error("Unexpected error occur at failed retry, cause: " + t.getMessage(), t);
49:             }
50:         }
51:     }, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS);
52: }
```

- `retryExecutor` å±æ€§ï¼Œ*è§ä»£ç æ³¨é‡Š*ã€‚

- ```
  retryFuture
  ```

   

  å±æ€§ï¼Œ

  è§ä»£ç æ³¨é‡Š

  ã€‚

  - ç¬¬ 41 è‡³ 51 è¡Œï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­åˆ›å»ºè¯¥å®šæ—¶å™¨ï¼Œåœ¨å…¶ `#run()` æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ `#retry()` æ–¹æ³•ï¼Œè¿›è¡Œé‡è¯•ã€‚

- ```
  failedXXX
  ```

   

  å±æ€§ï¼Œ

  è§ä»£ç æ³¨é‡Š

  ã€‚

  - æ¯ç§æ“ä½œéƒ½æœ‰ä¸€ä¸ªè®°å½•å¤±è´¥çš„é›†åˆã€‚

- `destroyed` å±æ€§ï¼Œ*è§ä»£ç æ³¨é‡Š*ã€‚

###### 3.3.2 register && unregister

- [`#register(url)`](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L162-L199)
- [`#unregister(url)`](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L201-L238)

> ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

###### 3.3.3 subscribe && unsubscribe

- [`#subscribe(url, listener)`](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L240-L282)
- [`#unsubscribe(url, listener)`](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L284-L324)

> ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

###### 3.3.4 notify

- [`#notify(url, listener, url)`](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L326-L352)

> ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

###### 3.3.5 recover

- [`#recover()`](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L354-L379) æ–¹æ³•ï¼Œ**å®Œå…¨è¦†ç›–çˆ¶ç±»æ–¹æ³•**( å³ä¸åƒå‰é¢å‡ ä¸ªæ–¹æ³•ï¼Œä¼šè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³• )ï¼Œå°†éœ€è¦æ³¨å†Œå’Œè®¢é˜…çš„ URL æ·»åŠ åˆ° `failedRegistered` `failedSubscribed` å±æ€§ä¸­ã€‚è¿™æ ·ï¼Œåœ¨ `#retry()` æ–¹æ³•ä¸­ï¼Œä¼šé‡è¯•è¿›è¡Œè¿æ¥ã€‚

> ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

###### 3.3.6 retry

- [`#retry()`](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L381-L528) æ–¹æ³•ï¼Œéå†äº”ä¸ª `failedXXX` å±æ€§ï¼Œé‡è¯•å¯¹åº”çš„æ“ä½œã€‚

> ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

###### 3.3.7 destroy

- [`#destroy()`](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L530-L541) æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…ï¼Œå¹¶å…³é—­å®šæ—¶å™¨ã€‚

> ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

## 4. NotifyListener

[`com.alibaba.dubbo.registry.NotifyListener`](https://github.com/YunaiV/dubbo/blob/da5ebc2737d560dc0fe308793780695c6afc5fda/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/NotifyListener.java) ï¼Œé€šçŸ¥ç›‘å¬å™¨ã€‚å½“æ”¶åˆ°æœåŠ¡å˜æ›´é€šçŸ¥æ—¶è§¦å‘ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public interface NotifyListener {

    /**
     * å½“æ”¶åˆ°æœåŠ¡å˜æ›´é€šçŸ¥æ—¶è§¦å‘ã€‚
     * <p>
     * é€šçŸ¥éœ€å¤„ç†å¥‘çº¦ï¼š<br>
     * 1. æ€»æ˜¯ä»¥æœåŠ¡æ¥å£å’Œæ•°æ®ç±»å‹ä¸ºç»´åº¦å…¨é‡é€šçŸ¥ï¼Œå³ä¸ä¼šé€šçŸ¥ä¸€ä¸ªæœåŠ¡çš„åŒç±»å‹çš„éƒ¨åˆ†æ•°æ®ï¼Œç”¨æˆ·ä¸éœ€è¦å¯¹æ¯”ä¸Šä¸€æ¬¡é€šçŸ¥ç»“æœã€‚<br>
     * 2. è®¢é˜…æ—¶çš„ç¬¬ä¸€æ¬¡é€šçŸ¥ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰ç±»å‹æ•°æ®çš„å…¨é‡é€šçŸ¥ã€‚<br>
     * 3. ä¸­é€”å˜æ›´æ—¶ï¼Œå…è®¸ä¸åŒç±»å‹çš„æ•°æ®åˆ†å¼€é€šçŸ¥ï¼Œæ¯”å¦‚ï¼šproviders, consumers, routers, overridesï¼Œå…è®¸åªé€šçŸ¥å…¶ä¸­ä¸€ç§ç±»å‹ï¼Œä½†è¯¥ç±»å‹çš„æ•°æ®å¿…é¡»æ˜¯å…¨é‡çš„ï¼Œä¸æ˜¯å¢é‡çš„ã€‚<br>
     * 4. å¦‚æœä¸€ç§ç±»å‹çš„æ•°æ®ä¸ºç©ºï¼Œéœ€é€šçŸ¥ä¸€ä¸ªemptyåè®®å¹¶å¸¦categoryå‚æ•°çš„æ ‡è¯†æ€§URLæ•°æ®ã€‚<br>
     * 5. é€šçŸ¥è€…(å³æ³¨å†Œä¸­å¿ƒå®ç°)éœ€ä¿è¯é€šçŸ¥çš„é¡ºåºï¼Œæ¯”å¦‚ï¼šå•çº¿ç¨‹æ¨é€ï¼Œé˜Ÿåˆ—ä¸²è¡ŒåŒ–ï¼Œå¸¦ç‰ˆæœ¬å¯¹æ¯”ã€‚<br>
     *
     * @param urls å·²æ³¨å†Œä¿¡æ¯åˆ—è¡¨ï¼Œæ€»ä¸ä¸ºç©ºï¼Œå«ä¹‰åŒ{@link com.alibaba.dubbo.registry.RegistryService#lookup(URL)}çš„è¿”å›å€¼ã€‚
     */
    void notify(List<URL> urls);

}
```

- æ³¨æ„çœ‹æ–¹æ³•ä¸Šçš„æ³¨é‡Šï¼Œç‰¹åˆ«æ˜¯**å…¨é‡**ã€**åˆ†ç±»**ã€**ä¸ºç©º**ã€**é¡ºåº**ã€‚

NotifyListener çš„å­ç±»å¦‚ä¸‹å›¾ï¼š

[![ç±»å›¾](http://static.iocoder.cn/images/Dubbo/2018_08_01/02.png)](http://static.iocoder.cn/images/Dubbo/2018_08_01/02.png)ç±»å›¾

## 5. ProviderConsumerRegTable

[`com.alibaba.dubbo.registry.support.ProviderConsumerRegTable`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java) ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…æ³¨å†Œè¡¨ï¼Œå­˜å‚¨ JVM è¿›ç¨‹å†…**è‡ªå·±**çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…çš„ Invoker ã€‚

è¯¥ä¿¡æ¯ç”¨äº [Dubbo QOS](http://dubbo.apache.org/zh-cn/docs/user/references/qos.html) ä½¿ç”¨ï¼Œä¾‹å¦‚å°† JVM è¿›ç¨‹ä¸­ï¼Œ**è‡ªå·±**çš„æœåŠ¡æä¾›è€…ä¸‹çº¿ï¼Œåˆæˆ–è€…æŸ¥è¯¢è‡ªå·±çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…åˆ—è¡¨ã€‚

- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” åœ¨çº¿è¿ç»´å‘½ä»¤ - QOSã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/qos.html)
- åç»­ä¼šæœ‰æ–‡ç« åˆ†äº« QOS ï¼Œæœ¬æ–‡ä¸å¤šå•°å—¦ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```
public class ProviderConsumerRegTable {

    /**
     * æœåŠ¡æä¾›è€… Invoker é›†åˆ
     *
     * keyï¼šæœåŠ¡æä¾›è€… URL æœåŠ¡é”®
     */
    public static ConcurrentHashMap<String, Set<ProviderInvokerWrapper>> providerInvokers = new ConcurrentHashMap<String, Set<ProviderInvokerWrapper>>();
    /**
     * æœåŠ¡æ¶ˆè´¹è€… Invoker é›†åˆ
     *
     * keyï¼šæœåŠ¡æ¶ˆè´¹è€… URL æœåŠ¡é”®
     */
    public static ConcurrentHashMap<String, Set<ConsumerInvokerWrapper>> consumerInvokers = new ConcurrentHashMap<String, Set<ConsumerInvokerWrapper>>();
    
    // .... çœç•¥æ–¹æ³•
    
}
```

- å¦‚ä¸‹æ–¹æ³•ï¼Œå·²ç»æ·»åŠ ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡»æŸ¥çœ‹ã€‚
- æœåŠ¡æä¾›è€…
  - [`#registerProvider(invoker, registryUrl, providerUrl)`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L51-L70) é™æ€æ–¹æ³•ï¼Œæ³¨å†Œ Provider Invoker ã€‚
  - [`#getProviderInvoker(serviceUniqueName)`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L72-L84) é™æ€é™æ€ï¼Œè·å¾—æŒ‡å®šæœåŠ¡é”®çš„ Provider Invoker é›†åˆã€‚
  - [`#getProviderWrapper(invoker)`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L86-L112) é™æ€æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…å¯¹åº”çš„ Invoker Wrapper å¯¹è±¡ã€‚
- æœåŠ¡æ¶ˆè´¹è€…
  - [`#registerConsumer(invoker, registryUrl, consumerUrl, registryDirectory)`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L114-L134) é™æ€æ–¹æ³•ï¼Œæ³¨å†Œ Consumer Invoker ã€‚
  - [`#getConsumerInvoker(serviceUniqueName)`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L136-L148) é™æ€æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šæœåŠ¡é”®çš„ Consumer Invoker é›†åˆã€‚

#### 5.1 ProviderInvokerWrapper

[`com.alibaba.dubbo.registry.support.ProviderInvokerWrapper`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderInvokerWrapper.java) ï¼Œå®ç° Invoker æ¥å£ï¼ŒæœåŠ¡æä¾›è€… Invoker Wrapper ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
/**
 * Invoker å¯¹è±¡
 */
private Invoker<T> invoker;
/**
 * åŸå§‹ URL
 */
private URL originUrl;
/**
 * æ³¨å†Œä¸­å¿ƒ URL
 */
private URL registryUrl;
/**
 * æœåŠ¡æä¾›è€… URL
 */
private URL providerUrl;
/**
 * æ˜¯å¦æ³¨å†Œ
 */
private volatile boolean isReg;
    
// ... çœç•¥æ–¹æ³•
```

- ç›¸æ¯”çº¯ç²¹çš„ Invoker å¯¹è±¡ï¼Œåˆå¤šäº†è¿ç»´å‘½ä»¤éœ€è¦çš„å±æ€§ã€‚ä¾‹å¦‚ `isReg` **çŠ¶æ€**å±æ€§ï¼Œå¯ä»¥åœ¨ä½¿ç”¨**ä¸‹çº¿æœåŠ¡å‘½ä»¤**åï¼Œæ ‡è®°ä¸º `false` ã€‚æƒ³æå‰æ·±å…¥äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹ä¸‹ [`com.alibaba.dubbo.qos.command.impl.Offline`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-plugin/dubbo-qos/src/main/java/com/alibaba/dubbo/qos/command/impl/Online.java) å’Œ [`com.alibaba.dubbo.qos.command.impl.Online`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-plugin/dubbo-qos/src/main/java/com/alibaba/dubbo/qos/command/impl/Online.java) ç±»ã€‚

#### 5.2 ConsumerInvokerWrapper

[`com.alibaba.dubbo.registry.support.ConsumerInvokerWrapper`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ConsumerInvokerWrapper.java) ï¼Œå®ç° Invoker æ¥å£ï¼ŒæœåŠ¡æ¶ˆè´¹è€… Invoker Wrapper ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
/**
 * Invoker å¯¹è±¡
 */
private Invoker<T> invoker;
/**
 * åŸå§‹ URL
 */
private URL originUrl;
/**
 * æ³¨å†Œä¸­å¿ƒ URL
 */
private URL registryUrl;
/**
 * æ¶ˆè´¹è€… URL
 */
private URL consumerUrl;
/**
 * æ³¨å†Œä¸­å¿ƒ Directory
 */
private RegistryDirectory registryDirectory;
```

- ç›¸æ¯”çº¯ç²¹çš„ Invoker å¯¹è±¡ï¼Œåˆå¤šäº†è¿ç»´å‘½ä»¤éœ€è¦çš„å±æ€§ã€‚ä¾‹å¦‚ `registryDirectory` å±æ€§ï¼Œå¯ä»¥åœ¨ä½¿ç”¨**åˆ—å‡ºæ¶ˆè´¹è€…å’Œæä¾›è€…å‘½ä»¤**åï¼Œè¾“å‡ºå¯æ¶ˆè´¹è€…**å¯è°ƒç”¨**çš„æœåŠ¡æä¾›è€…æ•°é‡ ã€‚æƒ³æå‰æ·±å…¥äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹ä¸‹ [`com.alibaba.dubbo.qos.command.impl.Ls`](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-plugin/dubbo-qos/src/main/java/com/alibaba/dubbo/qos/command/impl/Ls.java) ç±»ã€‚

## 5. integration

ä¸åŒäºä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„ä»£ç ï¼Œ[`integration`](https://github.com/YunaiV/dubbo/tree/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration) åŒ…ä¸‹æ˜¯å¯¹å…¶ä»– Dubbo æ¨¡å—çš„é›†æˆï¼š

- RegistryProtocol ï¼Œå¯¹ `dubbo-rpc-api` çš„ä¾èµ–é›†æˆã€‚
- RegistryDirectory ï¼Œå¯¹ `dubbo-cluster` çš„ä¾èµ–é›†æˆã€‚

è€ƒè™‘åˆ°è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒç•´ï¼Œåé¢æ¶‰åŠåˆ°æ—¶ï¼Œå•ç‹¬åˆ†äº«ã€‚

# Zookeeper

## 1. æ¦‚è¿°

å‰ç½®é˜…è¯»æ–‡ç« ï¼š

- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” Zookeeper å®¢æˆ·ç«¯ã€‹](http://svip.iocoder.cn/Dubbo/remoting-zookeeper/?self)
- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://svip.iocoder.cn/Dubbo/registry-api/?self)

ğŸ˜ˆ åœ¨ã€Šæ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ ä¸­ï¼Œæˆ‘ä»¬åˆ†äº«çš„é‚£æ˜¯**ç›¸å½“æŠ½è±¡**ã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ†äº« Dubbo ä½¿ç”¨ Zookeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ä»£ç ï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ†äº«æœåŠ¡æš´éœ²å’Œå¼•ç”¨æ—¶ï¼Œå¯¹æ³¨å†Œä¸­å¿ƒçš„ä½¿ç”¨ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” zookeeper æ³¨å†Œä¸­å¿ƒã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/registry/zookeeper.html) æ–‡æ¡£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

> [![æµç¨‹](http://static.iocoder.cn/images/Dubbo/2018_08_04/01.png)](http://static.iocoder.cn/images/Dubbo/2018_08_04/01.png)æµç¨‹
>
> æµç¨‹è¯´æ˜ï¼š
>
> - **æœåŠ¡æä¾›è€…**å¯åŠ¨æ—¶: å‘ `/dubbo/com.foo.BarService/providers` ç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„ URL åœ°å€
> - **æœåŠ¡æ¶ˆè´¹è€…**å¯åŠ¨æ—¶: è®¢é˜… `/dubbo/com.foo.BarService/providers` ç›®å½•ä¸‹çš„æä¾›è€… URL åœ°å€ã€‚å¹¶å‘ `/dubbo/com.foo.BarService/consumers` ç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„ URL åœ°å€
> - **ç›‘æ§ä¸­å¿ƒ**å¯åŠ¨æ—¶: è®¢é˜… `/dubbo/com.foo.BarService` ç›®å½•ä¸‹çš„æ‰€æœ‰æä¾›è€…å’Œæ¶ˆè´¹è€… URL åœ°å€ã€‚

- åœ¨å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Zookeeper çš„èŠ‚ç‚¹å±‚çº§ï¼Œè‡ªä¸Šè€Œä¸‹æ˜¯ï¼š
  - **Root** å±‚ï¼šæ ¹ç›®å½•ï¼Œå¯é€šè¿‡ `<dubbo:registry group="dubbo" />` çš„ `"group"` è®¾ç½® Zookeeper çš„æ ¹èŠ‚ç‚¹ï¼Œç¼ºçœä½¿ç”¨ `"dubbo"` ã€‚
  - **Service** å±‚ï¼šæœåŠ¡æ¥å£å…¨åã€‚
  - **Type** å±‚ï¼šåˆ†ç±»ã€‚ç›®å‰é™¤äº†æˆ‘ä»¬åœ¨å›¾ä¸­çœ‹åˆ°çš„ `"providers"`( æœåŠ¡æä¾›è€…åˆ—è¡¨ ) `"consumers"`( æœåŠ¡æ¶ˆè´¹è€…åˆ—è¡¨ ) å¤–ï¼Œè¿˜æœ‰ [`"routes"`](http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html)( è·¯ç”±è§„åˆ™åˆ—è¡¨ ) å’Œ [`"configurations"`](http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html)( é…ç½®è§„åˆ™åˆ—è¡¨ )ã€‚
  - **URL** å±‚ï¼šURL ï¼Œæ ¹æ®ä¸åŒ Type ç›®å½•ï¼Œä¸‹é¢å¯ä»¥æ˜¯æœåŠ¡æä¾›è€… URL ã€æœåŠ¡æ¶ˆè´¹è€… URL ã€è·¯ç”±è§„åˆ™ URL ã€é…ç½®è§„åˆ™ URL ã€‚
  - å®é™…ä¸Š URL ä¸Šå¸¦æœ‰ `"category"` å‚æ•°ï¼Œå·²ç»èƒ½åˆ¤æ–­æ¯ä¸ª URL çš„åˆ†ç±»ï¼Œä½†æ˜¯ Zookeeper æ˜¯åŸºäºèŠ‚ç‚¹ç›®å½•è®¢é˜…çš„ï¼Œæ‰€ä»¥å¢åŠ äº† **Type** å±‚ã€‚
- å®é™…ä¸Šï¼Œ**æœåŠ¡æ¶ˆè´¹è€…**å¯åŠ¨åï¼Œä¸ä»…ä»…è®¢é˜…äº† `"providers"` åˆ†ç±»ï¼Œä¹Ÿè®¢é˜…äº† `"routes"` `"configurations"` åˆ†ç±»ã€‚

## 2. ZookeeperRegistryFactory

[`com.alibaba.dubbo.registry.zookeeper.ZookeeperRegistryFactory`](https://github.com/YunaiV/dubbo/blob/66a1e1b0ef4b01175be148d27fdcf519f4f01b15/dubbo-registry/dubbo-registry-zookeeper/src/main/java/com/alibaba/dubbo/registry/zookeeper/ZookeeperRegistryFactory.java) ï¼Œå®ç° AbstractRegistryFactory æŠ½è±¡ç±»ï¼ŒZookeeper Registry å·¥å‚ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class ZookeeperRegistryFactory extends AbstractRegistryFactory {

    /**
     * Zookeeper å·¥å‚
     */
    private ZookeeperTransporter zookeeperTransporter;

    /**
     * è®¾ç½® Zookeeper å·¥å‚
     *
     * è¯¥æ–¹æ³•ï¼Œé€šè¿‡ Dubbo SPI æ³¨å…¥
     *
     * @param zookeeperTransporter Zookeeper å·¥å‚å¯¹è±¡
     */
    public void setZookeeperTransporter(ZookeeperTransporter zookeeperTransporter) {
        this.zookeeperTransporter = zookeeperTransporter;
    }

    @Override
    public Registry createRegistry(URL url) {
        return new ZookeeperRegistry(url, zookeeperTransporter);
    }

}
```

## 3. ZookeeperRegistry

[`com.alibaba.dubbo.registry.zookeeper.ZookeeperRegistry`](https://github.com/YunaiV/dubbo/blob/66a1e1b0ef4b01175be148d27fdcf519f4f01b15/dubbo-registry/dubbo-registry-zookeeper/src/main/java/com/alibaba/dubbo/registry/zookeeper/ZookeeperRegistry.java) ï¼Œå®ç° FailbackRegistry æŠ½è±¡ç±»ï¼ŒZookeeper Registry ã€‚

#### 3.1 å±æ€§ + æ„é€ æ–¹æ³•

```
 1: /**
 2:  * é»˜è®¤ç«¯å£
 3:  */
 4: private final static int DEFAULT_ZOOKEEPER_PORT = 2181;
 5: /**
 6:  * é»˜è®¤ Zookeeper æ ¹èŠ‚ç‚¹
 7:  */
 8: private final static String DEFAULT_ROOT = "dubbo";
 9: 
10: /**
11:  * Zookeeper æ ¹èŠ‚ç‚¹
12:  */
13: private final String root;
14: /**
15:  * Service æ¥å£å…¨åé›†åˆ
16:  */
17: private final Set<String> anyServices = new ConcurrentHashSet<String>();
18: /**
19:  * ç›‘å¬å™¨é›†åˆ
20:  */
21: private final ConcurrentMap<URL, ConcurrentMap<NotifyListener, ChildListener>> zkListeners = new ConcurrentHashMap<URL, ConcurrentMap<NotifyListener, ChildListener>>();
22: /**
23:  * Zookeeper å®¢æˆ·ç«¯
24:  */
25: private final ZookeeperClient zkClient;
26: 
27: public ZookeeperRegistry(URL url, ZookeeperTransporter zookeeperTransporter) {
28:     super(url);
29:     if (url.isAnyHost()) {
30:         throw new IllegalStateException("registry address == null");
31:     }
32:     // è·å¾— Zookeeper æ ¹èŠ‚ç‚¹
33:     String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT); // `url.parameters.group` å‚æ•°å€¼
34:     if (!group.startsWith(Constants.PATH_SEPARATOR)) {
35:         group = Constants.PATH_SEPARATOR + group;
36:     }
37:     this.root = group;
38:     // åˆ›å»º Zookeeper Client
39:     zkClient = zookeeperTransporter.connect(url);
40:     // æ·»åŠ  StateListener å¯¹è±¡ã€‚è¯¥ç›‘å¬å™¨ï¼Œåœ¨é‡è¿æ—¶ï¼Œè°ƒç”¨æ¢å¤æ–¹æ³•ã€‚
41:     zkClient.addStateListener(new StateListener() {
42:         public void stateChanged(int state) {
43:             if (state == RECONNECTED) {
44:                 try {
45:                     recover();
46:                 } catch (Exception e) {
47:                     logger.error(e.getMessage(), e);
48:                 }
49:             }
50:         }
51:     });
52: }
```

- `root` å±æ€§ï¼ŒZookeeper æ ¹èŠ‚ç‚¹ï¼Œå³é¦–å›¾çš„ **Root** å±‚ã€‚
- `anyServices` å±æ€§ï¼ŒService æ¥å£æ¥å£å…¨å**é›†åˆ**ã€‚è¯¥å±æ€§é€‚å¯ç”¨äºç›‘æ§ä¸­å¿ƒï¼Œè®¢é˜…**æ•´ä¸ª** **Service** å±‚ã€‚å› ä¸ºï¼ŒService å±‚æ˜¯**åŠ¨æ€**çš„ï¼Œå¯ä»¥æœ‰ä¸æ–­æœ‰æ–°çš„ Service æœåŠ¡å‘å¸ƒï¼ˆæ³¨æ„ï¼Œä¸æ˜¯æœåŠ¡å®ä¾‹ï¼‰ã€‚åœ¨ `#doSubscribe(url, notifyListener)` æ–¹æ³•ä¸­ï¼Œä¼šæ›´å®¹æ˜“ç†è§£ã€‚
- `zkListeners` å±æ€§ï¼Œç›‘å¬å™¨é›†åˆï¼Œå»ºç«‹ NotifyListener å’Œ ChildListener çš„æ˜ å°„å…³ç³»ã€‚
- `zkClient` å±æ€§ï¼ŒZookeeper å®¢æˆ·ç«¯ã€‚
- æ„é€ æ–¹æ³•
  - ç¬¬ 28 è‡³ 31 è¡Œï¼šè®¾ç½®æ³¨å†Œä¸­å¿ƒçš„ URL ã€‚
  - ç¬¬ 32 è‡³ 37 è¡Œï¼šè®¾ç½®åœ¨ Zookeeper çš„æ ¹èŠ‚ç‚¹ï¼Œç¼ºçœä½¿ç”¨ `DEFAULT_ROOT` ã€‚
  - ç¬¬ 39 è¡Œï¼šè°ƒç”¨ `ZookeeperTransporter#connect(url)` æ–¹æ³•ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼Œæ ¹æ® `url` å‚æ•°ï¼ŒåŠ è½½å¯¹åº”çš„ ZookeeperTransporter å®ç°ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ ZookeeperClient å®ç°ç±»çš„å¯¹åº”ã€‚
  - ç¬¬ 41 è‡³ 51 è¡Œï¼šæ·»åŠ  StateListener å¯¹è±¡åˆ° ZookeeperClient å¯¹è±¡ä¸­ã€‚è¯¥ç›‘å¬å™¨ï¼Œåœ¨é‡è¿æ—¶ï¼Œåœ¨ç¬¬ 45 è¡Œçš„ä»£ç ï¼Œè°ƒç”¨ `#recover()` æ–¹æ³•ï¼Œè¿›è¡Œæ¢å¤é€»è¾‘ï¼Œé‡æ–°å‘èµ·æ³¨å†Œå’Œè®¢é˜…ã€‚

#### 3.2 doRegister

```
1: @Override
2: protected void doRegister(URL url) {
3:     try {
4:         zkClient.create(toUrlPath(url), url.getParameter(Constants.DYNAMIC_KEY, true));
5:     } catch (Throwable e) {
6:         throw new RpcException("Failed to register " + url + " to zookeeper " + getUrl() + ", cause: " + e.getMessage(), e);
7:     }
8: }
```

- ç¬¬ 4 è¡Œï¼šè°ƒç”¨ `#toUrlPath(url)` æ–¹æ³•ï¼Œè·å¾— URL çš„è·¯å¾„ã€‚
- ç¬¬ 4 è¡Œï¼š`url.parameters.dynamic` ï¼Œæ˜¯å¦åŠ¨æ€æ•°æ®ã€‚è‹¥ä¸º false ï¼Œè¯¥æ•°æ®ä¸º**æŒä¹…æ•°æ®**ï¼Œå½“æ³¨å†Œæ–¹é€€å‡ºæ—¶ï¼Œæ•°æ®ä¾ç„¶ä¿å­˜åœ¨æ³¨å†Œä¸­å¿ƒã€‚
- ç¬¬ 4 è¡Œï¼šè°ƒç”¨ `ZookeeperClient#create(url, ephemeral)` æ–¹æ³•ï¼Œåˆ›å»º URL èŠ‚ç‚¹ï¼Œå³æˆ‘ä»¬åœ¨é¦–å›¾çœ‹åˆ°çš„ **URL å±‚**ã€‚

###### 3.2.1 toUrlPath

```
/**
 * è·å¾— URL çš„è·¯å¾„
 *
 * Root + Service + Type + URL
 *
 * è¢« {@link #doRegister(URL)} å’Œ {@link #doUnregister(URL)} è°ƒç”¨
 *
 * @param url URL
 * @return è·¯å¾„
 */
private String toUrlPath(URL url) {
    return toCategoryPath(url) + Constants.PATH_SEPARATOR + URL.encode(url.toFullString());
}
```

###### 3.2.2 toCategoryPath

```
/**
 * è·å¾—åˆ†ç±»è·¯å¾„
 *
 * Root + Service + Type
 *
 * @param url URL
 * @return åˆ†ç±»è·¯å¾„
 */
private String toCategoryPath(URL url) {
    return toServicePath(url) + Constants.PATH_SEPARATOR + url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);
}
```

###### 3.2.3 toServicePath

```
/**
 * è·å¾—æœåŠ¡è·¯å¾„
 *
 * Root + Type
 *
 * @param url URL
 * @return æœåŠ¡è·¯å¾„
 */
private String toServicePath(URL url) {
    String name = url.getServiceInterface();
    if (Constants.ANY_VALUE.equals(name)) {
        return toRootPath();
    }
    return toRootDir() + URL.encode(name);
}
```

###### 3.2.4 toRootDir

```
/**
 * è·å¾—æ ¹ç›®å½•
 *
 * Root
 *
 * @return è·¯å¾„
 */
private String toRootDir() {
    if (root.equals(Constants.PATH_SEPARATOR)) {
        return root;
    }
    return root + Constants.PATH_SEPARATOR;
}

/**
 * Root
 *
 * @return æ ¹è·¯å¾„
 */
private String toRootPath() {
    return root;
}
```

#### 3.3 doUnregister

```
@Override
protected void doUnregister(URL url) {
    try {
        zkClient.delete(toUrlPath(url));
    } catch (Throwable e) {
        throw new RpcException("Failed to unregister " + url + " to zookeeper " + getUrl() + ", cause: " + e.getMessage(), e);
    }
}
```

#### 3.4 doSubscribe

```
 1: @Override
 2: protected void doSubscribe(final URL url, final NotifyListener listener) {
 3:     try {
 4:         // å¤„ç†æ‰€æœ‰ Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚ç›‘æ§ä¸­å¿ƒçš„è®¢é˜…
 5:         if (Constants.ANY_VALUE.equals(url.getServiceInterface())) {
 6:             String root = toRootPath();
 7:             // è·å¾— url å¯¹åº”çš„ç›‘å¬å™¨é›†åˆ
 8:             ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);
 9:             if (listeners == null) { // ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»º
10:                 zkListeners.putIfAbsent(url, new ConcurrentHashMap<NotifyListener, ChildListener>());
11:                 listeners = zkListeners.get(url);
12:             }
13:             // è·å¾— ChildListener å¯¹è±¡
14:             ChildListener zkListener = listeners.get(listener);
15:             if (zkListener == null) { // ä¸å­˜åœ¨ ChildListener å¯¹è±¡ï¼Œè¿›è¡Œåˆ›å»º ChildListener å¯¹è±¡
16:                 listeners.putIfAbsent(listener, new ChildListener() {
17:                     public void childChanged(String parentPath, List<String> currentChilds) {
18:                         for (String child : currentChilds) {
19:                             child = URL.decode(child);
20:                             // æ–°å¢ Service æ¥å£å…¨åæ—¶ï¼ˆå³æ–°å¢æœåŠ¡ï¼‰ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…
21:                             if (!anyServices.contains(child)) {
22:                                 anyServices.add(child);
23:                                 subscribe(url.setPath(child).addParameters(Constants.INTERFACE_KEY, child,
24:                                         Constants.CHECK_KEY, String.valueOf(false)), listener);
25:                             }
26:                         }
27:                     }
28:                 });
29:                 zkListener = listeners.get(listener);
30:             }
31:             // åˆ›å»º Service èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ã€‚
32:             zkClient.create(root, false);
33:             // å‘ Zookeeper ï¼ŒService èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…
34:             List<String> services = zkClient.addChildListener(root, zkListener);
35:             // é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œå¾ªç¯ Service æ¥å£å…¨åæ•°ç»„ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…
36:             if (services != null && !services.isEmpty()) {
37:                 for (String service : services) {
38:                     service = URL.decode(service);
39:                     anyServices.add(service);
40:                     subscribe(url.setPath(service).addParameters(Constants.INTERFACE_KEY, service,
41:                             Constants.CHECK_KEY, String.valueOf(false)), listener);
42:                 }
43:             }
44:         // å¤„ç†æŒ‡å®š Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚æœåŠ¡æ¶ˆè´¹è€…çš„è®¢é˜…
45:         } else {
46:             // å­èŠ‚ç‚¹æ•°æ®æ•°ç»„
47:             List<URL> urls = new ArrayList<URL>();
48:             // å¾ªç¯åˆ†ç±»æ•°ç»„
49:             for (String path : toCategoriesPath(url)) {
50:                 // è·å¾— url å¯¹åº”çš„ç›‘å¬å™¨é›†åˆ
51:                 ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);
52:                 if (listeners == null) { // ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»º
53:                     zkListeners.putIfAbsent(url, new ConcurrentHashMap<NotifyListener, ChildListener>());
54:                     listeners = zkListeners.get(url);
55:                 }
56:                 // è·å¾— ChildListener å¯¹è±¡
57:                 ChildListener zkListener = listeners.get(listener);
58:                 if (zkListener == null) { // ä¸å­˜åœ¨ ChildListener å¯¹è±¡ï¼Œè¿›è¡Œåˆ›å»º ChildListener å¯¹è±¡
59:                     listeners.putIfAbsent(listener, new ChildListener() {
60:                         public void childChanged(String parentPath, List<String> currentChilds) {
61:                             // å˜æ›´æ—¶ï¼Œè°ƒç”¨ `#notify(...)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener
62:                             ZookeeperRegistry.this.notify(url, listener, toUrlsWithEmpty(url, parentPath, currentChilds));
63:                         }
64:                     });
65:                     zkListener = listeners.get(listener);
66:                 }
67:                 // åˆ›å»º Type èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ã€‚
68:                 zkClient.create(path, false);
69:                 // å‘ Zookeeper ï¼ŒPATH èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…
70:                 List<String> children = zkClient.addChildListener(path, zkListener);
71:                 // æ·»åŠ åˆ° `urls` ä¸­
72:                 if (children != null) {
73:                     urls.addAll(toUrlsWithEmpty(url, path, children));
74:                 }
75:             }
76:             // é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œè°ƒç”¨ `#notify(...)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener
77:             notify(url, listener, urls);
78:         }
79:     } catch (Throwable e) {
80:         throw new RpcException("Failed to subscribe " + url + " to zookeeper " + getUrl() + ", cause: " + e.getMessage(), e);
81:     }
82: }
```

- æ•´ä¸ªæ–¹æ³•åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«ï¼š
- ============ ç¬¬äºŒéƒ¨åˆ†ã€ç¬¬ 44 è‡³ 78 è¡Œã€‘ ============
- å¤„ç†**æŒ‡å®š** Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚**æœåŠ¡æ¶ˆè´¹è€…**çš„è®¢é˜…ã€‚
- ç¬¬ 47 è¡Œï¼šå­èŠ‚ç‚¹æ•°æ®æ•°ç»„ï¼Œå³ **Service å±‚**ä¸‹çš„**æ‰€æœ‰ URL** ã€‚
- ç¬¬ 49 è¡Œï¼šå¾ªç¯åˆ†ç±»æ•°ç»„ã€‚å…¶ä¸­ï¼Œè°ƒç”¨ `#toCategoriesPath(url)` æ–¹æ³•ï¼Œè·å¾— åˆ†ç±»æ•°ç»„ã€‚
- ç¬¬ 51 è‡³ 55 è¡Œï¼šè·å¾—è®¢é˜…çš„ `url` å¯¹åº”çš„ç›‘å¬å™¨é›†åˆã€‚
- ç¬¬ 56 è‡³ 66 è¡Œï¼šè·å¾— `listener`( NotifyListener ) å¯¹åº”çš„ ChildListener å¯¹è±¡ã€‚**åœ¨ URL å±‚å‘ç”Ÿå˜æ›´æ—¶**ï¼Œä¼šè°ƒç”¨ `NotifyListener#notify(url, listener, currentChilds)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener çš„é€»è¾‘ã€‚é…±ç´«ï¼Œå¦‚æœ Service ä¸‹å¢åŠ **æ–°çš„æœåŠ¡æä¾›è€…å®ä¾‹**( æ–°çš„ URL )ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯åˆ›å»ºæ–°çš„ Invoker å¯¹è±¡ï¼Œç”¨äºè°ƒç”¨è¯¥æœåŠ¡æä¾›è€…ã€‚
- ç¬¬ 68 è¡Œï¼šåˆ›å»º **Type** èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸º**æŒä¹…**èŠ‚ç‚¹ã€‚
- ç¬¬ 70 è¡Œï¼šå‘ Zookeeper çš„ **Path** èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…ã€‚
- ç¬¬ 72 è‡³ 74 è¡Œï¼šæ·»åŠ åˆ° `urls` ä¸­ã€‚
- ç¬¬ 77 è¡Œï¼š**é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶**ï¼Œè°ƒç”¨ `NotifyListener#notify(url, listener, currentChilds)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener çš„é€»è¾‘ã€‚é…±ç´«ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯åˆ›å»ºæ‰€æœ‰çš„ Invoker å¯¹è±¡ï¼Œç”¨äºè°ƒç”¨æœåŠ¡æä¾›è€…ä»¬ã€‚
- ğŸ™‚ å›çœ‹ã€ç¬¬ 77 è¡Œã€‘å’Œã€ç¬¬ 62 è¡Œã€‘ï¼Œå…¨é‡ + å¢é‡ï¼Œä»”ç»†ç†è§£ä¸‹ã€‚
- ============ ç¬¬ä¸€éƒ¨åˆ†ã€ç¬¬ 5 è‡³ 43 è¡Œã€‘ ============
- å¤„ç†**æ‰€æœ‰** Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚**ç›‘æ§ä¸­å¿ƒ**çš„è®¢é˜…
- ç¬¬ 8 è‡³ 12 è¡Œï¼šè·å¾—è®¢é˜…çš„ `url` å¯¹åº”çš„ç›‘å¬å™¨é›†åˆã€‚
- ç¬¬ 13 è‡³ 30 è¡Œï¼šè·å¾— `listener`( NotifyListener ) å¯¹åº”çš„ ChildListener å¯¹è±¡ã€‚**åœ¨ Service å±‚å‘ç”Ÿå˜æ›´æ—¶**ï¼Œè‹¥æ˜¯æ–°å¢ Service æ¥å£å…¨åæ—¶ï¼ˆå³æ–°å¢æœåŠ¡ï¼‰ï¼Œè°ƒç”¨ `#subscribe(url, listener)` æ–¹æ³•ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…ï¼ˆã€ç¬¬ 45 è‡³ 78 è¡Œã€‘çš„é€»è¾‘ï¼‰ã€‚æ˜¯å¦æ˜¯æ–°å¢çš„æœåŠ¡ï¼Œé€šè¿‡ `anyServices` å±æ€§æ¥åˆ¤æ–­ã€‚
- ç¬¬ 32 è¡Œï¼šåˆ›å»º **Service** èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸º**æŒä¹…**èŠ‚ç‚¹ã€‚
- ç¬¬ 34 è¡Œï¼šå‘ Zookeeper çš„ **Service** èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…ã€‚
- ç¬¬ 36 è‡³ 43 è¡Œï¼š**é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶**ï¼Œå¾ªç¯ Service æ¥å£å…¨åæ•°ç»„ï¼Œè°ƒç”¨ `#subscribe(url, listener)` æ–¹æ³•ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…ï¼ˆã€ç¬¬ 45 è‡³ 78 è¡Œã€‘çš„é€»è¾‘ï¼‰ã€‚

> å‹æƒ…æç¤ºï¼šå¦‚æœè§‰å¾—æ¯”è¾ƒç»•ï¼Œæˆ–è€…ç¬”è€…è®²çš„ä¸æ¸…æ™°ï¼Œèƒ–å‹å¯ä»¥è¿›è¡Œè°ƒè¯•ç†è§£ã€‚

###### 3.4.1 toCategoriesPath

```
/**
 * è·å¾—åˆ†ç±»è·¯å¾„æ•°ç»„
 *
 * Root + Service + Type
 *
 * @param url URL
 * @return åˆ†ç±»è·¯å¾„æ•°ç»„
 */
private String[] toCategoriesPath(URL url) {
    // è·å¾—åˆ†ç±»æ•°ç»„
    String[] categories;
    if (Constants.ANY_VALUE.equals(url.getParameter(Constants.CATEGORY_KEY))) { // * æ—¶ï¼Œ
        categories = new String[]{Constants.PROVIDERS_CATEGORY, Constants.CONSUMERS_CATEGORY,
                Constants.ROUTERS_CATEGORY, Constants.CONFIGURATORS_CATEGORY};
    } else {
        categories = url.getParameter(Constants.CATEGORY_KEY, new String[]{Constants.DEFAULT_CATEGORY});
    }
    // è·å¾—åˆ†ç±»è·¯å¾„æ•°ç»„
    String[] paths = new String[categories.length];
    for (int i = 0; i < categories.length; i++) {
        paths[i] = toServicePath(url) + Constants.PATH_SEPARATOR + categories[i];
    }
    return paths;
}
```

###### 3.4.2 toUrlsWithEmpty

```
/**
 * è·å¾— providers ä¸­ï¼Œå’Œ consumer åŒ¹é…çš„ URL æ•°ç»„
 *
 * è‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º `empty://` çš„ URLè¿”å›ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¯ä»¥å¤„ç†ç±»ä¼¼æœåŠ¡æä¾›è€…ä¸ºç©ºçš„æƒ…å†µã€‚
 *
 * @param consumer ç”¨äºåŒ¹é… URL
 * @param path è¢«åŒ¹é…çš„ URL çš„å­—ç¬¦ä¸²
 * @param providers åŒ¹é…çš„ URL æ•°ç»„
 * @return åŒ¹é…çš„ URL æ•°ç»„
 */
private List<URL> toUrlsWithEmpty(URL consumer, String path, List<String> providers) {
    // è·å¾— providers ä¸­ï¼Œå’Œ consumer åŒ¹é…çš„ URL æ•°ç»„
    List<URL> urls = toUrlsWithoutEmpty(consumer, providers);
    // è‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º `empty://` çš„ URLè¿”å›
    if (urls == null || urls.isEmpty()) {
        int i = path.lastIndexOf('/');
        String category = i < 0 ? path : path.substring(i + 1);
        URL empty = consumer.setProtocol(Constants.EMPTY_PROTOCOL).addParameter(Constants.CATEGORY_KEY, category);
        urls.add(empty);
    }
    return urls;
}
```

- `#toUrlsWithoutEmpty()` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  /**
   * è·å¾— providers ä¸­ï¼Œå’Œ consumer åŒ¹é…çš„ URL æ•°ç»„
   *
   * @param consumer ç”¨äºåŒ¹é… URL
   * @param providers è¢«åŒ¹é…çš„ URL çš„å­—ç¬¦ä¸²
   * @return åŒ¹é…çš„ URL æ•°ç»„
   */
  private List<URL> toUrlsWithoutEmpty(URL consumer, List<String> providers) {
      List<URL> urls = new ArrayList<URL>();
      if (providers != null && !providers.isEmpty()) {
          for (String provider : providers) {
              provider = URL.decode(provider);
              if (provider.contains("://")) { // æ˜¯ url
                  URL url = URL.valueOf(provider); // å°†å­—ç¬¦ä¸²è½¬åŒ–æˆ URL
                  if (UrlUtils.isMatch(consumer, url)) { // åŒ¹é…
                      urls.add(url);
                  }
              }
          }
      }
      return urls;
  }
  ```

#### 3.5 doUnsubscribe

```
@Override
protected void doUnsubscribe(URL url, NotifyListener listener) {
    ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);
    if (listeners != null) {
        ChildListener zkListener = listeners.get(listener);
        if (zkListener != null) {
            // å‘ Zookeeper ï¼Œç§»é™¤è®¢é˜…
            zkClient.removeChildListener(toUrlPath(url), zkListener);
        }
    }
}
```

#### 3.6 lookup

```
/**
 * æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œä¸è®¢é˜…çš„æ¨æ¨¡å¼ç›¸å¯¹åº”ï¼Œè¿™é‡Œä¸ºæ‹‰æ¨¡å¼ï¼Œåªè¿”å›ä¸€æ¬¡ç»“æœã€‚
 *
 * @param url æŸ¥è¯¢æ¡ä»¶ï¼Œä¸å…è®¸ä¸ºç©ºï¼Œå¦‚ï¼šconsumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin
 * @return å·²æ³¨å†Œä¿¡æ¯åˆ—è¡¨ï¼Œå¯èƒ½ä¸ºç©ºï¼Œå«ä¹‰åŒ{@link com.alibaba.dubbo.registry.NotifyListener#notify(List<URL>)}çš„å‚æ•°ã€‚
 * @see com.alibaba.dubbo.registry.NotifyListener#notify(List)
 */
@Override
public List<URL> lookup(URL url) {
    if (url == null) {
        throw new IllegalArgumentException("lookup url == null");
    }
    try {
        // å¾ªç¯åˆ†ç±»æ•°ç»„ï¼Œè·å¾—æ‰€æœ‰çš„ URL æ•°ç»„
        List<String> providers = new ArrayList<String>();
        for (String path : toCategoriesPath(url)) {
            List<String> children = zkClient.getChildren(path);
            if (children != null) {
                providers.addAll(children);
            }
        }
        // åŒ¹é…
        return toUrlsWithoutEmpty(url, providers);
    } catch (Throwable e) {
        throw new RpcException("Failed to lookup " + url + " from zookeeper " + getUrl() + ", cause: " + e.getMessage(), e);
    }
}
```

#### 3.7 isAvailable

```
@Override
public boolean isAvailable() {
    return zkClient.isConnected();
}
```

#### 3.8 destroy

```
@Override
public void destroy() {
    super.destroy();
    try {
        zkClient.close();
    } catch (Exception e) {
        logger.warn("Failed to close zookeeper client " + getUrl() + ", cause: " + e.getMessage(), e);
    }
}
```

## 4. è°ƒç”¨

#### 4.1 æœåŠ¡æä¾›è€…

å›å¤´çœ‹ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡æš´éœ²ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹æš´éœ²ï¼ˆDubboï¼‰ã€‹](http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/?self) çš„ [ã€Œ3.2.2 exportã€](http://svip.iocoder.cn/Dubbo/registry-zookeeper/#) å°èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

- ç¬¬ 14 è¡Œï¼šè°ƒç”¨ `#register(registryUrl, registedProviderUrl)` æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æä¾›è€…ï¼ˆè‡ªå·±ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  public void register(URL registryUrl, URL registedProviderUrl) {
      Registry registry = registryFactory.getRegistry(registryUrl);
      registry.register(registedProviderUrl);
  }
  ```

#### 4.2 æœåŠ¡æ¶ˆè´¹è€…

å›å¤´çœ‹ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡å¼•ç”¨ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹å¼•ç”¨ï¼ˆDubboï¼‰ã€‹](http://svip.iocoder.cn/Dubbo/reference-refer-dubbo/?self) çš„ [ã€Œ3.2.2 doRefer](http://svip.iocoder.cn/Dubbo/registry-zookeeper/#) å°èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

- ç¬¬ 20 è‡³ 25 è¡Œï¼šè°ƒç”¨ `RegistryService#register(url)` æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œ**è‡ªå·±**ï¼ˆæœåŠ¡æ¶ˆè´¹è€…ï¼‰ã€‚

- ç¬¬ 35 è¡Œï¼šè°ƒç”¨

   

  ```
  Directory#subscribe(url)
  ```

   

  æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡æä¾›è€… + è·¯ç”±è§„åˆ™ + é…ç½®è§„åˆ™ã€‚

  - åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šå¾ªç¯è·å¾—åˆ°çš„æœåŠ¡ä½“ç”¨è¿™åˆ—è¡¨ï¼Œè°ƒç”¨ `Protocol#refer(type, url)` æ–¹æ³•ï¼Œåˆ›å»ºæ¯ä¸ªè°ƒç”¨æœåŠ¡çš„ Invoker å¯¹è±¡ã€‚

# Redis

## 1. æ¦‚è¿°

å‰ç½®é˜…è¯»æ–‡ç« ï¼š

- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://svip.iocoder.cn/Dubbo/registry-api/?self)
- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆäºŒï¼‰ä¹‹ Zookeeperã€‹](http://svip.iocoder.cn/Dubbo/registry-zookeeper/?self)

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” Redis æ³¨å†Œä¸­å¿ƒã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/registry/redis.html) æ–‡æ¡£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

> åŸºäº Redis å®ç°çš„æ³¨å†Œä¸­å¿ƒã€‚
>
> [![æµç¨‹](http://static.iocoder.cn/images/Dubbo/2018_08_07/01.png)](http://static.iocoder.cn/images/Dubbo/2018_08_07/01.png)æµç¨‹
>
> ä½¿ç”¨ Redis çš„ Key/Map ç»“æ„å­˜å‚¨æ•°æ®ç»“æ„ï¼š
>
> - ä¸» Key ä¸ºæœåŠ¡åå’Œç±»å‹
> - Map ä¸­çš„ Key ä¸º URL åœ°å€
> - Map ä¸­çš„ Value ä¸ºè¿‡æœŸæ—¶é—´ï¼Œç”¨äºåˆ¤æ–­è„æ•°æ®ï¼Œè„æ•°æ®ç”±ç›‘æ§ä¸­å¿ƒåˆ é™¤

- **æ¨ªå‘**æ¥çœ‹ï¼Œå’ŒåŸºäº Zookeeper å®ç°çš„æ³¨å†Œä¸­å¿ƒï¼Œä¹Ÿæ˜¯åˆ†æˆ **Root**ã€**Service**ã€**Type**ã€**URL** å››å±‚ã€‚
- ä½¿ç”¨ **Redis Map** çš„æ•°æ®ç»“æ„ï¼Œèšåˆç›¸åŒæœåŠ¡å’Œç±»å‹( Root + Service + Type )ã€‚
- ä¸ä½¿ç”¨ Redis çš„**è‡ªåŠ¨è¿‡æœŸ**æœºåˆ¶ï¼Œè€Œæ˜¯é€šè¿‡**ç›‘æ§ä¸­å¿ƒ**ï¼Œå®ç°è¿‡æœŸæœºåˆ¶ã€‚å› ä¸ºï¼ŒRedis Key è‡ªåŠ¨è¿‡æœŸæ—¶ï¼Œä¸å­˜åœ¨ç›¸åº”çš„äº‹ä»¶é€šçŸ¥ã€‚
- æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…ï¼Œå®šæ—¶å»¶é•¿å…¶æ³¨å†Œçš„ URL åœ°å€çš„è¿‡æœŸæ—¶é—´ã€‚

ä½¿ç”¨ Redis çš„ **Publish/Subscribe** äº‹ä»¶é€šçŸ¥æ•°æ®å˜æ›´ï¼š

> - é€šè¿‡äº‹ä»¶çš„å€¼åŒºåˆ†äº‹ä»¶ç±»å‹ï¼š`register`, `unregister`
> - æ™®é€šæ¶ˆè´¹è€…ç›´æ¥è®¢é˜…æŒ‡å®šæœåŠ¡æä¾›è€…çš„ Keyï¼Œåªä¼šæ”¶åˆ°**æŒ‡å®šæœåŠ¡**çš„å˜æ›´äº‹ä»¶
> - ç›‘æ§ä¸­å¿ƒé€šè¿‡ psubscribe åŠŸèƒ½è®¢é˜… `/dubbo/*`ï¼Œä¼šæ”¶åˆ°**æ‰€æœ‰æœåŠ¡**çš„æ‰€æœ‰å˜æ›´äº‹ä»¶

- æœåŠ¡å®ä¾‹çš„å¯åŠ¨æˆ–å…³é—­ï¼Œä¼šå†™å…¥æˆ–åˆ é™¤å¯¹åº”çš„ Redis Map ä¸­ï¼Œå¹¶å‘èµ·å¯¹åº”çš„ `register`, `unregister` äº‹ä»¶ï¼Œä»è€Œä¿è¯**å®æ—¶æ€§**ã€‚
- é€šè¿‡ç›‘æ§ä¸­å¿ƒï¼Œè½®è¯¢ Key è¿‡æœŸï¼Œä¿è¯**æœªæ­£å¸¸å…³é—­**çš„æœåŠ¡å®ä¾‹çš„ URL çš„åˆ é™¤ï¼Œå¹¶å‘èµ·å¯¹åº”çš„ `unregister` äº‹ä»¶ï¼Œä»è€Œä¿è¯**æœ€ç»ˆä¸€è‡´æ€§**ã€‚

**è°ƒç”¨è¿‡ç¨‹**ï¼š

> ã€ä¸€ã€‘æœåŠ¡æä¾›æ–¹
>
> - 1ã€æœåŠ¡æä¾›æ–¹å¯åŠ¨æ—¶ï¼Œå‘ `Key:/dubbo/com.foo.BarService/providers` ä¸‹ï¼Œæ·»åŠ å½“å‰æä¾›è€…çš„åœ°å€
> - 2ã€å¹¶å‘ `Channel:/dubbo/com.foo.BarService/providers` å‘é€ `register` äº‹ä»¶
>
> ã€äºŒã€‘æœåŠ¡æ¶ˆè´¹æ–¹
>
> - 3ã€æœåŠ¡æ¶ˆè´¹æ–¹å¯åŠ¨æ—¶ï¼Œä» `Channel:/dubbo/com.foo.BarService/providers` è®¢é˜… `register` å’Œ `unregister` äº‹ä»¶
> - 4ã€å¹¶å‘ `Key:/dubbo/com.foo.BarService/providers` ä¸‹ï¼Œæ·»åŠ å½“å‰æ¶ˆè´¹è€…çš„åœ°å€
>   æœåŠ¡æ¶ˆè´¹æ–¹æ”¶åˆ° `register` å’Œ `unregister` äº‹ä»¶åï¼Œä» `Key:/dubbo/com.foo.BarService/providers` ä¸‹è·å–æä¾›è€…åœ°å€åˆ—è¡¨
>
> ã€ä¸‰ã€‘æœåŠ¡ç›‘æ§ä¸­å¿ƒ
>
> - 5ã€æœåŠ¡ç›‘æ§ä¸­å¿ƒå¯åŠ¨æ—¶ï¼Œä» `Channel:/dubbo/*` è®¢é˜… `register` å’Œ `unregister`ï¼Œä»¥åŠ `subscribe` å’Œ `unsubsribe` äº‹ä»¶
> - 6ã€æœåŠ¡ç›‘æ§ä¸­å¿ƒæ”¶åˆ° `register` å’Œ `unregister` äº‹ä»¶åï¼Œä» `Key:/dubbo/com.foo.BarService/providers` ä¸‹è·å–æä¾›è€…åœ°å€åˆ—è¡¨
> - 7ã€æœåŠ¡ç›‘æ§ä¸­å¿ƒæ”¶åˆ° `subscribe` å’Œ `unsubsribe` äº‹ä»¶åï¼Œä» `Key:/dubbo/com.foo.BarService/consumers` ä¸‹è·å–æ¶ˆè´¹è€…åœ°å€åˆ—è¡¨

æœ¬æ–‡æ¶‰åŠä»…æœ‰ RedisRegistry ä¸€ä¸ªç±»ï¼Œç±»å›¾å¦‚ä¸‹ï¼š

[![ç±»å›¾](http://static.iocoder.cn/images/Dubbo/2018_08_07/02.png)](http://static.iocoder.cn/images/Dubbo/2018_08_07/02.png)ç±»å›¾

## 2. RedisRegistry

[`com.alibaba.dubbo.registry.redis.RedisRegistry`](https://github.com/YunaiV/dubbo/blob/master/dubbo-registry/dubbo-registry-redis/src/main/java/com/alibaba/dubbo/registry/redis/RedisRegistry.java) ï¼Œå®ç° FailbackRegistry æŠ½è±¡ç±»ï¼ŒåŸºäº Redis å®ç°çš„æ³¨å†Œä¸­å¿ƒå®ç°ç±»ã€‚

#### 2.1 æ„é€ æ–¹æ³•

```
  1: /**
  2:  * é»˜è®¤ç«¯å£
  3:  */
  4: private static final int DEFAULT_REDIS_PORT = 6379;
  5: /**
  6:  * é»˜è®¤ Redis æ ¹èŠ‚ç‚¹
  7:  */
  8: private final static String DEFAULT_ROOT = "dubbo";
  9: 
 10: /**
 11:  * Redis Key è¿‡æœŸæœºåˆ¶æ‰§è¡Œå™¨
 12:  */
 13: private final ScheduledExecutorService expireExecutor = Executors.newScheduledThreadPool(1, new NamedThreadFactory("DubboRegistryExpireTimer", true));
 14: /**
 15:  * Redis Key è¿‡æœŸæœºåˆ¶ Future
 16:  */
 17: private final ScheduledFuture<?> expireFuture;
 18: 
 19: /**
 20:  * Redis æ ¹èŠ‚ç‚¹
 21:  */
 22: private final String root;
 23: 
 24: /**
 25:  * JedisPool é›†åˆ
 26:  *
 27:  * keyï¼šip:port
 28:  */
 29: private final Map<String, JedisPool> jedisPools = new ConcurrentHashMap<String, JedisPool>();
 30: 
 31: /**
 32:  * é€šçŸ¥å™¨é›†åˆ
 33:  *
 34:  * keyï¼šRoot + Service ï¼Œä¾‹å¦‚ `/dubbo/com.alibaba.dubbo.demo.DemoService`
 35:  */
 36: private final ConcurrentMap<String, Notifier> notifiers = new ConcurrentHashMap<String, Notifier>();
 37: 
 38: /**
 39:  * é‡è¿å‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’
 40:  */
 41: private final int reconnectPeriod;
 42: /**
 43:  * è¿‡æœŸå‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’
 44:  */
 45: private final int expirePeriod;
 46: 
 47: /**
 48:  * æ˜¯å¦ç›‘æ§ä¸­å¿ƒ
 49:  *
 50:  * ç”¨äºåˆ¤æ–­è„æ•°æ®ï¼Œè„æ•°æ®ç”±ç›‘æ§ä¸­å¿ƒåˆ é™¤ {@link #clean(Jedis)}
 51:  */
 52: private volatile boolean admin = false;
 53: 
 54: /**
 55:  * æ˜¯å¦å¤åˆ¶æ¨¡å¼
 56:  */
 57: private boolean replicate;
 58: 
 59: public RedisRegistry(URL url) {
 60:     super(url);
 61:     if (url.isAnyHost()) {
 62:         throw new IllegalStateException("registry address == null");
 63:     }
 64:     // åˆ›å»º GenericObjectPoolConfig å¯¹è±¡
 65:     GenericObjectPoolConfig config = new GenericObjectPoolConfig();
 66:     config.setTestOnBorrow(url.getParameter("test.on.borrow", true));
 67:     config.setTestOnReturn(url.getParameter("test.on.return", false));
 68:     config.setTestWhileIdle(url.getParameter("test.while.idle", false));
 69:     if (url.getParameter("max.idle", 0) > 0)
 70:         config.setMaxIdle(url.getParameter("max.idle", 0));
 71:     if (url.getParameter("min.idle", 0) > 0)
 72:         config.setMinIdle(url.getParameter("min.idle", 0));
 73:     if (url.getParameter("max.active", 0) > 0)
 74:         config.setMaxTotal(url.getParameter("max.active", 0));
 75:     if (url.getParameter("max.total", 0) > 0)
 76:         config.setMaxTotal(url.getParameter("max.total", 0));
 77:     if (url.getParameter("max.wait", url.getParameter("timeout", 0)) > 0)
 78:         config.setMaxWaitMillis(url.getParameter("max.wait", url.getParameter("timeout", 0)));
 79:     if (url.getParameter("num.tests.per.eviction.run", 0) > 0)
 80:         config.setNumTestsPerEvictionRun(url.getParameter("num.tests.per.eviction.run", 0));
 81:     if (url.getParameter("time.between.eviction.runs.millis", 0) > 0)
 82:         config.setTimeBetweenEvictionRunsMillis(url.getParameter("time.between.eviction.runs.millis", 0));
 83:     if (url.getParameter("min.evictable.idle.time.millis", 0) > 0)
 84:         config.setMinEvictableIdleTimeMillis(url.getParameter("min.evictable.idle.time.millis", 0));
 85: 
 86:     // æ˜¯å¦å¤åˆ¶æ¨¡å¼
 87:     String cluster = url.getParameter("cluster", "failover");
 88:     if (!"failover".equals(cluster) && !"replicate".equals(cluster)) {
 89:         throw new IllegalArgumentException("Unsupported redis cluster: " + cluster + ". The redis cluster only supported failover or replicate.");
 90:     }
 91:     replicate = "replicate".equals(cluster);
 92: 
 93:     // è§£æ
 94:     List<String> addresses = new ArrayList<String>();
 95:     addresses.add(url.getAddress());
 96:     String[] backups = url.getParameter(Constants.BACKUP_KEY, new String[0]);
 97:     if (backups != null && backups.length > 0) {
 98:         addresses.addAll(Arrays.asList(backups));
 99:     }
100: 
101:     // åˆ›å»º JedisPool å¯¹è±¡
102:     String password = url.getPassword();
103:     for (String address : addresses) {
104:         int i = address.indexOf(':');
105:         String host;
106:         int port;
107:         if (i > 0) {
108:             host = address.substring(0, i);
109:             port = Integer.parseInt(address.substring(i + 1));
110:         } else {
111:             host = address;
112:             port = DEFAULT_REDIS_PORT;
113:         }
114:         if (StringUtils.isEmpty(password)) { // æ— å¯†ç è¿æ¥
115:             this.jedisPools.put(address, new JedisPool(config, host, port,
116:                     url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT)));
117:         } else { // æœ‰å¯†ç è¿æ¥
118:             this.jedisPools.put(address, new JedisPool(config, host, port,
119:                     url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT), password));
120:         }
121:     }
122: 
123:     // è§£æé‡è¿å‘¨æœŸ
124:     this.reconnectPeriod = url.getParameter(Constants.REGISTRY_RECONNECT_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RECONNECT_PERIOD);
125: 
126:     // è·å¾— Redis æ ¹èŠ‚ç‚¹
127:     String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT);
128:     if (!group.startsWith(Constants.PATH_SEPARATOR)) { // å¤´ `/`
129:         group = Constants.PATH_SEPARATOR + group;
130:     }
131:     if (!group.endsWith(Constants.PATH_SEPARATOR)) { // å°¾ `/`
132:         group = group + Constants.PATH_SEPARATOR;
133:     }
134:     this.root = group;
135: 
136:     // åˆ›å»ºå®ç° Redis Key è¿‡æœŸæœºåˆ¶çš„ä»»åŠ¡
137:     this.expirePeriod = url.getParameter(Constants.SESSION_TIMEOUT_KEY, Constants.DEFAULT_SESSION_TIMEOUT);
138:     this.expireFuture = expireExecutor.scheduleWithFixedDelay(new Runnable() {
139:         public void run() {
140:             try {
141:                 deferExpired(); // Extend the expiration time
142:             } catch (Throwable t) { // Defensive fault tolerance
143:                 logger.error("Unexpected exception occur at defer expire time, cause: " + t.getMessage(), t);
144:             }
145:         }
146:     }, expirePeriod / 2, expirePeriod / 2, TimeUnit.MILLISECONDS);
147: }
```

- `jedisPools` å±æ€§ï¼ŒJedisPool é›†åˆï¼Œå…¶ä¸­é”®ä¸º `ip:port` ã€‚åœ¨ã€ç¬¬ 64 è‡³ 84 è¡Œã€‘å’Œã€ç¬¬ 93 è‡³ 99 è¡Œã€‘å’Œã€101 è‡³ 121 è¡Œã€‘åˆå§‹åŒ–ã€‚

  - `root` å±æ€§ï¼ŒRedis æ ¹èŠ‚ç‚¹ï¼Œå³é¦–å›¾çš„ **Root** å±‚ã€‚åœ¨ã€ç¬¬ 126 è‡³ 134 è¡Œã€‘åˆå§‹åŒ–ã€‚

  - `replicate` å±æ€§ï¼Œæ˜¯å¦å¤åˆ¶æ¨¡å¼ã€‚åœ¨ã€ç¬¬ 86 è‡³ 90 è¡Œã€‘æ–‡æ¡£è¯´æ˜å¦‚ä¸‹ï¼š

    > å¯é€šè¿‡ `<dubbo:registry cluster="replicate" />` è®¾ç½® redis é›†ç¾¤ç­–ç•¥ï¼Œç¼ºçœä¸º `failover`ï¼š
    >
    > - `failover`: åªå†™å…¥å’Œè¯»å–ä»»æ„ä¸€å°ï¼Œå¤±è´¥æ—¶é‡è¯•å¦ä¸€å°ï¼Œéœ€è¦æœåŠ¡å™¨ç«¯è‡ªè¡Œé…ç½®æ•°æ®åŒæ­¥ã€‚
    > - `replicate`: åœ¨å®¢æˆ·ç«¯åŒæ—¶å†™å…¥æ‰€æœ‰æœåŠ¡å™¨ï¼Œåªè¯»å–å•å°ï¼ŒæœåŠ¡å™¨ç«¯ä¸éœ€è¦åŒæ­¥ï¼Œæ³¨å†Œä¸­å¿ƒé›†ç¾¤å¢å¤§ï¼Œæ€§èƒ½å‹åŠ›ä¹Ÿä¼šæ›´å¤§ã€‚

- `notifiers` å±æ€§ï¼Œé€šçŸ¥å™¨é›†åˆï¼Œå…¶ä¸­é”®ä¸º Root + Service ã€‚Notifier ï¼Œç”¨äº Redis Publish/Subscribe æœºåˆ¶ä¸­çš„è®¢é˜…ï¼Œå®æ—¶ç›‘å¬æ•°æ®çš„å˜åŒ–ã€‚

  - `reconnectPeriod` å±æ€§ï¼Œé‡è¿å‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’ã€‚åœ¨ã€ç¬¬ 91 è¡Œã€‘åˆå§‹åŒ–ã€‚ç”¨äºè®¢é˜…å‘ç”Ÿ Redis è¿æ¥å¼‚å¸¸æ—¶ï¼ŒNotifier **sleep** ï¼Œç­‰å¾…é‡è¿ä¸Šã€‚

- ```
  expireExecutor
  ```

   

  å±æ€§ï¼ŒRedis Key è¿‡æœŸæœºåˆ¶æ‰§è¡Œå™¨ã€‚

  - `expirePeriod` å±æ€§ï¼ŒRedis Key è¿‡æœŸå‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’ã€‚åœ¨ã€ç¬¬ 137 è¡Œã€‘åˆå§‹åŒ–ã€‚

  - ```
    expireFuture
    ```

     

    å±æ€§ï¼ŒRedis Key è¿‡æœŸæœºåˆ¶ä»»åŠ¡çš„ Future ã€‚åœ¨ã€ç¬¬ 138 è‡³ 146 è¡Œã€‘åˆå§‹åŒ–ã€‚

    - è¯¥ä»»åŠ¡ä¸»è¦æœ‰ä¸¤ä¸ªé€»è¾‘ï¼š1ï¼‰å»¶é•¿æœªè¿‡æœŸçš„ Key ï¼›2ï¼‰åˆ é™¤è¿‡æœŸçš„ Key ã€‚
    - ä»»åŠ¡é—´éš”ä¸º `expirePeriod` çš„**ä¸€åŠ**ï¼Œé¿å…è¿‡äºé¢‘ç¹ï¼Œå¯¹ Redis çš„å‹åŠ›è¿‡å¤§ï¼›åŒæ—¶ï¼Œé¿å…è¿‡äºä¸é¢‘ç¹ï¼Œæ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œéƒ½è¿‡æœŸäº†ã€‚

  - `admin` å±æ€§ï¼Œæ˜¯å¦ç›‘æ§ä¸­å¿ƒï¼Œåœ¨ `#clean(Jedis)` æ–¹æ³•ï¼Œçœ‹åˆ°å…·ä½“çš„ä½¿ç”¨ã€‚

#### 2.2 doRegister

```
 1: @Override
 2: public void doRegister(URL url) {
 3:     String key = toCategoryPath(url);
 4:     String value = url.toFullString();
 5:     // è®¡ç®—è¿‡æœŸæ—¶é—´
 6:     String expire = String.valueOf(System.currentTimeMillis() + expirePeriod);
 7:     boolean success = false;
 8:     RpcException exception = null;
 9:     // å‘ Redis æ³¨å†Œ
10:     for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
11:         JedisPool jedisPool = entry.getValue();
12:         try {
13:             Jedis jedis = jedisPool.getResource();
14:             try {
15:                 // å†™å…¥ Redis Map é”®
16:                 jedis.hset(key, value, expire);
17:                 // å‘å¸ƒ Redis æ³¨å†Œäº‹ä»¶
18:                 jedis.publish(key, Constants.REGISTER);
19:                 success = true;
20:                 //  å¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨
21:                 if (!replicate) {
22:                     break; //  If the server side has synchronized data, just write a single machine
23:                 }
24:             } finally {
25:                 jedisPool.returnResource(jedis);
26:             }
27:         } catch (Throwable t) {
28:             exception = new RpcException("Failed to register service to redis registry. registry: " + entry.getKey() + ", service: " + url + ", cause: " + t.getMessage(), t);
29:         }
30:     }
31:     // å¤„ç†å¼‚å¸¸
32:     if (exception != null) {
33:         if (success) { // è™½ç„¶å‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯ç»“æœæˆåŠŸ
34:             logger.warn(exception.getMessage(), exception);
35:         } else { // æœ€ç»ˆæœªæˆåŠŸ
36:             throw exception;
37:         }
38:     }
39: }
```

- ç¬¬ 3 è¡Œï¼šè°ƒç”¨ `#toCategoryPath(url)` æ–¹æ³•ï¼Œè·å¾—**åˆ†ç±»è·¯å¾„**ä½œä¸º Key ã€‚
- ç¬¬ 4 è¡Œï¼šè°ƒç”¨ `URL#toFullString()` æ–¹æ³•ï¼Œè·å¾— **URL å­—ç¬¦ä¸²**ä½œä¸º Value ã€‚
- ç¬¬ 6 è¡Œï¼šè®¡ç®—è¿‡æœŸæ—¶é—´ï¼Œå½“å‰æ—¶é—´ + `expirePeriod` ã€‚
- ç¬¬ 9 è‡³ 30 è¡Œï¼šå‘ Redis æ³¨å†Œã€‚
  - ç¬¬ 16 è¡Œï¼šè°ƒç”¨ `Jedis#hset(key, value, expire)` æ–¹æ³•ï¼Œå†™å…¥ Redis Map ä¸­ã€‚**æ³¨æ„ï¼Œè¿‡æœŸæ—¶é—´ï¼Œä½œä¸º Map çš„å€¼**ã€‚
  - ç¬¬ 18 è¡Œï¼šè°ƒç”¨ `Jedis#publish(channel, message)` æ–¹æ³•ï¼Œå‘å¸ƒ `register` äº‹ä»¶ã€‚è¿™æ ·è®¢é˜…è¯¥ Key çš„æœåŠ¡æ¶ˆè´¹è€…å’Œç›‘æ§ä¸­å¿ƒï¼Œå°±ä¼šå®æ—¶ä» Redis è¯»å–**è¯¥æœåŠ¡**çš„æœ€æ–°æ•°æ®ã€‚
  - ç¬¬ 21 è‡³ 23 è¡Œï¼šå¦‚æœé `replicate` ï¼Œæ„å‘³ç€ Redis æœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨ã€‚å› æ­¤ï¼Œç»“æŸå¾ªç¯ã€‚å¦åˆ™ï¼Œæ»¡è¶³ `replicate` ï¼Œå‘æ‰€æœ‰ Redis å†™å…¥ã€‚
- ç¬¬ 31 è‡³ 38 è¡Œï¼šå¤„ç†å¼‚å¸¸ã€‚è¿™å—ä»£ç èƒ–å‹è‡ªå·±çœ‹ä¸‹ï¼Œæ³¨æ„ä¸‹ `exception` å’Œ `success` èµ‹å€¼çš„åœ°æ–¹ã€‚è¿™å—çš„æ‰“å°å‘Šè­¦æ—¥å¿—çš„å¤„ç†æ–¹å¼ï¼Œä¹Ÿé€‚ç”¨äºå¤šæ¬¡é‡è¯•æŸä¸ªæ“ä½œï¼Œç»“æœå‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯æœ€ç»ˆæˆåŠŸã€‚ä¾‹å¦‚ï¼ŒHTTP è¯·æ±‚è¿œç¨‹æœåŠ¡ã€‚

###### 2.1.1 toCategoryPath

```
/**
 * è·å¾—åˆ†ç±»è·¯å¾„
 *
 * Root + Service + Type
 *
 * @param url URL
 * @return åˆ†ç±»è·¯å¾„
 */
private String toCategoryPath(URL url) {
    return toServicePath(url) + Constants.PATH_SEPARATOR + url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);
}
```

#### 2.3 doUnregister

```
@Override
public void doUnregister(URL url) {
    String key = toCategoryPath(url);
    String value = url.toFullString();
    RpcException exception = null;
    boolean success = false;
    // å‘ Redis æ³¨å†Œ
    for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
        JedisPool jedisPool = entry.getValue();
        try {
            Jedis jedis = jedisPool.getResource();
            try {
                // åˆ é™¤ Redis Map é”®
                jedis.hdel(key, value);
                // å‘å¸ƒ Redis å–æ¶ˆæ³¨å†Œäº‹ä»¶
                jedis.publish(key, Constants.UNREGISTER);
                success = true;
                //  å¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨
                if (!replicate) {
                    break; //  If the server side has synchronized data, just write a single machine
                }
            } finally {
                jedisPool.returnResource(jedis);
            }
        } catch (Throwable t) {
            exception = new RpcException("Failed to unregister service to redis registry. registry: " + entry.getKey() + ", service: " + url + ", cause: " + t.getMessage(), t);
        }
    }
    // å¤„ç†å¼‚å¸¸
    if (exception != null) {
        if (success) { // è™½ç„¶å‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯ç»“æœæˆåŠŸ
            logger.warn(exception.getMessage(), exception);
        } else { // æœ€ç»ˆæœªæˆåŠŸ
            throw exception;
        }
    }
}
```

- å½“æœåŠ¡æ¶ˆè´¹è€…æˆ–æœåŠ¡æä¾›è€…ï¼Œå…³é—­æ—¶ï¼Œä¼šè°ƒç”¨ `#doUnregister(url)` æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šåˆ é™¤å¯¹åº” Map ä¸­çš„**é”®** + å‘å¸ƒ `unregister` äº‹ä»¶ï¼Œä»è€Œ**å®æ—¶**é€šçŸ¥è®¢é˜…è€…ä»¬ã€‚å› æ­¤ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå°±æ— éœ€ç›‘æ§ä¸­å¿ƒï¼Œåšè„æ•°æ®åˆ é™¤çš„å·¥ä½œã€‚
- ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ `#doRegister()` æ–¹æ³•ï¼Œé€»è¾‘ç›¸åã€‚

#### 2.4 doSubscribe

```
 1: @Override
 2: public void doSubscribe(final URL url, final NotifyListener listener) {
 3:     // è·å¾—æœåŠ¡è·¯å¾„ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService`
 4:     String service = toServicePath(url);
 5:     // è·å¾—é€šçŸ¥å™¨ Notifier å¯¹è±¡
 6:     Notifier notifier = notifiers.get(service);
 7:     // ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º Notifier å¯¹è±¡
 8:     if (notifier == null) {
 9:         Notifier newNotifier = new Notifier(service);
10:         notifiers.putIfAbsent(service, newNotifier);
11:         notifier = notifiers.get(service);
12:         if (notifier == newNotifier) { // ä¿è¯å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯åŠ¨
13:             notifier.start();
14:         }
15:     }
16:     boolean success = false;
17:     RpcException exception = null;
18:     // å¾ªç¯ `jedisPools` ï¼Œä»…å‘ä¸€ä¸ª Redis å‘èµ·è®¢é˜…
19:     for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
20:         JedisPool jedisPool = entry.getValue();
21:         try {
22:             Jedis jedis = jedisPool.getResource();
23:             try {
24:                 // å¤„ç†æ‰€æœ‰ Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚ç›‘æ§ä¸­å¿ƒçš„è®¢é˜…
25:                 if (service.endsWith(Constants.ANY_VALUE)) {
26:                     admin = true;
27:                     // è·å¾—åˆ†ç±»å±‚é›†åˆï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`
28:                     Set<String> keys = jedis.keys(service);
29:                     if (keys != null && !keys.isEmpty()) {
30:                         // æŒ‰ç…§æœåŠ¡èšåˆ URL é›†åˆ
31:                         Map<String, Set<String>> serviceKeys = new HashMap<String, Set<String>>(); // Keyï¼šRoot + Service ; Valueï¼šURL ã€‚
32:                         for (String key : keys) {
33:                             String serviceKey = toServicePath(key);
34:                             Set<String> sk = serviceKeys.get(serviceKey);
35:                             if (sk == null) {
36:                                 sk = new HashSet<String>();
37:                                 serviceKeys.put(serviceKey, sk);
38:                             }
39:                             sk.add(key);
40:                         }
41:                         // å¾ªç¯ serviceKeys ï¼ŒæŒ‰ç…§æ¯ä¸ª Service å±‚çš„å‘èµ·é€šçŸ¥
42:                         for (Set<String> sk : serviceKeys.values()) {
43:                             doNotify(jedis, sk, url, Collections.singletonList(listener));
44:                         }
45:                     }
46:                 // å¤„ç†æŒ‡å®š Service å±‚çš„å‘èµ·é€šçŸ¥
47:                 } else {
48:                     doNotify(jedis, jedis.keys(service + Constants.PATH_SEPARATOR + Constants.ANY_VALUE), url, Collections.singletonList(listener));
49:                 }
50:                 // æ ‡è®°æˆåŠŸ
51:                 success = true;
52:                 // ç»“æŸï¼Œä»…ä»…ä»ä¸€å°æœåŠ¡å™¨è¯»å–æ•°æ®
53:                 break; // Just read one server's data
54:             } finally {
55:                 jedisPool.returnResource(jedis);
56:             }
57:         } catch (Throwable t) { // Try the next server
58:             exception = new RpcException("Failed to subscribe service from redis registry. registry: " + entry.getKey() + ", service: " + url + ", cause: " + t.getMessage(), t);
59:         }
60:     }
61:     // å¤„ç†å¼‚å¸¸
62:     if (exception != null) {
63:         if (success) { // è™½ç„¶å‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯ç»“æœæˆåŠŸ
64:             logger.warn(exception.getMessage(), exception);
65:         } else { // æœ€ç»ˆæœªæˆåŠŸ
66:             throw exception;
67:         }
68:     }
69: }
```

- ========== ã€ç¬¬ä¸€æ­¥ã€‘Notifier éƒ¨åˆ† ==========
- ç¬¬ 4 è¡Œï¼šè°ƒç”¨ `#toServicePath(url)` æ–¹æ³•ï¼Œè·å¾—æœåŠ¡è·¯å¾„ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService` ã€‚
- ç¬¬ 6 è¡Œï¼šè·å¾—é€šçŸ¥å™¨ Notifier å¯¹è±¡ã€‚
- ç¬¬ 8 è‡³ 15 è¡Œï¼šè‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º Notifier å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ `Notifier#start()` æ–¹æ³•ã€‚
- ========== ã€ç¬¬äºŒæ­¥ã€‘è·å–åˆå§‹åŒ–æ•°æ®ï¼Œå¹¶è¿›è¡Œé€šçŸ¥ ==========
- ç¬¬ 19 è¡Œï¼šå¾ªç¯ `jedisPools` ï¼Œå‘ Redis å‘èµ·è®¢é˜…ï¼Œ**ç›´åˆ°ä¸€ä¸ªæˆåŠŸ**ã€‚æˆ‘ä»¬ä¼šçœ‹åˆ°ä»£ç ï¼Œåˆ†æˆ**ä¸¤ä¸ªéƒ¨åˆ†**ã€‚
- ã€ç¬¬äºŒéƒ¨åˆ†ã€‘ç¬¬ 46 è‡³ 49 è¡Œï¼Œé€‚ç”¨æœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…ï¼Œå¤„ç†**æŒ‡å®š** Service å±‚çš„åˆå§‹åŒ–æ•°æ®ï¼š
- ç¬¬ 48 è¡Œï¼šè°ƒç”¨ `Jedis#keys(pattern)` æ–¹æ³•ï¼Œè·å¾—**æŒ‡å®š** Service å±‚ä¸‹çš„æ‰€æœ‰ URL ä»¬ã€‚ä¾‹å¦‚ `/dubbo/com.alibaba.dubbo.demo.DemoService/*` ã€‚
- ç¬¬ 48 è¡Œï¼šè°ƒç”¨ `#doNotify(jedis, keys, url, listeners)` æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼Œåˆå§‹çš„æ•°æ®ã€‚
- ã€ç¬¬ä¸€éƒ¨åˆ†ã€‘ç¬¬ 25 è‡³ 45 è¡Œï¼Œé€‚ç”¨æ³¨å†Œä¸­å¿ƒï¼Œå¤„ç†**æ‰€æœ‰** Service å±‚çš„åˆå§‹åŒ–æ•°æ®ï¼š
- ç¬¬ 26 è¡Œï¼šæ ‡è®° `admin = true` ã€‚å› ä¸ºï¼Œåªæœ‰æ³¨å†Œä¸­å¿ƒï¼Œæ‰æ¸…ç†è„æ•°æ®ã€‚
- ç¬¬ 28 è¡Œï¼šè°ƒç”¨ `Jedis#keys(pattern)` æ–¹æ³•ï¼Œè·å¾—**æ‰€æœ‰** Service å±‚ä¸‹çš„æ‰€æœ‰ URL ä»¬ã€‚ä¾‹å¦‚ `/dubbo/*` ã€‚
- ç¬¬ 31 è‡³ 39 è¡Œï¼šæŒ‰ç…§**æœåŠ¡**èšåˆ URL é›†åˆã€‚
- ç¬¬ 42 è‡³ 44 è¡Œï¼šå¾ªç¯ `serviceKeys` ï¼Œè°ƒç”¨ `#doNotify(jedis, keys, url, listeners)` æ–¹æ³•ï¼ŒæŒ‰ç…§**æ¯ä¸ª Service å±‚**ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼Œåˆå§‹çš„æ•°æ®ã€‚æ­¤å¤„ï¼Œå°±å’Œã€ç¬¬ 48 è¡Œã€‘**ç±»ä¼¼**ã€‚

å¦å¤–ï¼Œè®¢é˜…åŠ¨ä½œï¼ˆã€ç¬¬ä¸€æ­¥ã€‘ï¼‰**ä¸€å®š**è¦åœ¨è·å–åˆå§‹åŒ–æ•°æ®ï¼ˆã€ç¬¬äºŒæ­¥ã€‘ï¼‰**ä¹‹å‰**ã€‚å¦‚æœåè¿‡æ¥ï¼Œå¯èƒ½è·å–æ•°æ®å®Œåï¼Œå¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰æ•°æ®çš„å˜æ›´ï¼Œæˆ‘ä»¬å°±æ— æ³•æ”¶åˆ° `register` `unregister` çš„äº‹ä»¶ã€‚

###### 2.4.1 toServicePath

```
/**
 * è·å¾—æœåŠ¡è·¯å¾„
 *
 * Root + Type
 *
 * @param url URL
 * @return æœåŠ¡è·¯å¾„
 */
private String toServicePath(URL url) {
    return root + url.getServiceInterface();
}
```

###### 2.4.2 toServicePath

```
/**
 * è·å¾—æœåŠ¡è·¯å¾„ï¼Œä¸»è¦æˆªæ‰å¤šä½™çš„éƒ¨åˆ†
 *
 * Root + Type
 *
 * @param categoryPath åˆ†ç±»è·¯å¾„
 * @return æœåŠ¡è·¯å¾„
 */
private String toServicePath(String categoryPath) {
    int i;
    if (categoryPath.startsWith(root)) {
        i = categoryPath.indexOf(Constants.PATH_SEPARATOR, root.length());
    } else {
        i = categoryPath.indexOf(Constants.PATH_SEPARATOR);
    }
    return i > 0 ? categoryPath.substring(0, i) : categoryPath;
}
```

#### 2.5 doUnsubscribe

```
@Override
public void doUnsubscribe(URL url, NotifyListener listener) {
}
```

- æ­¤å¤„ç›®å‰å¹¶æœªå®ç°ï¼Œè‰¿è‰¿è§‰å¾—ï¼Œæ­¤å¤„åº”è¯¥å¢åŠ å–æ¶ˆå‘ Redis çš„è®¢é˜…( Subscribe ) ã€‚åœ¨ ZookeeperRegistry çš„è¯¥æ–¹æ³•ä¸­ï¼Œæ˜¯ç§»é™¤äº†å¯¹åº”çš„ç›‘å¬å™¨ã€‚

#### 2.6 doNotify

```
 1: // @params key åˆ†ç±»æ•°ç»„ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`
 2: private void doNotify(Jedis jedis, String key) {
 3:     for (Map.Entry<URL, Set<NotifyListener>> entry : new HashMap<URL, Set<NotifyListener>>(getSubscribed()).entrySet()) {
 4:         doNotify(jedis, Collections.singletonList(key), entry.getKey(), new HashSet<NotifyListener>(entry.getValue()));
 5:     }
 6: }
 7: 
 8: // @params keys åˆ†ç±»æ•°ç»„ï¼Œå…ƒç´ ä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`
 9: private void doNotify(Jedis jedis, Collection<String> keys, URL url, Collection<NotifyListener> listeners) {
10:     if (keys == null || keys.isEmpty() || listeners == null || listeners.isEmpty()) {
11:         return;
12:     }
13:     long now = System.currentTimeMillis();
14:     List<URL> result = new ArrayList<URL>();
15:     List<String> categories = Arrays.asList(url.getParameter(Constants.CATEGORY_KEY, new String[0])); // åˆ†ç±»æ•°ç»„
16:     String consumerService = url.getServiceInterface(); // æœåŠ¡æ¥å£
17:     // å¾ªç¯åˆ†ç±»å±‚ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`
18:     for (String key : keys) {
19:         // è‹¥æœåŠ¡ä¸åŒ¹é…ï¼Œè¿”å›
20:         if (!Constants.ANY_VALUE.equals(consumerService)) {
21:             String providerService = toServiceName(key);
22:             if (!providerService.equals(consumerService)) {
23:                 continue;
24:             }
25:         }
26:         // è‹¥è®¢é˜…çš„ä¸åŒ…å«è¯¥åˆ†ç±»ï¼Œè¿”å›
27:         String category = toCategoryName(key);
28:         if (!categories.contains(Constants.ANY_VALUE) && !categories.contains(category)) {
29:             continue;
30:         }
31:         // è·å¾—æ‰€æœ‰ URL æ•°ç»„
32:         List<URL> urls = new ArrayList<URL>();
33:         Map<String, String> values = jedis.hgetAll(key);
34:         if (values != null && values.size() > 0) {
35:             for (Map.Entry<String, String> entry : values.entrySet()) {
36:                 URL u = URL.valueOf(entry.getKey());
37:                 if (!u.getParameter(Constants.DYNAMIC_KEY, true) // éåŠ¨æ€èŠ‚ç‚¹ï¼Œå› ä¸ºåŠ¨æ€èŠ‚ç‚¹ï¼Œä¸å—è¿‡æœŸçš„é™åˆ¶
38:                         || Long.parseLong(entry.getValue()) >= now) { // æœªè¿‡æœŸ
39:                     if (UrlUtils.isMatch(url, u)) {
40:                         urls.add(u);
41:                     }
42:                 }
43:             }
44:         }
45:         // è‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º `empty://` çš„ URLè¿”å›ï¼Œç”¨äºæ¸…ç©ºè¯¥æœåŠ¡çš„è¯¥åˆ†ç±»ã€‚
46:         if (urls.isEmpty()) {
47:             urls.add(url.setProtocol(Constants.EMPTY_PROTOCOL)
48:                     .setAddress(Constants.ANYHOST_VALUE)
49:                     .setPath(toServiceName(key))
50:                     .addParameter(Constants.CATEGORY_KEY, category));
51:         }
52:         result.addAll(urls);
53:         if (logger.isInfoEnabled()) {
54:             logger.info("redis notify: " + key + " = " + urls);
55:         }
56:     }
57:     if (result.isEmpty()) {
58:         return;
59:     }
60:     // å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œè°ƒç”¨ `super#notify(...)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener
61:     for (NotifyListener listener : listeners) {
62:         super.notify(url, listener, result);
63:     }
64: }
```

- ä¸¤ä¸ªé‡è½½çš„ `#doNotify(...)` æ–¹æ³•ï¼Œä¸»è¦å·®å¼‚ç‚¹åœ¨å‰è€…å°‘ `url` å’Œ `listeners` æ–¹æ³•å‚æ•°ã€‚æ‰€ä»¥ï¼š

  - ç¬¬ 3 è¡Œï¼šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è°ƒç”¨ `#getSubscribed()` æ–¹æ³•ï¼Œè·å¾—**æ‰€æœ‰**ç›‘å¬å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
    /**
     * è®¢é˜… URL çš„ç›‘å¬å™¨é›†åˆ
     *
     * keyï¼šè®¢é˜…è€…çš„ URL ï¼Œä¾‹å¦‚æ¶ˆè´¹è€…çš„ URL
     */
    private final ConcurrentMap<URL, Set<NotifyListener>> subscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();
    ```

    - x

  - ç¬¬ 3 è‡³ 5 è¡Œï¼š**å¾ªç¯**è°ƒç”¨ `#doNotify(jedis, keys, url, listeners)` æ–¹æ³•ï¼Œè¿›è¡Œé€šçŸ¥ã€‚**ä½†æ˜¯å‘¢**ï¼Ÿè¿™æ ·ä¸€æ¥ï¼Œé€šçŸ¥çš„äº‹ä»¶( `key` )å’Œç›‘å¬å™¨æœªå¿…åŒ¹é…ï¼Œå› æ­¤åœ¨ã€ç¬¬ 20 è‡³ 30 è¡Œã€‘çš„ä»£ç ï¼Œè¿›è¡ŒåŒ¹é…ã€‚

- ç¬¬ 15 è¡Œï¼šè·å¾—åˆ†ç±»å±‚( Category )ï¼Œå³åˆ†ç±»æ•°ç»„ã€‚åœ¨

   

  ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆäºŒï¼‰ä¹‹ Zookeeperã€‹ã€Œ4. è°ƒç”¨ã€

   

  å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°ï¼Œä¸åŒè§’è‰²å…³æ³¨ä¸åŒçš„åˆ†ç±»æ•°æ®ã€‚

  - æœåŠ¡æ¶ˆè´¹è€…ï¼Œå…³æ³¨ `providers` `configurations` `routes` ã€‚
  - æœåŠ¡æä¾›è€…ï¼Œå…³æ³¨ `consumers` ã€‚
  - ç›‘æ§ä¸­å¿ƒï¼Œå…³æ³¨æ‰€æœ‰ã€‚

- ç¬¬ 18 è¡Œï¼šå¾ªç¯åˆ†ç±»å±‚ï¼Œå³æ¯ä¸ªå…ƒç´ ä¸º Root + Service + Type ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers` ã€‚

- ç¬¬ 32 è‡³ 44 è¡Œï¼šè°ƒç”¨ `Jedis#hgetAll(key)` æ–¹æ³•ï¼Œè·å¾—æ‰€æœ‰ URL æ•°ç»„ã€‚å¹¶ä¸”ï¼Œè·å–å®Œæˆåï¼Œä¼šè¿‡æ»¤æ‰**å·²è¿‡æœŸ**çš„**åŠ¨æ€**èŠ‚ç‚¹ã€‚

- ç¬¬ 45 è‡³ 51 è¡Œï¼šè‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º `empty://` çš„ URLè¿”å›ï¼Œç”¨äº**æ¸…ç©º**è¯¥æœåŠ¡çš„è¯¥åˆ†ç±»ã€‚

- ç¬¬ 52 è¡Œï¼šæ·»åŠ åˆ° `result` ä¸­ã€‚

- ç¬¬ 60 è‡³ 63 è¡Œï¼šå…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œè°ƒç”¨ `super#notify(...)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener ã€‚è¯¥æ–¹æ³•ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://svip.iocoder.cn/Dubbo/registry-api/?self) æœ‰è¯¦ç»†è§£æã€‚

###### 2.6.1 toServiceName

```
/**
 * è·å¾—æœåŠ¡åï¼Œä»æœåŠ¡è·¯å¾„ä¸Š
 *
 * Service
 *
 * @param categoryPath æœåŠ¡è·¯å¾„
 * @return æœåŠ¡å
 */
private String toServiceName(String categoryPath) {
    String servicePath = toServicePath(categoryPath);
    return servicePath.startsWith(root) ? servicePath.substring(root.length()) : servicePath;
}
```

###### 2.6.2 toCategoryName

```
/**
 * è·å¾—åˆ†ç±»åï¼Œä»åˆ†ç±»è·¯å¾„ä¸Š
 *
 * Type
 *
 * @param categoryPath åˆ†ç±»è·¯å¾„
 * @return åˆ†ç±»å
 */
private String toCategoryName(String categoryPath) {
    int i = categoryPath.lastIndexOf(Constants.PATH_SEPARATOR);
    return i > 0 ? categoryPath.substring(i + 1) : categoryPath;
}
```

#### 2.7 deferExpired

```
 1: private void deferExpired() {
 2:     for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
 3:         JedisPool jedisPool = entry.getValue();
 4:         try {
 5:             Jedis jedis = jedisPool.getResource();
 6:             try {
 7:                 // å¾ªç¯å·²æ³¨å†Œçš„ URL é›†åˆ
 8:                 for (URL url : new HashSet<URL>(getRegistered())) {
 9:                     // åŠ¨æ€èŠ‚ç‚¹
10:                     if (url.getParameter(Constants.DYNAMIC_KEY, true)) {
11:                         // è·å¾—åˆ†ç±»è·¯å¾„
12:                         String key = toCategoryPath(url);
13:                         // å†™å…¥ Redis Map ä¸­
14:                         if (jedis.hset(key, url.toFullString(), String.valueOf(System.currentTimeMillis() + expirePeriod)) == 1) {
15:                             // å‘å¸ƒ `register` äº‹ä»¶ã€‚
16:                             jedis.publish(key, Constants.REGISTER);
17:                         }
18:                     }
19:                 }
20:                 // ç›‘æ§ä¸­å¿ƒè´Ÿè´£åˆ é™¤è¿‡æœŸè„æ•°æ®
21:                 if (admin) {
22:                     clean(jedis);
23:                 }
24:                 // å¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨
25:                 if (!replicate) {
26:                     break;//  If the server side has synchronized data, just write a single machine
27:                 }
28:             } finally {
29:                 jedisPool.returnResource(jedis);
30:             }
31:         } catch (Throwable t) {
32:             logger.warn("Failed to write provider heartbeat to redis registry. registry: " + entry.getKey() + ", cause: " + t.getMessage(), t);
33:         }
34:     }
35: }
```

- è¢« `expireExecutor` ä¸­çš„å®šæ—¶è°ƒç”¨ï¼Œæ•´ä½“é€»è¾‘ç±»ä¼¼ `#doRegister()` æ–¹æ³•ã€‚

- ç¬¬ 8 è¡Œï¼šè°ƒç”¨ `#getRegistered()` æ–¹æ³•ï¼Œè·å¾—å·²æ³¨å†Œçš„ URL é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  /**
   * å·²æ³¨å†Œ URL é›†åˆã€‚
   *
   * æ³¨æ„ï¼Œæ³¨å†Œçš„ URL ä¸ä»…ä»…å¯ä»¥æ˜¯æœåŠ¡æä¾›è€…çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æ¶ˆè´¹è€…çš„
   */
  private final Set<URL> registered = new ConcurrentHashSet<URL>();
  ```

- ç¬¬ 8 è¡Œï¼šå¾ªç¯ URL é›†åˆã€‚

- ç¬¬ 10 è¡Œï¼šåˆ¤æ–­æ˜¯å¦ä¸º**åŠ¨æ€**èŠ‚ç‚¹ï¼Œåªæœ‰åŠ¨æ€èŠ‚ç‚¹éœ€è¦å»¶é•¿è¿‡æœŸæ—¶é—´ã€‚

- ç¬¬ 14 è¡Œï¼šè°ƒç”¨ `Jedis#hset(key, value, expire)` æ–¹æ³•ï¼Œå†™å…¥ Redis Map ä¸­ã€‚**æ³¨æ„ï¼Œè¿‡æœŸæ—¶é—´ï¼Œä½œä¸º Map çš„å€¼**ã€‚

- ç¬¬ 16 è¡Œï¼šè‹¥ã€ç¬¬ 14 è¡Œã€‘å†™å…¥è¿”å›çš„å€¼ä¸º 1 ï¼Œè¯´æ˜ Map ä¸­è¯¥é”®å¯¹åº”çš„å€¼ä¸å­˜åœ¨ï¼ˆä¾‹å¦‚ï¼Œå¤šå†™ Redis èŠ‚ç‚¹æ—¶ï¼Œæœ‰ä¸ªèŠ‚ç‚¹å†™å…¥å¤±è´¥ï¼‰ï¼Œå‘å¸ƒ `register` äº‹ä»¶ã€‚

- ç¬¬ 21 è‡³ 23 è¡Œï¼šè‹¥æ˜¯æ³¨å†Œä¸­å¿ƒ( `admin = true` ) æ—¶ï¼Œè°ƒç”¨ `#clean(Jedis)` æ–¹æ³•ï¼Œæ¸…ç†è¿‡æœŸè„æ•°æ®ã€‚

- ç¬¬ 25 è‡³ 27 è¡Œï¼šå¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨ã€‚

###### 2.7.1 clean

```
private void clean(Jedis jedis) {
    // è·å¾—æ‰€æœ‰æœåŠ¡
    Set<String> keys = jedis.keys(root + Constants.ANY_VALUE);
    if (keys != null && !keys.isEmpty()) {
        for (String key : keys) {
            // è·å¾—æ‰€æœ‰ URL
            Map<String, String> values = jedis.hgetAll(key);
            if (values != null && values.size() > 0) {
                boolean delete = false;
                long now = System.currentTimeMillis();
                for (Map.Entry<String, String> entry : values.entrySet()) {
                    URL url = URL.valueOf(entry.getKey());
                    // åŠ¨æ€èŠ‚ç‚¹
                    if (url.getParameter(Constants.DYNAMIC_KEY, true)) {
                        long expire = Long.parseLong(entry.getValue());
                        // å·²ç»è¿‡æœŸ
                        if (expire < now) {
                            //
                            jedis.hdel(key, entry.getKey());
                            delete = true;
                            if (logger.isWarnEnabled()) {
                                logger.warn("Delete expired key: " + key + " -> value: " + entry.getKey() + ", expire: " + new Date(expire) + ", now: " + new Date(now));
                            }
                        }
                    }
                }
                // è‹¥åˆ é™¤æˆåŠŸï¼Œå‘å¸ƒ `unregister` äº‹ä»¶
                if (delete) {
                    jedis.publish(key, Constants.UNREGISTER);
                }
            }
        }
    }
}
```

- æ•´ä½“é€»è¾‘ç±»ä¼¼ `#doUnregister()` æ–¹æ³•ã€‚
- ğŸ™‚ èƒ–å‹è‡ªå·±çœ‹æ–¹æ³•çš„æ³¨é‡Šå“ˆã€‚

#### 2.8 isAvailable

```
@Override
public boolean isAvailable() {
    for (JedisPool jedisPool : jedisPools.values()) {
        try {
            Jedis jedis = jedisPool.getResource();
            try {
                if (jedis.isConnected()) { // è‡³å°‘ä¸€ä¸ª Redis èŠ‚ç‚¹å¯ç”¨
                    return true; // At least one single machine is available.
                }
            } finally {
                jedisPool.returnResource(jedis);
            }
        } catch (Throwable ignored) {
        }
    }
    return false;
}
```

#### 2.9 destroy

```
@Override
public void destroy() {
    // çˆ¶ç±»å…³é—­
    super.destroy();
    // å…³é—­å®šæ—¶ä»»åŠ¡
    try {
        expireFuture.cancel(true);
    } catch (Throwable t) {
        logger.warn(t.getMessage(), t);
    }
    // å…³é—­é€šçŸ¥å™¨
    try {
        for (Notifier notifier : notifiers.values()) {
            notifier.shutdown();
        }
    } catch (Throwable t) {
        logger.warn(t.getMessage(), t);
    }
    // å…³é—­è¿æ¥æ± 
    for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
        JedisPool jedisPool = entry.getValue();
        try {
            jedisPool.destroy();
        } catch (Throwable t) {
            logger.warn("Failed to destroy the redis registry client. registry: " + entry.getKey() + ", cause: " + t.getMessage(), t);
        }
    }
}
```

## 3. Notifier

> Notifier æ˜¯ RedisRegistry çš„å†…éƒ¨ç±»ã€‚

Notifier ï¼Œç»§æ‰¿ Thread ç±»ï¼Œè´Ÿè´£å‘ Redis å‘èµ·è®¢é˜…é€»è¾‘ã€‚

#### 3.1 æ„é€ æ–¹æ³•

```
 1: /**
 2:  * æœåŠ¡å Root + Service
 3:  */
 4: private final String service;
 5: /**
 6:  * Jedis
 7:  */
 8: private volatile Jedis jedis;
 9: /**
10:  * æ˜¯å¦é¦–æ¬¡
11:  */
12: private volatile boolean first = true;
13: /**
14:  * æ˜¯å¦è¿è¡Œä¸­
15:  */
16: private volatile boolean running = true;
17: /**
18:  * è¿æ¥æ¬¡æ•°éšæœºæ•°
19:  */
20: private volatile int connectRandom;
21: /**
22:  * éœ€è¦å¿½ç•¥è¿æ¥çš„æ¬¡æ•°
23:  */
24: private final AtomicInteger connectSkip = new AtomicInteger();
25: /**
26:  * å·²ç»å¿½ç•¥è¿æ¥çš„æ¬¡æ•°
27:  */
28: private final AtomicInteger connectSkiped = new AtomicInteger();
29: /**
30:  * éšæœº
31:  */
32: private final Random random = new Random();
```

- `service` å±æ€§ï¼ŒæœåŠ¡å Root + Serviceã€‚

- `first` å±æ€§ï¼Œæ˜¯å¦é¦–æ¬¡ã€‚åœ¨ `#run()` æ–¹æ³•ä¸­ï¼ŒæŸ¥çœ‹ã€‚

- ã€ç¬¬ 13 è‡³ 32 è¡Œã€‘çš„å±æ€§ï¼Œç›¸å½“äº**é‡è¿ç­–ç•¥**ï¼Œç”¨äºå’Œ Redis æ–­å¼€æ—¶ï¼Œå¿½ç•¥ä¸€å®šæ¬¡æ•°å’Œ Redis çš„è¿æ¥ï¼Œé¿å…ç©ºè·‘ã€‚æ¶‰åŠæ–¹æ³•å¦‚ä¸‹ï¼š

  - `#isSkip()` æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å¿½ç•¥æœ¬æ¬¡å¯¹ Redis çš„è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
     1: private boolean isSkip() {
     2:     // è·å¾—éœ€è¦å¿½ç•¥è¿æ¥çš„æ€»æ¬¡æ•°ã€‚å¦‚æœè¶…è¿‡ 10 ï¼Œåˆ™åŠ ä¸Šä¸€ä¸ª 10 ä»¥å†…çš„éšæœºæ•°ã€‚
     3:     int skip = connectSkip.get(); // Growth of skipping times
     4:     if (skip >= 10) { // If the number of skipping times increases by more than 10, take the random number
     5:         if (connectRandom == 0) {
     6:             connectRandom = random.nextInt(10);
     7:         }
     8:         skip = 10 + connectRandom;
     9:     }
    10:     // è‡ªå¢å¿½ç•¥æ¬¡æ•°ã€‚è‹¥å¿½ç•¥æ¬¡æ•°ä¸å¤Ÿï¼Œåˆ™ç»§ç»­å¿½ç•¥ã€‚
    11:     if (connectSkiped.getAndIncrement() < skip) { // Check the number of skipping times
    12:         return true;
    13:     }
    14:     // å¢åŠ éœ€è¦å¿½ç•¥çš„æ¬¡æ•°
    15:     connectSkip.incrementAndGet();
    16:     // é‡ç½®å·²å¿½ç•¥æ¬¡æ•°å’Œéšæœºæ•°
    17:     connectSkiped.set(0);
    18:     connectRandom = 0;
    19:     return false;
    20: }
    ```

    - ç¬¬ 2 è‡³ 9 è¡Œï¼šè·å¾—**éœ€è¦å¿½ç•¥è¿æ¥çš„æ€»æ¬¡æ•°**ã€‚å¦‚æœè¶…è¿‡ 10 ï¼Œåˆ™åŠ ä¸Šä¸€ä¸ª 10 ä»¥å†…çš„éšæœºæ•°ã€‚æ€è·¯æ˜¯ï¼Œè¿æ¥å¤±è´¥çš„æ¬¡æ•°è¶Šå¤šï¼Œ**æ¯ä¸€è½®**åŠ å¤§éœ€è¦å¿½ç•¥çš„æ€»æ¬¡æ•°ï¼Œå¹¶ä¸”å¸¦æœ‰ä¸€å®šçš„éšæœºæ€§ã€‚

    - ç¬¬ 10 è‡³ 13 è¡Œï¼šè‡ªå¢å¿½ç•¥æ¬¡æ•°ã€‚è‹¥å¿½ç•¥æ¬¡æ•°ä¸å¤Ÿï¼Œåˆ™ç»§ç»­å¿½ç•¥ï¼Œå³è¿”å› `true` ã€‚

    - ç¬¬ 15 è¡Œï¼šå¢åŠ éœ€è¦å¿½ç•¥çš„æ¬¡æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**ä¸‹ä¸€è½®**ï¼Œä¸è€ƒè™‘éšæœºæ•°ï¼Œä¼šå¤šä¸€æ¬¡ã€‚å¦‚ä¸‹æ˜¯ä¸€æ¬¡æ¨¡æ‹Ÿï¼š

      > ç¬¬ä¸€è½®
      >
      > - connectSkip: 0; connectSkiped: 0
      >
      > ç¬¬äºŒè½®
      >
      > - connectSkip: 1; connectSkiped: 0
      > - connectSkip: 1; connectSkiped: 1
      >
      > ç¬¬ä¸‰è½®
      >
      > - connectSkip: 2; connectSkiped: 0
      > - connectSkip: 2; connectSkiped: 1
      > - connectSkip: 2; connectSkiped: 2

      - å½“è¶…è¿‡åè½®åï¼Œå¢åŠ éšæœºæ•°ã€‚

    - ç¬¬ 16 è‡³ 18 è¡Œï¼šé‡ç½®å·²å¿½ç•¥æ¬¡æ•°å’Œéšæœºæ•°ã€‚

  - `#resetSkip()` æ–¹æ³•ï¼Œé‡ç½®å¿½ç•¥è¿æ¥çš„ä¿¡æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
    private void resetSkip() {
        // é‡ç½®éœ€è¦è¿æ¥çš„æ¬¡æ•°
        connectSkip.set(0);
        // é‡ç½®å·²å¿½ç•¥æ¬¡æ•°å’Œéšæœºæ•°
        connectSkiped.set(0);
        connectRandom = 0;
    }
    ```

    - x

#### 3.2 run

```
 1: @Override
 2: public void run() {
 3:     while (running) {
 4:         try {
 5:             // æ˜¯å¦è·³è¿‡æœ¬æ¬¡ Redis è¿æ¥
 6:             if (!isSkip()) {
 7:                 try {
 8:                     for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
 9:                         JedisPool jedisPool = entry.getValue();
10:                         try {
11:                             jedis = jedisPool.getResource();
12:                             try {
13:                                 // ç›‘æ§ä¸­å¿ƒ
14:                                 if (service.endsWith(Constants.ANY_VALUE)) {
15:                                     if (!first) {
16:                                         first = false;
17:                                         Set<String> keys = jedis.keys(service);
18:                                         if (keys != null && !keys.isEmpty()) {
19:                                             for (String s : keys) {
20:                                                 doNotify(jedis, s);
21:                                             }
22:                                         }
23:                                         resetSkip();
24:                                     }
25:                                     // æ‰¹è®¢é˜…
26:                                     jedis.psubscribe(new NotifySub(jedisPool), service); // blocking
27:                                 // æœåŠ¡æä¾›è€…æˆ–æ¶ˆè´¹è€…
28:                                 } else {
29:                                     if (!first) {
30:                                         first = false;
31:                                         doNotify(jedis, service);
32:                                         resetSkip();
33:                                     }
34:                                     // æ‰¹è®¢é˜…
35:                                     jedis.psubscribe(new NotifySub(jedisPool), service + Constants.PATH_SEPARATOR + Constants.ANY_VALUE); // blocking
36:                                 }
37:                                 break;
38:                             } finally {
39:                                 jedisPool.returnBrokenResource(jedis);
40:                             }
41:                         } catch (Throwable t) { // Retry another server
42:                             logger.warn("Failed to subscribe service from redis registry. registry: " + entry.getKey() + ", cause: " + t.getMessage(), t);
43:                             // If you only have a single redis, you need to take a rest to avoid overtaking a lot of CPU resources
44:                             sleep(reconnectPeriod);
45:                         }
46:                     }
47:                 } catch (Throwable t) {
48:                     logger.error(t.getMessage(), t);
49:                     sleep(reconnectPeriod);
50:                 }
51:             }
52:         } catch (Throwable t) {
53:             logger.error(t.getMessage(), t);
54:         }
55:     }
56: }
```

- ç¬¬ 3 è¡Œï¼šå¾ªç¯æ‰§è¡Œï¼Œç›´åˆ°å…³é—­ã€‚

- ç¬¬ 6 è¡Œï¼šè°ƒç”¨ `#isSkip()` æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è·³è¿‡æœ¬æ¬¡ Redis è¿æ¥ã€‚But ï¼Œå³ä½¿è·³è¿‡ï¼Œä¹Ÿæ²¡æœ‰æ‰§è¡Œç±»ä¼¼ sleep çš„é€»è¾‘ï¼Œæœ‰ç‚¹å¥‡æ€ªã€‚è¿™æ ·ï¼Œä¼šå¯¼è‡´å®é™…å³ä½¿è·³è¿‡ï¼Œä¹Ÿä¼šå¿«é€Ÿå‘ Redis å‘èµ·è®¢é˜…ã€‚ã€TODO 8032ã€‘Redis é‡è¿é€»è¾‘

- ç¬¬ 8 è¡Œï¼šå¾ªç¯è¿æ¥æ± ï¼Œå‘èµ·è®¢é˜…ï¼Œç›´åˆ°**ä¸€ä¸ªæˆåŠŸ**ã€‚

- ======================================================

- ã€ç¬¬ä¸€ç§æƒ…å†µã€‘ç¬¬ 14 è‡³ 26 è¡Œï¼šç›‘æ§ä¸­å¿ƒ

  - ç¬¬ 15 è‡³ 24 è¡Œï¼šç›®å‰è¿™å—ä»£ç æœ‰ä¸€äº›é—®é¢˜ï¼Ÿï¼åˆå§‹æ—¶ `first=true` ï¼Œé‚£ä¹ˆè¿™å—ä»£ç æ°¸è¿œæ— æ³•æ‰§è¡Œåˆ°ã€‚ç¬”è€…çŒœæµ‹è¿™å—çš„æ„å›¾æ˜¯ï¼Œåœ¨ ZookeeperRegistry ä¸­ï¼Œå¯ä»¥å®ç°å¯¹è¿æ¥çŠ¶æ€çš„ç›‘å¬ï¼Œä»è€Œå®ç°æ–­å¼€é‡è¿æˆåŠŸåï¼Œä» Zookeeper è·å–åˆ°æœ€æ–°çš„æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
            zkClient.addStateListener(new StateListener() {
                public void stateChanged(int state) {
                    if (state == RECONNECTED) {
                        try {
                            recover();
                        } catch (Exception e) {
                            logger.error(e.getMessage(), e);
                        }
                    }
                }
            });
    ```

            * è€Œ JedisPool ä¸­ï¼Œä¸æä¾›è¿™æ ·çš„è¿æ¥ç›‘æ§æœºåˆ¶ã€‚é‚£ä¹ˆå¦‚æœè®¢é˜… Redis å‘ç”Ÿäº†å¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸º Redis è¿æ¥æ–­å¼€äº†ï¼Œéœ€è¦é‡æ–°å‘èµ·è®¢é˜…ï¼Œå¹¶ä¸”éœ€è¦**é‡æ–°**ä» Redis ä¸­è·å–åˆ°æœ€æ–°çš„æ•°æ®ã€‚
            * é‚£ä¹ˆæ­¤å¤„çš„ä»£ç å¯ä»¥è¿™æ ·æ”¹ï¼š
                * ç¬¬ 16 è¡Œï¼š `first = true;`
                * ç¬¬ 42 è¡Œï¼šå¢åŠ  `first = false;`
        * ç¬¬ 26 è¡Œï¼šè°ƒç”¨ `Jedis#psubscribe(JedisPubSub jedisPubSub, String... patterns)` æ–¹æ³•ï¼Œè®¢é˜…**æ‰€æœ‰ Service å±‚**ã€‚

    * ã€ç¬¬äºŒç§æƒ…å†µã€‘ç¬¬ 27 è‡³ 36 è¡Œï¼šæœåŠ¡æä¾›è€…æˆ–æ¶ˆè´¹è€…ã€‚
      * ç¬¬ 29 è‡³ 34 è¡Œï¼šå’Œã€ç¬¬ 15 è‡³ 24 è¡Œã€‘**ç±»ä¼¼**ã€‚
      * ç¬¬ 35 è¡Œï¼šè°ƒç”¨ `Jedis#psubscribe(JedisPubSub jedisPubSub, String... patterns)` æ–¹æ³•ï¼Œè®¢é˜…**æŒ‡å®š Service å±‚**ã€‚
    * ======================================================
    * ç¬¬ 37 è‡³ 40 è¡Œï¼šæ— æ³•æ‰§è¡Œåˆ°ï¼Œå› ä¸º `Jedis#psubscribe(JedisPubSub jedisPubSub, String... patterns)` æ–¹æ³•ï¼Œæ˜¯**é˜»å¡**çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Notifier æ˜¯ä¸€ä¸ª **Thread** çš„åŸå› ã€‚
    * ç¬¬ 41 è‡³ 45 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œè¯´æ˜ Redis è¿æ¥æ–­å¼€äº†ã€‚å› æ­¤ï¼Œè°ƒç”¨ `#sleep(millis)` æ–¹æ³•ï¼Œç­‰å¾… Redis é‡è¿æˆåŠŸã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œé¿å…æ‰§è¡Œï¼Œå ç”¨å¤§é‡çš„ CPU èµ„æºã€‚

    #### 3.3 shutdown

    ```Java
    public void shutdown() {
        try {
            // åœæ­¢è¿è¡Œ
            running = false;
            // Jedis æ–­å¼€è¿æ¥
            jedis.disconnect();
        } catch (Throwable t) {
            logger.warn(t.getMessage(), t);
        }
    }

    ```
    
    ```

## 4. NotifySub

> NotifySub æ˜¯ RedisRegistry çš„å†…éƒ¨ç±»ã€‚

NotifySub ï¼Œå®ç° `redis.clients.jedis.JedisPubSub` æŠ½è±¡ç±»ï¼Œé€šçŸ¥è®¢é˜…å®ç°ç±»ã€‚

```
 1: private class NotifySub extends JedisPubSub {
 2: 
 3:     private final JedisPool jedisPool;
 4: 
 5:     public NotifySub(JedisPool jedisPool) {
 6:         this.jedisPool = jedisPool;
 7:     }
 8: 
 9:     @Override
10:     public void onMessage(String key, String msg) {
11:         if (logger.isInfoEnabled()) {
12:             logger.info("redis event: " + key + " = " + msg);
13:         }
14:         if (msg.equals(Constants.REGISTER)
15:                 || msg.equals(Constants.UNREGISTER)) {
16:             try {
17:                 Jedis jedis = jedisPool.getResource();
18:                 try {
19:                     doNotify(jedis, key);
20:                 } finally {
21:                     jedisPool.returnResource(jedis);
22:                 }
23:             } catch (Throwable t) { // TODO Notification failure does not restore mechanism guarantee
24:                 logger.error(t.getMessage(), t);
25:             }
26:         }
27:     }
28: 
29:     @Override
30:     public void onPMessage(String pattern, String key, String msg) {
31:         onMessage(key, msg);
32:     }
33: 
34:     @Override
35:     public void onSubscribe(String key, int num) {
36:     }
37: 
38:     @Override
39:     public void onPSubscribe(String pattern, int num) {
40:     }
41: 
42:     @Override
43:     public void onUnsubscribe(String key, int num) {
44:     }
45: 
46:     @Override
47:     public void onPUnsubscribe(String pattern, int num) {
48:     }
49: 
50: }
```

- å®ç°äº† `#onMessage(key, msg)` å’Œ `#onPMessage(pattern, key, msg)` æ–¹æ³•ï¼Œæ”¶åˆ° `register` `unregister` äº‹ä»¶ï¼Œè°ƒç”¨ `#doNotify(jedis, key)` æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼Œæ•°æ®å˜åŒ–ï¼Œä»è€Œå®ç°**å®æ—¶**æ›´æ–°ã€‚

## 5. å¯é æ€§

> FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” Redis æ³¨å†Œä¸­å¿ƒã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/registry/redis.html)
>
> é˜¿é‡Œå†…éƒ¨å¹¶æ²¡æœ‰é‡‡ç”¨ Redis åšä¸ºæ³¨å†Œä¸­å¿ƒï¼Œè€Œæ˜¯ä½¿ç”¨è‡ªå·±å®ç°çš„åŸºäºæ•°æ®åº“çš„æ³¨å†Œä¸­å¿ƒï¼Œå³ï¼šRedis æ³¨å†Œä¸­å¿ƒå¹¶æ²¡æœ‰åœ¨é˜¿é‡Œå†…éƒ¨é•¿æ—¶é—´è¿è¡Œçš„å¯é æ€§ä¿éšœï¼Œæ­¤ Redis æ¡¥æ¥å®ç°åªä¸ºå¼€æºç‰ˆæœ¬æä¾›ï¼Œå…¶å¯é æ€§ä¾èµ–äº Redis æœ¬èº«çš„å¯é æ€§ã€‚

> FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æˆç†Ÿåº¦ã€‹](http://dubbo.apache.org/zh-cn/docs/user/maturity.html)
>
> Redisæ³¨å†Œä¸­å¿ƒ
>
> - Maturityï¼šStable
> - Strengthï¼šæ”¯æŒåŸºäºå®¢æˆ·ç«¯åŒå†™çš„é›†ç¾¤æ–¹å¼ï¼Œæ€§èƒ½é«˜
> - Problemï¼šè¦æ±‚æœåŠ¡å™¨æ—¶é—´åŒæ­¥ï¼Œç”¨äºæ£€æŸ¥å¿ƒè·³è¿‡æœŸè„æ•°æ®
> - Adviseï¼šå¯ç”¨äºç”Ÿäº§ç¯å¢ƒ

åšä¸ªå°ç¬”è®°ï¼ŒRedis ä¸»ä»å¤åˆ¶çš„æƒ…å†µä¸‹ï¼Œä»èŠ‚ç‚¹çš„è®¢é˜…( Subscribe )ï¼Œå¯ä»¥æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„å‘å¸ƒ( Publish ) ã€‚åšè¿™ä¸ªç¬”è®°çš„åŸå› æ˜¯ï¼ŒåŸæ¥æ‹…å¿ƒ `"failover"` æ¨¡å¼ä¸‹ï¼ŒRedis ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå¦‚æœè®¢é˜…ä»èŠ‚ç‚¹ï¼Œä¼šä¸ä¼šå‡ºç°ï¼ŒRedis ä¸»èŠ‚ç‚¹æ¢å¤åï¼Œæ”¶ä¸åˆ°åœ¨å…¶ä¸Šçš„å‘å¸ƒäº‹ä»¶ã€‚

