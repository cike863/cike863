# å±æ€§é…ç½®

## 1. æ¦‚è¿°

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹**å±æ€§é…ç½®**çš„å®šä¹‰ï¼š

> FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” å±æ€§é…ç½®ã€‹](http://dubbo.apache.org/zh-cn/docs/user/configuration/properties.html)
>
> å¦‚æœå…¬å…±é…ç½®å¾ˆ**ç®€å•**ï¼Œæ²¡æœ‰å¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®ç­‰æƒ…å†µï¼Œæˆ–è€…æƒ³å¤šä¸ª Spring å®¹å™¨æƒ³å…±äº«é…ç½®ï¼Œå¯ä»¥ä½¿ç”¨ `dubbo.properties` ä½œä¸ºç¼ºçœé…ç½®ã€‚
>
> Dubbo å°†è‡ªåŠ¨åŠ è½½ classpath æ ¹ç›®å½•ä¸‹çš„ `dubbo.properties`ï¼Œå¯ä»¥é€šè¿‡JVMå¯åŠ¨å‚æ•° `-Ddubbo.properties.file=xxx.properties` æ”¹å˜ç¼ºçœé…ç½®ä½ç½®ã€‚

ä»å®šä¹‰ä¸Šï¼Œå¾ˆå…³é”®çš„ä¸€ä¸ªè¯æ˜¯ â€œ**ç®€å•**â€ ã€‚

- **å±æ€§é…ç½®**ï¼Œä¸æ”¯æŒå¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®ç­‰æƒ…å†µï¼ŒåŸå› è§ä»£ç ã€‚
- **å¤–éƒ¨åŒ–é…ç½®**ï¼Œèƒ½å¤Ÿè§£å†³ä¸Šè¿°çš„é—®é¢˜ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±çœ‹ä¸‹ [ã€ŠDubbo å¤–éƒ¨åŒ–é…ç½®ï¼ˆExternalized Configurationï¼‰ã€‹](https://github.com/mercyblitz/blogs/blob/master/java/dubbo/Dubbo-Externalized-Configuration.md) ã€‚å½“ç„¶ï¼Œè¿™å—å†…å®¹åé¢åˆ†äº«ï¼Œä¸åœ¨æœ¬æ–‡çš„èŒƒç•´ã€‚

OK ï¼Œä¸‹é¢åœ¨å¼€å§‹çœ‹çœ‹å…·ä½“ä»£ç ä¹‹å‰ï¼Œå…ˆä»”ç»†é˜…è¯»ä¸‹ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” å±æ€§é…ç½®ã€‹](http://dubbo.apache.org/zh-cn/docs/user/configuration/properties.html) ï¼Œæœ‰åŠ©äºä¸‹é¢ä»£ç çš„ç†è§£ã€‚

## 2. AbstractConfig

åœ¨ AbstractConfig ä¸­ï¼Œæä¾›äº† [`#appendProperties(config)`](https://github.com/YunaiV/dubbo/blob/d3c3975f320c78452f96098b04441fed4c00ab70/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractConfig.java#L132-L212) æ–¹æ³•ï¼Œè¯»å–**å¯åŠ¨å‚æ•°å˜é‡**å’Œ **properties é…ç½®**åˆ°é…ç½®å¯¹è±¡ã€‚åœ¨å‰é¢çš„å‡ ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»¬å¤šæ¬¡çœ‹åˆ°è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![è¯»å–è°ƒç”¨](assets/01.png)](http://static.iocoder.cn/images/Dubbo/2018_01_13/01.png)è¯»å–è°ƒç”¨

ä»£ç å¦‚ä¸‹ï¼š

```
 1: protected static void appendProperties(AbstractConfig config) {
 2:     if (config == null) {
 3:         return;
 4:     }
 5:     String prefix = "dubbo." + getTagName(config.getClass()) + ".";
 6:     Method[] methods = config.getClass().getMethods();
 7:     for (Method method : methods) {
 8:         try {
 9:             String name = method.getName();
10:             if (name.length() > 3 && name.startsWith("set") && Modifier.isPublic(method.getModifiers()) // æ–¹æ³•æ˜¯ public çš„ setting æ–¹æ³•ã€‚
11:                     && method.getParameterTypes().length == 1 && isPrimitive(method.getParameterTypes()[0])) { // æ–¹æ³•çš„å”¯ä¸€å‚æ•°æ˜¯åŸºæœ¬æ•°æ®ç±»å‹
12:                 // è·å¾—å±æ€§åï¼Œä¾‹å¦‚ `ApplicationConfig#setName(...)` æ–¹æ³•ï¼Œå¯¹åº”çš„å±æ€§åä¸º name ã€‚
13:                 String property = StringUtils.camelToSplitName(name.substring(3, 4).toLowerCase() + name.substring(4), ".");
14: 
15:                 // ã€å¯åŠ¨å‚æ•°å˜é‡ã€‘ä¼˜å…ˆä»å¸¦æœ‰ `Config#id` çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼š`dubbo.application.demo-provider.name` ã€‚
16:                 String value = null;
17:                 if (config.getId() != null && config.getId().length() > 0) {
18:                     String pn = prefix + config.getId() + "." + property; // å¸¦æœ‰ `Config#id`
19:                     value = System.getProperty(pn);
20:                     if (!StringUtils.isBlank(value)) {
21:                         logger.info("Use System Property " + pn + " to config dubbo");
22:                     }
23:                 }
24:                 // ã€å¯åŠ¨å‚æ•°å˜é‡ã€‘è·å–ä¸åˆ°ï¼Œå…¶æ¬¡ä¸å¸¦ `Config#id` çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼š`dubbo.application.name` ã€‚
25:                 if (value == null || value.length() == 0) {
26:                     String pn = prefix + property; // // ä¸å¸¦ `Config#id`
27:                     value = System.getProperty(pn);
28:                     if (!StringUtils.isBlank(value)) {
29:                         logger.info("Use System Property " + pn + " to config dubbo");
30:                     }
31:                 }
32:                 if (value == null || value.length() == 0) {
33:                     // è¦†ç›–ä¼˜å…ˆçº§ä¸ºï¼šå¯åŠ¨å‚æ•°å˜é‡ > XML é…ç½® > properties é…ç½®ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ getter åˆ¤æ–­ XML æ˜¯å¦å·²ç»è®¾ç½®
34:                     Method getter;
35:                     try {
36:                         getter = config.getClass().getMethod("get" + name.substring(3), new Class<?>[0]);
37:                     } catch (NoSuchMethodException e) {
38:                         try {
39:                             getter = config.getClass().getMethod("is" + name.substring(3), new Class<?>[0]);
40:                         } catch (NoSuchMethodException e2) {
41:                             getter = null;
42:                         }
43:                     }
44:                     if (getter != null) {
45:                         if (getter.invoke(config, new Object[0]) == null) { // ä½¿ç”¨ getter åˆ¤æ–­ XML æ˜¯å¦å·²ç»è®¾ç½®
46:                             // ã€properties é…ç½®ã€‘ä¼˜å…ˆä»å¸¦æœ‰ `Config#id` çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼š`dubbo.application.demo-provider.name` ã€‚
47:                             if (config.getId() != null && config.getId().length() > 0) {
48:                                 value = ConfigUtils.getProperty(prefix + config.getId() + "." + property);
49:                             }
50:                             // ã€properties é…ç½®ã€‘è·å–ä¸åˆ°ï¼Œå…¶æ¬¡ä¸å¸¦ `Config#id` çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼š`dubbo.application.name` ã€‚
51:                             if (value == null || value.length() == 0) {
52:                                 value = ConfigUtils.getProperty(prefix + property);
53:                             }
54:                             // ã€properties é…ç½®ã€‘è€ç‰ˆæœ¬å…¼å®¹ï¼Œè·å–ä¸åˆ°ï¼Œæœ€åä¸å¸¦ `Config#id` çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼š`dubbo.protocol.name` ã€‚
55:                             if (value == null || value.length() == 0) {
56:                                 String legacyKey = legacyProperties.get(prefix + property);
57:                                 if (legacyKey != null && legacyKey.length() > 0) {
58:                                     value = convertLegacyValue(legacyKey, ConfigUtils.getProperty(legacyKey));
59:                                 }
60:                             }
61: 
62:                         }
63:                     }
64:                 }
65:                 // è·å–åˆ°å€¼ï¼Œè¿›è¡Œåå°„è®¾ç½®ã€‚
66:                 if (value != null && value.length() > 0) {
67:                     method.invoke(config, new Object[]{convertPrimitive(method.getParameterTypes()[0], value)});
68:                 }
69:             }
70:         } catch (Exception e) {
71:             logger.error(e.getMessage(), e);
72:         }
73:     }
74: }
```

- ç¬¬ 5 è¡Œï¼šè·å¾—é…ç½®é¡¹**å‰ç¼€**ã€‚æ­¤å¤„çš„ [`#getTagName(Class)`](https://github.com/YunaiV/dubbo/blob/d3c3975f320c78452f96098b04441fed4c00ab70/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractConfig.java#L214-L230) æ–¹æ³•ï¼Œä½¿ç”¨é…ç½®ç±»çš„ç±»åï¼Œè·å¾—å¯¹åº”çš„å±æ€§æ ‡ç­¾ã€‚è¯¥æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š

  ```
   1: /**
   2:  * é…ç½®ç±»åçš„åç¼€
   3:  * ä¾‹å¦‚ï¼ŒServiceConfig åç¼€ä¸º Configï¼›ServiceBean åç¼€ä¸º Beanã€‚
   4:  */
   5: private static final String[] SUFFIXES = new String[]{"Config", "Bean"};
   6: 
   7: /**
   8:  * è·å–ç±»åå¯¹åº”çš„å±æ€§æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼ŒServiceConfig å¯¹åº”ä¸º service ã€‚
   9:  *
  10:  * @param cls ç±»å
  11:  * @return æ ‡ç­¾
  12:  */
  13: private static String getTagName(Class<?> cls) {
  14:     String tag = cls.getSimpleName();
  15:     for (String suffix : SUFFIXES) {
  16:         if (tag.endsWith(suffix)) {
  17:             tag = tag.substring(0, tag.length() - suffix.length());
  18:             break;
  19:         }
  20:     }
  21:     tag = tag.toLowerCase();
  22:     return tag;
  23: }
  ```

- ç¬¬ 6 è¡Œï¼šè·å¾—é…ç½®ç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œç”¨äºä¸‹é¢é€šè¿‡**åå°„**è·å¾—é…ç½®é¡¹çš„å±æ€§åï¼Œå†ç”¨å±æ€§åï¼Œå»è¯»å–**å¯åŠ¨å‚æ•°å˜é‡**å’Œ **properties é…ç½®**åˆ°é…ç½®å¯¹è±¡ã€‚

- ç¬¬ 10 è‡³ 11 è¡Œï¼špublic && setting æ–¹æ³• && **å”¯ä¸€**å‚æ•°ä¸ºåŸºæœ¬ç±»å‹ã€‚

  - å…¶ä¸­**å”¯ä¸€**å‚æ•°ä¸º**åŸºæœ¬ç±»å‹**ï¼Œå†³å®šäº†ä¸€ä¸ªé…ç½®å¯¹è±¡æ— æ³•è®¾ç½®å¦å¤–ä¸€ä¸ªé…ç½®å¯¹è±¡**æ•°ç»„**ä¸ºå±æ€§ï¼Œå³**æ²¡æœ‰å¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®ç­‰æƒ…å†µ**ã€‚ä¾‹å¦‚ï¼ŒServiceConfig æ— æ³•é€šè¿‡**å±æ€§é…ç½®**è®¾ç½®å¤šä¸ª ProtocolConfig å¯¹è±¡ã€‚

  - å½“ç„¶ä¸Šè¿°é—®é¢˜ï¼Œæ­£å¦‚æ–‡åˆæ‰€è¯´ï¼Œ[ã€ŠDubbo å¤–éƒ¨åŒ–é…ç½®ï¼ˆExternalized Configurationï¼‰ã€‹](https://github.com/mercyblitz/blogs/blob/master/java/dubbo/Dubbo-Externalized-Configuration.md) å·²ç»æ”¯æŒã€‚

  - å¦å¤–ï¼Œ**å±æ€§é…ç½®**å’Œ**å¤–éƒ¨åŒ–é…ç½®**æœ‰ä¸€å®šçš„ç›¸ä¼¼ç‚¹ï¼š

    > FROM [ã€ŠDubbo å¤–éƒ¨åŒ–é…ç½®ï¼ˆExternalized Configurationï¼‰ã€‹](https://github.com/mercyblitz/blogs/blob/master/java/dubbo/Dubbo-Externalized-Configuration.md)

    åœ¨ Dubbo å®˜æ–¹ç”¨æˆ·æ‰‹å†Œçš„[â€œå±æ€§é…ç½®â€](http://dubbo.apache.org/zh-cn/docs/user/configuration/properties.html)ç« èŠ‚ä¸­ï¼Œ`dubbo.properties` é…ç½®å±æ€§èƒ½å¤Ÿæ˜ å°„åˆ° `ApplicationConfig` ã€`ProtocolConfig` ä»¥åŠ `RegistryConfig` çš„å­—æ®µã€‚ä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œ`dubbo.properties` ä¹Ÿæ˜¯ Dubbo çš„å¤–éƒ¨åŒ–é…ç½®ã€‚

- ç¬¬ 13 è¡Œï¼šè·å¾—å±æ€§åã€‚ä¾‹å¦‚ï¼Œ`ApplicationConfig#setName(...)` æ–¹æ³•ï¼Œå¯¹åº”çš„å±æ€§åä¸º `"name"` ã€‚

- è¯»å–çš„**è¦†ç›–ç­–ç•¥**å¦‚ä¸‹ï¼š

  > [![è¦†ç›–ç­–ç•¥](assets/02.png)](http://static.iocoder.cn/images/Dubbo/2018_01_13/02.png)è¦†ç›–ç­–ç•¥

- ç¬¬ 15 è‡³ 31 è¡Œï¼šä¼˜å…ˆä»ã€**å¯åŠ¨å‚æ•°å˜é‡**ã€‘è·å–é…ç½®é¡¹çš„å€¼ã€‚

  - ğŸ™‚ æœ‰**ä¸¤ç§**æƒ…å†µï¼Œç»†çœ‹ä¸‹æ³¨é‡Šã€‚

- ç¬¬ 33 è‡³ 45 è¡Œï¼šå› ä¸º XMLé…ç½® çš„ä¼˜å…ˆçº§**å¤§äº** propertiesé…ç½®ï¼Œå› æ­¤éœ€è¦**è·å–å¹¶ä½¿ç”¨** getting æ–¹æ³•ï¼Œåˆ¤æ–­é…ç½®å¯¹è±¡**å·²ç»æ‹¥æœ‰**è¯¥é…ç½®é¡¹çš„å€¼ã€‚å¦‚æœæœ‰ï¼Œåˆ™ä¸ä» propertiesé…ç½® è¯»å–å¯¹åº”çš„å€¼ã€‚

- ç¬¬ 46 è‡³ 59 è¡Œï¼šæœ€åä»ã€**propertiesé…ç½®**ã€‘è·å–é…ç½®é¡¹çš„å€¼ã€‚

  - ğŸ™‚ æœ‰**ä¸‰ç§**æƒ…å†µï¼Œå‰ä¸¤ç§å’Œã€**å¯åŠ¨å‚æ•°å˜é‡**ã€‘ç›¸åŒã€‚

  - æœ€åä¸€ç§ï¼Œä¸»è¦æ˜¯å…¼å®¹è€ç‰ˆæœ¬çš„é…ç½®é¡¹ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
     1: /**
     2:  * æ–°è€ç‰ˆæœ¬çš„ properties çš„ key æ˜ å°„
     3:  *
     4:  * keyï¼šæ–°ç‰ˆæœ¬çš„é…ç½® æ˜ å°„
     5:  * valueï¼šæ—§ç‰ˆæœ¬çš„é…ç½® æ˜ å°„
     6:  *
     7:  * æ¥è‡ª 2012/3/8 ä¸‹åˆ 5ï¼š51 cb1f705 æäº¤
     8:  * DUBBO-251 å¢åŠ APIè¦†ç›–dubbo.propertiesçš„æµ‹è¯•ï¼Œä»¥åŠæ—§ç‰ˆæœ¬é…ç½®é¡¹æµ‹è¯•ã€‚
     9:  */
    10: private static final Map<String, String> legacyProperties = new HashMap<String, String>();
    11: 
    12: /**
    13:  * å°†é”®å¯¹åº”çš„å€¼è½¬æ¢æˆç›®æ ‡çš„å€¼ã€‚
    14:  *
    15:  * å› ä¸ºï¼Œæ–°è€é…ç½®å¯èƒ½æœ‰ä¸€äº›å·®å¼‚ï¼Œé€šè¿‡è¯¥æ–¹æ³•è¿›è¡Œè½¬æ¢ã€‚
    16:  *
    17:  * @param key é”®
    18:  * @param value å€¼
    19:  * @return è½¬æ¢åçš„å€¼
    20:  */
    21: private static String convertLegacyValue(String key, String value) {
    22:     if (value != null && value.length() > 0) {
    23:         if ("dubbo.service.max.retry.providers".equals(key)) {
    24:             return String.valueOf(Integer.parseInt(value) - 1);
    25:         } else if ("dubbo.service.allow.no.provider".equals(key)) {
    26:             return String.valueOf(!Boolean.parseBoolean(value));
    27:         }
    28:     }
    29:     return value;
    30: }
    ```

    - x

- ç¬¬ 65 è‡³ 68 è¡Œï¼šæœ‰å€¼ï¼Œé€šè¿‡åå°„è¿›è¡Œè®¾ç½®åˆ°é…ç½®å¯¹è±¡ä¸­ã€‚

- ç¬¬ 70 è‡³ 72 è¡Œï¼šé€»è¾‘ä¸­é—´å‘ç”Ÿå¼‚å¸¸ï¼Œ**ä¸æŠ›å‡ºå¼‚å¸¸**ï¼Œä»…æ‰“å°é”™è¯¯æ—¥å¿—ã€‚

# XML é…ç½®

## 1. æ¦‚è¿°

åœ¨ Dubbo æä¾›çš„å‡ ç§æ–¹å¼ä¸­ï¼Œ**XML é…ç½®**è‚¯å®šæ˜¯å¤§å®¶æœ€ç†Ÿæ‚‰çš„æ–¹å¼ã€‚

å¦‚æœä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥æŸ¥çœ‹å¦‚ä¸‹æ–‡æ¡£ï¼š

- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” XML é…ç½®ã€‹](http://dubbo.apache.org/zh-cn/docs/user/configuration/xml.html)
- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” schema é…ç½®å‚è€ƒæ‰‹å†Œã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html)

XML é…ç½®ï¼Œè‡ªå®šä¹‰ `<dubbo: />` æ ‡ç­¾ï¼ŒåŸºäº **Spring XML** è¿›è¡Œè§£æã€‚å¦‚æœä¸äº†è§£çš„ï¼Œå¯ä»¥æŸ¥çœ‹å¦‚ä¸‹æ–‡æ¡£ï¼š

- [ã€ŠSpring æºç é˜…è¯» â€”â€” XML æ–‡ä»¶é»˜è®¤æ ‡ç­¾çš„è§£æã€‹](https://gavinzhang1.gitbooks.io/spring/content/xmlwen_jian_mo_ren_biao_qian_de_jie_xi.html)
- [ã€ŠSpring æºç é˜…è¯» â€”â€” XML è‡ªå®šä¹‰æ ‡ç­¾çš„è§£æã€‹](https://gavinzhang1.gitbooks.io/spring/content/xmlzi_ding_yi_biao_qian_de_jie_xi.html)

## 2. å®šä¹‰

### 2.1 sprng.schemas

Dubbo åœ¨ `dubbo-spring-config` çš„ [`META-INF/spring.schemas`](https://github.com/YunaiV/dubbo/blob/05dd4fe091e37d08e01d4e243e3fc24dbfdc61ff/dubbo-config/dubbo-config-spring/src/main/resources/META-INF/spring.schemas) å®šä¹‰å¦‚ä¸‹ï¼š

```
http\://code.alibabatech.com/schema/dubbo/dubbo.xsd=META-INF/dubbo.xsd
```

- `xmlns` ä¸º `http://code.alibabatech.com/schema/dubbo`
- `xsd` ä¸º `META-INF/dubbo.xsd`

### 2.2 dubbo.xsd

[`dubbo.xsd`](https://github.com/YunaiV/dubbo/blob/05dd4fe091e37d08e01d4e243e3fc24dbfdc61ff/dubbo-config/dubbo-config-spring/src/main/resources/META-INF/dubbo.xsd) å®šä¹‰å¦‚ä¸‹ï¼š

[![dubbo.xsd](assets/03.png)](http://static.iocoder.cn/images/Dubbo/2018_01_19/01.png)dubbo.xsd

- `<xsd:element name="" />` ï¼Œå®šä¹‰äº†**å…ƒç´ çš„åç§°**ã€‚ä¾‹å¦‚ï¼Œ`<xsd:element name="application" />` å¯¹åº” `<dubbo:application />` ã€‚
- `<xsd:element type="" />` ï¼Œå®šä¹‰äº†**å†…å»ºæ•°æ®ç±»å‹çš„åç§°**ã€‚ä¾‹å¦‚ï¼Œ`<xsd:element type="applicationType" />` å¯¹åº” `<xsd:complexType name="applicationType" />` ã€‚
- `<xsd:complexType name="">` ï¼Œå®šä¹‰äº†**å¤æ‚ç±»å‹**ã€‚ä¾‹å¦‚ `<xsd:complexType name="applicationType" />` å¦‚ä¸‹ï¼š

[![applicationType](assets/04.png)](http://static.iocoder.cn/images/Dubbo/2018_01_19/02.png)applicationType

### 2.3 spring.handlers

[`spring.handlers`](https://github.com/YunaiV/dubbo/blob/05dd4fe091e37d08e01d4e243e3fc24dbfdc61ff/dubbo-config/dubbo-config-spring/src/main/resources/META-INF/spring.handlers) å®šä¹‰å¦‚ä¸‹ï¼š

```
http\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler
```

- å®šä¹‰äº† Dubbo çš„ XML Namespace çš„å¤„ç†å™¨ DubboNamespaceHandler ã€‚

### 2.4 DubboNamespaceHandler

[`com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler`](https://github.com/YunaiV/dubbo/blob/025ac8b49c7608b0a76ea7bd8c2de6c72138b5ef/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboNamespaceHandler.java) ï¼Œå®ç° `org.springframework.beans.factory.xml.NamespaceHandlerSupport` **æŠ½è±¡ç±»**ï¼ŒDubbo çš„ XML Namespace çš„å¤„ç†å™¨ã€‚

åœ¨ [`#init()`](https://github.com/YunaiV/dubbo/blob/6cd9a5b53ca8f86de7eac4e978c1f2d13c439845/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboNamespaceHandler.java#L36-L49) æ–¹æ³•ï¼Œå®šä¹‰äº†æ¯ä¸ª `<xsd:element />` å¯¹åº”çš„ `org.springframework.beans.factory.xml.BeanDefinitionParser` ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Override
public void init() {
    registerBeanDefinitionParser("application", new DubboBeanDefinitionParser(ApplicationConfig.class, true));
    registerBeanDefinitionParser("module", new DubboBeanDefinitionParser(ModuleConfig.class, true));
    registerBeanDefinitionParser("registry", new DubboBeanDefinitionParser(RegistryConfig.class, true));
    registerBeanDefinitionParser("monitor", new DubboBeanDefinitionParser(MonitorConfig.class, true));
    registerBeanDefinitionParser("provider", new DubboBeanDefinitionParser(ProviderConfig.class, true));
    registerBeanDefinitionParser("consumer", new DubboBeanDefinitionParser(ConsumerConfig.class, true));
    registerBeanDefinitionParser("protocol", new DubboBeanDefinitionParser(ProtocolConfig.class, true));
    registerBeanDefinitionParser("service", new DubboBeanDefinitionParser(ServiceBean.class, true));
    registerBeanDefinitionParser("reference", new DubboBeanDefinitionParser(ReferenceBean.class, false));

    registerBeanDefinitionParser("annotation", new AnnotationBeanDefinitionParser()); // åºŸå¼ƒ
}
```

- ç»†å¿ƒçš„ï¼Œä¼šçœ‹åˆ° `service` æ ‡ç­¾ä½¿ç”¨çš„æ˜¯ ServiceBean ï¼Œè€Œä¸æ˜¯ ServiceConfig ï¼Œ`reference` è¡¨ç¤ºç”¨çš„æ˜¯ ReferenceBean ï¼Œå› ä¸ºæ— è®ºæ˜¯ ServiceConfig è¿˜æ˜¯ ReferenceBean ï¼Œåœ¨è§£æå®Œå…·ä½“é…ç½®åï¼Œéœ€è¦è°ƒç”¨å®ƒä»¬å¯¹åº”çš„æ–¹æ³•è¿›è¡Œ**åˆå§‹åŒ–**ã€‚ğŸ™‚ è€ƒè™‘åˆ°ç¯‡å¹…ï¼Œæˆ‘ä»¬åœ¨åç»­æ–‡ç« åˆ†äº«ã€‚è¿™ç¯‡æˆ‘ä»¬é‡ç‚¹æ”¾åœ¨**è§£æ**ã€‚

## 3. è§£æ

[`com.alibaba.dubbo.config.spring.schema.DubboBeanDefinitionParser`](http://svip.iocoder.cn/Dubbo/configuration-xml/DubboBeanDefinitionParser) ï¼Œå®ç° `org.springframework.beans.factory.xml.BeanDefinitionParser` **æ¥å£**ï¼ŒDubbo Bean å®šä¹‰è§£æå™¨ã€‚

### 3.1 æ„é€ æ–¹æ³•

[æ„é€ æ–¹æ³•](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L62-L74) ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
/**
 * Bean å¯¹è±¡çš„ç±»
 */
private final Class<?> beanClass;
/**
 * æ˜¯å¦éœ€è¦ Bean çš„ `id` å±æ€§
 */
private final boolean required;

public DubboBeanDefinitionParser(Class<?> beanClass, boolean required) {
    this.beanClass = beanClass;
    this.required = required;
}
```

- `beanClass` ï¼ŒBean å¯¹è±¡çš„**ç±»**ã€‚
- `required` ï¼Œæ˜¯å¦éœ€è¦åœ¨ Bean å¯¹è±¡çš„ç¼–å·( `id` ) ä¸å­˜åœ¨æ—¶ï¼Œ**è‡ªåŠ¨ç”Ÿæˆç¼–å·**ã€‚æ— éœ€è¢«å…¶ä»–åº”ç”¨å¼•ç”¨çš„é…ç½®å¯¹è±¡ï¼Œæ— éœ€è‡ªåŠ¨ç”Ÿæˆç¼–å·ã€‚ä¾‹å¦‚æœ‰ `<dubbo:reference />` ã€‚

### 3.2 è§£ææ–¹æ³•ã€ä¸»æµç¨‹ã€‘

[`#parse(Element, ParserContext)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L516-L518) æ–¹æ³•ï¼Œè§£æ XML å…ƒç´ ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public BeanDefinition parse(Element element, ParserContext parserContext) {
    return parse(element, parserContext, beanClass, required);
}
```

- è°ƒç”¨ [`#parse(Element, ParserContext, beanClass, required)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L76-L292) æ–¹æ³•ï¼Œ**çœŸæ­£**è§£æ XML å…ƒç´ ã€‚è¯¥æ–¹æ³•ååˆ†å†—é•¿ï¼Œè¿‘ 200+ è¡Œã€‚å¦å¤–ç®—ä¸Šå†…éƒ¨ä¼šè°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œæ•´ä½“ 500+ è¡Œå·¦å³ã€‚ğŸ™‚ ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å°†æ–¹æ³•åˆ‡æ¢ç†è§£ã€‚

> å‹æƒ…æç¤ºï¼šå»ºè®®ï¼Œèƒ½å¤Ÿè¾¹çœ‹è¾¹è°ƒè¯•ã€‚

##### 3.2.1 åˆ›å»º RootBeanDefinition

[`#parse(Element, ParserContext, beanClass, required)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L76-L292) çš„ç¬¬ 78 è‡³ 80 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```
RootBeanDefinition beanDefinition = new RootBeanDefinition();
beanDefinition.setBeanClass(beanClass);
beanDefinition.setLazyInit(false);
```

- é»˜è®¤ `lazyInit = false` ã€‚

  > FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” XML é…ç½®ã€‹](http://dubbo.apache.org/zh-cn/docs/user/configuration/xml.html)
  > å¼•ç”¨ç¼ºçœæ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œåªæœ‰å¼•ç”¨è¢«æ³¨å…¥åˆ°å…¶å®ƒ Beanï¼Œæˆ–è¢« getBean() è·å–ï¼Œæ‰ä¼šåˆå§‹åŒ–ã€‚å¦‚æœéœ€è¦é¥¥é¥¿åŠ è½½ï¼Œå³æ²¡æœ‰äººå¼•ç”¨ä¹Ÿç«‹å³ç”ŸæˆåŠ¨æ€ä»£ç†ï¼Œå¯ä»¥é…ç½®ï¼š`<dubbo:reference ... init="true" />`

##### 3.2.2 å¤„ç† Bean çš„ç¼–å·

[`#parse(Element, ParserContext, beanClass, required)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L81-L111) çš„ç¬¬ 81 è‡³ 111 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```
 81: // è§£æé…ç½®å¯¹è±¡çš„ id ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œç”Ÿæˆã€‚
 82: String id = element.getAttribute("id");
 83: if ((id == null || id.length() == 0) && required) {
 84:     // ç”Ÿæˆ id ã€‚ä¸åŒçš„é…ç½®å¯¹è±¡ï¼Œä¼šå­˜åœ¨ä¸åŒã€‚
 85:     String generatedBeanName = element.getAttribute("name");
 86:     if (generatedBeanName == null || generatedBeanName.length() == 0) {
 87:         if (ProtocolConfig.class.equals(beanClass)) {
 88:             generatedBeanName = "dubbo";
 89:         } else {
 90:             generatedBeanName = element.getAttribute("interface");
 91:         }
 92:     }
 93:     if (generatedBeanName == null || generatedBeanName.length() == 0) {
 94:         generatedBeanName = beanClass.getName();
 95:     }
 96:     id = generatedBeanName;
 97:     // è‹¥ id å·²å­˜åœ¨ï¼Œé€šè¿‡è‡ªå¢åºåˆ—ï¼Œè§£å†³é‡å¤ã€‚
 98:     int counter = 2;
 99:     while (parserContext.getRegistry().containsBeanDefinition(id)) {
100:         id = generatedBeanName + (counter++);
101:     }
102: }
103: if (id != null && id.length() > 0) {
104:     if (parserContext.getRegistry().containsBeanDefinition(id)) {
105:         throw new IllegalStateException("Duplicate spring bean id " + id);
106:     }
107:     // æ·»åŠ åˆ° Spring çš„æ³¨å†Œè¡¨
108:     parserContext.getRegistry().registerBeanDefinition(id, beanDefinition);
109:     // è®¾ç½® Bean çš„ `id` å±æ€§å€¼
110:     beanDefinition.getPropertyValues().addPropertyValue("id", id);
111: }
```

- ç¬¬ 82 è‡³ 102 è¡Œï¼šè§£æ Bean çš„

   

  ```
  id
  ```

   

  ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è‡ªåŠ¨è¿›è¡Œç”Ÿæˆã€‚

  - ç¬¬ 85 è‡³ 96 è¡Œï¼šç”Ÿæˆ `id` ã€‚è§„åˆ™ä¸º `name` > ç‰¹æ®Šè§„åˆ™ > `className` ã€‚
  - ç¬¬ 97 è‡³ 101 è¡Œï¼šè‹¥ `id` åœ¨ Spring æ³¨å†Œè¡¨å·²ç»å­˜åœ¨ï¼Œé€šè¿‡æ·»åŠ **è‡ªå¢åºåˆ—**ä½œä¸ºåç¼€ï¼Œé¿å…å†²çªã€‚

- ç¬¬ 108 è¡Œï¼šæ·»åŠ  Bean åˆ° Spring æ³¨å†Œè¡¨ã€‚

- ç¬¬ 110 è¡Œï¼šè®¾ç½® Bean çš„ `id` ã€‚

##### 3.2.3 å¤„ç† `<dubbo:protocol/>` ç‰¹æ®Šæƒ…å†µ

[`#parse(Element, ParserContext, beanClass, required)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L113-L128) çš„ç¬¬ 113 è‡³ 128 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```
113: // å¤„ç† `<dubbo:protocol` /> çš„ç‰¹æ®Šæƒ…å†µ
114: if (ProtocolConfig.class.equals(beanClass)) {
115:     // éœ€è¦æ»¡è¶³ç¬¬ 220 è‡³ 233 è¡Œã€‚
116:     // ä¾‹å¦‚ï¼šã€é¡ºåºè¦è¿™æ ·ã€‘
117:     // <dubbo:service interface="com.alibaba.dubbo.demo.DemoService" protocol="dubbo" ref="demoService"/>
118:     // <dubbo:protocol id="dubbo" name="dubbo" port="20880"/>
119:     for (String name : parserContext.getRegistry().getBeanDefinitionNames()) {
120:         BeanDefinition definition = parserContext.getRegistry().getBeanDefinition(name);
121:         PropertyValue property = definition.getPropertyValues().getPropertyValue("protocol");
122:         if (property != null) {
123:             Object value = property.getValue();
124:             if (value instanceof ProtocolConfig && id.equals(((ProtocolConfig) value).getName())) {
125:                 definition.getPropertyValues().addPropertyValue("protocol", new RuntimeBeanReference(id));
126:             }
127:         }
128:     }
```

åœ¨ [ã€Œ3.2.7 å¾ªç¯ Bean å¯¹è±¡çš„ setting æ–¹æ³•ï¼Œå°†å±æ€§èµ‹å€¼åˆ° Bean å¯¹è±¡ã€](http://svip.iocoder.cn/Dubbo/configuration-xml/#) ç»Ÿä¸€è§£æã€‚

##### 3.2.4 å¤„ç† `<dubbo:service />` çš„ `class` å±æ€§

[`#parse(Element, ParserContext, beanClass, required)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L129-L142) çš„ç¬¬ 129 è‡³ 142 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```
113: // å¤„ç† `<dubbo:service />` çš„å±æ€§ `class`
114: } else if (ServiceBean.class.equals(beanClass)) {
115:     // å¤„ç† `class` å±æ€§ã€‚ä¾‹å¦‚  <dubbo:service id="sa" interface="com.alibaba.dubbo.demo.DemoService" class="com.alibaba.dubbo.demo.provider.DemoServiceImpl" >
116:     String className = element.getAttribute("class");
117:     if (className != null && className.length() > 0) {
118:         // åˆ›å»º Service çš„ RootBeanDefinition å¯¹è±¡ã€‚ç›¸å½“äºå†…åµŒäº† <bean class="com.alibaba.dubbo.demo.provider.DemoServiceImpl" />
119:         RootBeanDefinition classDefinition = new RootBeanDefinition();
120:         classDefinition.setBeanClass(ReflectUtils.forName(className));
121:         classDefinition.setLazyInit(false);
122:         // è§£æ Service Bean å¯¹è±¡çš„å±æ€§
123:         parseProperties(element.getChildNodes(), classDefinition);
124:         // è®¾ç½® `<dubbo:service ref="" />` å±æ€§
125:         beanDefinition.getPropertyValues().addPropertyValue("ref", new BeanDefinitionHolder(classDefinition, id + "Impl"));
126:     }
```

- å¤„ç† `<dubbo:service class="" />` åœºæ™¯ä¸‹çš„å¤„ç†ï¼Œ**å¤§å¤šæ•°**æƒ…å†µä¸‹æˆ‘ä»¬ä¸è¿™ä¹ˆä½¿ç”¨ï¼ŒåŒ…æ‹¬å®˜æ–¹æ–‡æ¡£ä¹Ÿæ²¡æä¾›è¿™ç§æ–¹å¼çš„è¯´æ˜ã€‚å½“é…ç½® `class` å±æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»º Service Bean å¯¹è±¡ï¼Œè€Œæ— éœ€å†é…ç½® `ref` å±æ€§ï¼ŒæŒ‡å‘ Service Bean å¯¹è±¡ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

  ```
  <bean id="demoDAO" class="com.alibaba.dubbo.demo.provider.DemoDAO" />
  
  <dubbo:service id="sa" interface="com.alibaba.dubbo.demo.DemoService"  class="com.alibaba.dubbo.demo.provider.DemoServiceImpl">
      <property name="demoDAO" ref="demoDAO" />
  </dubbo:service>
  ```

  - é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨ `<property />` æ ‡ç­¾ï¼Œè®¾ç½® Service Bean çš„å±æ€§ã€‚

- ç¬¬ 118 è‡³ 121 è¡Œï¼šåˆ›å»º Service çš„ Bean å¯¹è±¡ã€‚

- ç¬¬ 123 è¡Œï¼šè°ƒç”¨ [`#parseProperties(NodeList, RootBeanDefinition)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L368-L399) æ–¹æ³•ï¼Œè§£æ Service Bean å¯¹è±¡çš„å±æ€§ä»¬ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3.1 parsePropertiesã€](http://svip.iocoder.cn/Dubbo/configuration-xml/#) æ–¹æ³•ã€‚

##### 3.2.5 è§£æ `<dubbo:provider />` çš„å†…åµŒå­å…ƒç´  `<dubbo:service />`

[`#parse(Element, ParserContext, beanClass, required)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L143-L145) çš„ç¬¬ 143 è‡³ 145 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// è§£æ `<dubbo:provider />` çš„å†…åµŒå­å…ƒç´  `<dubbo:service />`
} else if (ProviderConfig.class.equals(beanClass)) {
    parseNested(element, parserContext, ServiceBean.class, true, "service", "provider", id, beanDefinition);
```

- è°ƒç”¨ [`#parseNested(...)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L326-L366) æ–¹æ³•ï¼Œè§£æå†…åµŒçš„æŒ‡å‘çš„å­ XML å…ƒç´ ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3.2 parseNestedã€](http://svip.iocoder.cn/Dubbo/configuration-xml/#) æ–¹æ³•ã€‚

##### 3.2.6 è§£æ `<dubbo:consumer />` çš„å†…åµŒå­å…ƒç´  `<dubbo:reference />`

[`#parse(Element, ParserContext, beanClass, required)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L146-L149) çš„ç¬¬ 146 è‡³ 149 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// è§£æ `<dubbo:consumer />` çš„å†…åµŒå­å…ƒç´  `<dubbo:reference />`
} else if (ConsumerConfig.class.equals(beanClass)) {
    parseNested(element, parserContext, ReferenceBean.class, false, "reference", "consumer", id, beanDefinition);
}
```

- è°ƒç”¨ [`#parseNested(...)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L326-L366) æ–¹æ³•ï¼Œè§£æå†…åµŒçš„æŒ‡å‘çš„å­ XML å…ƒç´ ã€‚

##### 3.2.7 å¾ªç¯ Bean å¯¹è±¡çš„ setting æ–¹æ³•ï¼Œå°†å±æ€§èµ‹å€¼åˆ° Bean å¯¹è±¡

[`#parse(Element, ParserContext, beanClass, required)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L150-L273) çš„ç¬¬ 150 è‡³ 273 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```
150: Set<String> props = new HashSet<String>(); // å·²è§£æçš„å±æ€§é›†åˆ
151: ManagedMap parameters = null; //
152: // å¾ªç¯ Bean å¯¹è±¡çš„ setting æ–¹æ³•ï¼Œå°†å±æ€§æ·»åŠ åˆ° Bean å¯¹è±¡çš„å±æ€§èµ‹å€¼
153: for (Method setter : beanClass.getMethods()) {
154:     String name = setter.getName();
155:     if (name.length() > 3 && name.startsWith("set")
156:             && Modifier.isPublic(setter.getModifiers())
157:             && setter.getParameterTypes().length == 1) { // setting && public && å”¯ä¸€å‚æ•°
158:         Class<?> type = setter.getParameterTypes()[0];
159:         // æ·»åŠ  `props`
160:         String property = StringUtils.camelToSplitName(name.substring(3, 4).toLowerCase() + name.substring(4), "-");
161:         props.add(property);
162:         // getting && public && å±æ€§å€¼ç±»å‹ç»Ÿä¸€
163:         Method getter = null;
164:         try {
165:             getter = beanClass.getMethod("get" + name.substring(3), new Class<?>[0]);
166:         } catch (NoSuchMethodException e) {
167:             try {
168:                 getter = beanClass.getMethod("is" + name.substring(3), new Class<?>[0]);
169:             } catch (NoSuchMethodException e2) {
170:             }
171:         }
172:         if (getter == null
173:                 || !Modifier.isPublic(getter.getModifiers())
174:                 || !type.equals(getter.getReturnType())) {
175:             continue;
176:         }
177:         // è§£æ `<dubbo:parameters />`
178:         if ("parameters".equals(property)) {
179:             parameters = parseParameters(element.getChildNodes(), beanDefinition);
180:         // è§£æ `<dubbo:method />`
181:         } else if ("methods".equals(property)) {
182:             parseMethods(id, element.getChildNodes(), beanDefinition, parserContext);
183:         // è§£æ `<dubbo:argument />`
184:         } else if ("arguments".equals(property)) {
185:             parseArguments(id, element.getChildNodes(), beanDefinition, parserContext);
186:         } else {
187:             String value = element.getAttribute(property);
188:             if (value != null) {
189:                 value = value.trim();
190:                 if (value.length() > 0) {
191:                     // ä¸æƒ³æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„æƒ…å†µï¼Œå³ `registry=N/A` ã€‚
192:                     if ("registry".equals(property) && RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(value)) {
193:                         RegistryConfig registryConfig = new RegistryConfig();
194:                         registryConfig.setAddress(RegistryConfig.NO_AVAILABLE);
195:                         beanDefinition.getPropertyValues().addPropertyValue(property, registryConfig);
196:                     // å¤šæ³¨å†Œä¸­å¿ƒçš„æƒ…å†µ
197:                     } else if ("registry".equals(property) && value.indexOf(',') != -1) {
198:                         parseMultiRef("registries", value, beanDefinition, parserContext);
199:                     // å¤šæœåŠ¡æä¾›è€…çš„æƒ…å†µ
200:                     } else if ("provider".equals(property) && value.indexOf(',') != -1) {
201:                         parseMultiRef("providers", value, beanDefinition, parserContext);
202:                     // å¤šåè®®çš„æƒ…å†µ
203:                     } else if ("protocol".equals(property) && value.indexOf(',') != -1) {
204:                         parseMultiRef("protocols", value, beanDefinition, parserContext);
205:                     } else {
206:                         Object reference;
207:                         // å¤„ç†å±æ€§ç±»å‹ä¸ºåŸºæœ¬å±æ€§çš„æƒ…å†µ
208:                         if (isPrimitive(type)) {
209:                             // å…¼å®¹æ€§å¤„ç†
210:                             if ("async".equals(property) && "false".equals(value)
211:                                     || "timeout".equals(property) && "0".equals(value)
212:                                     || "delay".equals(property) && "0".equals(value)
213:                                     || "version".equals(property) && "0.0.0".equals(value)
214:                                     || "stat".equals(property) && "-1".equals(value)
215:                                     || "reliable".equals(property) && "false".equals(value)) {
216:                                 // backward compatibility for the default value in old version's xsd
217:                                 value = null;
218:                             }
219:                             reference = value;
220:                         // å¤„ç†åœ¨ `<dubbo:provider />` æˆ–è€… `<dubbo:service />` ä¸Šå®šä¹‰äº† `protocol` å±æ€§çš„ å…¼å®¹æ€§ã€‚
221:                         } else if ("protocol".equals(property)
222:                                 && ExtensionLoader.getExtensionLoader(Protocol.class).hasExtension(value) // å­˜åœ¨è¯¥æ³¨å†Œåè®®çš„å®ç°
223:                                 && (!parserContext.getRegistry().containsBeanDefinition(value) // Spring æ³¨å†Œè¡¨ä¸­ä¸å­˜åœ¨è¯¥ `<dubbo:provider />` çš„å®šä¹‰
224:                                     || !ProtocolConfig.class.getName().equals(parserContext.getRegistry().getBeanDefinition(value).getBeanClassName())) // Spring æ³¨å†Œè¡¨ä¸­å­˜åœ¨è¯¥ç¼–å·ï¼Œä½†æ˜¯ç±»å‹ä¸ä¸º ProtocolConfig ã€‚
225:                                 ) {
226:                             // ç›®å‰ï¼Œ`<dubbo:provider protocol="" />` æ¨èç‹¬ç«‹æˆ `<dubbo:protocol />`
227:                             if ("dubbo:provider".equals(element.getTagName())) {
228:                                 logger.warn("Recommended replace <dubbo:provider protocol=\"" + value + "\" ... /> to <dubbo:protocol name=\"" + value + "\" ... />");
229:                             }
230:                             // backward compatibility
231:                             ProtocolConfig protocol = new ProtocolConfig();
232:                             protocol.setName(value);
233:                             reference = protocol;
234:                         // å¤„ç† `onreturn` å±æ€§
235:                         } else if ("onreturn".equals(property)) {
236:                             // æŒ‰ç…§ `.` æ‹†åˆ†
237:                             int index = value.lastIndexOf(".");
238:                             String returnRef = value.substring(0, index);
239:                             String returnMethod = value.substring(index + 1);
240:                             // åˆ›å»º RuntimeBeanReference ï¼ŒæŒ‡å‘å›è°ƒçš„å¯¹è±¡
241:                             reference = new RuntimeBeanReference(returnRef);
242:                             // è®¾ç½® `onreturnMethod` åˆ° BeanDefinition çš„å±æ€§å€¼
243:                             beanDefinition.getPropertyValues().addPropertyValue("onreturnMethod", returnMethod);
244:                             // å¤„ç† `onthrow` å±æ€§
245:                         } else if ("onthrow".equals(property)) {
246:                             // æŒ‰ç…§ `.` æ‹†åˆ†
247:                             int index = value.lastIndexOf(".");
248:                             String throwRef = value.substring(0, index);
249:                             String throwMethod = value.substring(index + 1);
250:                             // åˆ›å»º RuntimeBeanReference ï¼ŒæŒ‡å‘å›è°ƒçš„å¯¹è±¡
251:                             reference = new RuntimeBeanReference(throwRef);
252:                             // è®¾ç½® `onthrowMethod` åˆ° BeanDefinition çš„å±æ€§å€¼
253:                             beanDefinition.getPropertyValues().addPropertyValue("onthrowMethod", throwMethod);
254:                         // é€šç”¨è§£æ
255:                         } else {
256:                             // æŒ‡å‘çš„ Service çš„ Bean å¯¹è±¡ï¼Œå¿…é¡»æ˜¯å•ä¾‹
257:                             if ("ref".equals(property) && parserContext.getRegistry().containsBeanDefinition(value)) {
258:                                 BeanDefinition refBean = parserContext.getRegistry().getBeanDefinition(value);
259:                                 if (!refBean.isSingleton()) {
260:                                     throw new IllegalStateException("The exported service ref " + value + " must be singleton! Please set the " + value + " bean scope to singleton, eg: <bean id=\"" + value + "\" scope=\"singleton\" ...>");
261:                                 }
262:                             }
263:                             // åˆ›å»º RuntimeBeanReference ï¼ŒæŒ‡å‘ Service çš„ Bean å¯¹è±¡
264:                             reference = new RuntimeBeanReference(value);
265:                         }
266:                         // è®¾ç½® BeanDefinition çš„å±æ€§å€¼
267:                         beanDefinition.getPropertyValues().addPropertyValue(property, reference);
268:                     }
269:                 }
270:             }
271:         }
272:     }
273: }
```

- ç¬¬ 150 è¡Œï¼šå·²è§£æçš„å±æ€§é›†åˆ `props` ã€‚è¯¥å±æ€§åœ¨ [ã€Œ3.2.8 å°† XML å…ƒç´ æœªéå†åˆ°çš„å±æ€§ï¼Œæ·»åŠ åˆ° `parameters` é›†åˆä¸­ã€](http://svip.iocoder.cn/Dubbo/configuration-xml/#) ä¼šä½¿ç”¨åˆ°ã€‚

- ç¬¬ 151 è¡Œï¼šè§£æçš„å‚æ•°é›†åˆ `parameters` ã€‚

- ç¬¬ 153 è¡Œï¼šå¾ªç¯ Bean å¯¹è±¡çš„ setting æ–¹æ³•ï¼Œå°†å±æ€§æ·»åŠ åˆ° Bean å¯¹è±¡çš„å±æ€§èµ‹å€¼ã€‚

- ç¬¬ 154 è‡³ 157 è¡Œï¼šåˆ¤æ–­æ–¹æ³•ç¬¦åˆ setting && `public` && å”¯ä¸€å‚æ•°çš„æ¡ä»¶ã€‚

- ç¬¬ 159 è‡³ 161 è¡Œï¼šæ·»åŠ **å±æ€§å**åˆ° `props` ã€‚

- ç¬¬ 162 è‡³ 176 è¡Œï¼šåˆ¤æ–­æ–¹æ³•ç¬¦åˆ getting && `public` && è¿”å›ç±»å‹ä¸ setting å‚æ•°ç±»å‹**ä¸€è‡´**çš„æ¡ä»¶ã€‚

- ç¬¬ 177 è‡³ 179 è¡Œï¼šè°ƒç”¨ [`#parseParameters(id, nodeList, beanDefinition, parserContext)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476) æ–¹æ³•ï¼Œè§£æ `<dubbo:argument />` æ ‡ç­¾ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3.6 parseParametersã€](http://svip.iocoder.cn/Dubbo/configuration-xml/#) æ–¹æ³•ã€‚

- ç¬¬ 180 è‡³ 182 è¡Œï¼šè°ƒç”¨ [`#parseMethods(id, nodeList, beanDefinition, parserContext)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476) æ–¹æ³•ï¼Œè§£æ `<dubbo:method />` æ ‡ç­¾ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3.4 parseMethodsã€](http://svip.iocoder.cn/Dubbo/configuration-xml/#) æ–¹æ³•ã€‚

- ç¬¬ 183 è‡³ 185 è¡Œï¼šè°ƒç”¨ [`#parseArguments(id, nodeList, beanDefinition, parserContext)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476) æ–¹æ³•ï¼Œè§£æ `<dubbo:argument />` æ ‡ç­¾ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3.5 parseArgumentsã€](http://svip.iocoder.cn/Dubbo/configuration-xml/#) æ–¹æ³•ã€‚

- ç¬¬ 191 è‡³ 195 è¡Œï¼šå¤„ç† `"registry"` å±æ€§ï¼Œä¸æƒ³æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„æƒ…å†µï¼Œå³ `registry=N/A` ã€‚

- ç¬¬ 196 è‡³ 204 è¡Œï¼šè°ƒç”¨ [`#parseMultiRef(property, beanDefinition, parserContext)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L301-L324) æ–¹æ³•ï¼Œå¤„ç†å¤šæ³¨å†Œä¸­å¿ƒã€å¤šæœåŠ¡æä¾›è€…ã€å¤šåè®®çš„æƒ…å†µä¸‹ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3. parseMultiRefã€](http://svip.iocoder.cn/Dubbo/configuration-xml/#) æ–¹æ³•ã€‚

- ç¬¬ 207 è‡³ 219 è¡Œï¼šå¤„ç†å±æ€§ç±»å‹ä¸º**åŸºç¡€å±æ€§**( [`#isPrimitive(Class)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L294-L299) )çš„æƒ…å†µã€‚

- ç¬¬ 220 è‡³ 233 è¡Œï¼šè¿™å—æ¯”è¾ƒ

  å¤æ‚

  ã€‚

  ```
  "protocol"
  ```

   

  å±æ€§ï¼Œåœ¨å¤šä¸ªæ ‡ç­¾ä¸­ä¼šä½¿ç”¨ï¼Œä¾‹å¦‚

   

  ```
  <dubbo:service />
  ```

   

  æˆ–è€…

   

  ```
  <dubbo:provider />
  ```

   

  ç­‰ç­‰ã€‚æ ¹æ®

   

  ã€ŠDubbo æ–‡æ¡£ â€”â€” schema é…ç½®å‚è€ƒæ‰‹å†Œã€‹

   

  çš„è¯´æ˜ï¼Œ

  ```
  "protocol"
  ```

   

  ä»£è¡¨çš„æ˜¯æŒ‡å‘çš„

   

  ```
  <dubbo:protocol />
  ```

   

  çš„ç¼–å·(

   

  ```
  id
  ```

   

  )ã€‚

  - ã€æ­¤å¤„æ˜¯çŒœæµ‹ã€‘ä½†æ˜¯ï¼Œæ—©æœŸçš„ç‰ˆæœ¬ï¼Œ`"protocol"` å±æ€§ï¼Œä»£è¡¨çš„æ˜¯**åè®®å**ã€‚è¿™å°±éº»çƒ¦äº†ï¼Œå’Œç°æœ‰çš„é€»è¾‘æœ‰å†²çªå•Šï¼

  - é‚£æ€ä¹ˆè§£å†³å‘¢ï¼Ÿä¼˜å…ˆä»¥æŒ‡å‘çš„ `<dubbo:protocol />` çš„**ç¼–å·**( `id` ) ä¸ºå‡†å¤‡ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯**åè®®å**ã€‚

  - é‚£å®é™…åœ¨è§£æ Bean å¯¹è±¡æ—¶ï¼Œå¸¦æœ‰

     

    ```
    "protocol"
    ```

     

    å±æ€§çš„æ ‡ç­¾ï¼Œæ— æ³•ä¿è¯ä¸€å®šåœ¨

     

    ```
    <dubbo:protocol />
    ```

     

    ä¹‹å

    è§£æã€‚é‚£å’‹æ•´å‘¢ï¼Ÿ

    - å¦‚æœå¸¦æœ‰ `"protocol"` å±æ€§çš„æ ‡ç­¾**å…ˆ**è§£æï¼Œå…ˆã€ç¬¬ 221 è‡³ 223 è¡Œã€‘**ç›´æ¥**åˆ›å»º ProtocolConfig å¯¹è±¡å¹¶è®¾ç½®åˆ° `"protocol"` å±æ€§ï¼Œå†ã€ç¬¬ 119 è‡³ 127 è¡Œã€‘åœ¨ `<dubbo:protocol />` è§£æåï¼Œè¿›è¡Œ**è¦†ç›–**ã€‚è¿™æ ·ï¼Œå¦‚æœä¸å­˜åœ¨ `<dubbo:protocol />` çš„æƒ…å†µï¼Œæœ€å¤šä¸è¿›è¡Œè¦†ç›–å‘¢ã€‚
    - å¦‚æœå¸¦æœ‰ `"protocol"` å±æ€§çš„æ ‡ç­¾**å**è§£æï¼Œæ— éœ€èµ°ä¸Šè¿°æµç¨‹ï¼Œèµ°ã€ç¬¬ 257 è‡³ 264 è¡Œã€‘å³å¯ã€‚
    - ğŸ™‚ å¦‚æœè¿™æ®µæ— æ³•ç†è§£ï¼Œå¯ä»¥ç»™æˆ‘ç•™è¨€ï¼Œæœ‰ç‚¹ç»•ã€‚

- ç¬¬ 234 è‡³ 243 è¡Œ **||** ç¬¬ 244 è‡³ 253 è¡Œï¼šå¤„ç† `"onreturn"` å’Œ `"onthrow"` å±æ€§ã€‚è¯¥å±æ€§ç”¨äº [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” äº‹ä»¶é€šçŸ¥ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/events-notify.html) åŠŸèƒ½ã€‚

- ç¬¬ 254 è‡³ 264 è¡Œï¼šå‰©ä½™æƒ…å†µï¼Œé€šç”¨è§£æï¼Œåˆ›å»º RuntimeBeanReference å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œ`<dubbo:service />` çš„ `"ref"` å±æ€§ã€‚

- ç¬¬ 267 è¡Œï¼šè®¾ç½® Bean çš„å±æ€§å€¼ã€‚**è¯¥å±æ€§å€¼æ¥è‡ªç¬¬ 206 è‡³ 265 è¡Œä»£ç çš„é€»è¾‘**ã€‚

##### 3.2.8 å°† XML å…ƒç´ æœªéå†åˆ°çš„å±æ€§ï¼Œæ·»åŠ åˆ° `parameters` é›†åˆä¸­

[`#parse(Element, ParserContext, beanClass, required)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L274-L290) çš„ç¬¬ 274 è‡³ 290 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š

```
274: // å°† XML å…ƒç´ ï¼Œæœªåœ¨ä¸Šé¢éå†åˆ°çš„å±æ€§ï¼Œæ·»åŠ åˆ° `parameters` é›†åˆä¸­ã€‚ç›®å‰æµ‹è¯•ä¸‹æ¥ï¼Œä¸å­˜åœ¨è¿™æ ·çš„æƒ…å†µã€‚
275: NamedNodeMap attributes = element.getAttributes();
276: int len = attributes.getLength();
277: for (int i = 0; i < len; i++) {
278:     Node node = attributes.item(i);
279:     String name = node.getLocalName();
280:     if (!props.contains(name)) {
281:         if (parameters == null) {
282:             parameters = new ManagedMap();
283:         }
284:         String value = node.getNodeValue();
285:         parameters.put(name, new TypedStringValue(value, String.class));
286:     }
287: }
288: if (parameters != null) {
289:     beanDefinition.getPropertyValues().addPropertyValue("parameters", parameters);
290: }
```

- ç¬¬ 275 è‡³ 287 è¡Œï¼šå°† XML å…ƒç´ ï¼Œ**æœªåœ¨ä¸Šé¢éå†åˆ°çš„å±æ€§**ï¼Œæ·»åŠ åˆ° `parameters` é›†åˆä¸­ã€‚ç›®å‰æµ‹è¯•ä¸‹æ¥ï¼Œä¸å­˜åœ¨è¿™æ ·çš„æƒ…å†µã€‚
- ç¬¬ 288 è‡³ 290 è¡Œï¼šè®¾ç½® Bean çš„ `parameters` ã€‚

### 3.3 è§£ææ–¹æ³•ã€è¾…æµç¨‹ã€‘

#### 3.3.1 parseProperties

[`#parseProperties(NodeList, RootBeanDefinition)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L368-L399) æ–¹æ³•ï¼Œè§£æ Service Bean å¯¹è±¡çš„å±æ€§ä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: /**
 2:  * è§£æ <dubbo:service class="" /> æƒ…å†µä¸‹ï¼Œå†…æ¶µçš„ `<property />` çš„èµ‹å€¼ã€‚
 3:  *
 4:  * @param nodeList å­å…ƒç´ æ•°ç»„
 5:  * @param beanDefinition Bean å®šä¹‰å¯¹è±¡
 6:  */
 7: private static void parseProperties(NodeList nodeList, RootBeanDefinition beanDefinition) {
 8:     if (nodeList != null && nodeList.getLength() > 0) {
 9:         for (int i = 0; i < nodeList.getLength(); i++) {
10:             Node node = nodeList.item(i);
11:             if (node instanceof Element) {
12:                 if ("property".equals(node.getNodeName())
13:                         || "property".equals(node.getLocalName())) {
14:                     String name = ((Element) node).getAttribute("name");
15:                     if (name != null && name.length() > 0) {
16:                         String value = ((Element) node).getAttribute("value");
17:                         String ref = ((Element) node).getAttribute("ref");
18:                         // value
19:                         if (value != null && value.length() > 0) {
20:                             beanDefinition.getPropertyValues().addPropertyValue(name, value);
21:                         // ref
22:                         } else if (ref != null && ref.length() > 0) {
23:                             beanDefinition.getPropertyValues().addPropertyValue(name, new RuntimeBeanReference(ref));
24:                         } else {
25:                             throw new UnsupportedOperationException("Unsupported <property name=\"" + name + "\"> sub tag, Only supported <property name=\"" + name + "\" ref=\"...\" /> or <property name=\"" + name + "\" value=\"...\" />");
26:                         }
27:                     }
28:                 }
29:             }
30:         }
31:     }
32: }
```

- ç¬¬ 11 è‡³ 13 è¡Œï¼š**åª**è§£æ `<property />` æ ‡ç­¾ã€‚
- ç¬¬ 18 è‡³ 20 è¡Œï¼šä¼˜å…ˆä½¿ç”¨ `"value"` å±æ€§ã€‚
- ç¬¬ 21 è‡³ 23 è¡Œï¼šå…¶æ¬¡ä½¿ç”¨ `"ref"` å±æ€§ã€‚
- ç¬¬ 24 è‡³ 27 è¡Œï¼šå±æ€§è¡¥å…¨ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚

#### 3.3.2 parseNested

[`#parseNested(...)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L326-L366) æ–¹æ³•ï¼Œè§£æå†…åµŒçš„æŒ‡å‘çš„å­ XML å…ƒç´ ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: /**
 2:  * è§£æå†…åµŒçš„æŒ‡å‘çš„å­ XML å…ƒç´ 
 3:  *
 4:  * @param element çˆ¶ XML å…ƒç´ 
 5:  * @param parserContext Spring è§£æä¸Šä¸‹æ–‡
 6:  * @param beanClass å†…åµŒè§£æå­å…ƒç´ çš„ Bean çš„ç±»
 7:  * @param required æ˜¯å¦éœ€è¦ Bean çš„ `id` å±æ€§
 8:  * @param tag æ ‡ç­¾
 9:  * @param property çˆ¶ Bean å¯¹è±¡åœ¨å­å…ƒç´ ä¸­çš„å±æ€§å
10:  * @param ref æŒ‡å‘
11:  * @param beanDefinition çˆ¶ Bean å®šä¹‰å¯¹è±¡
12:  */
13: private static void parseNested(Element element, ParserContext parserContext, Class<?> beanClass, boolean required, String tag,
14:                                 String property, String ref, BeanDefinition beanDefinition) {
15:     NodeList nodeList = element.getChildNodes();
16:     if (nodeList != null && nodeList.getLength() > 0) {
17:         boolean first = true;
18:         for (int i = 0; i < nodeList.getLength(); i++) {
19:             Node node = nodeList.item(i);
20:             if (node instanceof Element) {
21:                 if (tag.equals(node.getNodeName())
22:                         || tag.equals(node.getLocalName())) { // è¿™ä¸‰è¡Œï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæŒ‡å®šè¦è§£æçš„å­å…ƒç´ 
23:                     // ã€TODO 8008ã€‘ èŠ‹è‰¿ï¼Œdefault æ˜¯å¹²é”¤å­çš„
24:                     if (first) {
25:                         first = false;
26:                         String isDefault = element.getAttribute("default");
27:                         if (isDefault == null || isDefault.length() == 0) {
28:                             beanDefinition.getPropertyValues().addPropertyValue("default", "false");
29:                         }
30:                     }
31:                     // è§£æå­å…ƒç´ ï¼Œåˆ›å»º BeanDefinition å¯¹è±¡
32:                     BeanDefinition subDefinition = parse((Element) node, parserContext, beanClass, required);
33:                     // è®¾ç½®å­ BeanDefinition ï¼ŒæŒ‡å‘çˆ¶ BeanDefinition ã€‚
34:                     if (subDefinition != null && ref != null && ref.length() > 0) {
35:                         subDefinition.getPropertyValues().addPropertyValue(property, new RuntimeBeanReference(ref));
36:                     }
37:                 }
38:             }
39:         }
40:     }
41: }
```

- ç¬¬ 20 è‡³ 22 è¡Œï¼š**åª**è§£æ**æŒ‡å®šæ ‡ç­¾**ã€‚ç›®å‰æœ‰**å†…åµŒ**çš„ `<dubbo:service />` å’Œ `<dubbo:reference />` æ ‡ç­¾ã€‚
- ç¬¬ 32 è¡Œï¼šè§£ææŒ‡å®šæ ‡ç­¾ï¼Œåˆ›å»ºå­ Bean å¯¹è±¡ã€‚
- ç¬¬ 33 è‡³ 36 è¡Œï¼šè®¾ç½®åˆ›å»ºçš„**å­** Bean å¯¹è±¡ï¼ŒæŒ‡å‘**çˆ¶** Bean å¯¹è±¡ã€‚

#### 3.3.3 parseMultiRef

[`#parseMultiRef(property, beanDefinition, parserContext)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L301-L324) æ–¹æ³•ï¼Œè§£æå¤šæŒ‡å‘çš„æƒ…å†µï¼Œä¾‹å¦‚å¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®ç­‰ç­‰ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: /**
 2:  * è§£æå¤šæŒ‡å‘çš„æƒ…å†µï¼Œä¾‹å¦‚å¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®ç­‰ç­‰ã€‚
 3:  *
 4:  * @param property å±æ€§
 5:  * @param value å€¼
 6:  * @param beanDefinition Bean å®šä¹‰å¯¹è±¡
 7:  * @param parserContext Spring è§£æä¸Šä¸‹æ–‡
 8:  */
 9: @SuppressWarnings("unchecked")
10: private static void parseMultiRef(String property, String value, RootBeanDefinition beanDefinition,
11:                                   ParserContext parserContext) {
12:     String[] values = value.split("\\s*[,]+\\s*");
13:     ManagedList list = null;
14:     for (int i = 0; i < values.length; i++) {
15:         String v = values[i];
16:         if (v != null && v.length() > 0) {
17:             if (list == null) {
18:                 list = new ManagedList();
19:             }
20:             list.add(new RuntimeBeanReference(v));
21:         }
22:     }
23:     beanDefinition.getPropertyValues().addPropertyValue(property, list);
24: }
```

- ç¬¬ 12 è‡³ 22 è¡Œï¼šä»¥ `.` æ‹†åˆ†**å€¼**å­—ç¬¦ä¸²ï¼Œåˆ›å»º RuntimeBeanReference æ•°ç»„ã€‚
- ç¬¬ 23 è¡Œï¼šè®¾ç½® Bean å¯¹è±¡çš„æŒ‡å®šå±æ€§å€¼ã€‚

#### 3.3.4 parseMethods

[`#parseMethods(id, nodeList, beanDefinition, parserContext)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476) æ–¹æ³•ï¼Œè§£æ `<dubbo:method />` æ ‡ç­¾ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: /**
 2:  * è§£æ `<dubbo:method />`
 3:  *
 4:  * @param id Bean çš„ `id` å±æ€§ã€‚
 5:  * @param nodeList å­å…ƒç´ èŠ‚ç‚¹æ•°ç»„
 6:  * @param beanDefinition Bean å®šä¹‰å¯¹è±¡
 7:  * @param parserContext è§£æä¸Šä¸‹æ–‡
 8:  */
 9: @SuppressWarnings("unchecked")
10: private static void parseMethods(String id, NodeList nodeList, RootBeanDefinition beanDefinition,
11:                                  ParserContext parserContext) {
12:     if (nodeList != null && nodeList.getLength() > 0) {
13:         ManagedList methods = null; // è§£æçš„æ–¹æ³•æ•°ç»„
14:         for (int i = 0; i < nodeList.getLength(); i++) {
15:             Node node = nodeList.item(i);
16:             if (node instanceof Element) {
17:                 Element element = (Element) node;
18:                 if ("method".equals(node.getNodeName())
19:                         || "method".equals(node.getLocalName())) { // è¿™ä¸‰è¡Œï¼Œåˆ¤æ–­å€¼è§£æ `<dubbo:method />`
20:                     // æ–¹æ³•åä¸èƒ½ä¸ºç©º
21:                     String methodName = element.getAttribute("name");
22:                     if (methodName == null || methodName.length() == 0) {
23:                         throw new IllegalStateException("<dubbo:method> name attribute == null");
24:                     }
25:                     if (methods == null) {
26:                         methods = new ManagedList();
27:                     }
28:                     // è§£æ `<dubbo:method />`ï¼Œåˆ›å»º BeanDefinition å¯¹è±¡
29:                     BeanDefinition methodBeanDefinition = parse(((Element) node), parserContext, MethodConfig.class, false);
30:                     // æ·»åŠ åˆ° `methods` ä¸­
31:                     String name = id + "." + methodName;
32:                     BeanDefinitionHolder methodBeanDefinitionHolder = new BeanDefinitionHolder(methodBeanDefinition, name);
33:                     methods.add(methodBeanDefinitionHolder);
34:                 }
35:             }
36:         }
37:         if (methods != null) {
38:             beanDefinition.getPropertyValues().addPropertyValue("methods", methods);
39:         }
40:     }
41: }
```

- ç¬¬ 13 è¡Œï¼šè§£æçš„æ–¹æ³•æ•°ç»„ `methods` ã€‚
- ç¬¬ 16 è‡³ 19 è¡Œï¼š**åª**è§£æ `<dubbo:method>` æ ‡ç­¾ã€‚
- ç¬¬ 29 è¡Œï¼šè°ƒç”¨ [`#parse(Element, ParserContext)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L516-L518) æ–¹æ³•ï¼Œ**ä¸»æµç¨‹**ï¼Œè§£æ `<dubbo:method>` æ ‡ç­¾ï¼Œåˆ›å»ºå­ Bean å¯¹è±¡ã€‚
- ç¬¬ 33 è‡³ 36 è¡Œï¼šè®¾ç½®åˆ›å»ºçš„**å­** Bean å¯¹è±¡ï¼ŒæŒ‡å‘**çˆ¶** Bean å¯¹è±¡ã€‚
- ç¬¬ 30 è‡³ 33 è¡Œï¼šæ·»åŠ å­ Bean å¯¹è±¡åˆ° `methods` ä¸­ã€‚
- ç¬¬ 37 è‡³ 39 è¡Œï¼šè®¾ç½® Bean çš„ `methods` ã€‚

#### 3.3.5 parseArguments

[`#parseArguments(id, nodeList, beanDefinition, parserContext)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476) æ–¹æ³•ï¼Œè§£æ `<dubbo:argument />` æ ‡ç­¾ã€‚

å’Œ [ã€Œ3.3.4 parseMethodsã€](http://svip.iocoder.cn/Dubbo/configuration-xml/#) åŸºæœ¬ä¸€è‡´ï¼ŒğŸ™‚ ç‚¹å‡»æ–¹æ³•ï¼Œç›´æ¥æŸ¥çœ‹ä»£ç ã€‚

#### 3.3.6 parseParameters

[`#parseParameters(id, nodeList, beanDefinition, parserContext)`](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L401-L434) æ–¹æ³•ï¼Œè§£æ `<dubbo:argument />` æ ‡ç­¾ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: /**
 2:  * è§£æ `<dubbo:parameter />`
 3:  *
 4:  * @param nodeList å­å…ƒç´ èŠ‚ç‚¹æ•°ç»„
 5:  * @param beanDefinition Bean å®šä¹‰å¯¹è±¡
 6:  * @return å‚æ•°é›†åˆ
 7:  */
 8: @SuppressWarnings("unchecked")
 9: private static ManagedMap parseParameters(NodeList nodeList, RootBeanDefinition beanDefinition) {
10:     if (nodeList != null && nodeList.getLength() > 0) {
11:         ManagedMap parameters = null;
12:         for (int i = 0; i < nodeList.getLength(); i++) {
13:             Node node = nodeList.item(i);
14:             if (node instanceof Element) {
15:                 if ("parameter".equals(node.getNodeName())
16:                         || "parameter".equals(node.getLocalName())) { // è¿™ä¸‰è¡Œï¼Œåªè§£æå­å…ƒç´ ä¸­çš„ `<dubbo:parameter />`
17:                     if (parameters == null) {
18:                         parameters = new ManagedMap();
19:                     }
20:                     // æ·»åŠ åˆ°å‚æ•°é›†åˆ
21:                     String key = ((Element) node).getAttribute("key");
22:                     String value = ((Element) node).getAttribute("value");
23:                     boolean hide = "true".equals(((Element) node).getAttribute("hide")); // ã€TODO 8007ã€‘ <dubbo:parameter hide=â€œâ€ /> çš„ç”¨é€”
24:                     if (hide) {
25:                         key = Constants.HIDE_KEY_PREFIX + key;
26:                     }
27:                     parameters.put(key, new TypedStringValue(value, String.class));
28:                 }
29:             }
30:         }
31:         return parameters;
32:     }
33:     return null;
34: }
```

- ç¬¬ 13 è¡Œï¼šè§£æçš„å‚æ•°é›†åˆ `parameters` ã€‚
- ç¬¬ 20 è‡³ 27 è¡Œï¼šæ·»åŠ  `"key"` `"value"` åˆ° `parameters` ã€‚

# æ³¨è§£é…ç½®

## 1. æ¦‚è¿°

åœ¨ Dubbo æä¾›çš„å‡ ç§æ–¹å¼ä¸­ï¼Œ**æ³¨è§£é…ç½®**æ…¢æ…¢å˜æˆå¤§å®¶æœ€å¸¸ç”¨çš„æ–¹å¼ã€‚

å¦‚æœä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥æŸ¥çœ‹å¦‚ä¸‹æ–‡æ¡£ï¼š

- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æ³¨è§£é…ç½®ã€‹](http://dubbo.apache.org/zh-cn/docs/user/configuration/annotation.html)
- [ã€Šåœ¨ Dubbo ä¸­ä½¿ç”¨æ³¨è§£ã€‹](http://dubbo.apache.org/zh-cn/blog/dubbo-annotation.html)
- [ã€ŠDubbo æ³¨è§£é©±åŠ¨ï¼ˆAnnotation-Drivenï¼‰ã€‹](https://dubbo.apache.org/zh-cn/blog/dubbo-annotation-driven.html)

## 2. ä½¿ç”¨ç¤ºä¾‹

æˆ‘ä»¬æ¥çœ‹çœ‹ `dubbo-demo-annotation` é¡¹ç›®ä¸‹çš„ `dubbo-demo-annotation-provider` å­é¡¹ç›®æä¾›çš„ Dubbo Provider ç¤ºä¾‹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Application.java

public class Application {

    /**
     * In order to make sure multicast registry works, need to specify '-Djava.net.preferIPv4Stack=true' before
     * launch the application
     */
    public static void main(String[] args) throws Exception {
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(ProviderConfiguration.class);
        context.start();
        System.in.read();
    }

    @Configuration
    @EnableDubbo(scanBasePackages = "org.apache.dubbo.demo.provider") // <1>
    @PropertySource("classpath:/spring/dubbo-provider.properties") // <2>
    static class ProviderConfiguration {

        @Bean // <3>
        public RegistryConfig registryConfig() {
            RegistryConfig registryConfig = new RegistryConfig();
            registryConfig.setAddress("multicast://224.5.6.7:1234");
            return registryConfig;
        }

    }

}
```

- `<1>` å¤„ï¼Œä½¿ç”¨ `@EnableDubbo` æ³¨è§£ï¼Œé…ç½®æ‰«æ `"org.apache.dubbo.demo.provider"` ç›®å½•ä¸‹çš„ `@Service` å’Œ `@Reference` Bean å¯¹è±¡ã€‚
- `<2>` å¤„ï¼Œä½¿ç”¨ `@PropertySource` æ³¨è§£ï¼Œå¯¼å…¥ `"classpath:/spring/dubbo-provider.properties"` é…ç½®æ–‡ä»¶ã€‚
- `<3>` å¤„ï¼Œé€šè¿‡ `@Bean` æ³¨è§£æ–¹æ³•ï¼Œåˆ›å»º RegistryConfig Bean å¯¹è±¡ï¼Œå³æ³¨å†Œä¸­å¿ƒã€‚
- é€šè¿‡ä½¿ç”¨ Java Config + æ³¨è§£çš„æ–¹å¼ï¼Œç›¸æ¯” XML æ¥è¯´ï¼Œä¼šæ›´åŠ ç†Ÿæ‚‰ä¸€äº›~

ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹å…·ä½“çš„æºç è½ã€‚æœ¬æ–‡æ¶‰åŠçš„ç±»ï¼Œä¸»è¦å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![ç±»](assets/05.png)](http://static.iocoder.cn/images/Dubbo/2018_01_22/01.jpg)ç±»

## 3. @EnableDubbo

`org.apache.dubbo.config.spring.context.annotation.@EnableDubbo` æ³¨è§£ï¼Œæ˜¯ `@EnableDubboConfig` å’Œ `@DubboComponentScan` çš„ç»„åˆæ³¨è§£ï¼Œä½¿ç”¨æ—¶æ›´åŠ ä¾¿åˆ©ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// EnableDubbo.java

/**
 * Enables Dubbo components as Spring Beans, equals
 * {@link DubboComponentScan} and {@link EnableDubboConfig} combination.
 * <p>
 * Note : {@link EnableDubbo} must base on Spring Framework 4.2 and above
 *
 * @see DubboComponentScan
 * @see EnableDubboConfig
 * @since 2.5.8
 */
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Inherited
@Documented
@EnableDubboConfig // å¼€å¯ Dubbo Config
@DubboComponentScan // æ‰«æ Dubbo @Service å’Œ @Reference Bean
public @interface EnableDubbo {

    /**
     * é…ç½® @DubboComponentScan æ³¨è§£ï¼Œæ‰«æçš„åŒ…
     *
     * Base packages to scan for annotated @Service classes.
     * <p>
     * Use {@link #scanBasePackageClasses()} for a type-safe alternative to String-based
     * package names.
     *
     * @return the base packages to scan
     * @see DubboComponentScan#basePackages()
     */
    @AliasFor(annotation = DubboComponentScan.class, attribute = "basePackages")
    String[] scanBasePackages() default {};

    /**
     * é…ç½® @DubboComponentScan æ³¨è§£ï¼Œæ‰«æçš„ç±»
     *
     * Type-safe alternative to {@link #scanBasePackages()} for specifying the packages to
     * scan for annotated @Service classes. The package of each class specified will be
     * scanned.
     *
     * @return classes from the base packages to scan
     * @see DubboComponentScan#basePackageClasses
     */
    @AliasFor(annotation = DubboComponentScan.class, attribute = "basePackageClasses")
    Class<?>[] scanBasePackageClasses() default {};

    /**
     * é…ç½® @EnableDubboConfig æ³¨è§£ï¼Œé…ç½®æ˜¯å¦ç»‘å®šåˆ°å¤šä¸ª Spring Bean ä¸Š
     *
     * It indicates whether {@link AbstractConfig} binding to multiple Spring Beans.
     *
     * @return the default value is <code>false</code>
     * @see EnableDubboConfig#multiple()
     */
    @AliasFor(annotation = EnableDubboConfig.class, attribute = "multiple")
    boolean multipleConfig() default false;

}
```

- æ³¨æ„çœ‹ä¸‹å…·ä½“çš„æ³¨é‡Šã€‚

> é€šè¿‡ `@EnableDubbo` å¯ä»¥åœ¨æŒ‡å®šçš„åŒ…åä¸‹ï¼ˆé€šè¿‡ `scanBasePackages` å±æ€§ï¼‰ï¼Œæˆ–è€…æŒ‡å®šçš„ç±»ä¸­ï¼ˆé€šè¿‡ `scanBasePackageClasses` å±æ€§ï¼‰æ‰«æ Dubbo çš„æœåŠ¡æä¾›è€…ï¼ˆä»¥ `@Service` æ³¨è§£ï¼‰ä»¥åŠ Dubbo çš„æœåŠ¡æ¶ˆè´¹è€…ï¼ˆä»¥ `@Reference` æ³¨è§£ï¼‰ã€‚
>
> æ‰«æåˆ° Dubbo çš„æœåŠ¡æä¾›æ–¹å’Œæ¶ˆè´¹è€…ä¹‹åï¼Œå¯¹å…¶åšç›¸åº”çš„ç»„è£…å¹¶åˆå§‹åŒ–ï¼Œå¹¶æœ€ç»ˆå®ŒæˆæœåŠ¡æš´éœ²æˆ–è€…å¼•ç”¨çš„å·¥ä½œã€‚

## 4. @EnableDubboConfig

`org.apache.dubbo.config.spring.context.annotation.@EnableDubboConfig` æ³¨è§£ï¼Œå¼€å¯ Dubbo é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// EnableDubboConfig.java

/**
 * As  a convenient and multiple {@link EnableDubboConfigBinding}
 * in default behavior , is equal to single bean bindings with below convention prefixes of properties:
 * <ul>
 * <li>{@link ApplicationConfig} binding to property : "dubbo.application"</li>
 * <li>{@link ModuleConfig} binding to property :  "dubbo.module"</li>
 * <li>{@link RegistryConfig} binding to property :  "dubbo.registry"</li>
 * <li>{@link ProtocolConfig} binding to property :  "dubbo.protocol"</li>
 * <li>{@link MonitorConfig} binding to property :  "dubbo.monitor"</li>
 * <li>{@link ProviderConfig} binding to property :  "dubbo.provider"</li>
 * <li>{@link ConsumerConfig} binding to property :  "dubbo.consumer"</li>
 * </ul>
 * <p>
 * In contrast, on multiple bean bindings that requires to set {@link #multiple()} to be <code>true</code> :
 * <ul>
 * <li>{@link ApplicationConfig} binding to property : "dubbo.applications"</li>
 * <li>{@link ModuleConfig} binding to property :  "dubbo.modules"</li>
 * <li>{@link RegistryConfig} binding to property :  "dubbo.registries"</li>
 * <li>{@link ProtocolConfig} binding to property :  "dubbo.protocols"</li>
 * <li>{@link MonitorConfig} binding to property :  "dubbo.monitors"</li>
 * <li>{@link ProviderConfig} binding to property :  "dubbo.providers"</li>
 * <li>{@link ConsumerConfig} binding to property :  "dubbo.consumers"</li>
 * </ul>
 *
 * @see EnableDubboConfigBinding
 * @see DubboConfigConfiguration
 * @see DubboConfigConfigurationSelector
 * @since 2.5.8
 */
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Inherited
@Documented
@Import(DubboConfigConfigurationRegistrar.class)
public @interface EnableDubboConfig {

    /**
     * It indicates whether binding to multiple Spring Beans.
     *
     * é…ç½®æ˜¯å¦ç»‘å®šåˆ°å¤šä¸ª Spring Bean ä¸Š
     *
     * @return the default value is <code>false</code>
     * @revised 2.5.9
     */
    boolean multiple() default false;

}
```

- å…³äº

   

  ```
  multiple
  ```

   

  å±æ€§ï¼Œå¯èƒ½ç¬¬ä¸€çœ¼ä¼šæœ‰ç‚¹æ‡µé€¼ï¼Œé‚£å’‹æ•´å‘¢ï¼Ÿ

  - ç¬¬ä¸€æ­¥ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠDubbo æ–°ç¼–ç¨‹æ¨¡å‹ä¹‹å¤–éƒ¨åŒ–é…ç½® â€”â€” `@EnableDubboConfig`ã€‹](https://segmentfault.com/a/1190000012661402#articleHeader4) å¯¹ `@EnableDubboConfig` æ³¨è§£çš„ä»‹ç»ã€‚
  - ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åœ¨æ¥ä¸‹æ¥ä¼šçœ‹å…·ä½“çš„æºç ï¼Œä¼šæ›´æ˜“æ‡‚ä¸€äº›ã€‚

- `@Import(DubboConfigConfigurationRegistrar.class)` æ³¨è§£ï¼Œè¡¨æ˜ä½¿ç”¨ DubboConfigConfigurationRegistrar ç±»è¿›è¡Œå¯¼å…¥ã€‚è¯¦ç»†çš„ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹ [ã€Œ4.1 DubboConfigConfigurationRegistrarã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ã€‚

### 4.1 DubboConfigConfigurationRegistrar

`org.apache.dubbo.config.spring.context.annotation.DubboConfigConfigurationRegistrar` ï¼Œå®ç° ImportBeanDefinitionRegistrar æ¥å£ï¼Œå¤„ç† `@EnableDubboConfig` æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ DubboConfigConfiguration åˆ° Spring å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboConfigConfigurationRegistrar.java

/**
 * Dubbo {@link AbstractConfig Config} {@link ImportBeanDefinitionRegistrar register}, which order can be configured
 *
 * @see EnableDubboConfig
 * @see DubboConfigConfiguration
 * @see Ordered
 * @since 2.5.8
 */
public class DubboConfigConfigurationRegistrar implements ImportBeanDefinitionRegistrar {

    @Override
    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {
        // è·å¾— @EnableDubboConfig æ³¨è§£çš„å±æ€§
        AnnotationAttributes attributes = AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(EnableDubboConfig.class.getName()));
        // è·å¾— multiple å±æ€§
        boolean multiple = attributes.getBoolean("multiple");
        // å¦‚æœä¸º true ï¼Œåˆ™æ³¨å†Œ DubboConfigConfiguration.Multiple Bean å¯¹è±¡
        if (multiple) {
            AnnotatedBeanDefinitionRegistryUtils.registerBeans(registry, DubboConfigConfiguration.Multiple.class);
        // å¦‚æœä¸º false ï¼Œåˆ™æ³¨å†Œ DubboConfigConfiguration.Single Bean å¯¹è±¡
        } else {
            AnnotatedBeanDefinitionRegistryUtils.registerBeans(registry, DubboConfigConfiguration.Single.class);
        }
    }

}

// AnnotatedBeanDefinitionRegistryUtils.java

public static void registerBeans(BeanDefinitionRegistry registry, Class<?>... annotatedClasses) {
    if (ObjectUtils.isEmpty(annotatedClasses)) {
        return;
    }
    boolean debugEnabled = logger.isDebugEnabled();
    // åˆ›å»º AnnotatedBeanDefinitionReader å¯¹è±¡
    AnnotatedBeanDefinitionReader reader = new AnnotatedBeanDefinitionReader(registry);
    if (debugEnabled) {
        logger.debug(registry.getClass().getSimpleName() + " will register annotated classes : " + Arrays.asList(annotatedClasses) + " .");
    }
    // æ³¨å†Œ
    reader.register(annotatedClasses);
}
```

- æ ¹æ® `@EnableDubboConfig` æ³¨è§£ä¸Šçš„ `multiple` å±æ€§çš„ä¸åŒï¼Œåˆ›å»º DubboConfigConfiguration.Multiple æˆ– DubboConfigConfiguration.Single å¯¹è±¡ï¼Œæ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚

### 4.2 DubboConfigConfiguration

`org.apache.dubbo.config.spring.beans.factory.annotation.DubboConfigConfiguration` ï¼ŒDubbo AbstractConfig é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboConfigConfiguration.java

/**
 * Dubbo {@link AbstractConfig Config} {@link Configuration}
 *
 * @see Configuration
 * @see EnableDubboConfigBindings
 * @see EnableDubboConfigBinding
 * @see ApplicationConfig
 * @see ModuleConfig
 * @see RegistryConfig
 * @see ProtocolConfig
 * @see MonitorConfig
 * @see ProviderConfig
 * @see ConsumerConfig
 * @see org.apache.dubbo.config.ConfigCenterConfig
 * @since 2.5.8
 */
public class DubboConfigConfiguration {

    /**
     * Single Dubbo {@link AbstractConfig Config} Bean Binding
     */
    @EnableDubboConfigBindings({
            @EnableDubboConfigBinding(prefix = "dubbo.application", type = ApplicationConfig.class),
            @EnableDubboConfigBinding(prefix = "dubbo.module", type = ModuleConfig.class),
            @EnableDubboConfigBinding(prefix = "dubbo.registry", type = RegistryConfig.class),
            @EnableDubboConfigBinding(prefix = "dubbo.protocol", type = ProtocolConfig.class),
            @EnableDubboConfigBinding(prefix = "dubbo.monitor", type = MonitorConfig.class),
            @EnableDubboConfigBinding(prefix = "dubbo.provider", type = ProviderConfig.class),
            @EnableDubboConfigBinding(prefix = "dubbo.consumer", type = ConsumerConfig.class),
            @EnableDubboConfigBinding(prefix = "dubbo.config-center", type = ConfigCenterBean.class),
            @EnableDubboConfigBinding(prefix = "dubbo.metadata-report", type = MetadataReportConfig.class)
    })
    public static class Single {
    }

    /**
     * Multiple Dubbo {@link AbstractConfig Config} Bean Binding
     */
    @EnableDubboConfigBindings({
            @EnableDubboConfigBinding(prefix = "dubbo.applications", type = ApplicationConfig.class, multiple = true),
            @EnableDubboConfigBinding(prefix = "dubbo.modules", type = ModuleConfig.class, multiple = true),
            @EnableDubboConfigBinding(prefix = "dubbo.registries", type = RegistryConfig.class, multiple = true),
            @EnableDubboConfigBinding(prefix = "dubbo.protocols", type = ProtocolConfig.class, multiple = true),
            @EnableDubboConfigBinding(prefix = "dubbo.monitors", type = MonitorConfig.class, multiple = true),
            @EnableDubboConfigBinding(prefix = "dubbo.providers", type = ProviderConfig.class, multiple = true),
            @EnableDubboConfigBinding(prefix = "dubbo.consumers", type = ConsumerConfig.class, multiple = true),
            @EnableDubboConfigBinding(prefix = "dubbo.config-centers", type = ConfigCenterBean.class, multiple = true),
            @EnableDubboConfigBinding(prefix = "dubbo.metadata-reports", type = MetadataReportConfig.class, multiple = true)
    })
    public static class Multiple {
    }

}
```

- ä¹çœ¼ä¸€çœ‹ï¼Œå°±æ˜¯ Single å’Œ Multiple å†…éƒ¨ç±»ã€‚å…¶ä¸Šéƒ½æœ‰

   

  ```
  @@EnableDubboConfigBindings
  ```

   

  å’Œ

   

  ```
  @EnableDubboConfigBinding
  ```

   

  æ³¨è§£ã€‚

  - å‰è€… Single ï¼Œå…¶ä¸Šçš„æ³¨è§£ï¼Œ`prefix` éƒ½æ˜¯å•æ•°ã€‚
  - åè€… Multiple ï¼Œå…¶ä¸Šçš„æ³¨è§£ï¼Œ`prefix` éƒ½æ˜¯å¤æ•°ï¼Œä¸”æœ‰ `multiple = true` ã€‚

- é‚£ä¹ˆä¼šæœ‰ä»€ä¹ˆæ•ˆæœå‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€ [ã€Œ4.3 @@EnableDubboConfigBindingsã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) å’Œ [ã€Œ4.4 @@EnableDubboConfigBindingã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) çœ‹ã€‚

### 4.3 @EnableDubboConfigBindings

`org.apache.dubbo.config.spring.context.annotation.@EnableDubboConfigBindings` æ³¨è§£ï¼Œæ˜¯ `@EnableDubboConfigBinding` æ³¨è§£çš„æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// EnableDubboConfigBindings.java

/**
 * Multiple {@link EnableDubboConfigBinding} {@link Annotation}
 *
 * @since 2.5.8
 * @see EnableDubboConfigBinding
 */
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Import(DubboConfigBindingsRegistrar.class)
public @interface EnableDubboConfigBindings {

    /**
     * The value of {@link EnableDubboConfigBindings}
     *
     * @return non-null
     */
    EnableDubboConfigBinding[] value();

}
```

- `@Import(DubboConfigBindingsRegistrar.class)` æ³¨è§£ï¼Œè¡¨æ˜ä½¿ç”¨ DubboConfigBindingsRegistrar ç±»è¿›è¡Œå¯¼å…¥ã€‚è¯¦ç»†çš„ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹ [ã€Œ4.3.1 DubboConfigBindingsRegistrarã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ã€‚

#### 4.3.1 DubboConfigBindingsRegistrar

`org.apache.dubbo.config.spring.context.annotation.DubboConfigBindingsRegistrar` ï¼Œå®ç° ImportBeanDefinitionRegistrarã€EnvironmentAware æ¥å£ï¼Œå¤„ç† `@EnableDubboConfigBindings` æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ Dubbo AbstractConfig åˆ° Spring å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboConfigBindingsRegistrar.java

/**
 * {@link AbstractConfig Dubbo Config} binding Bean registrar for {@link EnableDubboConfigBindings}
 *
 * @see EnableDubboConfigBindings
 * @see DubboConfigBindingRegistrar
 * @since 2.5.8
 */
public class DubboConfigBindingsRegistrar implements ImportBeanDefinitionRegistrar, EnvironmentAware {

    private ConfigurableEnvironment environment;

    @Override
    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {
        // <1.1> è·å¾— @EnableDubboConfigBindings æ³¨è§£
        AnnotationAttributes attributes = AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(EnableDubboConfigBindings.class.getName()));
        // <1.2> è·å¾—å†…éƒ¨çš„ @EnableDubboConfigBinding æ³¨è§£çš„æ•°ç»„
        AnnotationAttributes[] annotationAttributes = attributes.getAnnotationArray("value");
        // <2> åˆ›å»º DubboConfigBindingRegistrar å¯¹è±¡ï¼Œå¹¶è®¾ç½® environment å±æ€§
        DubboConfigBindingRegistrar registrar = new DubboConfigBindingRegistrar();
        registrar.setEnvironment(environment);
        // <3> éå† annotationAttributes æ•°ç»„ï¼Œä½¿ç”¨ registrar è¿›è¡Œé€ä¸ª @EnableDubboConfigBinding æ³¨è§£çš„æ³¨å†Œå¯¹åº”çš„ Bean
        for (AnnotationAttributes element : annotationAttributes) {
            registrar.registerBeanDefinitions(element, registry);
        }
    }

    @Override
    public void setEnvironment(Environment environment) {
        Assert.isInstanceOf(ConfigurableEnvironment.class, environment);
        this.environment = (ConfigurableEnvironment) environment;
    }

}
```

- `<1.1>`ã€`<1.2>` å¤„ï¼Œè·å¾— `@EnableDubboConfigBindings` æ³¨è§£ï¼Œä»è€Œåé¢è·å¾—å†…éƒ¨çš„ `@EnableDubboConfigBinding` æ³¨è§£çš„æ•°ç»„ã€‚
- `<2>` å¤„ï¼Œåˆ›å»º DubboConfigBindingRegistrar å¯¹è±¡ï¼Œå¹¶è®¾ç½® `environment` å±æ€§ã€‚
- `<3>` å¤„ï¼Œéå† `annotationAttributes` æ•°ç»„ï¼Œä½¿ç”¨ `registrar` ï¼Œè°ƒç”¨ `DubboConfigBindingRegistrar#registerBeanDefinitions(AnnotationAttributes attributes, BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œè¿›è¡Œé€ä¸ª `@EnableDubboConfigBinding` æ³¨è§£çš„æ³¨å†Œå¯¹åº”çš„ Bean ã€‚
- åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ° DubboConfigBindingRegistrar æœ¬æ¥å°±æ˜¯ç”¨æ¥å¤„ç† `EnableDubboConfigBinding` æ³¨è§£ã€‚

### 4.4 @EnableDubboConfigBinding

`org.apache.dubbo.config.spring.context.annotation.@EnableDubboConfigBinding` æ³¨è§£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// EnableDubboConfigBinding.java

@Target({ElementType.TYPE, ElementType.ANNOTATION_TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Repeatable(EnableDubboConfigBindings.class)
@Import(DubboConfigBindingRegistrar.class)
public @interface EnableDubboConfigBinding {

    /**
     * The name prefix of the properties that are valid to bind to {@link AbstractConfig Dubbo Config}.
     *
     * é…ç½®å‰ç¼€
     *
     * @return the name prefix of the properties to bind
     */
    String prefix();

    /**
     * é…ç½®ç±»
     *
     * @return The binding type of {@link AbstractConfig Dubbo Config}.
     * @see AbstractConfig
     * @see ApplicationConfig
     * @see ModuleConfig
     * @see RegistryConfig
     */
    Class<? extends AbstractConfig> type();

    /**
     * æ˜¯å¦ multiple
     *
     * It indicates whether {@link #prefix()} binding to multiple Spring Beans.
     *
     * @return the default value is <code>false</code>
     */
    boolean multiple() default false;

}
```

- æ¯ä¸ªå±æ€§ï¼Œçœ‹å…¶ä¸Šçš„ä»£ç æ³¨é‡Šã€‚
- - `@Import(DubboConfigBindingRegistrar.class)` æ³¨è§£ï¼Œè¡¨æ˜ä½¿ç”¨ DubboConfigBindingRegistrar ç±»è¿›è¡Œå¯¼å…¥ã€‚è¯¦ç»†çš„ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹ [ã€Œ4.4.1 DubboConfigBindingRegistrarã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ã€‚

#### 4.4.1 DubboConfigBindingRegistrar

`org.apache.dubbo.config.spring.context.annotation.DubboConfigBindingRegistrar` ï¼Œå®ç° ImportBeanDefinitionRegistrarã€EnvironmentAware æ¥å£ï¼Œå¤„ç† `@EnableDubboConfigBinding` æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ Dubbo AbstractConfig åˆ° Spring å®¹å™¨ä¸­ã€‚

##### 4.4.1.1 registerBeanDefinitions

å®ç° `#registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œå¤„ç† `@EnableDubboConfigBinding` æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ Dubbo AbstractConfig åˆ° Spring å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboConfigBindingRegistrar.java

@Override
public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {
    // <1> è·å¾— @EnableDubboConfigBinding æ³¨è§£
    AnnotationAttributes attributes = AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(EnableDubboConfigBinding.class.getName()));
    // <2> æ³¨å†Œé…ç½®å¯¹åº”çš„ Bean Definition å¯¹è±¡
    registerBeanDefinitions(attributes, registry);
}

protected void registerBeanDefinitions(AnnotationAttributes attributes, BeanDefinitionRegistry registry) {
    // <2.1> è·å¾— prefix å±æ€§
    String prefix = environment.resolvePlaceholders(attributes.getString("prefix")); // å› ä¸ºï¼Œæœ‰å¯èƒ½æœ‰å ä½ç¬¦ï¼Œæ‰€ä»¥è¦è§£æã€‚
    // <2.2> è·å¾— type å±æ€§ï¼Œå³ AbstractConfig çš„å®ç°ç±»
    Class<? extends AbstractConfig> configClass = attributes.getClass("type");
    // <2.3> è·å¾— multiple å±æ€§
    boolean multiple = attributes.getBoolean("multiple");
    // <2.4> æ³¨å†Œ Dubbo Config Bean å¯¹è±¡
    registerDubboConfigBeans(prefix, configClass, multiple, registry);
}
```

- `<1>` å¤„ï¼Œè·å¾— `@EnableDubboConfigBinding` æ³¨è§£ã€‚

- ```
  <2>
  ```

   

  æ³¨å†Œé…ç½®å¯¹åº”çš„ Bean Definition å¯¹è±¡ã€‚ğŸ˜ˆ è¿™é‡Œæœ‰ä¸ªçŸ¥è¯†ç‚¹è¦è¡¥å……ä¸‹ï¼ŒSpring åœ¨åˆ›å»º Bean ä¹‹å‰ï¼Œä¼šå°† XML é…ç½®æˆ–è€…æ³¨è§£é…ç½®ï¼Œå…ˆè§£ææˆå¯¹åº”çš„ BeanDefinition å¯¹è±¡ï¼Œç„¶ååœ¨åˆ›å»º Bean å¯¹è±¡ã€‚

  - `<2.1>` å¤„ï¼Œè·å¾— `prefix` å±æ€§ã€‚
  - `<2.2>` å¤„ï¼Œè·å¾— `type` å±æ€§ï¼Œå³ AbstractConfig çš„å®ç°ç±»ã€‚
  - `<2.3>` å¤„ï¼Œè·å¾— `multiple` å±æ€§ã€‚
  - `<2.4>` å¤„ï¼Œè°ƒç”¨ `#registerDubboConfigBeans(String prefix, Class<? extends AbstractConfig> configClass, boolean multiple, BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œæ³¨å†Œ Dubbo Config Bean å¯¹è±¡ã€‚

##### 4.4.1.2 registerDubboConfigBeans

`#registerDubboConfigBeans(String prefix, Class<? extends AbstractConfig> configClass, boolean multiple, BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œæ³¨å†Œ Dubbo Config Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboConfigBindingRegistrar.java

private void registerDubboConfigBeans(String prefix, Class<? extends AbstractConfig> configClass, boolean multiple,
                                      BeanDefinitionRegistry registry) {
    // <1.1> è·å¾— prefix å¼€å¤´çš„é…ç½®å±æ€§
    Map<String, Object> properties = PropertySourcesUtils.getSubProperties(environment.getPropertySources(), prefix);
    // <1.2> å¦‚æœé…ç½®å±æ€§ä¸ºç©ºï¼Œåˆ™æ— éœ€åˆ›å»º
    if (CollectionUtils.isEmpty(properties)) {
        if (log.isDebugEnabled()) {
            log.debug("There is no property for binding to dubbo config class [" + configClass.getName()
                    + "] within prefix [" + prefix + "]");
        }
        return;
    }
    // <2> è·å¾—é…ç½®å±æ€§å¯¹åº”çš„ Bean åå­—çš„é›†åˆ
    Set<String> beanNames = multiple ? resolveMultipleBeanNames(properties) :
            Collections.singleton(resolveSingleBeanName(properties, configClass, registry));
    // <3> éå† beanNames æ•°ç»„ï¼Œé€ä¸ªæ³¨å†Œ
    for (String beanName : beanNames) {
        // <3.1> æ³¨æ³¨å†Œ Dubbo Config Bean å¯¹è±¡
        registerDubboConfigBean(beanName, configClass, registry);
        // <3.2> æ³¨æ³¨å†Œ Dubbo Config å¯¹è±¡å¯¹åº”çš„ DubboConfigBindingBeanPostProcessor å¯¹è±¡
        registerDubboConfigBindingBeanPostProcessor(prefix, beanName, multiple, registry);
    }
}
```

- `<1.1>` å¤„ï¼Œè°ƒç”¨ `PropertySourcesUtils#getSubProperties(Iterable<PropertySource<?>> propertySources, String prefix)` æ–¹æ³•ï¼Œè·å¾— `prefix` å¼€å¤´çš„é…ç½®å±æ€§ã€‚å› ä¸ºï¼Œåç»­ä¼šç”¨è¿™ä¸ªå±æ€§ï¼Œè®¾ç½®åˆ°åˆ›å»ºçš„ Bean å¯¹è±¡ä¸­ã€‚

- `<1.2>` å¤„ï¼Œå¦‚æœé…ç½®å±æ€§ä¸ºç©ºï¼Œåˆ™æ— éœ€åˆ›å»ºã€‚

- `<2>` å¤„ï¼Œæ ¹æ® `multiple` çš„å€¼ï¼Œè°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼Œè·å¾—é…ç½®å±æ€§å¯¹åº”çš„ Bean åå­—çš„é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // DubboConfigBindingRegistrar.java
  
  // ä¾‹å¦‚ï¼šdubbo.application.${beanName}.name=dubbo-demo-annotation-provider
  private Set<String> resolveMultipleBeanNames(Map<String, Object> properties) {
      Set<String> beanNames = new LinkedHashSet<String>();
      for (String propertyName : properties.keySet()) {
          // è·å–ä¸Šè¿°ç¤ºä¾‹çš„ ${beanName} å­—ç¬¦ä¸²
          int index = propertyName.indexOf(".");
          if (index > 0) {
              String beanName = propertyName.substring(0, index);
              beanNames.add(beanName);
          }
      }
      return beanNames;
  }
  
  // ä¾‹å¦‚ï¼šdubbo.application.name=dubbo-demo-annotation-provider
  private String resolveSingleBeanName(Map<String, Object> properties, Class<? extends AbstractConfig> configClass,
                                       BeanDefinitionRegistry registry) {
      // è·å¾— Bean çš„åå­—
      String beanName = (String) properties.get("id");
      // å¦‚æœå®šä¹‰ï¼ŒåŸºäº Spring æä¾›çš„æœºåˆ¶ï¼Œç”Ÿæˆå¯¹åº”çš„ Bean çš„åå­—ã€‚ä¾‹å¦‚è¯´ï¼šorg.apache.dubbo.config.ApplicationConfig#0
      if (!StringUtils.hasText(beanName)) {
          BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(configClass);
          beanName = BeanDefinitionReaderUtils.generateBeanName(builder.getRawBeanDefinition(), registry);
      }
      return beanName;
  }
  ```

  - è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œçœ‹çœ‹æˆ‘æä¾›çš„ç¤ºä¾‹ã€‚

  - `#resolveMultipleBeanNames(Map<String, Object> properties)` æ–¹æ³•ï¼Œå¯èƒ½æ¯”è¾ƒéš¾ç†è§£ä¸€ç‚¹ã€‚å¯ä»¥å¢åŠ å¦‚ä¸‹åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼š

    ```
    # application.properties
    dubbo.applications.x.name=biu
    dubbo.applications.y.name=biubiubiu
    ```

    - æ­¤æ—¶ï¼Œä½ éœ€è¦æŒ‡å®š `@Service` Bean ä½¿ç”¨å“ªä¸ªåº”ç”¨ã€‚

- `<3>` å¤„ï¼Œéå† `beanNames` æ•°ç»„ï¼Œé€ä¸ªæ³¨å†Œã€‚

  - `<3.1>` å¤„ï¼Œè°ƒç”¨ `#registerDubboConfigBean(String beanName, Class<? extends AbstractConfig> configClass, BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œæ³¨å†Œ Dubbo Config Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
    // DubboConfigBindingRegistrar.java
    
    private void registerDubboConfigBean(String beanName, Class<? extends AbstractConfig> configClass,
                                         BeanDefinitionRegistry registry) {
        // åˆ›å»º BeanDefinitionBuilder å¯¹è±¡
        BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(configClass);
        // è·å¾— AbstractBeanDefinition å¯¹è±¡
        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();
        // æ³¨å†Œåˆ° registry ä¸­
        registry.registerBeanDefinition(beanName, beanDefinition);
        if (log.isInfoEnabled()) {
            log.info("The dubbo config bean definition [name : " + beanName + ", class : " + configClass.getName() + "] has been registered.");
        }
    }
    ```

    - æ­¤æ—¶ï¼Œä»…ä»…æ˜¯é€šè¿‡é…±ç´«çš„æ–¹å¼ï¼Œåˆ›å»ºäº†ä¸€ä¸ª Dubbo Config Bean å¯¹è±¡ï¼Œå¹¶æ²¡æœ‰å°†é…ç½®å±æ€§ï¼Œè®¾ç½®åˆ°è¯¥å¯¹è±¡ä¸­ã€‚ç­”æ¡ˆåœ¨ `<3.2>` ä¸­ã€‚

  - `<3.2>` å¤„ï¼Œè°ƒç”¨ `#registerDubboConfigBindingBeanPostProcessor(String prefix, String beanName, boolean multiple, BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œæ³¨å†Œ Dubbo Config å¯¹è±¡å¯¹è±¡çš„ DubboConfigBindingBeanPostProcessor å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
    // DubboConfigBindingRegistrar.java
    
    private void registerDubboConfigBindingBeanPostProcessor(String prefix, String beanName, boolean multiple,
                                                             BeanDefinitionRegistry registry) {
        // åˆ›å»º BeanDefinitionBuilder å¯¹è±¡
        Class<?> processorClass = DubboConfigBindingBeanPostProcessor.class;
        BeanDefinitionBuilder builder = rootBeanDefinition(processorClass);
        // æ·»åŠ æ„é€ æ–¹æ³•çš„å‚æ•°ä¸º actualPrefix å’Œ beanName ã€‚å³ï¼Œåˆ›å»º DubboConfigBindingBeanPostProcessor å¯¹è±¡ï¼Œéœ€è¦è¿™ä¸¤ä¸ªæ„é€ å‚æ•°
        String actualPrefix = multiple ? PropertySourcesUtils.normalizePrefix(prefix) + beanName : prefix;
        builder.addConstructorArgValue(actualPrefix).addConstructorArgValue(beanName);
        // è·å¾— AbstractBeanDefinition å¯¹è±¡
        AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();
        // è®¾ç½® role å±æ€§
        beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);
        // æ³¨å†Œåˆ° registry ä¸­
        BeanDefinitionReaderUtils.registerWithGeneratedName(beanDefinition, registry);
        if (log.isInfoEnabled()) {
            log.info("The BeanPostProcessor bean definition [" + processorClass.getName() + "] for dubbo config bean [name : " + beanName + "] has been registered.");
        }
    }
    ```

    - å› ä¸ºæ­¤æ—¶ Dubbo Config Bean å¯¹è±¡è¿˜æœªåˆ›å»ºï¼Œæ‰€ä»¥éœ€è¦ç­‰åç»­å®ƒçœŸçš„åˆ›å»ºä¹‹åï¼Œä½¿ç”¨ DubboConfigBindingBeanPostProcessor ç±»ï¼Œå®ç°å¯¹å¯¹è±¡ï¼ˆBean å¯¹è±¡ï¼‰çš„é…ç½®è¾“å…¥çš„è®¾ç½®ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°ï¼Œéœ€è¦ç»§ç»­æŒ–æ˜ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ¥çœ‹ [ã€ŒDubboConfigBindingBeanPostProcessorã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ç±»ã€‚

### 4.5 DubboConfigBindingBeanPostProcessor

`org.apache.dubbo.config.spring.beans.factory.annotation.DubboConfigBindingBeanPostProcessor` ï¼Œå®ç° BeanPostProcessorã€ApplicationContextAwareã€InitializingBean æ¥å£ï¼Œå¤„ç† Dubbo AbstractConfig Bean çš„é…ç½®å±æ€§æ³¨å…¥ã€‚

#### 4.5.1 æ„é€ æ–¹æ³•

```
// DubboConfigBindingBeanPostProcessor.java

/**
 * The prefix of Configuration Properties
 *
 * é…ç½®å±æ€§çš„å‰ç¼€
 */
private final String prefix;

/**
 * Binding Bean Name
 *
 * Bean çš„åå­—
 */
private final String beanName;

private DubboConfigBinder dubboConfigBinder;

private ApplicationContext applicationContext;

/**
 * æ˜¯å¦å¿½ç•¥ä½ç½®çš„å±æ€§
 */
private boolean ignoreUnknownFields = true;

/**
 * æ˜¯å¦å¿½ç•¥ç±»å‹ä¸å¯¹çš„å±æ€§
 */
private boolean ignoreInvalidFields = true;

/**
 * @param prefix   the prefix of Configuration Properties
 * @param beanName the binding Bean Name
 */
public DubboConfigBindingBeanPostProcessor(String prefix, String beanName) {
    Assert.notNull(prefix, "The prefix of Configuration Properties must not be null");
    Assert.notNull(beanName, "The name of bean must not be null");
    this.prefix = prefix;
    this.beanName = beanName;
}
```

- æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­ä¼šçœ‹åˆ°ï¼Œåˆ›å»º DubboConfigBindingBeanPostProcessor Bean æ—¶ï¼Œä¼šæœ‰ `builder.addConstructorArgValue(actualPrefix).addConstructorArgValue(beanName);` ä¸€æ®µçš„ä»£ç ã€‚

#### 4.5.2 afterPropertiesSet

`#afterPropertiesSet()` æ–¹æ³•ï¼Œè®¾ç½® `dubboConfigBinder` å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboConfigBindingBeanPostProcessor.java

@Override
public void afterPropertiesSet() throws Exception {
    // è·å¾—ï¼ˆåˆ›å»ºï¼‰DubboConfigBinder å¯¹è±¡
    if (dubboConfigBinder == null) {
        try {
            dubboConfigBinder = applicationContext.getBean(DubboConfigBinder.class);
        } catch (BeansException ignored) {
            if (log.isDebugEnabled()) {
                log.debug("DubboConfigBinder Bean can't be found in ApplicationContext.");
            }
            // Use Default implementation
            dubboConfigBinder = createDubboConfigBinder(applicationContext.getEnvironment());
        }
    }
    // è®¾ç½® ignoreUnknownFieldsã€ignoreInvalidFields å±æ€§
    dubboConfigBinder.setIgnoreUnknownFields(ignoreUnknownFields);
    dubboConfigBinder.setIgnoreInvalidFields(ignoreInvalidFields);
}

/**
 * Create {@link DubboConfigBinder} instance.
 *
 * @param environment
 * @return {@link DefaultDubboConfigBinder}
 */
protected DubboConfigBinder createDubboConfigBinder(Environment environment) {
    // åˆ›å»º DefaultDubboConfigBinder å¯¹è±¡
    DefaultDubboConfigBinder defaultDubboConfigBinder = new DefaultDubboConfigBinder();
    // è®¾ç½® environment å±æ€§
    defaultDubboConfigBinder.setEnvironment(environment);
    return defaultDubboConfigBinder;
}
```

- å…³äº DefaultDubboConfigBinder ç±»ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢çš„å°èŠ‚å…ˆæ¥ç…ç…ã€‚

##### 4.5.2.1 DubboConfigBinder

`org.apache.dubbo.config.spring.context.properties.DubboConfigBinder` ï¼Œç»§æ‰¿ EnvironmentAware æ¥å£ï¼ŒDubbo Config Binder æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboConfigBinder.java

/**
 * {@link AbstractConfig DubboConfig} Binder
 *
 * @see AbstractConfig
 * @see EnvironmentAware
 * @since 2.5.11
 */
public interface DubboConfigBinder extends EnvironmentAware {

    /**
     * Set whether to ignore unknown fields, that is, whether to ignore bind
     * parameters that do not have corresponding fields in the target object.
     * <p>Default is "true". Turn this off to enforce that all bind parameters
     * must have a matching field in the target object.
     *
     * @see #bind
     */
    void setIgnoreUnknownFields(boolean ignoreUnknownFields);

    /**
     * Set whether to ignore invalid fields, that is, whether to ignore bind
     * parameters that have corresponding fields in the target object which are
     * not accessible (for example because of null values in the nested path).
     * <p>Default is "false".
     *
     * @see #bind
     */
    void setIgnoreInvalidFields(boolean ignoreInvalidFields);

    /**
     * Bind the properties to Dubbo Config Object under specified prefix.
     *
     * @param prefix
     * @param dubboConfig
     */
    <C extends AbstractConfig> void bind(String prefix, C dubboConfig);
    
}
```

- åç»­çš„å®ç°ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°åŸºäº Spring DataBinder æ¥å®ç°ã€‚ä¸äº†è§£ DataBinder çš„ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠSpring éªŒè¯ã€æ•°æ®ç»‘å®šå’Œç±»å‹è½¬æ¢ã€‹](https://my.oschina.net/u/2453016/blog/1512184) æ–‡ç« ã€‚

##### 4.5.2.2 DubboConfigBinder

`org.apache.dubbo.config.spring.context.properties.AbstractDubboConfigBinder` ï¼Œå®ç° DubboConfigBinder æ¥å£ï¼ŒDubboConfigBinder çš„æŠ½è±¡åŸºç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// AbstractDubboConfigBinder.java

public abstract class AbstractDubboConfigBinder implements DubboConfigBinder {

    /**
     * PropertySource æ•°ç»„ï¼ˆè¿­ä»£ï¼‰
     */
    private Iterable<PropertySource<?>> propertySources;

    private boolean ignoreUnknownFields = true;

    private boolean ignoreInvalidFields = false;

    /**
     * Get multiple {@link PropertySource propertySources}
     *
     * @return multiple {@link PropertySource propertySources}
     */
    protected Iterable<PropertySource<?>> getPropertySources() {
        return propertySources;
    }

    public boolean isIgnoreUnknownFields() {
        return ignoreUnknownFields;
    }

    @Override
    public void setIgnoreUnknownFields(boolean ignoreUnknownFields) {
        this.ignoreUnknownFields = ignoreUnknownFields;
    }

    public boolean isIgnoreInvalidFields() {
        return ignoreInvalidFields;
    }

    @Override
    public void setIgnoreInvalidFields(boolean ignoreInvalidFields) {
        this.ignoreInvalidFields = ignoreInvalidFields;
    }

    @Override
    public final void setEnvironment(Environment environment) {
        if (environment instanceof ConfigurableEnvironment) {
            this.propertySources = ((ConfigurableEnvironment) environment).getPropertySources();
        }
    }

}
```

- æä¾›é»˜è®¤çš„å±æ€§ã€‚

##### 4.5.2.3 DefaultDubboConfigBinder

`org.apache.dubbo.config.spring.context.properties.DefaultDubboConfigBinder` ï¼Œç»§æ‰¿ AbstractDubboConfigBinder æŠ½è±¡ç±»ï¼Œä½¿ç”¨ Spring DataBinder ï¼Œå°†é…ç½®å±æ€§è®¾ç½®åˆ° Dubbo Config å¯¹è±¡ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DefaultDubboConfigBinder.java

/**
 * Default {@link DubboConfigBinder} implementation based on Spring {@link DataBinder}
 */
public class DefaultDubboConfigBinder extends AbstractDubboConfigBinder {

    @Override
    public <C extends AbstractConfig> void bind(String prefix, C dubboConfig) {
        // å°† dubboConfig åŒ…è£…æˆ DataBinder å¯¹è±¡
        DataBinder dataBinder = new DataBinder(dubboConfig);
        // Set ignored*
        // è®¾ç½®å“åº”çš„ ignored* å±æ€§
        dataBinder.setIgnoreInvalidFields(isIgnoreInvalidFields());
        dataBinder.setIgnoreUnknownFields(isIgnoreUnknownFields());
        // Get properties under specified prefix from PropertySources
        // è·å¾— prefix å¼€å¤´çš„é…ç½®å±æ€§
        Map<String, Object> properties = PropertySourcesUtils.getSubProperties(getPropertySources(), prefix);
        // Convert Map to MutablePropertyValues
        // åˆ›å»º MutablePropertyValues å¯¹è±¡
        MutablePropertyValues propertyValues = new MutablePropertyValues(properties);
        // Bind
        // ç»‘å®šé…ç½®å±æ€§åˆ° dubboConfig ä¸­
        dataBinder.bind(propertyValues);
    }

}
```

- æ¯”è¾ƒç®€å•ï¼Œè‡ªå·±ç…ä¸€çœ¼ä»£ç å³å¯ã€‚

åœ¨ [ã€ŠDubbo æºç åˆ†æ â€”â€” é›†æˆ Spring Bootã€‹](http://www.iocoder.cn/Dubbo/spring-boot-integration/) ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦å¤–ä¸€ä¸ª AbstractDubboConfigBinder çš„å®ç°ç±» RelaxedDubboConfigBinder ï¼Œå®ƒæ˜¯åŸºäº Spring Boot [Binder](https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/context/properties/bind/Binder.html) è¿›è¡Œå®ç°ã€‚ğŸ˜ˆ å› ä¸ºè‰¿è‰¿æ²¡æœ‰æ·±å…¥äº†è§£è¿‡ Spring Boot Binder ç›¸å…³ï¼Œæ‰€ä»¥è¿˜è¯´ä¸å‡ºå’Œ Spring DataBinder çš„åŒºåˆ«åœ¨å“ªã€‚orz

#### 4.5.3 postProcessBeforeInitialization

å®ç° `#postProcessBeforeInitialization(Object bean, String beanName)` æ–¹æ³•ï¼Œè®¾ç½®é…ç½®å±æ€§åˆ° Dubbo Config ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboConfigBindingBeanPostProcessor.java

@Override
public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
    // åˆ¤æ–­å¿…é¡»æ˜¯ beanName ï¼Œå¹¶ä¸”æ˜¯ AbstractConfig ç±»å‹
    if (beanName.equals(this.beanName) && bean instanceof AbstractConfig) {
        AbstractConfig dubboConfig = (AbstractConfig) bean;
        // è®¾ç½®å±æ€§åˆ° dubboConfig ä¸­
        dubboConfigBinder.bind(prefix, dubboConfig);
        if (log.isInfoEnabled()) {
            log.info("The properties of bean [name : " + beanName + "] have been binding by prefix of " + "configuration properties : " + prefix);
        }
    }
    return bean;
}
```

è‡³æ­¤ï¼ŒDubbo Config å¯¹è±¡çš„åˆ›å»ºå’Œå±æ€§è®¾ç½®ï¼Œå·²ç»å®Œæˆã€‚å¦‚æœè¿˜æ˜¯æœ‰ç‚¹æ‡µé€¼ï¼Œå¯ä»¥è°ƒè¯•ä¸€æ¬¡ï¼Œæ²¡æœ‰ä»€ä¹ˆå¤æ‚é€»è¾‘å“Ÿã€‚

## 5. @DubboComponentScan

`org.apache.dubbo.config.spring.context.annotation.@DubboComponentScan` æ³¨è§£ï¼Œé…ç½®è¦æ‰«æ `@Service` å’Œ `@Reference` æ³¨è§£çš„åŒ…æˆ–è€…ç±»ä»¬ï¼Œä»è€Œåˆ›å»ºå¯¹åº”çš„ Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboComponentScan.java

/**
 * Dubbo Component Scan {@link Annotation},scans the classpath for annotated components that will be auto-registered as
 * Spring beans. Dubbo-provided {@link Service} and {@link Reference}.
 *
 * @see Service
 * @see Reference
 * @since 2.5.7
 */
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Import(DubboComponentScanRegistrar.class)
public @interface DubboComponentScan {

    /**
     * å’Œ {@link #basePackages()} ç­‰ä»·
     *
     * Alias for the {@link #basePackages()} attribute. Allows for more concise annotation
     * declarations e.g.: {@code @DubboComponentScan("org.my.pkg")} instead of
     * {@code @DubboComponentScan(basePackages="org.my.pkg")}.
     *
     * @return the base packages to scan
     */
    String[] value() default {};

    /**
     * è¦æ‰«æçš„åŒ…çš„æ•°ç»„
     *
     * Base packages to scan for annotated @Service classes. {@link #value()} is an
     * alias for (and mutually exclusive with) this attribute.
     * <p>
     * Use {@link #basePackageClasses()} for a type-safe alternative to String-based
     * package names.
     *
     * @return the base packages to scan
     */
    String[] basePackages() default {};

    /**
     * è¦æ‰«æçš„ç±»çš„æ•°ç»„
     *
     * Type-safe alternative to {@link #basePackages()} for specifying the packages to
     * scan for annotated @Service classes. The package of each class specified will be
     * scanned.
     *
     * @return classes from the base packages to scan
     */
    Class<?>[] basePackageClasses() default {};

}
```

- `@Import(DubboComponentScanRegistrar.class)` æ³¨è§£ï¼Œè¡¨æ˜ä½¿ç”¨ DubboComponentScanRegistrar ç±»è¿›è¡Œå¯¼å…¥ã€‚è¯¦ç»†çš„ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹ [ã€Œ5.1 DubboComponentScanRegistrarã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ã€‚

### 5.1 DubboComponentScanRegistrar

`org.apache.dubbo.config.spring.context.annotation.DubboComponentScanRegistrar` ï¼Œå®ç° ImportBeanDefinitionRegistrar æ¥å£ï¼Œå¤„ç† `@DubboComponentScan` æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ ServiceAnnotationBeanPostProcessor å’Œ ReferenceAnnotationBeanPostProcessor åˆ° Spring å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboComponentScanRegistrar.java

@Override
public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {
    // <1> è·å¾—è¦æ‰«æçš„åŒ…
    Set<String> packagesToScan = getPackagesToScan(importingClassMetadata);
    // <2> åˆ›å»º ServiceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ `@Service` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Service Bean å¯¹è±¡
    registerServiceAnnotationBeanPostProcessor(packagesToScan, registry);
    // <3> åˆ›å»º ReferenceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ `@Reference` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Reference Bean å¯¹è±¡
    registerReferenceAnnotationBeanPostProcessor(registry);
}

// ... çœç•¥ç¨åè°ƒç”¨çš„æ–¹æ³•ã€‚
```

- `<1>` å¤„ï¼Œè°ƒç”¨ `#getPackagesToScan(AnnotationMetadata metadata)` æ–¹æ³•ï¼Œè·å¾—è¦æ‰«æçš„åŒ…ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // DubboComponentScanRegistrar.java
  
  private Set<String> getPackagesToScan(AnnotationMetadata metadata) {
      // è·å¾— @DubboComponentScan æ³¨è§£
      AnnotationAttributes attributes = AnnotationAttributes.fromMap(metadata.getAnnotationAttributes(DubboComponentScan.class.getName()));
      // è·å¾—å…¶ä¸Šçš„å±æ€§
      String[] basePackages = attributes.getStringArray("basePackages");
      Class<?>[] basePackageClasses = attributes.getClassArray("basePackageClasses");
      String[] value = attributes.getStringArray("value");
      // Appends value array attributes
      // æƒ…å†µä¸€ï¼Œå°†å±æ€§æ·»åŠ åˆ° packagesToScan é›†åˆä¸­
      Set<String> packagesToScan = new LinkedHashSet<String>(Arrays.asList(value));
      packagesToScan.addAll(Arrays.asList(basePackages));
      for (Class<?> basePackageClass : basePackageClasses) {
          packagesToScan.add(ClassUtils.getPackageName(basePackageClass));
      }
      // æƒ…å†µäºŒï¼Œå¦‚æœ packagesToScan ä¸ºç©ºï¼Œåˆ™é»˜è®¤ä½¿ç”¨æ³¨è§£ç±»æ‰€åœ¨çš„åŒ…
      if (packagesToScan.isEmpty()) {
          return Collections.singleton(ClassUtils.getPackageName(metadata.getClassName()));
      }
      return packagesToScan;
  }
  ```

  - æœ‰ä¸¤ç§æƒ…å†µï¼Œçœ‹çš„æ—¶å€™ï¼Œè¦æ³¨æ„ä¸‹ã€‚

- `<2>` å¤„ï¼Œè°ƒç”¨ `#registerServiceAnnotationBeanPostProcessor(Set<String> packagesToScan, BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œåˆ›å»º ServiceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ `@Service` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Service Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // DubboComponentScanRegistrar.java
  
  private void registerServiceAnnotationBeanPostProcessor(Set<String> packagesToScan, BeanDefinitionRegistry registry) {
      // åˆ›å»º BeanDefinitionBuilder å¯¹è±¡
      BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(ServiceAnnotationBeanPostProcessor.class);
      // è®¾ç½®æ„é€ æ–¹æ³•å‚æ•°ä¸º packagesToScan ï¼Œå³ BeanDefinitionBuilder æ‰«æè¯¥åŒ…
      builder.addConstructorArgValue(packagesToScan);
      // è®¾ç½® role å±æ€§
      builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);
      // è·å¾— AbstractBeanDefinition å¯¹è±¡
      AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();
      // æ³¨å†Œåˆ° registry ä¸­
      BeanDefinitionReaderUtils.registerWithGeneratedName(beanDefinition, registry);
  }
  ```

  - å…³äº ServiceAnnotationBeanPostProcessor ç±»ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ5.2 ServiceAnnotationBeanPostProcessorã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

- `<3>` å¤„ï¼Œè°ƒç”¨ `#registerReferenceAnnotationBeanPostProcessor(BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œåˆ›å»º ReferenceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ `@Reference` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Reference Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // DubboComponentScanRegistrar.java
  
  private void registerReferenceAnnotationBeanPostProcessor(BeanDefinitionRegistry registry) {
      // Register @Reference Annotation Bean Processor
      BeanRegistrar.registerInfrastructureBean(registry, ReferenceAnnotationBeanPostProcessor.BEAN_NAME, ReferenceAnnotationBeanPostProcessor.class);
  }
  
  // BeanRegistrar.java
  
  public static void registerInfrastructureBean(BeanDefinitionRegistry beanDefinitionRegistry,
                                                String beanName, Class<?> beanType) {
      // ä¸å­˜åœ¨ beanName å¯¹åº”çš„ BeanDefinition å¯¹è±¡
      if (!beanDefinitionRegistry.containsBeanDefinition(beanName)) {
          // åˆ›å»º RootBeanDefinition å¯¹è±¡
          RootBeanDefinition beanDefinition = new RootBeanDefinition(beanType);
          // è®¾ç½® role
          beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);
          // æ³¨å†Œåˆ° beanDefinitionRegistry ä¸­
          beanDefinitionRegistry.registerBeanDefinition(beanName, beanDefinition);
      }
  }
  ```

  - å…³äº ReferenceAnnotationBeanPostProcessor ç±»ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ5.3 ReferenceAnnotationBeanPostProcessorã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

### 5.2 ServiceAnnotationBeanPostProcessor

`org.apache.dubbo.config.spring.beans.factory.annotation.ServiceAnnotationBeanPostProcessor` ï¼Œå®ç° BeanDefinitionRegistryPostProcessorã€EnvironmentAwareã€ResourceLoaderAwareã€BeanClassLoaderAware æ¥å£ï¼Œæ‰«æ `@Service` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ã€‚

#### 5.2.1 æ„é€ æ–¹æ³•

```
// ServiceAnnotationBeanPostProcessor.java

/**
 * è¦æ‰«æçš„åŒ…çš„é›†åˆ
 */
private final Set<String> packagesToScan;

private Environment environment;

private ResourceLoader resourceLoader;

private ClassLoader classLoader;

public ServiceAnnotationBeanPostProcessor(String... packagesToScan) { // ä¸Šè¿°æ–‡ç« ä½¿ç”¨åˆ°çš„æ„é€ æ–¹æ³•
    this(Arrays.asList(packagesToScan));
}

public ServiceAnnotationBeanPostProcessor(Collection<String> packagesToScan) {
    this(new LinkedHashSet<String>(packagesToScan));
}

public ServiceAnnotationBeanPostProcessor(Set<String> packagesToScan) {
    this.packagesToScan = packagesToScan;
}
```

#### 5.2.2 postProcessBeanDefinitionRegistry

å®ç° `#postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œæ‰«æ `@Service` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ServiceAnnotationBeanPostProcessor.java

@Override
public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException {
    // <1> è§£æ packagesToScan é›†åˆã€‚å› ä¸ºï¼Œå¯èƒ½å­˜åœ¨å ä½ç¬¦
    Set<String> resolvedPackagesToScan = resolvePackagesToScan(packagesToScan);
    // <2> æ‰«æ packagesToScan åŒ…ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ã€‚
    if (!CollectionUtils.isEmpty(resolvedPackagesToScan)) {
        registerServiceBeans(resolvedPackagesToScan, registry);
    } else {
        if (logger.isWarnEnabled()) {
            logger.warn("packagesToScan is empty , ServiceBean registry will be ignored!");
        }
    }
}
```

- `<1>` å¤„ï¼Œè°ƒç”¨ `#resolvePackagesToScan(Set<String> packagesToScan)` æ–¹æ³•ï¼Œè§£æ `packagesToScan` é›†åˆã€‚å› ä¸ºï¼Œå¯èƒ½å­˜åœ¨å ä½ç¬¦ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ServiceAnnotationBeanPostProcessor.java
  
  private Set<String> resolvePackagesToScan(Set<String> packagesToScan) {
      Set<String> resolvedPackagesToScan = new LinkedHashSet<String>(packagesToScan.size());
      // éå† packagesToScan æ•°ç»„
      for (String packageToScan : packagesToScan) {
          if (StringUtils.hasText(packageToScan)) {
              // è§£æå¯èƒ½å­˜åœ¨çš„å ä½ç¬¦
              String resolvedPackageToScan = environment.resolvePlaceholders(packageToScan.trim());
              // æ·»åŠ åˆ° resolvedPackagesToScan ä¸­
              resolvedPackagesToScan.add(resolvedPackageToScan);
          }
      }
      return resolvedPackagesToScan;
  }
  ```

- `<2>` å¤„ï¼Œè°ƒç”¨ `#registerServiceBeans(Set<String> packagesToScan, BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œæ‰«æ `packagesToScan` åŒ…ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ5.2.3 resolvePackagesToScanã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ä¸­ã€‚

#### 5.2.3 resolvePackagesToScan

`#registerServiceBeans(Set<String> packagesToScan, BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œæ‰«æ `packagesToScan` åŒ…ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ServiceAnnotationBeanPostProcessor.java

private void registerServiceBeans(Set<String> packagesToScan, BeanDefinitionRegistry registry) {
    // <1.1> åˆ›å»º DubboClassPathBeanDefinitionScanner å¯¹è±¡
    DubboClassPathBeanDefinitionScanner scanner = new DubboClassPathBeanDefinitionScanner(registry, environment, resourceLoader);
    // <1.2> è·å¾— BeanNameGenerator å¯¹è±¡ï¼Œå¹¶è®¾ç½® beanNameGenerator åˆ° scanner ä¸­
    BeanNameGenerator beanNameGenerator = resolveBeanNameGenerator(registry);
    scanner.setBeanNameGenerator(beanNameGenerator);
    // <1.3> è®¾ç½®è¿‡æ»¤è·å¾—å¸¦æœ‰ @Service æ³¨è§£çš„ç±»
    scanner.addIncludeFilter(new AnnotationTypeFilter(Service.class));

    // <2> éå† packagesToScan æ•°ç»„
    for (String packageToScan : packagesToScan) {
        // Registers @Service Bean first
        // <2.1> æ‰§è¡Œæ‰«æ
        scanner.scan(packageToScan);
        // Finds all BeanDefinitionHolders of @Service whether @ComponentScan scans or not.
        // <2.2> åˆ›å»ºæ¯ä¸ªåœ¨ packageToScan æ‰«æåˆ°çš„ç±»ï¼Œå¯¹åº”çš„ BeanDefinitionHolder å¯¹è±¡ï¼Œè¿”å› BeanDefinitionHolder é›†åˆ
        Set<BeanDefinitionHolder> beanDefinitionHolders = findServiceBeanDefinitionHolders(scanner, packageToScan, registry, beanNameGenerator);
        // <2.3> æ³¨å†Œåˆ° registry ä¸­
        if (!CollectionUtils.isEmpty(beanDefinitionHolders)) {
            for (BeanDefinitionHolder beanDefinitionHolder : beanDefinitionHolders) {
                registerServiceBean(beanDefinitionHolder, registry, scanner);
            }
            if (logger.isInfoEnabled()) {
                logger.info(beanDefinitionHolders.size() + " annotated Dubbo's @Service Components { " + beanDefinitionHolders + " } were scanned under package[" + packageToScan + "]");
            }
        } else {
            if (logger.isWarnEnabled()) {
                logger.warn("No Spring Bean annotating Dubbo's @Service was found under package[" + packageToScan + "]");
            }
        }
    }
}
```

- `<1.1>` å¤„ï¼Œåˆ›å»º DubboClassPathBeanDefinitionScanner å¯¹è±¡ã€‚å®ƒæ˜¯ç”¨äºæ‰«ææŒ‡å®šåŒ…ä¸‹ç¬¦åˆæ¡ä»¶çš„ç±»ï¼Œç”¨äºå°†æ¯ä¸ªç¬¦åˆæ¡ä»¶çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Bean ã€‚å…³äº DubboClassPathBeanDefinitionScanner ç±»ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/apache/incubator-dubbo/blob/master/dubbo-config/dubbo-config-spring/src/main/java/org/apache/dubbo/config/spring/beans/factory/annotation/ServiceAnnotationBeanPostProcessor.java) ç…ä¸€çœ¼å³å¯ã€‚

- `<1.2>` å¤„ï¼Œè°ƒç”¨ `#resolveBeanNameGenerator(BeanDefinitionRegistry registry)` æ–¹æ³•ï¼Œè·å¾— BeanNameGenerator å¯¹è±¡ï¼Œå¹¶è®¾ç½® `beanNameGenerator` åˆ° `scanner` ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ServiceAnnotationBeanPostProcessor.java
  
  /**
   * It'd better to use BeanNameGenerator instance that should reference
   * {@link ConfigurationClassPostProcessor#componentScanBeanNameGenerator},
   * thus it maybe a potential problem on bean name generation.
   *
   * @param registry {@link BeanDefinitionRegistry}
   * @return {@link BeanNameGenerator} instance
   * @see SingletonBeanRegistry
   * @see AnnotationConfigUtils#CONFIGURATION_BEAN_NAME_GENERATOR
   * @see ConfigurationClassPostProcessor#processConfigBeanDefinitions
   * @since 2.5.8
   */
  @SuppressWarnings("Duplicates")
  private BeanNameGenerator resolveBeanNameGenerator(BeanDefinitionRegistry registry) {
      BeanNameGenerator beanNameGenerator = null;
      // å¦‚æœæ˜¯ SingletonBeanRegistry ç±»å‹ï¼Œä»ä¸­è·å¾—å¯¹åº”çš„ BeanNameGenerator Bean å¯¹è±¡
      if (registry instanceof SingletonBeanRegistry) {
          SingletonBeanRegistry singletonBeanRegistry = SingletonBeanRegistry.class.cast(registry);
          beanNameGenerator = (BeanNameGenerator) singletonBeanRegistry.getSingleton(AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR);
      }
      // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º AnnotationBeanNameGenerator å¯¹è±¡
      if (beanNameGenerator == null) {
          if (logger.isInfoEnabled()) {
              logger.info("BeanNameGenerator bean can't be found in BeanFactory with name [" + CONFIGURATION_BEAN_NAME_GENERATOR + "]");
              logger.info("BeanNameGenerator will be a instance of " + AnnotationBeanNameGenerator.class.getName() + " , it maybe a potential problem on bean name generation.");
          }
          beanNameGenerator = new AnnotationBeanNameGenerator();
      }
      return beanNameGenerator;
  }
  ```

- `<1.3>` å¤„ï¼Œè®¾ç½®è¿‡æ»¤è·å¾—å¸¦æœ‰ `@Service` æ³¨è§£çš„ç±»ã€‚å…³äº `@Service` æ³¨è§£çš„å…·ä½“çš„å±æ€§ï¼Œæœ¬æ–‡å°±ä¸è¿‡åˆ†ä»‹ç»ï¼Œè‡ªå·±ç…ç…ã€‚

- ```
  <2>
  ```

   

  å¤„ï¼Œéå†

   

  ```
  packagesToScan
  ```

   

  æ•°ç»„ã€‚

  - `<2.1>` å¤„ï¼Œè°ƒç”¨ `DubboClassPathBeanDefinitionScanner#scan(String... basePackages)` æ–¹æ³•ï¼Œæ‰§è¡Œæ‰«æã€‚
  - `<2.2>` å¤„ï¼Œè°ƒç”¨ `#findServiceBeanDefinitionHolders(ClassPathBeanDefinitionScanner scanner, String packageToScan, BeanDefinitionRegistry registry, BeanNameGenerator beanNameGenerator)` æ–¹æ³•ï¼Œåˆ›å»ºæ¯ä¸ªåœ¨ `packageToScan` æ‰«æåˆ°çš„ç±»ï¼Œå¯¹åº”çš„ BeanDefinitionHolder å¯¹è±¡ï¼Œè¿”å› BeanDefinitionHolder é›†åˆã€‚è¯¦ç»†è§£æ ï¼Œè§ [ã€Œ5.2.4 findServiceBeanDefinitionHoldersã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ä¸­ã€‚
  - `<2.3>` å¤„ï¼Œè°ƒç”¨ `#registerServiceBean(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry, DubboClassPathBeanDefinitionScanner scanner)` æ–¹æ³•ï¼Œæ³¨å†Œåˆ° `registry` ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ5.2.5 registerServiceBeanã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ä¸­ã€‚

#### 5.2.4 findServiceBeanDefinitionHolders

`#findServiceBeanDefinitionHolders(ClassPathBeanDefinitionScanner scanner, String packageToScan, BeanDefinitionRegistry registry, BeanNameGenerator beanNameGenerator)` æ–¹æ³•ï¼Œåˆ›å»ºæ¯ä¸ªåœ¨ `packageToScan` æ‰«æåˆ°çš„ç±»ï¼Œå¯¹åº”çš„ BeanDefinitionHolder å¯¹è±¡ï¼Œè¿”å› BeanDefinitionHolder é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ServiceAnnotationBeanPostProcessor.java

/**
 * Finds a {@link Set} of {@link BeanDefinitionHolder BeanDefinitionHolders} whose bean type annotated
 * {@link Service} Annotation.
 *
 * @param scanner       {@link ClassPathBeanDefinitionScanner}
 * @param packageToScan pachage to scan
 * @param registry      {@link BeanDefinitionRegistry}
 * @return non-null
 * @since 2.5.8
 */
@SuppressWarnings("Duplicates")
private Set<BeanDefinitionHolder> findServiceBeanDefinitionHolders(
        ClassPathBeanDefinitionScanner scanner, String packageToScan, BeanDefinitionRegistry registry,
        BeanNameGenerator beanNameGenerator) {
    // è·å¾— packageToScan åŒ…ä¸‹ç¬¦åˆæ¡ä»¶çš„ BeanDefinition é›†åˆ
    Set<BeanDefinition> beanDefinitions = scanner.findCandidateComponents(packageToScan);

    // åˆ›å»º BeanDefinitionHolder é›†åˆ
    Set<BeanDefinitionHolder> beanDefinitionHolders = new LinkedHashSet<BeanDefinitionHolder>(beanDefinitions.size());
    // éå† beanDefinitions æ•°ç»„
    for (BeanDefinition beanDefinition : beanDefinitions) {
        // è·å¾— Bean çš„åå­—
        String beanName = beanNameGenerator.generateBeanName(beanDefinition, registry);
        // åˆ›å»º BeanDefinitionHolder å¯¹è±¡
        BeanDefinitionHolder beanDefinitionHolder = new BeanDefinitionHolder(beanDefinition, beanName);
        // æ·»åŠ åˆ° beanDefinitions ä¸­
        beanDefinitionHolders.add(beanDefinitionHolder);
    }
    return beanDefinitionHolders;
}
```

#### 5.2.5 registerServiceBean

`#registerServiceBean(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry, DubboClassPathBeanDefinitionScanner scanner)` æ–¹æ³•ï¼Œæ³¨å†Œåˆ° `registry` ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ServiceAnnotationBeanPostProcessor.java

/**
 * Registers {@link ServiceBean} from new annotated {@link Service} {@link BeanDefinition}
 *
 * @param beanDefinitionHolder
 * @param registry
 * @param scanner
 * @see ServiceBean
 * @see BeanDefinition
 */
@SuppressWarnings("Duplicates")
private void registerServiceBean(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry,
                                 DubboClassPathBeanDefinitionScanner scanner) {
    // <1.1> è§£æ Bean çš„ç±»
    Class<?> beanClass = resolveClass(beanDefinitionHolder);
    // <1.2> è·å¾— @Service æ³¨è§£
    Service service = AnnotationUtils.findAnnotation(beanClass, Service.class);
    // <1.3> è·å¾— Service æ¥å£
    Class<?> interfaceClass = resolveServiceInterfaceClass(beanClass, service);
    // <1.4> è·å¾— Bean çš„åå­—
    String annotatedServiceBeanName = beanDefinitionHolder.getBeanName();
    // <1.5> åˆ›å»º AbstractBeanDefinition å¯¹è±¡
    AbstractBeanDefinition serviceBeanDefinition = buildServiceBeanDefinition(service, interfaceClass, annotatedServiceBeanName);

    // ServiceBean Bean name
    // <2> é‡æ–°ç”Ÿæˆ Bean çš„åå­—
    String beanName = generateServiceBeanName(service, interfaceClass, annotatedServiceBeanName);
    // <3> æ ¡éªŒåœ¨ scanner ä¸­ï¼Œå·²ç»å­˜åœ¨ beanName ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œæ³¨å†Œã€‚
    if (scanner.checkCandidate(beanName, serviceBeanDefinition)) { // check duplicated candidate bean
        registry.registerBeanDefinition(beanName, serviceBeanDefinition);
        if (logger.isInfoEnabled()) {
            logger.info("The BeanDefinition[" + serviceBeanDefinition + "] of ServiceBean has been registered with name : " + beanName);
        }
    } else {
        if (logger.isWarnEnabled()) {
            logger.warn("The Duplicated BeanDefinition[" + serviceBeanDefinition + "] of ServiceBean[ bean name : " + beanName + "] was be found , Did @DubboComponentScan scan to same package in many times?");
        }
    }
}
```

- `<1.1>` å¤„ï¼Œè°ƒç”¨ `#resolveClass(BeanDefinitionHolder beanDefinitionHolder)` æ–¹æ³•ï¼Œè§£æè¿”å› Bean çš„ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ServiceAnnotationBeanPostProcessor.java
  
  private Class<?> resolveClass(BeanDefinitionHolder beanDefinitionHolder) {
      BeanDefinition beanDefinition = beanDefinitionHolder.getBeanDefinition();
      return resolveClass(beanDefinition);
  }
  
  private Class<?> resolveClass(BeanDefinition beanDefinition) {
      String beanClassName = beanDefinition.getBeanClassName();
      return ClassUtils.resolveClassName(beanClassName, classLoader);
  }
  ```

  - å› ä¸º BeanDefinition çš„ `beanClassName` æ˜¯ String ç±»å‹ï¼Œæ‰€ä»¥å¾—è½¬æ¢æˆ Class ç±»å‹ã€‚

- `<1.2>` å¤„ï¼Œè·å¾— `@Service` æ³¨è§£ã€‚

- `<1.3>` å¤„ï¼Œè°ƒç”¨ `#resolveServiceInterfaceClass(Class<?> annotatedServiceBeanClass, Service service)` æ–¹æ³•ï¼Œè·å¾— Service æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ServiceAnnotationBeanPostProcessor.java
  
  @SuppressWarnings("Duplicates")
  private Class<?> resolveServiceInterfaceClass(Class<?> annotatedServiceBeanClass, Service service) {
      // é¦–å…ˆï¼Œä»æ³¨è§£æœ¬èº«ä¸Šè·å¾—
      Class<?> interfaceClass = service.interfaceClass();
      if (void.class.equals(interfaceClass)) { // ä¸€èˆ¬æ˜¯æ»¡è¶³çš„
          interfaceClass = null;
          // è·å¾— @Service æ³¨è§£çš„ interfaceName å±æ€§ã€‚
          String interfaceClassName = service.interfaceName();
          // å¦‚æœå­˜åœ¨ï¼Œè·å¾—å…¶å¯¹åº”çš„ç±»
          if (StringUtils.hasText(interfaceClassName)) {
              if (ClassUtils.isPresent(interfaceClassName, classLoader)) {
                  interfaceClass = ClassUtils.resolveClassName(interfaceClassName, classLoader);
              }
          }
      }
  
      // <X>ã€ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨è¿™ä¸ªã€‘è·å¾—ä¸åˆ°ï¼Œåˆ™ä»è¢«æ³¨è§£çš„ç±»ä¸Šè·å¾—å…¶å®ç°çš„é¦–ä¸ªæ¥å£
      if (interfaceClass == null) {
          Class<?>[] allInterfaces = annotatedServiceBeanClass.getInterfaces();
          if (allInterfaces.length > 0) {
              interfaceClass = allInterfaces[0];
          }
      }
  
      Assert.notNull(interfaceClass, "@Service interfaceClass() or interfaceName() or interface class must be present!");
      Assert.isTrue(interfaceClass.isInterface(), "The type that was annotated @Service is not an interface!");
      return interfaceClass;
  }
  ```

  - è™½ç„¶ä»£ç æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯é‡ç‚¹çœ‹ `<X>` å¤„ï¼Œä»è¢«æ³¨è§£çš„ç±»ä¸Šè·å¾—å…¶å®ç°çš„é¦–ä¸ªæ¥å£ã€‚

- `<1.4>` å¤„ï¼Œè·å¾— Bean çš„åå­—ã€‚

- `<1.5>` å¤„ï¼Œè°ƒç”¨ `#buildServiceBeanDefinition(Service service, Class<?> interfaceClass, String annotatedServiceBeanName)` æ–¹æ³•ï¼Œåˆ›å»º AbstractBeanDefinition å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ServiceAnnotationBeanPostProcessor.java
  
  @SuppressWarnings("Duplicates")
  private AbstractBeanDefinition buildServiceBeanDefinition(Service service, Class<?> interfaceClass, String annotatedServiceBeanName) {
      // åˆ›å»º BeanDefinitionBuilder å¯¹è±¡
      BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(ServiceBean.class);
      // è·å¾— AbstractBeanDefinition å¯¹è±¡
      AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();
  
      // è·å¾— MutablePropertyValues å±æ€§ã€‚åç»­ ï¼Œé€šè¿‡å‘å®ƒæ·»åŠ å±æ€§ï¼Œè®¾ç½®åˆ° BeanDefinition ä¸­ï¼Œå³ Service Bean ä¸­ã€‚
      MutablePropertyValues propertyValues = beanDefinition.getPropertyValues();
  
      // <X> åˆ›å»º AnnotationPropertyValuesAdapter å¯¹è±¡ï¼Œæ·»åŠ åˆ° propertyValues ä¸­ã€‚
      // æ­¤å¤„ï¼Œæ˜¯å°†æ³¨è§£ä¸Šçš„å±æ€§ï¼Œè®¾ç½®åˆ° propertyValues ä¸­
      String[] ignoreAttributeNames = of("provider", "monitor", "application", "module", "registry", "protocol", "interface", "interfaceName"); // å¿½ç•¥çš„å±æ€§ï¼Œä¸‹é¢è¿›è¡Œå•ç‹¬è®¾ç½®ã€‚
      propertyValues.addPropertyValues(new AnnotationPropertyValuesAdapter(service, environment, ignoreAttributeNames));
  
      // References "ref" property to annotated-@Service Bean
      // è®¾ç½® ref å±æ€§æŒ‡å‘çš„ Service Bean åå­—
      addPropertyReference(builder, "ref", annotatedServiceBeanName);
      // Set interface è®¾ç½® Service æ¥å£ç±»å…¨ç±»å
      builder.addPropertyValue("interface", interfaceClass.getName());
  
      /**
       * Add {@link org.apache.dubbo.config.ProviderConfig} Bean reference
       *
       * æ·»åŠ  provider å±æ€§å¯¹åº”çš„ ProviderConfig Bean å¯¹è±¡
       */
      String providerConfigBeanName = service.provider();
      if (StringUtils.hasText(providerConfigBeanName)) {
          addPropertyReference(builder, "provider", providerConfigBeanName);
      }
  
      /**
       * Add {@link org.apache.dubbo.config.MonitorConfig} Bean reference
       *
       * æ·»åŠ  monitor å±æ€§å¯¹åº”çš„ MonitorConfig Bean å¯¹è±¡
       */
      String monitorConfigBeanName = service.monitor();
      if (StringUtils.hasText(monitorConfigBeanName)) {
          addPropertyReference(builder, "monitor", monitorConfigBeanName);
      }
  
      /**
       * Add {@link org.apache.dubbo.config.ApplicationConfig} Bean reference
       *
       * æ·»åŠ  application å±æ€§å¯¹åº”çš„ ApplicationConfig Bean å¯¹è±¡
       */
      String applicationConfigBeanName = service.application();
      if (StringUtils.hasText(applicationConfigBeanName)) {
          addPropertyReference(builder, "application", applicationConfigBeanName);
      }
  
      /**
       * Add {@link org.apache.dubbo.config.ModuleConfig} Bean reference
       *
       * æ·»åŠ  module å±æ€§å¯¹åº”çš„ ModuleConfig Bean å¯¹è±¡
       */
      String moduleConfigBeanName = service.module();
      if (StringUtils.hasText(moduleConfigBeanName)) {
          addPropertyReference(builder, "module", moduleConfigBeanName);
      }
  
  
      /**
       * Add {@link org.apache.dubbo.config.RegistryConfig} Bean reference
       *
       * æ·»åŠ  registries å±æ€§å¯¹åº”çš„ RegistryConfig Bean æ•°ç»„ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰
       */
      String[] registryConfigBeanNames = service.registry();
      List<RuntimeBeanReference> registryRuntimeBeanReferences = toRuntimeBeanReferences(registryConfigBeanNames);
      if (!registryRuntimeBeanReferences.isEmpty()) {
          builder.addPropertyValue("registries", registryRuntimeBeanReferences);
      }
  
      /**
       * Add {@link org.apache.dubbo.config.ProtocolConfig} Bean reference
       *
       * æ·»åŠ  protocols å±æ€§å¯¹åº”çš„ ProtocolConfig Bean æ•°ç»„ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰
       */
      String[] protocolConfigBeanNames = service.protocol();
      List<RuntimeBeanReference> protocolRuntimeBeanReferences = toRuntimeBeanReferences(protocolConfigBeanNames);
      if (!protocolRuntimeBeanReferences.isEmpty()) {
          builder.addPropertyValue("protocols", protocolRuntimeBeanReferences);
      }
  
      return builder.getBeanDefinition();
  }
  
  // RuntimeBeanReference ï¼Œåœ¨è§£æåˆ°ä¾èµ–çš„Beançš„æ—¶ä¾¯ï¼Œè§£æå™¨ä¼šä¾æ®ä¾èµ–beançš„nameåˆ›å»ºä¸€ä¸ªRuntimeBeanReferenceå¯¹åƒï¼Œå°†è¿™ä¸ªå¯¹åƒæ”¾å…¥BeanDefinitionçš„MutablePropertyValuesä¸­ã€‚
  // æ­¤å¤„ï¼Œå’Œä¸Šé¢ä¸å¤ªä¸€æ ·çš„åŸå› ï¼Œå› ä¸ºæ˜¯å¤šä¸ª
  @SuppressWarnings("Duplicates")
  private ManagedList<RuntimeBeanReference> toRuntimeBeanReferences(String... beanNames) {
      ManagedList<RuntimeBeanReference> runtimeBeanReferences = new ManagedList<RuntimeBeanReference>();
      if (!ObjectUtils.isEmpty(beanNames)) {
          for (String beanName : beanNames) {
              // è§£æçœŸæ­£çš„ Bean åå­—ï¼Œå¦‚æœæœ‰å ä½ç¬¦çš„è¯
              String resolvedBeanName = environment.resolvePlaceholders(beanName);
              runtimeBeanReferences.add(new RuntimeBeanReference(resolvedBeanName));
          }
      }
      return runtimeBeanReferences;
  }
  
  // æ·»åŠ å±æ€§å€¼æ˜¯å¼•ç”¨ç±»å‹
  private void addPropertyReference(BeanDefinitionBuilder builder, String propertyName, String beanName) {
      String resolvedBeanName = environment.resolvePlaceholders(beanName);
      builder.addPropertyReference(propertyName, resolvedBeanName);
  }
  ```

  - æ¯”è¾ƒå†—é•¿ï¼Œé¡ºç€å¾€ä¸‹çœ‹å³å¯ã€‚

  - ```
    <X>
    ```

     

    å¤„ï¼Œåˆ›å»º AnnotationPropertyValuesAdapter å¯¹è±¡ï¼Œæ·»åŠ åˆ°

     

    ```
    propertyValues
    ```

     

    ä¸­ã€‚æ­¤å¤„ï¼Œæ˜¯å°†æ³¨è§£ä¸Šçš„å±æ€§ï¼Œè®¾ç½®åˆ°

     

    ```
    propertyValues
    ```

     

    ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ³¨è§£ä¸Šçš„å±æ€§ï¼Œè‡ªç„¶çš„èƒ½å¤Ÿè®¾ç½®åˆ°åç»­åˆ›å»ºçš„ Service Bean çš„å¯¹è±¡ä¸­ã€‚

    - ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè¯´ `@Service(version="1.0.0")` ï¼Œé‚£ä¹ˆè¿™ä¸ªç‰ˆæœ¬å·ï¼ˆ`version`ï¼‰ï¼Œå°±å¯ä»¥è®¾ç½®åˆ° Dubbo Service Bean ä¸­å»äº†ã€‚
    - å…³äº `org.apache.dubbo.config.spring.beans.factory.annotation.AnnotationPropertyValuesAdapter` ç±»ï¼Œå°±æ˜¯ä¸Šè¿°çš„ç”¨é€”ï¼Œæ¯”è¾ƒç®€å•ï¼Œç‚¹å‡» [é“¾æ¥](https://github.com/apache/incubator-dubbo/blob/ff0ce37c46523e9d0dfa13748fca339e68edc027/dubbo-config/dubbo-config-spring/src/main/java/org/apache/dubbo/config/spring/beans/factory/annotation/AnnotationPropertyValuesAdapter.java) æŸ¥çœ‹å³å¯ã€‚

- `<2>` å¤„ï¼Œè°ƒç”¨ `#generateServiceBeanName(Service service, Class<?> interfaceClass, String annotatedServiceBeanName)` æ–¹æ³•ï¼Œé‡æ–°ç”Ÿæˆ Bean çš„åå­—ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ServiceAnnotationBeanPostProcessor.java
  
  private String generateServiceBeanName(Service service, Class<?> interfaceClass, String annotatedServiceBeanName) {
      ServiceBeanNameBuilder builder = ServiceBeanNameBuilder.create(service, interfaceClass, environment);
      return builder.build();
  }
  
  // ServiceBeanNameBuilder.java
  
  private static final String SEPARATOR = ":";
  
  private final String interfaceClassName;
  private final Environment environment;
  // Optional
  private String version;
  private String group;
  
  // ServiceBean:${interfaceClassName}:${version}:${group}
  public String build() {
      StringBuilder beanNameBuilder = new StringBuilder("ServiceBean");
      // Required
      append(beanNameBuilder, interfaceClassName);
      // Optional
      append(beanNameBuilder, version);
      append(beanNameBuilder, group);
      // Build
      String rawBeanName = beanNameBuilder.toString();
      // Resolve placeholders
      return environment.resolvePlaceholders(rawBeanName);
  }
  
  private static void append(StringBuilder builder, String value) {
      if (StringUtils.hasText(value)) {
          builder.append(SEPARATOR).append(value);
      }
  }
  ```

  - ç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š[![`beanName`](assets/06.png)](http://static.iocoder.cn/images/Dubbo/2018_01_22/02.jpg)`beanName`

- `<3>` å¤„ï¼Œæ ¡éªŒåœ¨ `scanner` ä¸­ï¼Œæ˜¯å¦å·²ç»å­˜åœ¨ `beanName` ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œæ³¨å†Œã€‚

ğŸ˜ˆ æ•´ä¸ªé€»è¾‘ï¼Œæœ‰ç‚¹é•¿é•¿æ»´ã€‚è¾›è‹¦ä¸Šä¸‹æ»‘åŠ¨ï¼Œåœ¨ç…ç…ã€‚

### 5.3 ReferenceAnnotationBeanPostProcessor

`org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor` ï¼Œç»§æ‰¿ AnnotationInjectedBeanPostProcessor æŠ½è±¡ç±»ï¼Œå®ç° ApplicationContextAwareã€ApplicationListener æ¥å£ï¼Œæ‰«æ `@Reference` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Reference Bean å¯¹è±¡ã€‚

> è™½ç„¶ `org.apache.dubbo.config.spring.beans.factory.annotation.AnnotationInjectedBeanPostProcessor` æ”¾åœ¨ Dubbo é¡¹ç›®ä¸­ï¼Œä½†æ˜¯æ˜¯ clone è‡ª https://github.com/alibaba/spring-context-support/blob/1.0.2/src/main/java/com/alibaba/spring/beans/factory/annotation/AnnotationInjectedBeanPostProcessor.java ç±»ã€‚æ‰€ä»¥å‘¢ï¼Œæˆ‘ä»¬å…ˆä¸æ·±ç©¶è¿™ä¸ªç±»ï¼Œåªè¦çŸ¥é“å¦‚ä¸‹ï¼š
>
> - è‹±æ–‡ï¼šAbstract generic {@link BeanPostProcessor} implementation for customized annotation that annotated injected-object.
> - ä¸­æ–‡ï¼šBeanPostProcessor çš„æŠ½è±¡å®ç°ç±»ï¼Œç”¨äºæ”¯æŒä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£ï¼Œæ³¨å…¥å¯¹è±¡çš„å±æ€§ã€‚

- æ­¤æ—¶ï¼ŒReferenceAnnotationBeanPostProcessor å®ç°çš„å°±æ˜¯ æ”¯æŒ `@Reference` æ³¨è§£çš„å±æ€§æ³¨å…¥ã€‚

> ç›¸å¯¹æ¥è¯´ï¼Œæœ¬èŠ‚çš„ ReferenceAnnotationBeanPostProcessor ï¼Œä¼šæ¯”ä¸Šä¸€èŠ‚çš„ ServiceAnnotationBeanPostProcessor å¤æ‚è›®å¤š~ SO ï¼Œä¿æŒè€å¿ƒå“ˆã€‚

#### 5.3.1 æ„é€ æ–¹æ³•

```
// ReferenceAnnotationBeanPostProcessor.java

/**
 * The bean name of {@link ReferenceAnnotationBeanPostProcessor}
 */
public static final String BEAN_NAME = "referenceAnnotationBeanPostProcessor";

/**
 * Cache size
 */
private static final int CACHE_SIZE = Integer.getInteger(BEAN_NAME + ".cache.size", 32);

/**
 * ReferenceBean ç¼“å­˜ Map
 *
 * KEYï¼šReference Bean çš„åå­—
 */
private final ConcurrentMap<String, ReferenceBean<?>> referenceBeanCache = new ConcurrentHashMap<String, ReferenceBean<?>>(CACHE_SIZE);

/**
 * ReferenceBeanInvocationHandler ç¼“å­˜ Map
 *
 * KEYï¼šReference Bean çš„åå­—
 */
private final ConcurrentHashMap<String, ReferenceBeanInvocationHandler> localReferenceBeanInvocationHandlerCache = new ConcurrentHashMap<String, ReferenceBeanInvocationHandler>(CACHE_SIZE);

/**
 * ä½¿ç”¨å±æ€§è¿›è¡Œæ³¨å…¥çš„ @Reference Bean çš„ç¼“å­˜ Map
 *
 * ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨è¿™ä¸ª
 */
private final ConcurrentMap<InjectionMetadata.InjectedElement, ReferenceBean<?>> injectedFieldReferenceBeanCache = new ConcurrentHashMap<InjectionMetadata.InjectedElement, ReferenceBean<?>>(CACHE_SIZE);

/**
 * ä½¿ç”¨æ–¹æ³•è¿›è¡Œæ³¨å…¥çš„ @Reference Bean çš„ç¼“å­˜ Map
 */
private final ConcurrentMap<InjectionMetadata.InjectedElement, ReferenceBean<?>> injectedMethodReferenceBeanCache = new ConcurrentHashMap<InjectionMetadata.InjectedElement, ReferenceBean<?>>(CACHE_SIZE);

private ApplicationContext applicationContext;
```

- å…·ä½“çš„æ¯ä¸ªå˜é‡çš„æ—¶å€™ï¼Œç»“åˆä¸‹é¢æ¥çœ‹ã€‚

#### 5.3.2 doGetInjectedBean

å®ç° `#doGetInjectedBean(Reference reference, Object bean, String beanName, Class<?> injectedType, InjectionMetadata.InjectedElement injectedElement)` æ–¹æ³•ï¼Œè·å¾—è¦æ³¨å…¥çš„ `@Reference` Bean ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ReferenceAnnotationBeanPostProcessor.java

@Override
protected Object doGetInjectedBean(Reference reference, Object bean, String beanName, Class<?> injectedType,
                                   InjectionMetadata.InjectedElement injectedElement) throws Exception {
    // <1> è·å¾— Reference Bean çš„åå­—
    String referencedBeanName = buildReferencedBeanName(reference, injectedType);
    // <2> åˆ›å»º ReferenceBean å¯¹è±¡
    ReferenceBean referenceBean = buildReferenceBeanIfAbsent(referencedBeanName, reference, injectedType, getClassLoader());
    // <3> ç¼“å­˜åˆ° injectedFieldReferenceBeanCache or injectedMethodReferenceBeanCache ä¸­
    cacheInjectedReferenceBean(referenceBean, injectedElement);
    // <4> åˆ›å»º Proxy ä»£ç†å¯¹è±¡
    return buildProxy(referencedBeanName, referenceBean, injectedType);
}
```

- `<1>` å¤„ï¼Œè°ƒç”¨ `#buildReferencedBeanName(Reference reference, Class<?> injectedType)` æ–¹æ³•ï¼Œè·å¾— Reference Bean çš„åå­—ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ReferenceAnnotationBeanPostProcessor.java
  
  private String buildReferencedBeanName(Reference reference, Class<?> injectedType) {
      // åˆ›å»º Service Bean çš„åå­—
      ServiceBeanNameBuilder builder = ServiceBeanNameBuilder.create(reference, injectedType, getEnvironment());
      return getEnvironment().resolvePlaceholders(builder.build()); // è¿™é‡Œï¼Œè²Œä¼¼é‡å¤è§£æå ä½ç¬¦äº†ã€‚ä¸è¿‡æ²¡å•¥å½±å“~
  }
  ```

  - å®é™…ä¸Šï¼Œä½¿ç”¨çš„å°±æ˜¯ ServiceBeanNameBuilder çš„é€»è¾‘ï¼Œå³å’Œ Dubbo Service Bean çš„åå­—ï¼Œæ˜¯ åŒä¸€å¥—ã€‚å½“ç„¶ï¼Œè¿™ä¸ªä¹Ÿéå¸¸åˆç†~

- `<2>` å¤„ï¼Œè°ƒç”¨ `#buildReferenceBeanIfAbsent(String referencedBeanName, Reference reference, Class<?> referencedType, ClassLoader classLoader)` æ–¹æ³•ï¼Œåˆ›å»ºï¼ˆè·å¾—ï¼‰ ReferenceBean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ReferenceAnnotationBeanPostProcessor.java
  
  private ReferenceBean buildReferenceBeanIfAbsent(String referencedBeanName, Reference reference, Class<?> referencedType, ClassLoader classLoader)
          throws Exception {
      // é¦–å…ˆï¼Œä» referenceBeanCache ç¼“å­˜ä¸­ï¼Œè·å¾— referencedBeanName å¯¹åº”çš„ ReferenceBean å¯¹è±¡
      ReferenceBean<?> referenceBean = referenceBeanCache.get(referencedBeanName);
      // ç„¶åï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚ç„¶åï¼Œæ·»åŠ åˆ° referenceBeanCache ç¼“å­˜ä¸­ã€‚
      if (referenceBean == null) {
          ReferenceBeanBuilder beanBuilder = ReferenceBeanBuilder
                  .create(reference, classLoader, applicationContext)
                  .interfaceClass(referencedType);
          referenceBean = beanBuilder.build();
          referenceBeanCache.put(referencedBeanName, referenceBean);
      }
      return referenceBean;
  }
  ```

  - å…¶ä¸­ï¼Œä¼šä½¿ç”¨ ReferenceBeanBuilder ç±»ï¼Œæ„å»º ReferenceBean å¯¹è±¡ã€‚å…³äºå®ƒï¼Œæˆ‘ä»¬ç¨ååœ¨ [ã€Œ5.3.4 ReferenceBeanBuilderã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) æ¥ç…ç…ã€‚å®é™…ä¸Šï¼Œå’Œä¸Šé¢ ServiceBean çš„æ„å»ºï¼Œä¹Ÿå·®ä¸äº†å¤ªå¤šã€‚

- `<3>` å¤„ï¼Œè°ƒç”¨ `#cacheInjectedReferenceBean(String referencedBeanName, Reference reference, Class<?> referencedType, ClassLoader classLoader)` æ–¹æ³•ï¼Œç¼“å­˜åˆ° `injectedFieldReferenceBeanCache` or `injectedMethodReferenceBeanCache` ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ReferenceAnnotationBeanPostProcessor.java
  
  private void cacheInjectedReferenceBean(ReferenceBean referenceBean, InjectionMetadata.InjectedElement injectedElement) {
      if (injectedElement.getMember() instanceof Field) {
          injectedFieldReferenceBeanCache.put(injectedElement, referenceBean);
      } else if (injectedElement.getMember() instanceof Method) {
          injectedMethodReferenceBeanCache.put(injectedElement, referenceBean);
      }
  }
  ```

- `<4>` å¤„ï¼Œè°ƒç”¨ `#buildProxy(String referencedBeanName, ReferenceBean referenceBean, Class<?> injectedType)` æ–¹æ³•ï¼Œåˆ›å»º Proxy ä»£ç†å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ReferenceAnnotationBeanPostProcessor.java
  
  private Object buildProxy(String referencedBeanName, ReferenceBean referenceBean, Class<?> injectedType) {
      InvocationHandler handler = buildInvocationHandler(referencedBeanName, referenceBean);
      return Proxy.newProxyInstance(getClassLoader(), new Class[]{injectedType}, handler);
  }
  
  private InvocationHandler buildInvocationHandler(String referencedBeanName, ReferenceBean referenceBean) {
      // é¦–å…ˆï¼Œä» localReferenceBeanInvocationHandlerCache ç¼“å­˜ä¸­ï¼Œè·å¾— ReferenceBeanInvocationHandler å¯¹è±¡
      ReferenceBeanInvocationHandler handler = localReferenceBeanInvocationHandlerCache.get(referencedBeanName);
      // ç„¶åï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º ReferenceBeanInvocationHandler å¯¹è±¡
      if (handler == null) {
          handler = new ReferenceBeanInvocationHandler(referenceBean);
      }
  
      // <X> ä¹‹åï¼Œæ ¹æ®å¼•ç”¨çš„ Dubbo æœåŠ¡æ˜¯è¿œç¨‹çš„è¿˜æ˜¯æœ¬åœ°çš„ï¼Œåšä¸åŒçš„å¤„ç†ã€‚
      // ã€æœ¬åœ°ã€‘åˆ¤æ–­å¦‚æœ applicationContext ä¸­å·²ç»åˆå§‹åŒ–ï¼Œè¯´æ˜æ˜¯æœ¬åœ°çš„ @Service Bean ï¼Œåˆ™æ·»åŠ åˆ° localReferenceBeanInvocationHandlerCache ç¼“å­˜ä¸­ã€‚
      // ç­‰åˆ°æœ¬åœ°çš„ @Service Bean æš´éœ²åï¼Œå†è¿›è¡Œåˆå§‹åŒ–ã€‚
      if (applicationContext.containsBean(referencedBeanName)) { // Is local @Service Bean or not ?
          // ReferenceBeanInvocationHandler's initialization has to wait for current local @Service Bean has been exported.
          localReferenceBeanInvocationHandlerCache.put(referencedBeanName, handler);
      // ã€è¿œç¨‹ã€‘åˆ¤æ–­è‹¥æœ applicationContext ä¸­æœªåˆå§‹åŒ–ï¼Œè¯´æ˜æ˜¯è¿œç¨‹çš„ @Service Bean å¯¹è±¡ï¼Œåˆ™ç«‹å³è¿›è¡Œåˆå§‹åŒ–
      } else {
          // Remote Reference Bean should initialize immediately
          handler.init();
      }
      return handler;
  }
  ```

  - æ¯”è¾ƒå¤æ‚çš„æ˜¯ï¼Œ

    ```
    <X>
    ```

     

    å¤„ï¼Œæ ¹æ®å¼•ç”¨çš„ Dubbo æœåŠ¡æ˜¯è¿œç¨‹çš„è¿˜æ˜¯æœ¬åœ°çš„ï¼Œåšä¸åŒçš„å¤„ç†ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

    - è¿œç¨‹çš„ Dubbo æœåŠ¡ï¼Œç†è®ºæ¥è¯´ï¼ˆä¸è€ƒè™‘å¯¹æ–¹æŒ‚æ‰çš„æƒ…å†µï¼‰ï¼Œæ˜¯å·²ç»å­˜åœ¨ï¼Œæ­¤æ—¶å¯ä»¥è¿›è¡ŒåŠ è½½å¼•ç”¨ã€‚
    - æœ¬åœ°çš„ Dubbo æœåŠ¡ï¼Œæ­¤æ—¶å¹¶æœªæš´éœ²ï¼Œåˆ™å…ˆæ·»åŠ åˆ° `localReferenceBeanInvocationHandlerCache` ä¸­è¿›è¡Œç¼“å­˜ã€‚ç­‰åç»­çš„ï¼Œé€šè¿‡ Spring äº‹ä»¶ç›‘å¬çš„åŠŸèƒ½ï¼Œè¿›è¡Œå®ç°ã€‚è¯¦ç»†çš„ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ5.3.3 onApplicationEventã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ä¸­ä¼šçœ‹åˆ°ã€‚

  - ReferenceBeanInvocationHandler ï¼Œæ˜¯ ReferenceAnnotationBeanPostProcessor çš„å†…éƒ¨é™æ€ç±»ï¼Œå®ç° Dubbo InvocationHandler æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

    ```
    // ReferenceAnnotationBeanPostProcessor#ReferenceBeanInvocationHandler.java
    
    private static class ReferenceBeanInvocationHandler implements InvocationHandler {
    
        /**
         * ReferenceBean å¯¹è±¡
         */
        private final ReferenceBean referenceBean;
    
        /**
         * Bean å¯¹è±¡
         */
        private Object bean;
    
        private ReferenceBeanInvocationHandler(ReferenceBean referenceBean) {
            this.referenceBean = referenceBean;
        }
    
        @Override
        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
            // è°ƒç”¨ bean çš„å¯¹åº”çš„æ–¹æ³•
            return method.invoke(bean, args);
        }
    
        // é€šè¿‡åˆå§‹åŒ–æ–¹æ³•ï¼Œå¯ä»¥è·å¾— `ReferenceBean.ref`
        private void init() {
            this.bean = referenceBean.get();
        }
    
    }
    ```

    - é‡å¿ƒåœ¨äº `#init()` æ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨ `ReferenceBean#get()` æ–¹æ³•ï¼Œè¿›è¡Œå¼•ç”¨çš„ Bean çš„åˆå§‹åŒ–ï¼Œæœ€åè¿”å›å¼•ç”¨ `ref` ã€‚

#### 5.3.3 onApplicationEvent

å®ç° `#onApplicationEvent(ApplicationEvent event)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// ReferenceAnnotationBeanPostProcessor.java

@Override
public void onApplicationEvent(ApplicationEvent event) {
    if (event instanceof ServiceBeanExportedEvent) {
        onServiceBeanExportEvent((ServiceBeanExportedEvent) event);
    } else if (event instanceof ContextRefreshedEvent) {
        onContextRefreshedEvent((ContextRefreshedEvent) event);
    }
}

private void onServiceBeanExportEvent(ServiceBeanExportedEvent event) {
    // è·å¾— ServiceBean å¯¹è±¡
    ServiceBean serviceBean = event.getServiceBean();
    // åˆå§‹åŒ–å¯¹åº”çš„ ReferenceBeanInvocationHandler
    initReferenceBeanInvocationHandler(serviceBean);
}

private void initReferenceBeanInvocationHandler(ServiceBean serviceBean) {
    String serviceBeanName = serviceBean.getBeanName();
    // Remove ServiceBean when it's exported
    // ä» localReferenceBeanInvocationHandlerCache ç¼“å­˜ä¸­ï¼Œç§»é™¤
    ReferenceBeanInvocationHandler handler = localReferenceBeanInvocationHandlerCache.remove(serviceBeanName);
    // Initialize
    // æ‰§è¡Œåˆå§‹åŒ–
    if (handler != null) {
        handler.init();
    }
}

private void onContextRefreshedEvent(ContextRefreshedEvent event) {
}
```

- é‡ç‚¹åœ¨äºå¤„ç† ServiceBeanExportedEvent äº‹ä»¶ã€‚å¤„ç†æ—¶ï¼Œå¦‚æœåˆ¤æ–­ `localReferenceBeanInvocationHandlerCache` ä¸­å­˜åœ¨ ReferenceBeanInvocationHandler å¯¹è±¡ï¼Œè¯´æ˜æœ‰å®ƒæœªåˆå§‹åŒ–ã€‚åç»­ï¼Œè°ƒç”¨ `ReferenceBeanInvocationHandler#init()` æ–¹æ³•ï¼Œä»è€Œå®Œæˆã€‚è¿™å—ï¼Œç»“åˆ [ã€Œ5.2.2 doGetInjectedBeanã€](http://svip.iocoder.cn/Dubbo/configuration-annotation/#) ä¸€èµ·ï¼Œæ˜¯ä¸æ˜¯å°±æ˜ç™½äº†ã€‚

- åœ¨ ServiceBean æš´éœ²æœåŠ¡å®Œæˆåï¼Œä¼šå‘å¸ƒ ServiceBeanExportedEvent äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ServiceBean.java
  
  private ApplicationEventPublisher applicationEventPublisher;
  
  /**
   * @since 2.6.5
   */
  @Override
  public void export() {
      // æš´éœ²æœåŠ¡
      super.export();
      // Publish ServiceBeanExportedEvent
      // å‘å¸ƒäº‹ä»¶
      publishExportEvent();
  }
  
  /**
   * @since 2.6.5
   */
  private void publishExportEvent() {
      // åˆ›å»º ServiceBeanExportedEvent å¯¹è±¡
      ServiceBeanExportedEvent exportEvent = new ServiceBeanExportedEvent(this);
      // å‘å¸ƒäº‹ä»¶
      applicationEventPublisher.publishEvent(exportEvent);
  }
  ```

- `org.apache.dubbo.config.spring.context.event.ServiceBeanExportedEvent` ï¼ŒService Bean æš´éœ²å®Œæˆäº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // BeanExportedEvent.java
  
  /**
   * A {@link ApplicationEvent} after {@link ServiceBean} {@link ServiceBean#export() export} invocation
   *
   * @see ApplicationEvent
   * @see ApplicationListener
   * @see ServiceBean
   * @since 2.6.5
   */
  public class ServiceBeanExportedEvent extends ApplicationEvent {
  
      /**
       * Create a new ApplicationEvent.
       *
       * @param serviceBean {@link ServiceBean} bean
       */
      public ServiceBeanExportedEvent(ServiceBean serviceBean) {
          super(serviceBean);
      }
  
      /**
       * Get {@link ServiceBean} instance
       *
       * @return non-null
       */
      public ServiceBean getServiceBean() {
          return (ServiceBean) super.getSource();
      }
  
  }
  ```

#### 5.3.4 ReferenceBeanBuilder

`org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceBeanBuilder` ï¼Œç»§æ‰¿ AbstractAnnotationConfigBeanBuilder æŠ½è±¡ç±»ï¼ŒReferenceBean çš„æ„å»ºå™¨ã€‚

> è€ƒè™‘åˆ° ReferenceBeanBuilder ç±»ï¼Œå°±æ˜¯ `#build()` æ–¹æ³•ï¼Œæˆ‘ä»¬å°±ç›´æ¥ç»“åˆ AbstractAnnotationConfigBeanBuilder æŠ½è±¡ç±»ï¼Œä¸€èµ·å†™äº†ã€‚

##### 5.3.4.1 æ„é€ æ–¹æ³•

```
// AbstractAnnotationConfigBeanBuilder.java

abstract class AbstractAnnotationConfigBeanBuilder<A extends Annotation, B extends AbstractInterfaceConfig> {

    /**
     * æ³¨è§£
     */
    protected final A annotation;
    
    protected final ApplicationContext applicationContext;
    
    protected final ClassLoader classLoader;
    
    /**
     * Bean å¯¹è±¡
     */
    protected Object bean;
    /**
     * æ¥å£
     */
    protected Class<?> interfaceClass;
    
    protected AbstractAnnotationConfigBeanBuilder(A annotation, ClassLoader classLoader,
                                                  ApplicationContext applicationContext) {
        Assert.notNull(annotation, "The Annotation must not be null!");
        Assert.notNull(classLoader, "The ClassLoader must not be null!");
        Assert.notNull(applicationContext, "The ApplicationContext must not be null!");
        this.annotation = annotation;
        this.applicationContext = applicationContext;
        this.classLoader = classLoader;
    }
}

// ReferenceBeanBuilder.java

class ReferenceBeanBuilder extends AbstractAnnotationConfigBeanBuilder<Reference, ReferenceBean> {

    private ReferenceBeanBuilder(Reference annotation, ClassLoader classLoader, ApplicationContext applicationContext) {
        super(annotation, classLoader, applicationContext);
    }

    public static ReferenceBeanBuilder create(Reference annotation, ClassLoader classLoader, ApplicationContext applicationContext) {
        return new ReferenceBeanBuilder(annotation, classLoader, applicationContext);
    }
    
}
```

- å…¶ä¸­ï¼Œæ³›å‹ `A` å¯¹åº” `@Reference` æ³¨è§£ï¼Œæ³›å‹ `B` å¯¹åº” ReferenceBean ç±»ã€‚

##### 5.3.4.2 build

`#build()` æ–¹æ³•ï¼Œæ„é€ æ³›å‹ `B` å¯¹è±¡ã€‚æ­¤å¤„ï¼Œå°±æ˜¯æ„é€  ReferenceBean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// AbstractAnnotationConfigBeanBuilder.java

public final B build() throws Exception {
    // æ ¡éªŒä¾èµ–
    checkDependencies();
    // æ‰§è¡Œæ„é€  Bean å¯¹è±¡
    B bean = doBuild();
    // é…ç½® Bean å¯¹è±¡
    configureBean(bean);
    if (logger.isInfoEnabled()) {
        logger.info("The bean[type:" + bean.getClass().getSimpleName() + "] has been built.");
    }
    return bean;
}

private void checkDependencies() {
}

/**
 * Builds {@link B Bean}
 *
 * @return {@link B Bean}
 */
protected abstract B doBuild();


protected void configureBean(B bean) throws Exception {
    // å‰ç½®é…ç½®
    preConfigureBean(annotation, bean);

    // é…ç½® RegistryConfig å±æ€§
    configureRegistryConfigs(bean);
    // é…ç½® MonitorConfig å±æ€§
    configureMonitorConfig(bean);
    // é…ç½® ApplicationConfig å±æ€§
    configureApplicationConfig(bean);
    // é…ç½® ModuleConfig å±æ€§
    configureModuleConfig(bean);

    // åç½®é…ç½®
    postConfigureBean(annotation, bean);
}

protected abstract void preConfigureBean(A annotation, B bean) throws Exception; // æŠ½è±¡æ–¹æ³•

private void configureRegistryConfigs(B bean) {
    String[] registryConfigBeanIds = resolveRegistryConfigBeanNames(annotation);
    List<RegistryConfig> registryConfigs = BeanFactoryUtils.getBeans(applicationContext, registryConfigBeanIds, RegistryConfig.class);
    bean.setRegistries(registryConfigs);
}

private void configureMonitorConfig(B bean) {
    String monitorBeanName = resolveMonitorConfigBeanName(annotation);
    MonitorConfig monitorConfig = BeanFactoryUtils.getOptionalBean(applicationContext, monitorBeanName, MonitorConfig.class);
    bean.setMonitor(monitorConfig);
}

private void configureApplicationConfig(B bean) {
    String applicationConfigBeanName = resolveApplicationConfigBeanName(annotation);
    ApplicationConfig applicationConfig = BeanFactoryUtils.getOptionalBean(applicationContext, applicationConfigBeanName, ApplicationConfig.class);
    bean.setApplication(applicationConfig);
}

private void configureModuleConfig(B bean) {
    String moduleConfigBeanName = resolveModuleConfigBeanName(annotation);
    ModuleConfig moduleConfig = BeanFactoryUtils.getOptionalBean(applicationContext, moduleConfigBeanName, ModuleConfig.class);
    bean.setModule(moduleConfig);
}

protected abstract String resolveModuleConfigBeanName(A annotation); // æŠ½è±¡æ–¹æ³•
protected abstract String resolveApplicationConfigBeanName(A annotation); // æŠ½è±¡æ–¹æ³•
protected abstract String[] resolveRegistryConfigBeanNames(A annotation); // æŠ½è±¡æ–¹æ³•
protected abstract String resolveMonitorConfigBeanName(A annotation); // æŠ½è±¡æ–¹æ³•

protected abstract void postConfigureBean(A annotation, B bean) throws Exception; // æŠ½è±¡æ–¹æ³•
```

- ReferenceBeanBuilder ä¸»è¦å¯¹ä¸Šé¢çš„æŠ½è±¡æ–¹æ³•ï¼Œè¿›è¡Œå…·ä½“å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ReferenceBeanBuilder.java
  
  static final String[] IGNORE_FIELD_NAMES = of("application", "module", "consumer", "monitor", "registry")
  
  @Override
  protected ReferenceBean doBuild() {
      // åˆ›å»º ReferenceBean å¯¹è±¡
      return new ReferenceBean<>();
  }
  
  @SuppressWarnings("Duplicates")
  @Override
  protected void preConfigureBean(Reference reference, ReferenceBean referenceBean) {
      Assert.notNull(interfaceClass, "The interface class must set first!");
  
      // åˆ›å»º DataBinder å¯¹è±¡
      DataBinder dataBinder = new DataBinder(referenceBean);
      // Register CustomEditors for special fields
      // æ³¨å†ŒæŒ‡å®šå±æ€§çš„è‡ªå®šä¹‰ Editor
      dataBinder.registerCustomEditor(String.class, "filter", new StringTrimmerEditor(true));
      dataBinder.registerCustomEditor(String.class, "listener", new StringTrimmerEditor(true));
      dataBinder.registerCustomEditor(Map.class, "parameters", new PropertyEditorSupport() {
          @Override
          public void setAsText(String text) throws java.lang.IllegalArgumentException {
              // Trim all whitespace
              String content = StringUtils.trimAllWhitespace(text);
              if (!StringUtils.hasText(content)) { // No content , ignore directly
                  return;
              }
              // replace "=" to ","
              content = StringUtils.replace(content, "=", ",");
              // replace ":" to ","
              content = StringUtils.replace(content, ":", ",");
              // String[] to Map
              Map<String, String> parameters = CollectionUtils.toStringMap(commaDelimitedListToStringArray(content));
              setValue(parameters);
          }
      });
  
      // Bind annotation attributes
      // å°†æ³¨è§£çš„å±æ€§ï¼Œè®¾ç½®åˆ° reference ä¸­
      dataBinder.bind(new AnnotationPropertyValuesAdapter(reference, applicationContext.getEnvironment(), IGNORE_FIELD_NAMES));
  }
  
  
  @Override
  protected String resolveModuleConfigBeanName(Reference annotation) {
      return annotation.module();
  }
  
  @Override
  protected String resolveApplicationConfigBeanName(Reference annotation) {
      return annotation.application();
  }
  
  @Override
  protected String[] resolveRegistryConfigBeanNames(Reference annotation) {
      return annotation.registry();
  }
  
  @Override
  protected String resolveMonitorConfigBeanName(Reference annotation) {
      return annotation.monitor();
  }
  
  @Override
  protected void postConfigureBean(Reference annotation, ReferenceBean bean) throws Exception {
      // è®¾ç½® applicationContext
      bean.setApplicationContext(applicationContext);
      // é…ç½® interfaceClass
      configureInterface(annotation, bean);
      // é…ç½® ConsumerConfig
      configureConsumerConfig(annotation, bean);
  
      // æ‰§è¡Œ Bean åç½®å±æ€§åˆå§‹åŒ–
      bean.afterPropertiesSet();
  }
  
  @SuppressWarnings("Duplicates")
  private void configureInterface(Reference reference, ReferenceBean referenceBean) {
      // é¦–å…ˆï¼Œä» @Reference è·å¾— interfaceName å±æ€§ï¼Œä»è€Œè·å¾— interfaceClass ç±»
      Class<?> interfaceClass = reference.interfaceClass();
      if (void.class.equals(interfaceClass)) {
          interfaceClass = null;
          String interfaceClassName = reference.interfaceName();
          if (StringUtils.hasText(interfaceClassName)) {
              if (ClassUtils.isPresent(interfaceClassName, classLoader)) {
                  interfaceClass = ClassUtils.resolveClassName(interfaceClassName, classLoader);
              }
          }
  
      }
  
      // å¦‚æœè·å¾—ä¸åˆ°ï¼Œåˆ™ä½¿ç”¨ interfaceClass å³å¯
      if (interfaceClass == null) {
          interfaceClass = this.interfaceClass;
      }
  
      Assert.isTrue(interfaceClass.isInterface(), "The class of field or method that was annotated @Reference is not an interface!");
      referenceBean.setInterface(interfaceClass);
  }
  
  
  private void configureConsumerConfig(Reference reference, ReferenceBean<?> referenceBean) {
      // è·å¾— ConsumerConfig å¯¹è±¡
      String consumerBeanName = reference.consumer();
      ConsumerConfig consumerConfig = getOptionalBean(applicationContext, consumerBeanName, ConsumerConfig.class);
      // è®¾ç½®åˆ° referenceBean ä¸­
      referenceBean.setConsumer(consumerConfig);
  }
  ```

  - ~

ğŸ˜ˆ å†™çš„ç›¸å¯¹ç®€ç•¥ã€‚æ³¨æ„çœ‹æ¯ä¸€ä¸ªçš„æ³¨é‡Šå“ˆ~

#### 5.3.5 destroy

å®ç° `#destroy()` æ–¹æ³•ï¼Œæ‰§è¡Œé”€æ¯é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ReferenceAnnotationBeanPostProcessor.java

@Override
public void destroy() throws Exception {
    // çˆ¶ç±»é”€æ¯
    super.destroy();
    // æ¸…ç©ºç¼“å­˜
    this.referenceBeanCache.clear();
    this.localReferenceBeanInvocationHandlerCache.clear();
    this.injectedFieldReferenceBeanCache.clear();
    this.injectedMethodReferenceBeanCache.clear();
}
```

