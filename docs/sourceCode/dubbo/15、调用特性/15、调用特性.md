# å›å£°æµ‹è¯•

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«**å›å£°æµ‹è¯•**ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹ [ã€Šç”¨æˆ·æŒ‡å— â€”â€” å›å£°æµ‹è¯•ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/echo-service.html) çš„å®šä¹‰ï¼š

> å›å£°æµ‹è¯•ç”¨äºæ£€æµ‹æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œå›å£°æµ‹è¯•æŒ‰ç…§æ­£å¸¸è¯·æ±‚æµç¨‹æ‰§è¡Œï¼Œèƒ½å¤Ÿæµ‹è¯•æ•´ä¸ªè°ƒç”¨æ˜¯å¦é€šç•…ï¼Œå¯ç”¨äºç›‘æ§ã€‚

## 2. æœåŠ¡æ¶ˆè´¹è€…

#### 2.1 EchoService

[`com.alibaba.dubbo.rpc.service.EchoService`](https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/service/EchoService.java) ï¼ŒEcho æœåŠ¡æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public interface EchoService {

    /**
     * echo test.
     *
     * @param message message.
     * @return message.
     */
    Object $echo(Object message);

}
```

> æ‰€æœ‰æœåŠ¡è‡ªåŠ¨å®ç° EchoService æ¥å£ï¼Œåªéœ€å°†ä»»æ„æœåŠ¡å¼•ç”¨å¼ºåˆ¶è½¬å‹ä¸º EchoServiceï¼Œå³å¯ä½¿ç”¨ã€‚

åœ¨ AbstractProxyFactory ä¸­ï¼Œ`#getProxy(invoker)` æ–¹æ³•ï¼Œåˆ›å»ºæœåŠ¡æ¶ˆè´¹è€…çš„ Proxy å¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨å®ç° EchoService æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

[![AbstractProxyFactory](http://static.iocoder.cn/images/Dubbo/2018_11_05/01.png)](http://static.iocoder.cn/images/Dubbo/2018_11_05/01.png)AbstractProxyFactory

#### 2.2 ä½¿ç”¨ç¤ºä¾‹

> æ—ç™½å›ï¼šå¦‚ä¸‹éƒ¨åˆ†ï¼Œä»å®˜æ–¹æ–‡æ¡£ï¼Œç›´æ¥å¤åˆ¶ç²˜è´´çš„ã€‚

Spring é…ç½®ï¼š

```
<dubbo:reference id="memberService" interface="com.xxx.MemberService" />
```

ä»£ç ï¼š

```
// è¿œç¨‹æœåŠ¡å¼•ç”¨
MemberService memberService = ctx.getBean("memberService"); 

EchoService echoService = (EchoService) memberService; // å¼ºåˆ¶è½¬å‹ä¸ºEchoService

// å›å£°æµ‹è¯•å¯ç”¨æ€§
String status = echoService.$echo("OK"); 

assert(status.equals("OK"));
```

## 3. æœåŠ¡æä¾›è€…

æœåŠ¡æä¾›è€…ï¼Œæ˜¯**ä¸å®ç°** EchoService æ¥å£ï¼Œè€Œæ˜¯é€šè¿‡ EchoFilter å®ç°ã€‚

#### 3.1 EchoFilter

[`com.alibaba.dubbo.rpc.filter.EchoFilter`](https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/filter/EchoFilter.java) ï¼Œå®ç° Filter æ¥å£ï¼Œå›å£°è¿‡æ»¤å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Activate(group = Constants.PROVIDER, order = -110000)
public class EchoFilter implements Filter {

    @Override
    public Result invoke(Invoker<?> invoker, Invocation inv) throws RpcException {
        // æ–¹æ³•åä¸º `$echo` ï¼Œå‚æ•°åªæœ‰ä¸€ä¸ª
        if (inv.getMethodName().equals(Constants.$ECHO) && inv.getArguments() != null && inv.getArguments().length == 1) {
            return new RpcResult(inv.getArguments()[0]);
        }
        return invoker.invoke(inv);
    }

}
```

- ä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œ**è‡ªåŠ¨åŠ è½½**ï¼Œä»…é™**æœåŠ¡æä¾›è€…**ã€‚
- å¦‚æœè°ƒç”¨æ–¹æ³•æ˜¯**å›å£°**è°ƒç”¨æ—¶ï¼Œé€šè¿‡æ–¹æ³•å( `$echo` ) å’Œæ–¹æ³•å‚æ•°æ•°é‡ä¸º **1** ï¼Œç›´æ¥è¿”å›æ–¹æ³•å‚æ•°ã€‚
- è‹¥æœè°ƒç”¨æ–¹æ³•é**å›å£°**è°ƒç”¨æ—¶ï¼Œè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼Œç»§ç»­èµ°åé¢çš„è¿‡æ»¤é“¾ã€‚

# æ³›åŒ–å¼•ç”¨

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«**æ³›åŒ–å¼•ç”¨**ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹ [ã€Šç”¨æˆ·æŒ‡å— â€”â€” æ³›åŒ–å¼•ç”¨ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/generic-reference.html) çš„å®šä¹‰ï¼š

> æ³›åŒ–æ¥å£è°ƒç”¨æ–¹å¼ä¸»è¦ç”¨äºå®¢æˆ·ç«¯æ²¡æœ‰ API æ¥å£åŠæ¨¡å‹ç±»å…ƒçš„æƒ…å†µï¼Œå‚æ•°åŠè¿”å›å€¼ä¸­çš„æ‰€æœ‰ POJO å‡ç”¨ Map è¡¨ç¤ºï¼Œé€šå¸¸ç”¨äºæ¡†æ¶é›†æˆï¼Œæ¯”å¦‚ï¼šå®ç°ä¸€ä¸ªé€šç”¨çš„æœåŠ¡æµ‹è¯•æ¡†æ¶ï¼Œå¯é€šè¿‡ GenericService è°ƒç”¨æ‰€æœ‰æœåŠ¡å®ç°ã€‚

è¯·æ³¨æ„ï¼Œæ¶ˆè´¹**æ¶ˆè´¹è€…**æ²¡æœ‰ **API æ¥å£** åŠ **æ¨¡å‹ç±»å…ƒ**ã€‚é‚£å°±æ˜¯è¯´ï¼ŒDubbo åœ¨æ³›åŒ–å¼•ç”¨ä¸­ï¼Œéœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼š

- æ²¡æœ‰ **API æ¥å£**ï¼Œæ‰€ä»¥æä¾›ä¸€ä¸ªæ³›åŒ–æœåŠ¡æ¥å£ï¼Œç›®å‰æ˜¯ [`com.alibaba.dubbo.rpc.service.GenericService`](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/service/GenericService.java) ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  public interface GenericService {
  
      /**
       * Generic invocation
       *
       * æ³›åŒ–è°ƒç”¨
       *
       * @param method         Method name, e.g. findPerson. If there are overridden methods, parameter info is
       *                       required, e.g. findPerson(java.lang.String)
       *                       æ–¹æ³•å
       * @param parameterTypes Parameter types
       *                       å‚æ•°ç±»å‹æ•°ç»„
       * @param args           Arguments
       *                       å‚æ•°æ•°ç»„
       * @return invocation return value è°ƒç”¨ç»“æœ
       * @throws Throwable potential exception thrown from the invocation
       */
      Object $invoke(String method, String[] parameterTypes, Object[] args) throws GenericException;
  
  }
  ```

  - **ä¸€ä¸ª**æ³›åŒ–å¼•ç”¨ï¼Œåªå¯¹åº”**ä¸€ä¸ª**æœåŠ¡å®ç°ã€‚
  - é€šè¿‡ `$invoke(method, parameterTypes, args)` æ–¹æ³•ï¼Œå¯ä»¥å®ç°æœåŠ¡çš„æ³›åŒ–è°ƒç”¨ã€‚
  - å…·ä½“çš„ä½¿ç”¨æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ2. ç¤ºä¾‹ã€](http://svip.iocoder.cn/Dubbo/rpc-feature-generic-reference/#) ä¸­çœ‹ã€‚

- æ²¡æœ‰ **æ¨¡å‹ç±»å…ƒ**ï¼Œæ‰€ä»¥æ–¹æ³•å‚æ•°å’Œæ–¹æ³•è¿”å›è‹¥æ˜¯ POJO ( ä¾‹å¦‚ User å’Œ Order ç­‰ ) ï¼Œéœ€è¦**è½¬æ¢å¤„ç†**ï¼š

  - æœåŠ¡æ¶ˆè´¹è€…ï¼Œå°† POJO è½¬æˆ Map ï¼Œç„¶åå†è°ƒç”¨æœåŠ¡æä¾›è€…ã€‚
  - æœåŠ¡æä¾›è€…ï¼Œæ¥æ”¶åˆ° Map ï¼Œè½¬æ¢æˆ POJO ï¼Œå†è°ƒç”¨ Service æ–¹æ³•ã€‚è‹¥è¿”å›å€¼æœ‰ POJO ï¼Œåˆ™è½¬æ¢æˆ Map å†è¿”å›ã€‚
  - ğŸ™‚ æ­¤å¤„çš„ Map åªæ˜¯ä¸¾ä¾‹å­ï¼Œå®é™…åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿˜æœ‰**ä¸¤ç§**è½¬æ¢æ–¹å¼ã€‚

æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š

![æµç¨‹](http://static.iocoder.cn/images/Dubbo/2018_11_06/01.png)

## 2. ç¤ºä¾‹

**æœåŠ¡æä¾›è€…**

åœ¨ [`dubbo-generic-reference-demo-provider`](https://github.com/YunaiV/dubbo/blob/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-demo/dubbo-generic-reference-demo-provider) ï¼Œæˆ‘ä»¬æä¾›äº†ä¾‹å­ã€‚æ™®é€šçš„æœåŠ¡æä¾›è€…ï¼Œä¸éœ€è¦åšä»»ä½•å¤„ç†ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚

**æœåŠ¡æ¶ˆè´¹è€…**

åœ¨ [`dubbo-generic-reference-demo-consumer`](https://github.com/YunaiV/dubbo/tree/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-demo/dubbo-generic-reference-demo-consumer) ï¼Œæˆ‘ä»¬æä¾›äº†ä¾‹å­ã€‚æˆ‘ä»¬æŒ‘**é‡ç‚¹**çš„åœ°æ–¹è¯´ã€‚

â‘  åœ¨ Spring é…ç½®ç”³æ˜ `generic="true"`ï¼š

```
<dubbo:reference id="demoService"  interface="com.alibaba.dubbo.demo.DemoService" generic="true" />
```

- `interface` é…ç½®é¡¹ï¼Œæ³›åŒ–å¼•ç”¨çš„æœåŠ¡æ¥å£ã€‚é€šè¿‡è¯¥é…ç½®ï¼Œå¯ä»¥ä»æ³¨å†Œä¸­å¿ƒï¼Œè·å–åˆ°æ‰€æœ‰**è¯¥æœåŠ¡**çš„æä¾›æ–¹çš„åœ°å€ã€‚

- ```
  generic
  ```

   

  é…ç½®é¡¹ï¼Œé»˜è®¤ä¸º

   

  ```
  false
  ```

   

  ï¼Œä¸ä½¿ç”¨é…ç½®é¡¹ã€‚ç›®å‰æœ‰

  ä¸‰ç§é…ç½®é¡¹çš„å€¼

  ï¼Œå¼€å¯æ³›åŒ–å¼•ç”¨çš„åŠŸèƒ½ï¼š

  - `generic=true` ï¼Œä½¿ç”¨ [`com.alibaba.dubbo.common.utils.PojoUtils`](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/PojoUtils.java) ï¼Œå®ç° `POJO <=> Map` çš„äº’è½¬ã€‚
  - `generic=nativejava` ï¼Œä½¿ç”¨ [`com.alibaba.dubbo.common.serialize.support.nativejava.NativeJavaSerialization`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/nativejava/NativeJavaSerialization.java) ï¼Œå®ç° `POJO <=> byte[]` çš„äº’è½¬ã€‚
  - `generic=bean` ï¼Œä½¿ç”¨ [`com.alibaba.dubbo.common.beanutil.JavaBeanSerializeUtil`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/beanutil/JavaBeanSerializeUtil.java) ï¼Œå®ç° `POJO <=> JavaBeanDescriptor` çš„äº’è½¬ã€‚
  - æ€»çš„æ¥è¯´ï¼Œä¸‰ç§æ–¹å¼çš„å·®å¼‚ï¼Œåœ¨äºä½¿ç”¨äº’è½¬( **åºåˆ—åŒ–å’Œååºåˆ—åŒ–** )çš„æ–¹å¼ä¸åŒã€‚æœªæ¥å¦‚æœæˆ‘ä»¬æœ‰éœ€è¦ï¼Œå®Œæˆå¯ä»¥å®ç° `generic=json` ï¼Œä½¿ç”¨ FastJSON æ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

â‘¡ åœ¨ Java ä»£ç è·å– barService å¹¶å¼€å§‹æ³›åŒ–è°ƒç”¨ï¼š

```
ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[]{"META-INF/spring/dubbo-demo-consumer.xml"});

GenericService genericService = (GenericService) context.getBean("demoService");
Object result = genericService.$invoke("say01", new String[]{"java.lang.String"}, new Object[]{"123"});
System.out.println("result: " + result);
```

- é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨ GenericService è½¬æ¢ï¼Ÿç­”æ¡ˆåœ¨ `ReferenceConfig#init()` æ–¹æ³•ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  // ReferenceConfig.java
  if (ProtocolUtils.isGeneric(getGeneric())) {
      interfaceClass = GenericService.class;
  }
  
  // ProtocolUtils.java
  public static boolean isGeneric(String generic) {
      return generic != null
              && !"".equals(generic)
              && (Constants.GENERIC_SERIALIZATION_DEFAULT.equalsIgnoreCase(generic)  /* Normal generalization cal */
              || Constants.GENERIC_SERIALIZATION_NATIVE_JAVA.equalsIgnoreCase(generic) /* Streaming generalization call supporting jdk serialization */
              || Constants.GENERIC_SERIALIZATION_BEAN.equalsIgnoreCase(generic));
  }
  ```

#### 2.1 æœ‰å…³æ³›åŒ–ç±»å‹çš„è¿›ä¸€æ­¥è§£é‡Š

> æœ¬å°èŠ‚ä¸ºå¼•ç”¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æ³›åŒ–å¼•ç”¨ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/generic-reference.html) ã€‚

å‡è®¾å­˜åœ¨ POJO å¦‚ï¼š

```
package com.xxx;

public class PersonImpl implements Person {
    private String name;
    private String password;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }
}
```

åˆ™ POJO æ•°æ®ï¼š

```
Person person = new PersonImpl(); 
person.setName("xxx"); 
person.setPassword("yyy");
```

ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘å¯ç”¨ä¸‹é¢ Map è¡¨ç¤ºï¼š

```
Map<String, Object> map = new HashMap<String, Object>(); 
// æ³¨æ„ï¼šå¦‚æœå‚æ•°ç±»å‹æ˜¯æ¥å£ï¼Œæˆ–è€…Listç­‰ä¸¢å¤±æ³›å‹ï¼Œå¯é€šè¿‡classå±æ€§æŒ‡å®šç±»å‹ã€‚
map.put("class", "com.xxx.PersonImpl"); 
map.put("name", "xxx"); 
map.put("password", "yyy");
```

- Map ä¸­çš„ `class` å±æ€§ï¼Œåœ¨ PojoUtils ä¸­ï¼Œä¼šæ ¹æ®è¯¥å±æ€§ï¼Œå°† Map è½¬æ¢æˆ POJO å¯¹è±¡ã€‚

## 3. æœåŠ¡æ¶ˆè´¹è€… GenericImplFilter

[`com.alibaba.dubbo.rpc.filter.GenericImplFilter`](https://github.com/YunaiV/dubbo/blob/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/filter/GenericImplFilter.java) ï¼Œå®ç° Filter æ¥å£ï¼ŒæœåŠ¡æ¶ˆè´¹è€…çš„æ³›åŒ–è°ƒç”¨è¿‡æ»¤å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: @Activate(group = Constants.CONSUMER, value = Constants.GENERIC_KEY, order = 20000)
 2: public class GenericImplFilter implements Filter {
 3: 
 4:     // ... çœç•¥æ— å…³å±æ€§
 5: 
 6:     @Override
 7:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
 8:         // è·å¾— `generic` é…ç½®é¡¹
 9:         String generic = invoker.getUrl().getParameter(Constants.GENERIC_KEY);
10: 
11:         // çœç•¥ä»£ç ...æ³›åŒ–å®ç°çš„è°ƒç”¨
12: 
13:         // æ³›åŒ–å¼•ç”¨çš„è°ƒç”¨
14:         if (invocation.getMethodName().equals(Constants.$INVOKE) // æ–¹æ³•åä¸º `$invoke`
15:                 && invocation.getArguments() != null
16:                 && invocation.getArguments().length == 3
17:                 && ProtocolUtils.isGeneric(generic)) {
18:             Object[] args = (Object[]) invocation.getArguments()[2];
19:             // `nativejava` ï¼Œæ ¡éªŒæ–¹æ³•å‚æ•°éƒ½ä¸º byte[]
20:             if (ProtocolUtils.isJavaGenericSerialization(generic)) {
21:                 for (Object arg : args) {
22:                     if (!(byte[].class == arg.getClass())) {
23:                         error(byte[].class.getName(), arg.getClass().getName());
24:                     }
25:                 }
26:             // `bean` ï¼Œæ ¡éªŒæ–¹æ³•å‚æ•°ä¸º JavaBeanDescriptor
27:             } else if (ProtocolUtils.isBeanGenericSerialization(generic)) {
28:                 for (Object arg : args) {
29:                     if (!(arg instanceof JavaBeanDescriptor)) {
30:                         error(JavaBeanDescriptor.class.getName(), arg.getClass().getName());
31:                     }
32:                 }
33:             }
34: 
35:             // é€šè¿‡éšå¼å‚æ•°ï¼Œä¼ é€’ `generic` é…ç½®é¡¹
36:             ((RpcInvocation) invocation).setAttachment(Constants.GENERIC_KEY, generic);
37:         }
38:         return invoker.invoke(invocation);
39:     }
40: 
41:     // çœç•¥ `#error(...)` æ–¹æ³•
42: 
43: }
```

- ä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œ

  è‡ªåŠ¨åŠ è½½

  ï¼Œä»…é™

  æœåŠ¡æ¶ˆè´¹è€…

  ï¼Œå¹¶ä¸”æœ‰

   

  ```
  generic
  ```

   

  é…ç½®é¡¹ã€‚

  - æ­¤å¤„ç¬”è€…å°±äº§ç”Ÿäº†ä¸€ä¸ªç–‘é—®ï¼Œä»æ³¨å†Œä¸­å¿ƒï¼Œè·å¾—åˆ°çš„æœåŠ¡ URL ï¼Œå¹¶æ²¡æœ‰è®¾ç½® `generic` çš„é…ç½®é¡¹ï¼Œé‚£å²‚ä¸æ˜¯åœ¨ ProtocolFilterWrapper ä¸­ï¼Œä½¿ç”¨ Dubbo SPI Adaptive åŠ è½½ä¸åˆ° GenericImplFilter è¿™ä¸ªè¿‡æ»¤å™¨ï¼Ÿ
  - äºæ˜¯ï¼Œç¬”è€…å°±å¼€å§‹æ…¢æ…¢è°ƒè¯•ï¼Œç›´åˆ°å‘ç° `RegistryDirectory#mergeUrl(providerUrl)` æ–¹æ³•ï¼Œå®ƒä¼šå°†æœåŠ¡æ¶ˆè´¹è€…çš„é…ç½®( URL )é¡¹ï¼Œ**è¦†ç›–**åˆ°æœåŠ¡æä¾›è€…çš„ URL ã€‚
  - åˆå› ä¸ºæ³›åŒ–å¼•ç”¨æ—¶ï¼Œæˆ‘ä»¬ä¼šåœ¨æœåŠ¡æ¶ˆè´¹è€…çš„é…ç½® `generic = true` ï¼Œé‚£ä¹ˆæœåŠ¡æä¾›è€… URL è‡ªç„¶å°±æœ‰äº†è¯¥é…ç½®é¡¹ï¼Œæ‰€ä»¥ä¾¿æœ‰äº† GenericImplFilter è¿‡æ»¤å™¨ã€‚

- ç¬¬ 9 è¡Œï¼šè·å¾— `generic` é…ç½®é¡¹ã€‚

- ç¬¬ 11 è¡Œï¼šçœç•¥ç”¨äºè°ƒç”¨**æ³›åŒ–å®ç°æœåŠ¡**çš„ä»£ç ï¼Œå¯¹åº”æ–‡æ¡£ä¸º [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æ³›åŒ–å®ç°ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/generic-service.html) ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬è¯¦ç»†åˆ†äº«ã€‚

- ç¬¬ 13 è‡³ 37 è¡Œï¼š**æ³›åŒ–å¼•ç”¨**çš„è°ƒç”¨ï¼Œé€šè¿‡æ–¹æ³•( åŒ…æ‹¬æ–¹æ³•åã€å‚æ•° ) + `generic` é…ç½®é¡¹ï¼Œè¿›è¡Œåˆ¤æ–­ã€‚

  - ç¬¬ 19 è‡³ 33 è¡Œï¼šæ ¹æ®ä¸åŒçš„ `generic` é…ç½®é¡¹ï¼Œæ ¡éªŒæ–¹æ³•å‚æ•°æ˜¯å¦å·²ç»æ­£ç¡®**åºåˆ—åŒ–**ã€‚è‹¥ä¸åˆæ³•ï¼Œè°ƒç”¨ `#error(expected, actual)` æ–¹æ³•ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
    private void error(String expected, String actual) throws RpcException {
        throw new RpcException(
                new StringBuilder(32)
                        .append("Generic serialization [")
                        .append(Constants.GENERIC_SERIALIZATION_NATIVE_JAVA)
                        .append("] only support message type ")
                        .append(expected)
                        .append(" and your message type is ")
                        .append(actual).toString());
    }
    ```

    - x

  - ç¬¬ 36 è¡Œï¼šè°ƒç”¨ `RpcInvocation#setAttachment(key, value)` é€šè¿‡éšå¼å‚æ•°ï¼Œä¼ é€’ `generic` é…ç½®é¡¹ã€‚

- ç¬¬ 38 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼Œç»§ç»­è¿‡æ»¤é“¾çš„è°ƒç”¨ï¼Œæœ€ç»ˆ RPC è°ƒç”¨ã€‚

## 4. æœåŠ¡æä¾›è€… GenericFilter

[`com.alibaba.dubbo.rpc.filter.GenericFilter`](https://github.com/YunaiV/dubbo/blob/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/filter/GenericFilter.java) ï¼Œå®ç° Filter æ¥å£ï¼ŒæœåŠ¡æ¶ˆè´¹è€…çš„æ³›åŒ–è°ƒç”¨è¿‡æ»¤å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: @Activate(group = Constants.PROVIDER, order = -20000)
 2: public class GenericFilter implements Filter {
 3: 
 4:     @Override
 5:     public Result invoke(Invoker<?> invoker, Invocation inv) throws RpcException {
 6:         // æ³›åŒ–å¼•ç”¨çš„è°ƒç”¨
 7:         if (inv.getMethodName().equals(Constants.$INVOKE)
 8:                 && inv.getArguments() != null
 9:                 && inv.getArguments().length == 3
10:                 && !ProtocolUtils.isGeneric(invoker.getUrl().getParameter(Constants.GENERIC_KEY))) { // éæ³›åŒ–å®ç°çš„è°ƒç”¨
11:             String name = ((String) inv.getArguments()[0]).trim();
12:             String[] types = (String[]) inv.getArguments()[1];
13:             Object[] args = (Object[]) inv.getArguments()[2];
14:             try {
15:                 // è·å¾—å¯¹åº”çš„æ–¹æ³• Method å¯¹è±¡
16:                 Method method = ReflectUtils.findMethodByMethodSignature(invoker.getInterface(), name, types);
17:                 // è·å¾—æ–¹æ³•å‚æ•°ç±»å‹å’Œæ–¹æ³•å‚æ•°æ•°ç»„
18:                 Class<?>[] params = method.getParameterTypes();
19:                 if (args == null) {
20:                     args = new Object[params.length];
21:                 }
22:                 // è·å¾— `generic` é…ç½®é¡¹
23:                 String generic = inv.getAttachment(Constants.GENERIC_KEY);
24:                 // ã€ç¬¬ä¸€æ­¥ã€‘`true` ï¼Œååºåˆ—åŒ–å‚æ•°ï¼Œä»…æœ‰ Map => POJO
25:                 if (StringUtils.isEmpty(generic) || ProtocolUtils.isDefaultGenericSerialization(generic)) {
26:                     args = PojoUtils.realize(args, params, method.getGenericParameterTypes());
27:                 // ã€ç¬¬ä¸€æ­¥ã€‘`nativejava` ï¼Œååºåˆ—åŒ–å‚æ•°ï¼Œbyte[] => æ–¹æ³•å‚æ•°
28:                 } else if (ProtocolUtils.isJavaGenericSerialization(generic)) {
29:                     for (int i = 0; i < args.length; i++) {
30:                         if (byte[].class == args[i].getClass()) {
31:                             try {
32:                                 UnsafeByteArrayInputStream is = new UnsafeByteArrayInputStream((byte[]) args[i]);
33:                                 args[i] = ExtensionLoader.getExtensionLoader(Serialization.class).getExtension(Constants.GENERIC_SERIALIZATION_NATIVE_JAVA)
34:                                         .deserialize(null, is).readObject();
35:                             } catch (Exception e) {
36:                                 throw new RpcException("Deserialize argument [" + (i + 1) + "] failed.", e);
37:                             }
38:                         } else {
39:                             throw new RpcException(
40:                                     new StringBuilder(32).append("Generic serialization [")
41:                                             .append(Constants.GENERIC_SERIALIZATION_NATIVE_JAVA)
42:                                             .append("] only support message type ")
43:                                             .append(byte[].class)
44:                                             .append(" and your message type is ")
45:                                             .append(args[i].getClass()).toString());
46:                         }
47:                     }
48:                 // ã€ç¬¬ä¸€æ­¥ã€‘`bean` ï¼Œååºåˆ—åŒ–å‚æ•°ï¼ŒJavaBeanDescriptor => æ–¹æ³•å‚æ•°
49:                 } else if (ProtocolUtils.isBeanGenericSerialization(generic)) {
50:                     for (int i = 0; i < args.length; i++) {
51:                         if (args[i] instanceof JavaBeanDescriptor) {
52:                             args[i] = JavaBeanSerializeUtil.deserialize((JavaBeanDescriptor) args[i]);
53:                         } else {
54:                             throw new RpcException(
55:                                     new StringBuilder(32)
56:                                             .append("Generic serialization [")
57:                                             .append(Constants.GENERIC_SERIALIZATION_BEAN)
58:                                             .append("] only support message type ")
59:                                             .append(JavaBeanDescriptor.class.getName())
60:                                             .append(" and your message type is ")
61:                                             .append(args[i].getClass().getName()).toString());
62:                         }
63:                     }
64:                 }
65:                 // ã€ç¬¬äºŒæ­¥ã€‘æ–¹æ³•è°ƒç”¨
66:                 Result result = invoker.invoke(new RpcInvocation(method, args, inv.getAttachments()));
67:                 // ã€ç¬¬ä¸‰æ­¥ã€‘è‹¥æ˜¯å¼‚å¸¸ç»“æœï¼Œå¹¶ä¸”é GenericException å¼‚å¸¸ï¼Œåˆ™ä½¿ç”¨ GenericException åŒ…è£…
68:                 if (result.hasException()
69:                         && !(result.getException() instanceof GenericException)) {
70:                     return new RpcResult(new GenericException(result.getException()));
71:                 }
72:                 // ã€ç¬¬ä¸‰æ­¥ã€‘`nativejava` ï¼Œåºåˆ—åŒ–ç»“æœï¼Œç»“æœ => byte[]
73:                 if (ProtocolUtils.isJavaGenericSerialization(generic)) {
74:                     try {
75:                         UnsafeByteArrayOutputStream os = new UnsafeByteArrayOutputStream(512);
76:                         ExtensionLoader.getExtensionLoader(Serialization.class).getExtension(Constants.GENERIC_SERIALIZATION_NATIVE_JAVA)
77:                                 .serialize(null, os).writeObject(result.getValue());
78:                         return new RpcResult(os.toByteArray());
79:                     } catch (IOException e) {
80:                         throw new RpcException("Serialize result failed.", e);
81:                     }
82:                 // ã€ç¬¬ä¸‰æ­¥ã€‘`bean` ï¼Œåºåˆ—åŒ–ç»“æœï¼Œç»“æœ => JavaBeanDescriptor
83:                 } else if (ProtocolUtils.isBeanGenericSerialization(generic)) {
84:                     return new RpcResult(JavaBeanSerializeUtil.serialize(result.getValue(), JavaBeanAccessor.METHOD));
85:                 // ã€ç¬¬ä¸‰æ­¥ã€‘`true` ï¼Œåºåˆ—åŒ–ç»“æœï¼Œä»…æœ‰ POJO => Map
86:                 } else {
87:                     return new RpcResult(PojoUtils.generalize(result.getValue()));
88:                 }
89:             } catch (NoSuchMethodException e) {
90:                 throw new RpcException(e.getMessage(), e);
91:             } catch (ClassNotFoundException e) {
92:                 throw new RpcException(e.getMessage(), e);
93:             }
94:         }
95:         // æ™®é€šè°ƒç”¨
96:         return invoker.invoke(inv);
97:     }
98: 
99: }
```

- ä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œ**è‡ªåŠ¨åŠ è½½**ï¼Œä»…é™**æœåŠ¡æä¾›è€…**ã€‚

- ç¬¬ 96 è¡Œï¼šè‹¥æ˜¯æ™®é€šè°ƒç”¨( **éæ³›åŒ–å¼•ç”¨çš„è°ƒç”¨** )ï¼Œè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼Œç»§ç»­è¿‡æ»¤é“¾çš„è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨ Service æœåŠ¡ã€‚

- ç¬¬ 6 è‡³ 95 è¡Œï¼š è‹¥æ˜¯**æ³›åŒ–å¼•ç”¨çš„è°ƒç”¨**ï¼Œé€šè¿‡æ–¹æ³•( åŒ…æ‹¬æ–¹æ³•åã€å‚æ•° )åˆ¤æ–­ã€‚**æ³¨æ„**ï¼Œã€ç¬¬ 10 è¡Œã€‘é**æ³›åŒ–å®ç°**çš„è°ƒç”¨ã€‚

- ç¬¬ 16 è¡Œï¼šè°ƒç”¨ [`ReflectUtils#findMethodByMethodSignature(Class clazz, String methodName, String[\] parameterTypes)`](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/ReflectUtils.java#L768-L814) æ–¹æ³•ï¼Œé€šè¿‡åå°„ï¼Œè·å¾—å¯¹åº”çš„æ–¹æ³• **Method** å¯¹è±¡ã€‚å…·ä½“çš„ä»£ç å®ç°ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹å“ˆã€‚

- ç¬¬ 17 è‡³ 21 è¡Œï¼šè·å¾—**æ–¹æ³•å‚æ•°ç±»å‹å’Œæ–¹æ³•å‚æ•°**æ•°ç»„ã€‚

- ç¬¬ 23 è¡Œï¼šè·å¾— `generic` é…ç½®é¡¹ã€‚

- ========== ã€ç¬¬ä¸€æ­¥ï¼šååºåˆ—åŒ–å‚æ•°ã€‘ ==========

- ç¬¬ 24 è‡³ 26 è¡Œï¼š`generic = true` ï¼Œè°ƒç”¨ [`PojoUtils#realize(Object[\] objs, Class[] types, Type[] gtypes)`](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/PojoUtils.java#L81-L89) æ–¹æ³•ï¼Œååºåˆ—åŒ–å‚æ•°ã€‚**æ³¨æ„**ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œåªæœ‰å¸¦æœ‰ `class` å±æ€§çš„ Map ï¼Œéœ€è¦**ååºåˆ—åŒ–**æˆå¯¹åº”çš„ POJO å¯¹è±¡ã€‚

- ç¬¬ 27 è‡³ 47 è¡Œï¼š`generic = nativejava` ï¼Œè°ƒç”¨ `NativeJavaSerialization#deserialize(url, input)` æ–¹æ³•ï¼Œååºåˆ—åŒ–å‚æ•°ï¼Œå³ `byte[] => æ–¹æ³•å‚æ•°` ã€‚

- ç¬¬ 48 è‡³ 64 è¡Œï¼š`generic = bean` ï¼Œè°ƒç”¨ `JavaBeanSerializeUtil#deserialize(JavaBeanDescriptor)` æ–¹æ³•ï¼Œååºåˆ—åŒ–å‚æ•°ï¼Œå³ `JavaBeanDescriptor => æ–¹æ³•å‚æ•°` ã€‚

- ========== ã€ç¬¬äºŒæ­¥ï¼šæ–¹æ³•è°ƒç”¨ã€‘ ==========

- ç¬¬ 66 è¡Œï¼šåˆ›å»º**æ–°çš„** RpcInvocation å¯¹è±¡ã€‚è¿™æ˜¯**éå¸¸å…³é”®**çš„ä¸€æ­¥ï¼Œ`$invoke` çš„æ³›åŒ–è°ƒç”¨ï¼Œè¢«è½¬æ¢æˆ**å…·ä½“**çš„æ™®é€šè°ƒç”¨ã€‚

- ç¬¬ 66 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼Œç»§ç»­è¿‡æ»¤é“¾çš„è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨ Service æœåŠ¡ã€‚

- ========== ã€ç¬¬ä¸‰æ­¥ï¼šåºåˆ—åŒ–ç»“æœã€‘ ==========

- ç¬¬ 68 è‡³ 71 è¡Œï¼šè‹¥æ˜¯å¼‚å¸¸ç»“æœï¼Œå¹¶ä¸”é GenericException å¼‚å¸¸ï¼Œå¯èƒ½è¿™ä¸ªå¼‚å¸¸åœ¨æœåŠ¡æ¶ˆè´¹ç«¯æ˜¯**æ²¡æœ‰**çš„ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ [GenericException](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/service/GenericException.java) **åŒ…è£…åè¿”å›**ã€‚GenericException çš„ä»£ç å¦‚ä¸‹ï¼š

  ```
  public class GenericException extends RuntimeException {
      
          private String exceptionClass;
      
      private String exceptionMessage;
      
      public GenericException() {
      }
      
      public GenericException(String exceptionClass, String exceptionMessage) {
          super(exceptionMessage);
          this.exceptionClass = exceptionClass;
          this.exceptionMessage = exceptionMessage;
      }
      
      public GenericException(Throwable cause) {
          super(StringUtils.toString(cause));
          this.exceptionClass = cause.getClass().getName();
          this.exceptionMessage = cause.getMessage();
      }
      
      // ... çœç•¥ getting/setting çš„æ–¹æ³•
  }
  ```

- ç¬¬ 72 è‡³ 81 è¡Œï¼š`generic = nativejava` ï¼Œè°ƒç”¨ `NativeJavaSerialization#serialize(url, output)` æ–¹æ³•ï¼Œåºåˆ—åŒ–ç»“æœï¼Œå³ `ç»“æœ => byte[]` ã€‚

- ç¬¬ 82 è‡³ 84 è¡Œï¼š`generic = bean` ï¼Œè°ƒç”¨ `JavaBeanSerializeUtil#serialize(Object, JavaBeanAccessor)` æ–¹æ³•ï¼Œåºåˆ—åŒ–ç»“æœï¼Œå³ `ç»“æœ => JavaBeanDescriptor` ã€‚

- ç¬¬ 85 è‡³ 88 è¡Œï¼š`generic = true` ï¼Œè°ƒç”¨ `PojoUtils#generalize(Object)` æ–¹æ³•ï¼Œåºåˆ—åŒ–ç»“æœï¼Œä»…æœ‰ `POJO => Map` ã€‚

# æ³›åŒ–å®ç°

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«**æ³›åŒ–å®ç°**ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹ [ã€Šç”¨æˆ·æŒ‡å— â€”â€” æ³›åŒ–å®ç°ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/generic-service.html) çš„å®šä¹‰ï¼š

> æ³›æ¥å£å®ç°æ–¹å¼ä¸»è¦ç”¨äºæœåŠ¡å™¨ç«¯æ²¡æœ‰APIæ¥å£åŠæ¨¡å‹ç±»å…ƒçš„æƒ…å†µï¼Œå‚æ•°åŠè¿”å›å€¼ä¸­çš„æ‰€æœ‰ POJO å‡ç”¨ Map è¡¨ç¤ºï¼Œé€šå¸¸ç”¨äºæ¡†æ¶é›†æˆï¼Œæ¯”å¦‚ï¼šå®ç°ä¸€ä¸ªé€šç”¨çš„è¿œç¨‹æœåŠ¡ Mock æ¡†æ¶ï¼Œå¯é€šè¿‡å®ç° GenericService æ¥å£å¤„ç†æ‰€æœ‰æœåŠ¡è¯·æ±‚ã€‚

è¯·æ³¨æ„ï¼Œæ¶ˆè´¹**æä¾›è€…**æ²¡æœ‰ **API æ¥å£** åŠ **æ¨¡å‹ç±»å…ƒ**ã€‚é‚£å°±æ˜¯è¯´ï¼ŒDubbo åœ¨æ³›åŒ–å®ç°ä¸­ï¼Œéœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼š

> **æ³›åŒ–å®ç°**é€‚ç”¨äºæœåŠ¡æä¾›è€…ï¼Œå’Œ**æ³›åŒ–å¼•ç”¨**é€‚ç”¨äºæœåŠ¡æ¶ˆè´¹è€…ï¼Œæ°æ°â€œç›¸åâ€ã€‚

- æ²¡æœ‰

   

  API æ¥å£

  ï¼Œæ‰€ä»¥æä¾›ä¸€ä¸ªæ³›åŒ–æœåŠ¡æ¥å£ï¼Œç›®å‰æ˜¯

   

  `com.alibaba.dubbo.rpc.service.GenericService`

   

  ã€‚

  - **ä¸€ä¸ª**æ³›åŒ–å®ç°ï¼Œåªå®ç°**ä¸€ä¸ª**æœåŠ¡ã€‚
  - é€šè¿‡å®ç° `$invoke(method, parameterTypes, args)` æ–¹æ³•ï¼Œ**å¤„ç†æ‰€æœ‰è¯¥æœåŠ¡çš„è¯·æ±‚**ã€‚
  - å…·ä½“çš„ä½¿ç”¨æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ2. ç¤ºä¾‹ã€](http://svip.iocoder.cn/Dubbo/rpc-feature-generic-service/#) ä¸­çœ‹ã€‚

- æ²¡æœ‰

   

  æ¨¡å‹ç±»å…ƒ

  ï¼Œæ‰€ä»¥æ–¹æ³•å‚æ•°å’Œæ–¹æ³•è¿”å›è‹¥æ˜¯ POJO ( ä¾‹å¦‚ User å’Œ Order ç­‰ ) ï¼Œéœ€è¦

  è½¬æ¢å¤„ç†

  ï¼š

  - æœåŠ¡æ¶ˆè´¹è€…ï¼Œå°† POJO è½¬æˆ Map ï¼Œç„¶åå†è°ƒç”¨æœåŠ¡æä¾›è€…ã€‚ï¼ˆ**é€æ˜**ï¼‰
  - æœåŠ¡æä¾›è€…ï¼Œè¿”å› Map ã€‚
  - æœåŠ¡æ¶ˆè´¹è€…ï¼Œè‹¥**æ”¶åˆ°**è¿”å›å€¼æ˜¯ Map ï¼Œåˆ™è½¬æ¢æˆ POJO å†è¿”å›ã€‚
  - ğŸ™‚ æ­¤å¤„çš„ Map åªæ˜¯ä¸¾ä¾‹å­ï¼Œå®é™…åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿˜æœ‰**ä¸€ç§**è½¬æ¢æ–¹å¼ã€‚ ï¼ˆ**é€æ˜**ï¼‰

æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š

![æµç¨‹](http://static.iocoder.cn/images/Dubbo/2018_11_07/01.png)

## 2. ç¤ºä¾‹

**æœåŠ¡æä¾›è€…**

åœ¨ [`dubbo-generic-service-demo-provider`](https://github.com/YunaiV/dubbo/tree/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-demo/dubbo-generic-reference-demo-provider) ï¼Œæˆ‘ä»¬æä¾›äº†ä¾‹å­ã€‚æˆ‘ä»¬æŒ‘**é‡ç‚¹**çš„åœ°æ–¹è¯´ã€‚

â‘  åœ¨ Java ä»£ç ä¸­å®ç° GenericService æ¥å£ï¼š

```
public class DemoServiceImpl implements GenericService {

    @Override
    public Object $invoke(String method, String[] parameterTypes, Object[] args) throws GenericException {
        if ("sayHello".equals(method)) {
            return "Welcome " + args[0];
        }
        return "unknown method";
    }

}
```

â‘¡ åœ¨ Spring é…ç½®ç”³æ˜æœåŠ¡çš„å®ç°ï¼š

```
<bean id="demoService" class="com.alibaba.dubbo.demo.provider.DemoServiceImpl" />

<dubbo:service interface="com.alibaba.dubbo.demo.DemoService" ref="demoService" generic="true" />
```

- `interface` é…ç½®é¡¹ï¼Œæ³›åŒ–å®ç°çš„æœåŠ¡æ¥å£ã€‚é€šè¿‡è¯¥é…ç½®ï¼ŒæœåŠ¡æ¶ˆè´¹è€…ï¼Œå¯ä»¥ä»æ³¨å†Œä¸­å¿ƒï¼Œè·å–åˆ°æ‰€æœ‰**è¯¥æœåŠ¡**çš„æä¾›æ–¹çš„åœ°å€ï¼ŒåŒ…æ‹¬æ³›åŒ–å®ç°çš„è¯¥æœåŠ¡çš„åœ°å€ã€‚

- ```
  generic
  ```

   

  é…ç½®é¡¹ï¼Œé»˜è®¤ä¸º

   

  ```
  false
  ```

   

  ï¼Œä¸ä½¿ç”¨é…ç½®é¡¹ã€‚ç›®å‰æœ‰

  ä¸¤ç§é…ç½®é¡¹çš„å€¼

  ï¼Œå¼€å¯æ³›åŒ–å®ç°çš„åŠŸèƒ½ï¼š

  - `generic=true` ï¼Œä½¿ç”¨ [`com.alibaba.dubbo.common.utils.PojoUtils`](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/PojoUtils.java) ï¼Œå®ç° `POJO <=> Map` çš„äº’è½¬ã€‚
  - `generic=bean` ï¼Œä½¿ç”¨ [`com.alibaba.dubbo.common.beanutil.JavaBeanSerializeUtil`](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/beanutil/JavaBeanSerializeUtil.java) ï¼Œå®ç° `POJO <=> JavaBeanDescriptor` çš„äº’è½¬ã€‚
  - ä¸å­˜åœ¨ `generic=nativejava` é…ç½®é¡¹ã€‚

**æœåŠ¡æ¶ˆè´¹è€…**

åœ¨ [`dubbo-generic-service-demo-consumer`](https://github.com/YunaiV/dubbo/tree/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-demo/dubbo-generic-service-demo-consumer) ï¼Œæˆ‘ä»¬æä¾›äº†ä¾‹å­ã€‚æˆ‘ä»¬æŒ‘**é‡ç‚¹**çš„åœ°æ–¹è¯´ã€‚

è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼š

```
DemoService demoService = (DemoService) context.getBean("demoService"); // get remote service proxy
Object result = demoService.say01("NIHAO");
System.out.println("result: " + result);
```

- å’Œæˆ‘ä»¬æ™®é€šçš„æœåŠ¡æ¶ˆè´¹è€…ï¼Œè°ƒç”¨æœåŠ¡æä¾›è€…ï¼Œ**ä¸€æ¨¡ä¸€æ ·**ï¼Œæ³¨æ„ï¼Œæ˜¯**ä¸€æ¨¡ä¸€æ ·**ã€‚

## 3. æœåŠ¡æ¶ˆè´¹è€… GenericImplFilter

[`com.alibaba.dubbo.rpc.filter.GenericImplFilter`](https://github.com/YunaiV/dubbo/blob/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/filter/GenericImplFilter.java) ï¼Œå®ç° Filter æ¥å£ï¼ŒæœåŠ¡æ¶ˆè´¹è€…çš„æ³›åŒ–è°ƒç”¨è¿‡æ»¤å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
  1: @Activate(group = Constants.CONSUMER, value = Constants.GENERIC_KEY, order = 20000)
  2: public class GenericImplFilter implements Filter {
  3: 
  4:     private static final Logger logger = LoggerFactory.getLogger(GenericImplFilter.class);
  5: 
  6:     private static final Class<?>[] GENERIC_PARAMETER_TYPES = new Class<?>[]{String.class, String[].class, Object[].class};
  7: 
  8:     @Override
  9:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
 10:         // è·å¾— `generic` é…ç½®é¡¹
 11:         String generic = invoker.getUrl().getParameter(Constants.GENERIC_KEY);
 12: 
 13:         // æ³›åŒ–å®ç°çš„è°ƒç”¨
 14:         if (ProtocolUtils.isGeneric(generic)
 15:                 && !Constants.$INVOKE.equals(invocation.getMethodName())
 16:                 && invocation instanceof RpcInvocation) {
 17:             RpcInvocation invocation2 = (RpcInvocation) invocation;
 18:             String methodName = invocation2.getMethodName();
 19:             Class<?>[] parameterTypes = invocation2.getParameterTypes();
 20:             Object[] arguments = invocation2.getArguments();
 21: 
 22:             // è·å¾—å‚æ•°ç±»å‹æ•°ç»„
 23:             String[] types = new String[parameterTypes.length];
 24:             for (int i = 0; i < parameterTypes.length; i++) {
 25:                 types[i] = ReflectUtils.getName(parameterTypes[i]);
 26:             }
 27: 
 28:             Object[] args;
 29:             // ã€ç¬¬ä¸€æ­¥ã€‘`bean` ï¼Œåºåˆ—åŒ–å‚æ•°ï¼Œæ–¹æ³•å‚æ•° => JavaBeanDescriptor
 30:             if (ProtocolUtils.isBeanGenericSerialization(generic)) {
 31:                 args = new Object[arguments.length];
 32:                 for (int i = 0; i < arguments.length; i++) {
 33:                     args[i] = JavaBeanSerializeUtil.serialize(arguments[i], JavaBeanAccessor.METHOD);
 34:                 }
 35:             // ã€ç¬¬ä¸€æ­¥ã€‘`true` ï¼Œåºåˆ—åŒ–å‚æ•°ï¼Œä»…æœ‰ Map => POJO
 36:             } else {
 37:                 args = PojoUtils.generalize(arguments);
 38:             }
 39: 
 40:             // ä¿®æ”¹è°ƒç”¨æ–¹æ³•çš„åå­—ä¸º `$invoke`
 41:             invocation2.setMethodName(Constants.$INVOKE);
 42:             // è®¾ç½®è°ƒç”¨æ–¹æ³•çš„å‚æ•°ç±»å‹ä¸º `GENERIC_PARAMETER_TYPES`
 43:             invocation2.setParameterTypes(GENERIC_PARAMETER_TYPES);
 44:             // è®¾ç½®è°ƒç”¨æ–¹æ³•çš„å‚æ•°æ•°ç»„ï¼Œåˆ†åˆ«ä¸ºæ–¹æ³•åã€å‚æ•°ç±»å‹æ•°ç»„ã€å‚æ•°æ•°ç»„
 45:             invocation2.setArguments(new Object[]{methodName, types, args});
 46: 
 47:             // ã€ç¬¬äºŒæ­¥ã€‘RPC è°ƒç”¨
 48:             Result result = invoker.invoke(invocation2);
 49: 
 50:             // ã€ç¬¬ä¸‰æ­¥ã€‘ååºåˆ—åŒ–æ­£å¸¸ç»“æœ
 51:             if (!result.hasException()) {
 52:                 Object value = result.getValue();
 53:                 try {
 54:                     // ã€ç¬¬ä¸‰æ­¥ã€‘`bean` ï¼Œååºåˆ—åŒ–ç»“æœï¼ŒJavaBeanDescriptor => ç»“æœ
 55:                     if (ProtocolUtils.isBeanGenericSerialization(generic)) {
 56:                         if (value == null) {
 57:                             return new RpcResult(null);
 58:                         } else if (value instanceof JavaBeanDescriptor) {
 59:                             return new RpcResult(JavaBeanSerializeUtil.deserialize((JavaBeanDescriptor) value));
 60:                         } else { // å¿…é¡»æ˜¯ JavaBeanDescriptor è¿”å›
 61:                             throw new RpcException(
 62:                                     new StringBuilder(64)
 63:                                             .append("The type of result value is ")
 64:                                             .append(value.getClass().getName())
 65:                                             .append(" other than ")
 66:                                             .append(JavaBeanDescriptor.class.getName())
 67:                                             .append(", and the result is ")
 68:                                             .append(value).toString());
 69:                         }
 70:                     } else {
 71:                         // è·å¾—å¯¹åº”çš„æ–¹æ³• Method å¯¹è±¡
 72:                         Method method = invoker.getInterface().getMethod(methodName, parameterTypes);
 73:                         //ã€ç¬¬ä¸‰æ­¥ã€‘`true` ï¼Œååºåˆ—åŒ–ç»“æœï¼Œä»…æœ‰ Map => POJO
 74:                         return new RpcResult(PojoUtils.realize(value, method.getReturnType(), method.getGenericReturnType()));
 75:                     }
 76:                 } catch (NoSuchMethodException e) {
 77:                     throw new RpcException(e.getMessage(), e);
 78:                 }
 79:             // ã€ç¬¬ä¸‰æ­¥ã€‘ååºåˆ—åŒ–å¼‚å¸¸ç»“æœ
 80:             } else if (result.getException() instanceof GenericException) {
 81:                 GenericException exception = (GenericException) result.getException();
 82:                 try {
 83:                     String className = exception.getExceptionClass();
 84:                     Class<?> clazz = ReflectUtils.forName(className);
 85:                     Throwable targetException = null;
 86:                     Throwable lastException = null;
 87:                     // åˆ›å»ºåŸå§‹å¼‚å¸¸
 88:                     try {
 89:                         targetException = (Throwable) clazz.newInstance();
 90:                     } catch (Throwable e) {
 91:                         lastException = e;
 92:                         for (Constructor<?> constructor : clazz.getConstructors()) {
 93:                             try {
 94:                                 targetException = (Throwable) constructor.newInstance(new Object[constructor.getParameterTypes().length]);
 95:                                 break;
 96:                             } catch (Throwable e1) {
 97:                                 lastException = e1;
 98:                             }
 99:                         }
100:                     }
101:                     // è®¾ç½®å¼‚å¸¸çš„æ˜ç»†
102:                     if (targetException != null) {
103:                         try {
104:                             Field field = Throwable.class.getDeclaredField("detailMessage");
105:                             if (!field.isAccessible()) {
106:                                 field.setAccessible(true);
107:                             }
108:                             field.set(targetException, exception.getExceptionMessage());
109:                         } catch (Throwable e) {
110:                             logger.warn(e.getMessage(), e);
111:                         }
112:                         // åˆ›å»ºæ–°çš„å¼‚å¸¸ RpcResult å¯¹è±¡
113:                         result = new RpcResult(targetException);
114:                     // åˆ›å»ºåŸå§‹å¼‚å¸¸å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
115:                     } else if (lastException != null) {
116:                         throw lastException;
117:                     }
118:                 } catch (Throwable e) { // è‹¥å‘ç”Ÿå¼‚å¸¸ï¼ŒåŒ…è£…æˆ RpcException å¼‚å¸¸ï¼ŒæŠ›å‡ºã€‚
119:                     throw new RpcException("Can not deserialize exception " + exception.getExceptionClass() + ", message: " + exception.getExceptionMessage(), e);
120:                 }
121:             }
122:             // è¿”å› RpcResult ç»“æœ
123:             return result;
124:         }
125: 
126:         // çœç•¥ä»£ç ....æ³›åŒ–å¼•ç”¨çš„è°ƒç”¨
127: 
128:          // æ™®é€šè°ƒç”¨
129:         return invoker.invoke(invocation);
130:     }
131: 
132:     // ... çœç•¥ getting/setting çš„æ–¹æ³•
133: 
134: }
```

- æ•´ä½“ï¼Œå’Œ**æœåŠ¡æä¾›è€…**çš„ GenericFilter æœ‰ä¸€äº›**ç±»ä¼¼**ã€‚
- ä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œ**è‡ªåŠ¨åŠ è½½**ï¼Œä»…é™**æœåŠ¡æ¶ˆè´¹è€…**ï¼Œå¹¶ä¸”æœ‰ `generic` é…ç½®é¡¹ã€‚
- ç¬¬ 126 è¡Œï¼šçœç•¥**æ³›åŒ–å¼•ç”¨**çš„è°ƒç”¨ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” è°ƒç”¨ç‰¹æ€§ï¼ˆäºŒï¼‰ä¹‹æ³›åŒ–å¼•ç”¨ã€‹](http://svip.iocoder.cn/Dubbo/rpc-feature-generic-reference) ä¸­ï¼Œè¯¦ç»†è§£æã€‚
- ç¬¬ 129 è¡Œï¼šè‹¥æ˜¯æ™®é€šè°ƒç”¨( **éæ³›åŒ–å¼•ç”¨çš„è°ƒç”¨** )ï¼Œè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼Œç»§ç»­è¿‡æ»¤é“¾çš„è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨ Service æœåŠ¡ã€‚
- ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ­£æˆ ğŸ‘‡ğŸ‘‡ğŸ‘‡
- ç¬¬ 14 è‡³ 16 è¡Œï¼šåˆ¤æ–­æ˜¯**æ³›åŒ–å®ç°**çš„è°ƒç”¨
- ç¬¬ 22 è‡³ 26 è¡Œï¼šè·å¾—**å‚æ•°ç±»å‹**æ•°ç»„ã€‚
- ========== ã€ç¬¬ä¸€æ­¥ï¼šåºåˆ—åŒ–å‚æ•°ã€‘ ==========
- ç¬¬ 29 è‡³ 34 è¡Œï¼š`generic = bean` ï¼Œè°ƒç”¨ `JavaBeanSerializeUtil#serialize(JavaBeanDescriptor)` æ–¹æ³•ï¼Œåºåˆ—åŒ–å‚æ•°ï¼Œå³ `æ–¹æ³•å‚æ•° => JavaBeanDescriptor` ã€‚
- ç¬¬ 35 è‡³ 38 è¡Œï¼š`generic = true` ï¼Œè°ƒç”¨ [`PojoUtils#generalize(Object[\] objs`](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/PojoUtils.java#L63-L69) æ–¹æ³•ï¼Œåºåˆ—åŒ–å‚æ•°ï¼Œä»…æœ‰ `POJO => Map` ã€‚
- ========== ã€ç¬¬äºŒæ­¥ï¼šRPC è°ƒç”¨ã€‘ ==========
- ç¬¬ 41 è¡Œï¼šè®¾ç½® RpcInvocation çš„æ–¹æ³•åä¸º `$invoke` ã€‚
- ç¬¬ 42 è¡Œï¼šè®¾ç½® RpcInvocation çš„æ–¹æ³•å‚æ•°ç±»å‹ä¸º `GENERIC_PARAMETER_TYPES` ã€‚
- ç¬¬ 43 è¡Œï¼šè®¾ç½® RpcInvocation çš„å‚æ•°æ•°ç»„ä¸º `methodName` `types` `types` ã€‚
- ç¬¬ 48 è¡Œï¼šé€šè¿‡å¦‚ä¸Šçš„ **RpcInvocation** çš„è®¾ç½®ï¼Œæˆ‘ä»¬è°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼Œå°±èƒ½ RPC è°ƒç”¨åˆ°**æ³›åŒ–å®ç°**çš„æœåŠ¡ã€‚
- ========== ã€ç¬¬ä¸‰æ­¥ï¼šååºåˆ—åŒ–**æ­£å¸¸**ç»“æœã€‘ ==========
- ç¬¬ 55 è‡³ 69 è¡Œï¼š`generic = bean` ï¼Œè°ƒç”¨ `JavaBeanSerializeUtil#serialize(JavaBeanDescriptor)` æ–¹æ³•ï¼Œååºåˆ—åŒ–ç»“æœï¼Œå³ `JavaBeanDescriptor => POJO` ã€‚
- ç¬¬ 71 è‡³ 74 è¡Œï¼š`generic = true` ï¼Œè°ƒç”¨ `PojoUtils#realize(pojo, type, genericType)` æ–¹æ³•ï¼Œååºåˆ—åŒ–ç»“æœï¼Œä»…æœ‰ `Map => POJO` ã€‚
- **æ³¨æ„**ï¼Œååºåˆ—å®Œï¼Œæ˜¯ä¼šåˆ›å»º**æ–°çš„** RpcResult ã€‚
- ========== ã€ç¬¬ä¸‰æ­¥ï¼šååºåˆ—åŒ–**å¼‚å¸¸**ç»“æœã€‘ ==========
- ç¬¬ 87 è‡³ 100 è¡Œï¼šæ ¹æ® GenericException å¼‚å¸¸ï¼Œåˆ›å»º**åŸå§‹**å¼‚å¸¸ `targetException` ã€‚
- ç¬¬ 101 è‡³ 111 è¡Œï¼šè®¾ç½®å¼‚å¸¸æ˜ç»†åˆ° `targetException` ã€‚
- ç¬¬ 113 è¡Œï¼šåˆ›å»º**æ–°çš„**å¼‚å¸¸ RpcResult å¯¹è±¡ã€‚
- ç¬¬ 114 è‡³ 117 è¡Œï¼šåˆ›å»ºåŸå§‹å¼‚å¸¸å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ `lastException` ã€‚