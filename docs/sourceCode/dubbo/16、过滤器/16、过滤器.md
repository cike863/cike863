# 1ã€ClassLoaderFilter

## 1. æ¦‚è¿°

ä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Dubbo çš„**è¿‡æ»¤å™¨**ä»¬ã€‚åœ¨ ProtocolFilterWrapper ä¸­ï¼Œåœ¨æœåŠ¡å¼•ç”¨å’Œæš´éœ²æ—¶ï¼Œ`#buildInvokerChain(invoker, key, group)` æ–¹æ³•ä¸­ï¼ŒåŸºäº Dubbo SPI **Active** æœºåˆ¶ï¼ŒåŠ è½½**åŒ¹é…**å¯¹åº”çš„è¿‡æ»¤å™¨æ•°ç»„ï¼Œåˆ›å»ºå¸¦æœ‰**è¿‡æ»¤å™¨é“¾çš„ Invoker å¯¹è±¡**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
/**
 * åˆ›å»ºå¸¦ Filter é“¾çš„ Invoker å¯¹è±¡
 *
 * @param invoker Invoker å¯¹è±¡
 * @param key è·å– URL å‚æ•°å
 * @param group åˆ†ç»„
 * @param <T> æ³›å‹
 * @return Invoker å¯¹è±¡
 */
private static <T> Invoker<T> buildInvokerChain(final Invoker<T> invoker, String key, String group) {
    Invoker<T> last = invoker;
    // è·å¾—è¿‡æ»¤å™¨æ•°ç»„
    List<Filter> filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);
    // å€’åºå¾ªç¯ Filter ï¼Œåˆ›å»ºå¸¦ Filter é“¾çš„ Invoker å¯¹è±¡
    if (!filters.isEmpty()) {
        for (int i = filters.size() - 1; i >= 0; i--) {
            final Filter filter = filters.get(i);
            final Invoker<T> next = last;
            last = new Invoker<T>() {

                @Override
                public Class<T> getInterface() {
                    return invoker.getInterface();
                }

                @Override
                public URL getUrl() {
                    return invoker.getUrl();
                }

                @Override
                public boolean isAvailable() {
                    return invoker.isAvailable();
                }

                @Override
                public Result invoke(Invocation invocation) throws RpcException {
                    return filter.invoke(next, invocation);
                }

                @Override
                public void destroy() {
                    invoker.destroy();
                }

                @Override
                public String toString() {
                    return invoker.toString();
                }
            };
        }
    }
    return last;
}
```

- å…·ä½“çš„è¿‡æ»¤å™¨é“¾çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œåœ¨å‰é¢çš„ Dubbo RPC è°ƒç”¨ï¼Œå·²ç»åˆ†äº«ï¼Œè¿™é‡Œå°±ä¸é‡å¤è§£é‡Šå•¦ã€‚

æˆ‘ä»¬æŠŠæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…çš„è¿‡æ»¤å™¨ç»Ÿä¸€æ•´ç†å¦‚ä¸‹ï¼š

[![è¿‡æ»¤å™¨æ•´ç†](http://static.iocoder.cn/images/Dubbo/2018_11_12/01.png)](http://static.iocoder.cn/images/Dubbo/2018_11_12/01.png)è¿‡æ»¤å™¨æ•´ç†

- **é»„è‰²**éƒ¨åˆ†ï¼Œä»£è¡¨è¿‡æ»¤å™¨åœ¨æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…ä¸Šçš„é¡ºåºã€‚è‹¥ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæ— è¯¥è¿‡æ»¤å™¨ã€‚

- è“è‰²

  éƒ¨åˆ†ï¼ŒEchoFilter ç­‰ç­‰ï¼Œå·²ç»åœ¨å…¶ä»–æ–‡ç« é‡Œåˆ†äº«ã€‚

  - `dubbo-filter-cache` çš„ CacheFilter, `dubbo-filter-validation` çš„ ValidationFilter ï¼Œæœªç½—åˆ—åœ¨è¡¨æ ¼ä¸­ï¼Œä¹Ÿä¼šåœ¨å…¶ä»–æ–‡ç« é‡Œåˆ†äº«ã€‚

- **ç»¿è‰²**éƒ¨åˆ† ï¼ŒCompatibleFilter ç­‰ç­‰ï¼Œç›®å‰æœªå¼€å¯ Dubbo SPI `@Adaptive` æ³¨è§£ï¼Œæˆ‘ä»¬å°±ä¸å†™äº†ã€‚

æœ¬æ–‡åˆ†äº« ClassLoaderFilter ã€‚åç»­çš„æ–‡ç« ï¼Œä¹Ÿä¼šæ˜¯æ¯ç¯‡æ–‡ç« åˆ†äº« 1-2 ä¸ªè¿‡æ»¤å™¨ï¼Œæ ¹æ®å®é™…ç”¨é€”çš„æƒ…å†µã€‚

## 2. Filter

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ ¸å¿ƒæµç¨‹ä¸€è§ˆã€‹ã€Œ4.4 Filterã€](http://svip.iocoder.cn/Dubbo/implementation-intro/?self) ä¸­ï¼Œå·²ç»è¯¦ç»†åˆ†äº«ã€‚

## 3. ClassLoaderFilter

[`com.alibaba.dubbo.rpc.filter.ClassLoaderFilter`](https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/filter/ClassLoaderFilter.java) ï¼Œå®ç° Filter æ¥å£ï¼Œç±»åŠ è½½å™¨åˆ‡æ¢è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: @Activate(group = Constants.PROVIDER, order = -30000)
 2: public class ClassLoaderFilter implements Filter {
 3: 
 4:     @Override
 5:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
 6:         // è·å¾—åŸæ¥çš„ç±»åŠ è½½å™¨
 7:         ClassLoader ocl = Thread.currentThread().getContextClassLoader();
 8:         // åˆ‡æ¢å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸ºæœåŠ¡æ¥å£çš„ç±»åŠ è½½å™¨
 9:         Thread.currentThread().setContextClassLoader(invoker.getInterface().getClassLoader());
10:         // æœåŠ¡è°ƒç”¨
11:         try {
12:             return invoker.invoke(invocation);
13:         } finally {
14:             // åˆ‡æ¢å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸ºåŸæ¥çš„ç±»åŠ è½½å™¨
15:             Thread.currentThread().setContextClassLoader(ocl);
16:         }
17:     }
18: 
19: }
```

- ç¬¬ 7 è¡Œï¼šè°ƒç”¨ `Thread#getContextClassLoader()` æ–¹æ³•ï¼Œè·å¾—**åŸæ¥çš„**ç±»åŠ è½½å™¨ã€‚
- ç¬¬ 9 è¡Œï¼šè°ƒç”¨ `Thread#setContextClassLoader(ClassLoader)` æ–¹æ³•ï¼Œ**åˆ‡æ¢**å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸º**æœåŠ¡æ¥å£çš„**ç±»åŠ è½½å™¨ã€‚
- ç¬¬ 12 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚
- ç¬¬ 15 è¡Œï¼šè°ƒç”¨ `Thread#setContextClassLoader(ClassLoader)` æ–¹æ³•ï¼Œ**åˆ‡æ¢**å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸º**åŸæ¥çš„**ç±»åŠ è½½å™¨ã€‚

ç¬”è€…çœ‹åˆ°è¿™ä¸ªè¿‡æ»¤å™¨ï¼Œè¡¨ç¤ºä¸€è„¸æ‡µé€¼ï¼Œäºæ˜¯å¼€å§‹ Google æ¢ç´¢ä¹‹è·¯ã€‚

1ã€äºæ˜¯æœåˆ° [ã€ŠISSUE#1406ï¼šclassloaderFilterã€‹](https://github.com/apache/incubator-dubbo/issues/1406) ï¼Œå†…å®¹å¦‚ä¸‹ï¼š[![ISSUE#1406](http://static.iocoder.cn/images/Dubbo/2018_11_12/02.png)](http://static.iocoder.cn/images/Dubbo/2018_11_12/02.png)ISSUE#1406

ä½¿ç”¨æˆ‘å¤§æœ‰é“è¯å…¸ç¿»è¯‘ï¼š

> åœ¨è®¾è®¡ç›®çš„ä¸­ï¼Œåˆ‡æ¢åˆ°åŠ è½½äº†æ¥å£å®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œä»¥ä¾¿å®ç°ä¸ç›¸åŒçš„ç±»åŠ è½½å™¨ä¸Šä¸‹æ–‡ä¸€èµ·å·¥ä½œã€‚

2ã€é‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹ä¼šæœ‰å¤šä¸ª ClassLoader çš„æƒ…å†µå‘¢ï¼Ÿå†äºæ˜¯æœåˆ° [ã€ŠISSUE#178ï¼šé¡¹ç›®æœ‰å¤šä¸ªClassLoadæ—¶ä½¿ç”¨dubboå‡ºé”™ï¼›ã€‹](https://github.com/apache/incubator-dubbo/issues/178) ï¼Œå†…å®¹å¦‚ä¸‹ï¼š[![ISSUE#178](http://static.iocoder.cn/images/Dubbo/2018_11_12/03.png)](http://static.iocoder.cn/images/Dubbo/2018_11_12/03.png)ISSUE#178

å¼€å§‹æ£€ç´¢ **pf4j** æ˜¯ä»€ä¹ˆä¸œä¸œï¼Ÿ

> FROM [ã€ŠJava çš„æ’ä»¶æ¡†æ¶ PF4Jã€‹](https://www.oschina.net/p/pf4j)
>
> PF4J æ˜¯ä¸€ä¸ª Java çš„æ’ä»¶æ¡†æ¶ï¼Œä¸ºç¬¬ä¸‰æ–¹æä¾›åº”ç”¨æ‰©å±•çš„æ¸ é“ã€‚ä½¿ç”¨ PF4J ä½ å¯ä»¥è½»æ¾å°†ä¸€ä¸ªæ™®é€šçš„ Java åº”ç”¨è½¬æˆä¸€ä¸ªæ¨¡å—åŒ–çš„åº”ç”¨ã€‚PF4J æœ¬èº«éå¸¸è½»é‡çº§ï¼Œåªæœ‰ 50KB å·¦å³ï¼Œç›®å‰åªä¾èµ–äº† slf4jã€‚[Gitblit](https://www.oschina.net/p/gitblit) é¡¹ç›®ä½¿ç”¨çš„å°±æ˜¯ PF4J è¿›è¡Œæ’ä»¶ç®¡ç†ã€‚

ğŸ™‚ çœ‹åˆ°æ­¤å¤„ï¼Œç¬”è€…å·²ç»è¿›å…¥äº†äº‘é‡Œå’Œé›¾é‡Œã€‚æ‰€ä»¥ï¼Œæˆ‘ä»…ä»…æ˜¯æŠ›ä¸ªç –ï¼Œæš‚æ—¶è¿˜æ²¡å»æµ‹è¯•ã€‚å†æ‰€ä»¥ï¼Œèƒ–å‹å¦‚æœæ„Ÿå…´è¶£ï¼Œå¯ä»¥è‡ªå·±å»ç ”ç©¶ä¸‹ä¸‹ã€‚æˆ‘çš„çŒœæµ‹æ˜¯ï¼Œä½¿ç”¨ PF4J åŠ è½½ä¸åŒçš„æœåŠ¡å®ç°ç±»çš„ Jar ï¼Œä¸åŒçš„ Jar çš„ç±»åŠ è½½å™¨ä¸åŒã€‚

æœ‰ç†Ÿæ‚‰è¿™å—çš„èƒ–å‹ï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œè¯·ç«‹å³æ–§æ­£æˆ‘ã€‚å“ˆå“ˆå“ˆã€‚

# 2ã€ContextFilter

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº« RpcContext ç›¸å…³è¿‡æ»¤å™¨ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªï¼š

- ConsumerContextFilter ï¼šåœ¨æœåŠ¡**æ¶ˆè´¹è€…**ä¸­ä½¿ç”¨ï¼Œè´Ÿè´£**å‘èµ·**è°ƒç”¨æ—¶ï¼Œåˆå§‹åŒ– RpcContext ã€‚
- ContextFilter ï¼šåœ¨æœåŠ¡**æä¾›è€…**ä¸­ä½¿ç”¨ï¼Œè´Ÿè´£**è¢«**è°ƒç”¨æ—¶ï¼Œåˆå§‹åŒ– RpcContext ã€‚

## 2. RpcContext

RpcContextï¼Œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/context.html) ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

> ä¸Šä¸‹æ–‡ä¸­å­˜æ”¾çš„æ˜¯å½“å‰è°ƒç”¨è¿‡ç¨‹ä¸­æ‰€éœ€çš„ç¯å¢ƒä¿¡æ¯ã€‚æ‰€æœ‰é…ç½®ä¿¡æ¯éƒ½å°†è½¬æ¢ä¸º URL çš„å‚æ•°ï¼Œå‚è§ [schema é…ç½®å‚è€ƒæ‰‹å†Œ](http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html) ä¸­çš„å¯¹åº”URLå‚æ•°ä¸€åˆ—ã€‚
>
> RpcContext æ˜¯ä¸€ä¸ª ThreadLocal çš„ä¸´æ—¶çŠ¶æ€è®°å½•å™¨ï¼Œå½“æ¥æ”¶åˆ° RPC è¯·æ±‚ï¼Œæˆ–å‘èµ· RPC è¯·æ±‚æ—¶ï¼ŒRpcContext çš„çŠ¶æ€éƒ½ä¼šå˜åŒ–ã€‚æ¯”å¦‚ï¼šA è°ƒ Bï¼ŒB å†è°ƒ Cï¼Œåˆ™ B æœºå™¨ä¸Šï¼Œ
>
> - åœ¨ B è°ƒ C ä¹‹å‰ï¼ŒRpcContext è®°å½•çš„æ˜¯ A è°ƒ B çš„ä¿¡æ¯ï¼Œ
> - åœ¨ B è°ƒ C ä¹‹åï¼ŒRpcContext è®°å½•çš„æ˜¯ B è°ƒ C çš„ä¿¡æ¯ã€‚

- RpcContext åœ¨è°ƒç”¨æ—¶çš„çŠ¶æ€å˜åŒ–ï¼Œæœ‰ç‚¹ç»•ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹å…·ä½“çš„ Filter å®ç°ï¼Œå°±ç›¸å¯¹å®¹æ˜“æ˜ç™½åˆ—ã€‚

[`com.alibaba.dubbo.rpc.RpcContext`](http://svip.iocoder.cn/Dubbo/filter-context-filter/TODO) ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
/**
 * RpcContext çº¿ç¨‹å˜é‡
 */
private static final ThreadLocal<RpcContext> LOCAL = new ThreadLocal<RpcContext>() {

    @Override
    protected RpcContext initialValue() {
        return new RpcContext();
    }

};

/**
 * éšå¼å‚æ•°é›†åˆ
 */
private final Map<String, String> attachments = new HashMap<String, String>();
// å®é™…æœªä½¿ç”¨
private final Map<String, Object> values = new HashMap<String, Object>();
/**
 * å¼‚æ­¥è°ƒç”¨ Future
 */
private Future<?> future;
/**
 * å¯è°ƒç”¨æœåŠ¡çš„ URL å¯¹è±¡é›†åˆ
 */
private List<URL> urls;
/**
 * è°ƒç”¨æœåŠ¡çš„ URL å¯¹è±¡
 */
private URL url;
/**
 * æ–¹æ³•å
 */
private String methodName;
/**
 * å‚æ•°ç±»å‹æ•°ç»„
 */
private Class<?>[] parameterTypes;
/**
 * å‚æ•°å€¼æ•°ç»„
 */
private Object[] arguments;
/**
 * æœåŠ¡æ¶ˆè´¹è€…åœ°å€
 */
private InetSocketAddress localAddress;
/**
 * æœåŠ¡æä¾›è€…åœ°å€
 */
private InetSocketAddress remoteAddress;

@Deprecated // DUBBO-325 åºŸå¼ƒçš„ï¼Œä½¿ç”¨ urls å±æ€§æ›¿ä»£
private List<Invoker<?>> invokers;
@Deprecated // DUBBO-325 åºŸå¼ƒçš„ï¼Œä½¿ç”¨ url å±æ€§æ›¿ä»£
private Invoker<?> invoker;
@Deprecated // DUBBO-325 åºŸå¼ƒçš„ï¼Œä½¿ç”¨ methodNameã€parameterTypesã€arguments å±æ€§æ›¿ä»£
private Invocation invocation;

/**
 * è¯·æ±‚
 *
 * ä¾‹å¦‚ï¼Œåœ¨ RestProtocol
 */
private Object request;
/**
 * å“åº”
 *
 * ä¾‹å¦‚ï¼Œåœ¨ RestProtocol
 */
private Object response;
 
 // ... çœç•¥ä¸€äº›
```

- `LOCAL` **é™æ€**å±æ€§ï¼ŒRpcContext çº¿ç¨‹å˜é‡ã€‚åˆå§‹è·å¾—æ—¶ï¼Œè¿”å›æ–°çš„ RpcContext å¯¹è±¡ã€‚

- ```
  attachments
  ```

   

  å±æ€§ï¼Œéšå¼å‚æ•°é›†åˆã€‚

  - ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ PRC è°ƒç”¨å‰ï¼Œå¯åœ¨ä¸šåŠ¡ä»£ç é‡Œæ·»åŠ ä¸€äº›æƒ³è¦ä¼ é€’ç»™æœåŠ¡çš„å‚æ•°åˆ°è¯¥å±æ€§
  - åˆä¾‹å¦‚ï¼Œåœ¨åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªæ—¶ï¼Œæ·»åŠ é“¾è·¯è¿½è¸ª**ç¼–å·**åˆ°è¯¥å±æ€§ç§ã€‚
  - [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” éšå¼å‚æ•°ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/attachment.html)

- `future` å±æ€§ï¼Œå¼‚æ­¥è°ƒç”¨ Future å¯¹è±¡ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡è°ƒç”¨ï¼ˆä¸‰ï¼‰ä¹‹è¿œç¨‹è°ƒç”¨ï¼ˆDubboï¼‰ã€3ã€‘å¼‚æ­¥è°ƒç”¨ã€‹](http://svip.iocoder.cn/Dubbo/rpc-dubbo-3-async/?self) æœ‰è¯¦ç»†ä½¿ç”¨çš„ä»£ç åˆ†äº«ã€‚

- ã€æ›¿ä»£

   

  ```
  invokers
  ```

   

  å±æ€§ã€‘

  - `urls` å±æ€§ï¼Œ**å¯è°ƒç”¨**çš„æœåŠ¡çš„ URL å¯¹è±¡é›†åˆï¼Œåœ¨é›†ç¾¤å®¹é”™æ¨¡å—å®ç°ã€‚

- ã€æ›¿ä»£

   

  ```
  invoker
  ```

   

  å±æ€§ã€‘

  - `url` å±æ€§ï¼Œ**è°ƒç”¨**çš„æœåŠ¡çš„ URL å¯¹è±¡ã€‚

- ã€æ›¿ä»£

   

  ```
  invocation
  ```

   

  å±æ€§ã€‘

  - `methodName` å±æ€§ï¼Œ**è°ƒç”¨**çš„æ–¹æ³•åã€‚
  - `parameterTypes` å±æ€§ï¼Œ**è°ƒç”¨**çš„å‚æ•°ç±»å‹æ•°ç»„ã€‚
  - `arguments` å±æ€§ï¼Œ**è°ƒç”¨**çš„å‚æ•°å€¼æ•°ç»„ã€‚

- åœ°å€

  - `localAddress` å±æ€§ï¼Œ æœåŠ¡æ¶ˆè´¹è€…åœ°å€ã€‚
  - `remoteAddress` å±æ€§ï¼ŒæœåŠ¡æä¾›è€…åœ°å€ã€‚

- ```
  request
  ```

   

  ```
  response
  ```

   

  å±æ€§ï¼Œè¯·æ±‚å’Œå“åº”ã€‚ä¾‹å¦‚ï¼Œåœ¨ RestProtocol ä¸­ä½¿ç”¨ï¼Œä»£è¡¨ HTTP Request å’Œ Response å¯¹è±¡ï¼Œåœ¨ RpcContextFilter ä¸­è®¾ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

  ![RpcContextFilter](http://static.iocoder.cn/images/Dubbo/2018_11_13/01.png)

  RpcContextFilter

  - æˆ‘ä»¬å¯ä»¥çœ‹åˆ° `request` `response` çš„ç±»å‹æ˜¯ Object ç±»ã€‚é€šè¿‡è¿™ç§å½¢å¼ï¼Œå¯ä»¥ä¸ä»…ä»…é€‚ç”¨äº HTTP çš„åœºæ™¯ã€‚

RpcContext ä¸­ï¼Œæœ‰å¾ˆå¤šæ–¹æ³•ï¼Œæ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹å™¢ã€‚

## 3. ConsumerContextFilter

`com.alibaba.dubbo.rpc.filter.ConsumerContextFilter` ï¼Œå®ç° Filter æ¥å£ï¼Œ**æœåŠ¡æ¶ˆè´¹è€…**çš„ ContextFilter å®ç°ç±»ã€‚

```
 1: @Activate(group = Constants.CONSUMER, order = -10000)
 2: public class ConsumerContextFilter implements Filter {
 3: 
 4:     @Override
 5:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
 6:         // è®¾ç½® RpcContext å¯¹è±¡
 7:         RpcContext.getContext()
 8:                 .setInvoker(invoker)
 9:                 .setInvocation(invocation)
10:                 .setLocalAddress(NetUtils.getLocalHost(), 0) // æœ¬åœ°åœ°å€
11:                 .setRemoteAddress(invoker.getUrl().getHost(), invoker.getUrl().getPort()); // è¿œç¨‹åœ°å€
12:         // è®¾ç½® RpcInvocation å¯¹è±¡çš„ `invoker` å±æ€§
13:         if (invocation instanceof RpcInvocation) {
14:             ((RpcInvocation) invocation).setInvoker(invoker);
15:         }
16:         // æœåŠ¡è°ƒç”¨
17:         try {
18:             return invoker.invoke(invocation);
19:         } finally {
20:             // æ¸…ç†éšå¼å‚æ•°é›†åˆ
21:             RpcContext.getContext().clearAttachments();
22:         }
23:     }
24: 
25: }
```

- ç¬¬ 6 è‡³ 11 è¡Œï¼šè®¾ç½® RpcContext å¯¹è±¡ã€‚

- ç¬¬ 12 è‡³ 15 è¡Œï¼šè®¾ç½® RpcInvocation å¯¹è±¡çš„ `invoker` å±æ€§ã€‚è¯¥å±æ€§ï¼Œç›®å‰ä½¿ç”¨åœ¨å¦‚ä¸‹å›¾çš„åœºæ™¯ï¼š[![RpcInvocation](http://static.iocoder.cn/images/Dubbo/2018_11_13/02.png)](http://static.iocoder.cn/images/Dubbo/2018_11_13/02.png)RpcInvocation

- ç¬¬ 18 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 19 è‡³ 22 è¡Œï¼šè°ƒç”¨ `RpcContext#clearAttachments()` æ–¹æ³•ï¼Œæ¸…ç†éšå¼å‚æ•°é›†åˆã€‚æ‰€ä»¥ï¼Œ**æ¯æ¬¡**ï¼ˆæ³¨æ„ï¼Œæ¯æ¬¡ï¼ï¼ï¼ï¼‰æœåŠ¡è°ƒç”¨å®Œæˆï¼ŒRpcContext è®¾ç½®çš„éšå¼å‚æ•°**éƒ½ä¼šè¢«æ¸…ç†**ï¼ä»£ç å¦‚ä¸‹ï¼š

  ```
  public void clearAttachments() {
      this.attachments.clear();
  }
  ```

ğŸ˜ˆ çœ‹åˆ°æ­¤å¤„ï¼Œ`RpcContext.attachments` å±æ€§ï¼Œæ˜¯å¦‚ä½•ä¼ é€’ç»™è¢«è°ƒç”¨çš„æœåŠ¡çš„å‘¢ï¼Ÿç­”æ¡ˆåœ¨ä¸‹å›¾ï¼š[![é€ä¼ ](http://static.iocoder.cn/images/Dubbo/2018_11_13/03.png)](http://static.iocoder.cn/images/Dubbo/2018_11_13/03.png)é€ä¼ 

## 4. ContextFilter

`com.alibaba.dubbo.rpc.filter.ContextFilter` ï¼Œå®ç° Filter æ¥å£ï¼Œ**æœåŠ¡æä¾›è€…**çš„ ContextFilter å®ç°ç±»ã€‚

```
 1: @Activate(group = Constants.PROVIDER, order = -10000)
 2: public class ContextFilter implements Filter {
 3: 
 4:     @Override
 5:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
 6:         // åˆ›å»ºæ–°çš„ `attachments` é›†åˆï¼Œæ¸…ç†å…¬ç”¨çš„éšå¼å‚æ•°
 7:         Map<String, String> attachments = invocation.getAttachments();
 8:         if (attachments != null) {
 9:             attachments = new HashMap<String, String>(attachments);
10:             attachments.remove(Constants.PATH_KEY);
11:             attachments.remove(Constants.GROUP_KEY);
12:             attachments.remove(Constants.VERSION_KEY);
13:             attachments.remove(Constants.DUBBO_VERSION_KEY);
14:             attachments.remove(Constants.TOKEN_KEY);
15:             attachments.remove(Constants.TIMEOUT_KEY);
16:             attachments.remove(Constants.ASYNC_KEY); // Remove async property to avoid being passed to the following invoke chain.
17:                                                      // æ¸…ç©ºæ¶ˆè´¹ç«¯çš„å¼‚æ­¥å‚æ•°
18:         }
19:         // è®¾ç½® RpcContext å¯¹è±¡
20:         RpcContext.getContext()
21:                 .setInvoker(invoker)
22:                 .setInvocation(invocation)
23: //                .setAttachments(attachments)  // merged from dubbox
24:                 .setLocalAddress(invoker.getUrl().getHost(), invoker.getUrl().getPort());
25:         // mreged from dubbox
26:         // we may already added some attachments into RpcContext before this filter (e.g. in rest protocol)
27:         // åœ¨æ­¤è¿‡æ»¤å™¨(ä¾‹å¦‚reståè®®)ä¹‹å‰ï¼Œæˆ‘ä»¬å¯èƒ½å·²ç»åœ¨RpcContextä¸­æ·»åŠ äº†ä¸€äº›é™„ä»¶ã€‚
28:         if (attachments != null) {
29:             if (RpcContext.getContext().getAttachments() != null) {
30:                 RpcContext.getContext().getAttachments().putAll(attachments);
31:             } else {
32:                 RpcContext.getContext().setAttachments(attachments);
33:             }
34:         }
35:         // è®¾ç½® RpcInvocation å¯¹è±¡çš„ `invoker` å±æ€§
36:         if (invocation instanceof RpcInvocation) {
37:             ((RpcInvocation) invocation).setInvoker(invoker);
38:         }
39:         // æœåŠ¡è°ƒç”¨
40:         try {
41:             return invoker.invoke(invocation);
42:         } finally {
43:             // ç§»é™¤ä¸Šä¸‹æ–‡
44:             RpcContext.removeContext();
45:         }
46:     }
47: 
48: }
```

- ç¬¬ 6 è‡³ 18 è¡Œï¼šåˆ›å»ºæ–°çš„ `attachments` é›†åˆï¼Œå› ä¸ºè¦æ¸…ç†**å…¬ç”¨**çš„éšå¼å‚æ•°ã€‚è¯¥**å…¬ç”¨**çš„éšå¼å‚æ•°ï¼Œè®¾ç½®çš„åœ°æ–¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![RpcInvocation](http://static.iocoder.cn/images/Dubbo/2018_11_13/04.png)](http://static.iocoder.cn/images/Dubbo/2018_11_13/04.png)RpcInvocation

- ç¬¬ 19 è‡³ 24 è¡Œï¼šè®¾ç½® RpcContext å¯¹è±¡ã€‚

- ç¬¬ 25 è‡³ 34 è¡Œï¼šåœ¨æ­¤è¿‡æ»¤å™¨( ä¾‹å¦‚ RestProtocol çš„ RpcContextFilter )ä¹‹å‰ï¼Œæˆ‘ä»¬å¯èƒ½å·²ç»åœ¨ RpcContext ä¸­æ·»åŠ äº†ä¸€äº›éšå¼å‚æ•°ã€‚

- ç¬¬ 35 è‡³ 38 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 41 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 42 è‡³ 45 è¡Œï¼šè°ƒç”¨ `RpcContext#removeContext()` æ–¹æ³•ï¼Œç§»é™¤ä¸Šä¸‹æ–‡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  public static void removeContext() {
      LOCAL.remove();
  }
  ```

## 5. RpcContext.values

æˆ‘ä»¬åœ¨å›è¿‡å¤´æ¥çœ‹ `RpcContext.values` å±æ€§ã€‚ç›®å‰ Dubbo ä¸­ï¼Œ**å¹¶æœªä½¿ç”¨å®ƒ**ã€‚

ä»ä»£ç çœ‹ä¸‹æ¥ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æœ‰**å¤šæ¬¡** Dubbo è°ƒç”¨ï¼Œå…±äº«å‚æ•°ï¼Œå¹¶ä¸”ä¸è¢« ConsumerContextFilter æ¸…ç†éšå¼å‚æ•°ï¼Œç¬”è€…è§‰å¾—å¯ä»¥ä½¿ç”¨è¯¥ `values` å±æ€§ã€‚

å’Œ `value` å±æ€§ç›¸å…³çš„æ–¹æ³•å¦‚ä¸‹ï¼š

```
public Map<String, Object> get() {
    return values;
}

public RpcContext set(String key, Object value) {
    if (value == null) {
        values.remove(key);
    } else {
        values.put(key, value);
    }
    return this;
}   

public RpcContext remove(String key) {
    values.remove(key);
    return this;
} 

public Object get(String key) {
    return values.get(key);
}
```

å½“ç„¶ï¼Œå¦‚æœåŒæ—¶æˆ‘ä»¬å¸Œæœ›ä¸€äº›**é€šç”¨**çš„ `values` ä¼ é€’ç»™è¢«è°ƒç”¨çš„æœåŠ¡ï¼Œå¯ä»¥å®ç°ä¸€ä¸ª Filter ï¼Œç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š

```
RpcContext.getContext().setAttachment("key1", RpcContext.getContext().get("key2").toString());
```

æ©ï¼Œè¿˜æ˜¯å½“ç„¶ï¼Œåœ¨ä¸šåŠ¡ä»£ç é‡Œï¼Œä¹Ÿå¯ä»¥è¿™ä¹ˆè°ƒç”¨ã€‚ğŸ™‚

# 3ã€AccessLogFilter

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«è®°å½•**è®¿é—®æ—¥å¿—**çš„è¿‡æ»¤å™¨ AccessLogFilter ï¼Œéœ€è¦åœ¨ `<dubbo:protocol />` æˆ– `<dubbo:provider />` æˆ– `<dubbo:service />` ä¸­ï¼Œè®¾ç½® `"accesslog"` é…ç½®é¡¹**å¼€å¯**ã€‚æœ‰ä¸¤ç§é…ç½®é¡¹é€‰æ‹©ï¼š

- ã€é…ç½®æ–¹å¼ä¸€ã€‘ `true` ï¼šå°†å‘æ—¥å¿—ç»„ä»¶ logger ä¸­è¾“å‡ºè®¿é—®æ—¥å¿—ã€‚
- ã€é…ç½®æ–¹å¼äºŒã€‘è®¿é—®æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼šç›´æ¥æŠŠè®¿é—®æ—¥å¿—è¾“å‡ºåˆ°**æŒ‡å®š**æ–‡ä»¶ã€‚

## 2. AccessLogFilter

`com.alibaba.dubbo.rpc.filter.AccessLogFilter` ï¼Œå®ç° Filter æ¥å£ï¼Œè®°å½•**æœåŠ¡**çš„è®¿é—®æ—¥å¿—çš„è¿‡æ»¤å™¨å®ç°ç±»ã€‚

#### 2.1 æ„é€ æ–¹æ³•

```
/**
 * è®¿é—®æ—¥å¿—åœ¨ {@link LoggerFactory} ä¸­çš„æ—¥å¿—å
 */
private static final String ACCESS_LOG_KEY = "dubbo.accesslog";

/**
 * è®¿é—®æ—¥å¿—çš„æ–‡ä»¶åç¼€
 */
private static final String FILE_DATE_FORMAT = "yyyyMMdd";
/**
 * æ—¥å†çš„æ—¶é—´æ ¼å¼åŒ–
 */
private static final String MESSAGE_DATE_FORMAT = "yyyy-MM-dd HH:mm:ss";
/**
 * é˜Ÿåˆ—å¤§å°ï¼Œå³ {@link #logQueue} å€¼çš„å¤§å°
 */
private static final int LOG_MAX_BUFFER = 5000;
/**
 * æ—¥å¿—è¾“å‡ºé¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚ä»…é€‚ç”¨äº {@link #logFuture}
 */
private static final long LOG_OUTPUT_INTERVAL = 5000;

/**
 * æ—¥å¿—é˜Ÿåˆ—
 *
 * keyï¼šè®¿é—®æ—¥å¿—å
 * valueï¼šæ—¥å¿—é›†åˆ
 */
private final ConcurrentMap<String, Set<String>> logQueue = new ConcurrentHashMap<String, Set<String>>();
/**
 * å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± 
 */
private final ScheduledExecutorService logScheduled = Executors.newScheduledThreadPool(2, new NamedThreadFactory("Dubbo-Access-Log", true));
/**
 * è®°å½•æ—¥å¿—ä»»åŠ¡
 */
private volatile ScheduledFuture<?> logFuture = null;
```

- ã€é…ç½®æ–¹å¼ä¸€ã€‘
  - `ACCESS_LOG_KEY`
- ã€é…ç½®æ–¹å¼äºŒã€‘
  - æ–‡ä»¶ç›¸å…³ï¼š
    - `FILE_DATE_FORMAT`
    - `MESSAGE_DATE_FORMAT`
  - é˜Ÿåˆ—ç›¸å…³ï¼š
    - `logQueue`
    - `LOG_MAX_BUFFER`
  - ä»»åŠ¡ç›¸å…³ï¼š
    - `logScheduled`
    - `LOG_OUTPUT_INTERVAL`
    - `logFuture`
  - æ—¥å¿—æµå‘ä¸ºï¼š**logMessage** => é˜Ÿåˆ— => ä»»åŠ¡ => æ–‡ä»¶ã€‚

#### 2.2 invoke

```
 1: @Override
 2: @SuppressWarnings("Duplicates")
 3: public Result invoke(Invoker<?> invoker, Invocation inv) throws RpcException {
 4:     try {
 5:         // è®°å½•è®¿é—®æ—¥å¿—çš„æ–‡ä»¶å
 6:         String accesslog = invoker.getUrl().getParameter(Constants.ACCESS_LOG_KEY);
 7:         if (ConfigUtils.isNotEmpty(accesslog)) {
 8:             // æœåŠ¡çš„åå­—ã€ç‰ˆæœ¬ã€åˆ†ç»„ä¿¡æ¯
 9:             RpcContext context = RpcContext.getContext();
10:             String serviceName = invoker.getInterface().getName();
11:             String version = invoker.getUrl().getParameter(Constants.VERSION_KEY);
12:             String group = invoker.getUrl().getParameter(Constants.GROUP_KEY);
13:             // æ‹¼æ¥æ—¥å¿—å†…å®¹
14:             StringBuilder sn = new StringBuilder();
15:             sn.append("[").append(new SimpleDateFormat(MESSAGE_DATE_FORMAT).format(new Date())).append("] ") // æ—¶é—´
16:                     .append(context.getRemoteHost()).append(":").append(context.getRemotePort()) // è°ƒç”¨æ–¹åœ°å€
17:                     .append(" -> ").append(context.getLocalHost()).append(":").append(context.getLocalPort()) // æœ¬åœ°åœ°å€
18:                     .append(" - ");
19:             if (null != group && group.length() > 0) { // åˆ†ç»„
20:                 sn.append(group).append("/");
21:             }
22:             sn.append(serviceName); // æœåŠ¡å
23:             if (null != version && version.length() > 0) { // ç‰ˆæœ¬
24:                 sn.append(":").append(version);
25:             }
26:             sn.append(" ");
27:             sn.append(inv.getMethodName()); // æ–¹æ³•å
28:             sn.append("(");
29:             Class<?>[] types = inv.getParameterTypes(); // å‚æ•°ç±»å‹
30:             if (types != null && types.length > 0) {
31:                 boolean first = true;
32:                 for (Class<?> type : types) {
33:                     if (first) {
34:                         first = false;
35:                     } else {
36:                         sn.append(",");
37:                     }
38:                     sn.append(type.getName());
39:                 }
40:             }
41:             sn.append(") ");
42:             Object[] args = inv.getArguments(); // å‚æ•°å€¼
43:             if (args != null && args.length > 0) {
44:                 sn.append(JSON.toJSONString(args));
45:             }
46:             String msg = sn.toString();
47:             // ã€æ–¹å¼ä¸€ã€‘ä½¿ç”¨æ—¥å¿—ç»„ä»¶ï¼Œä¾‹å¦‚ Log4j ç­‰å†™
48:             if (ConfigUtils.isDefault(accesslog)) {
49:                 LoggerFactory.getLogger(ACCESS_LOG_KEY + "." + invoker.getInterface().getName()).info(msg);
50:             // ã€æ–¹å¼äºŒã€‘å¼‚æ­¥è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶
51:             } else {
52:                 log(accesslog, msg);
53:             }
54:         }
55:     } catch (Throwable t) {
56:         logger.warn("Exception in AcessLogFilter of service(" + invoker + " -> " + inv + ")", t);
57:     }
58:     // æœåŠ¡è°ƒç”¨
59:     return invoker.invoke(inv);
60: }
```

- ç¬¬ 6 è¡Œï¼šè·å¾—è®¿é—®æ—¥å¿—çš„**é…ç½®é¡¹**ã€‚

- ç¬¬ 8 è‡³ 12 è¡Œï¼šè·å¾—æœåŠ¡çš„åå­—ã€ç‰ˆæœ¬ã€åˆ†ç»„ä¿¡æ¯ã€‚

- ç¬¬ 13 è‡³ 46 è¡Œï¼šæ‹¼æ¥æ—¥å¿—çš„å†…å®¹ã€‚ä¾‹å­å¦‚ä¸‹ï¼š

  ```
  [2018-04-14 11:57:58] 192.168.3.17:57207 -> 192.168.3.17:20880 - com.alibaba.dubbo.demo.DemoService say01(java.lang.String) [null]
  ```

- ç¬¬ 47 è‡³ 49 è¡Œï¼šè°ƒç”¨ `ConfigUtils#isDefault(value)` æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä½¿ç”¨æ—¥å¿—ç»„ä»¶è®°å½•æ—¥å¿—ã€‚ä¾‹å¦‚ Log4J ç­‰ç­‰ã€‚è¯¦ç»†å‚è§ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æ—¥å¿—é€‚é…ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/logger-strategy.html) ã€‚

- ç¬¬ 50 è‡³ 53 è¡Œï¼šè°ƒç”¨ `#log(accesslog, logMessage)` æ–¹æ³•ï¼Œæ·»åŠ æ—¥å¿—å†…å®¹åˆ°æ—¥å¿—é˜Ÿåˆ—ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  /**
   * åˆå§‹åŒ–ä»»åŠ¡
   */
  private void init() {
      if (logFuture == null) {
          synchronized (logScheduled) {
              if (logFuture == null) { // åŒé‡é”ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
                  logFuture = logScheduled.scheduleWithFixedDelay(new LogTask(), LOG_OUTPUT_INTERVAL, LOG_OUTPUT_INTERVAL, TimeUnit.MILLISECONDS);
              }
          }
      }
  }
  
  /**
   * æ·»åŠ æ—¥å¿—å†…å®¹åˆ°æ—¥å¿—é˜Ÿåˆ—
   *
   * @param accesslog æ—¥å¿—æ–‡ä»¶
   * @param logmessage æ—¥å¿—å†…å®¹
   */
  private void log(String accesslog, String logmessage) {
      // åˆå§‹åŒ–
      init();
      // è·å¾—é˜Ÿåˆ—ï¼Œä»¥æ–‡ä»¶åä¸º Key
      Set<String> logSet = logQueue.get(accesslog);
      if (logSet == null) {
          logQueue.putIfAbsent(accesslog, new ConcurrentHashSet<String>());
          logSet = logQueue.get(accesslog);
      }
      // è‹¥æœªè¶…è¿‡é˜Ÿåˆ—å¤§å°ï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
      if (logSet.size() < LOG_MAX_BUFFER) {
          logSet.add(logmessage);
      }
  }
  ```

#### 2.3 LogTask

> LogTask æ˜¯ AccessLogFilter çš„å†…éƒ¨ç±»

```
 1: /**
 2:  * æ—¥å¿—ä»»åŠ¡
 3:  */
 4: private class LogTask implements Runnable {
 5: 
 6:     @Override
 7:     public void run() {
 8:         try {
 9:             if (logQueue.size() > 0) {
10:                 for (Map.Entry<String, Set<String>> entry : logQueue.entrySet()) {
11:                     try {
12:                         String accesslog = entry.getKey();
13:                         Set<String> logSet = entry.getValue();
14:                         // è·å¾—æ—¥å¿—æ–‡ä»¶
15:                         File file = new File(accesslog);
16:                         File dir = file.getParentFile();
17:                         if (null != dir && !dir.exists()) {
18:                             dir.mkdirs();
19:                         }
20:                         if (logger.isDebugEnabled()) {
21:                             logger.debug("Append log to " + accesslog);
22:                         }
23:                         // å½’æ¡£å†å²æ—¥å¿—æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š `accesslog` => `access.20181023`
24:                         if (file.exists()) {
25:                             String now = new SimpleDateFormat(FILE_DATE_FORMAT).format(new Date());
26:                             String last = new SimpleDateFormat(FILE_DATE_FORMAT).format(new Date(file.lastModified())); // æœ€åä¿®æ”¹æ—¶é—´
27:                             if (!now.equals(last)) {
28:                                 File archive = new File(file.getAbsolutePath() + "." + last);
29:                                 file.renameTo(archive);
30:                             }
31:                         }
32:                         // è¾“å‡ºæ—¥å¿—åˆ°æŒ‡å®šæ–‡ä»¶
33:                         FileWriter writer = new FileWriter(file, true);
34:                         try {
35:                             for (Iterator<String> iterator = logSet.iterator(); iterator.hasNext(); iterator.remove()) {
36:                                 writer.write(iterator.next()); // å†™å…¥ä¸€è¡Œæ—¥å¿—
37:                                 writer.write("\r\n"); // æ¢è¡Œ
38:                             }
39:                             writer.flush(); // åˆ·ç›˜
40:                         } finally {
41:                             writer.close(); // å…³é—­
42:                         }
43:                     } catch (Exception e) {
44:                         logger.error(e.getMessage(), e);
45:                     }
46:                 }
47:             }
48:         } catch (Exception e) {
49:             logger.error(e.getMessage(), e);
50:         }
51:     }
52: 
53: }
```

- ä» `#init()` æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒLogTask æ¯ 5000 ( `LOG_OUTPUT_INTERVAL` ) æ¯«ç§’ï¼Œæ‰§è¡Œä¸€æ¬¡ã€‚

- ç¬¬ 9 è‡³ 10 è¡Œï¼šå¾ªç¯æ—¥å¿—é˜Ÿåˆ— `logQueue` ã€‚**æ³¨æ„**ï¼Œæ—¥å¿—é›†åˆä½¿ç”¨äº† ConcurrentHashSet ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€å®šçš„**ä¹±åº**ï¼Œåœ¨æœ€ç»ˆè¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶åã€‚

- ç¬¬ 14 è‡³ 22 è¡Œï¼šè·å¾—æ—¥å¿—æ–‡ä»¶ã€‚

- ç¬¬ 23 è‡³ 31 è¡Œï¼šå½’æ¡£å†å²æ—¥å¿—æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

  ```
  accesslog
  ```

   

  =>

   

  ```
  access.20181023
  ```

   

  ã€‚

  - **æ³¨æ„**ï¼Œå› ä¸ºæ˜¯æŒ‰ç…§**æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´**ï¼Œæ‰€ä»¥æç«¯æƒ…å†µï¼ˆå†™ç€å†™ç€åˆ°äº†**ç¬¬äºŒå¤©**ï¼‰ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå½’æ¡£äº†ã€‚

- ç¬¬ 32 è‡³ 42 è¡Œï¼šè¾“å‡ºæ—¥å¿—åˆ°æŒ‡å®šæ–‡ä»¶ã€‚

# 4ã€ActiveLimitFilter && ExecuteLimitFilter

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«**æœåŠ¡æ–¹æ³•**çš„**æœ€å¤§å¯å¹¶è¡Œè°ƒç”¨**çš„**é™åˆ¶**è¿‡æ»¤å™¨ï¼Œåœ¨æœåŠ¡**æ¶ˆè´¹è€…**å’Œ**æä¾›è€…**å„æœ‰ä¸€ä¸ª LimitFilter ï¼š

- ActiveLimitFilter ï¼Œåœ¨æœåŠ¡**æ¶ˆè´¹è€…**ï¼Œé€šè¿‡ `<dubbo:reference />` çš„ `"actives"` **ç»Ÿä¸€**é…ç½®é¡¹å¼€å¯ï¼š

  > æ¯æœåŠ¡æ¶ˆè´¹è€…ï¼Œ**æ¯æœåŠ¡**çš„**æ¯æ–¹æ³•**æœ€å¤§å¹¶å‘è°ƒç”¨æ•°ã€‚

- ExecuteLimitFilter ï¼Œåœ¨æœåŠ¡**æä¾›è€…**ï¼Œé€šè¿‡ `<dubbo:service />` çš„ `"executes"` **ç»Ÿä¸€**é…ç½®é¡¹å¼€å¯ï¼š

  > æœåŠ¡æä¾›è€…ï¼Œ**æ¯æœåŠ¡**çš„**æ¯æ–¹æ³•**æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚

å¦å¤–ï¼Œåœ¨ `<dubbo:method />` çš„ `"actives"` å’Œ `"executes"` é…ç½®é¡¹ï¼Œå¯ä»¥**è‡ªå®šä¹‰**æ¯ä¸ªæ–¹æ³•çš„é…ç½®ã€‚

## 2. RpcStatus

`com.alibaba.dubbo.rpc.RpcStatus` ï¼ŒRPC çŠ¶æ€ã€‚å¯ä»¥è®¡å…¥å¦‚ä¸‹ç»´åº¦ç»Ÿè®¡ï¼š

- 1. åŸºäºæœåŠ¡ URL
- 1. åŸºäºæœåŠ¡ URL + æ–¹æ³•

ç”¨äº ActiveLimitFilter å’Œ ExecuteLimitFilter ä¸­ã€‚ğŸ™‚ å½“ç„¶ï¼ŒDubbo ä¸­ï¼Œä¹Ÿæœ‰å…¶ä»–ç±»ï¼Œä¹Ÿä¼šè°ƒç”¨åˆ° RpcStatus ã€‚

#### 2.1 æ„é€ æ–¹æ³•

```
/**
 * åŸºäºæœåŠ¡ URL ä¸ºç»´åº¦çš„ RpcStatus é›†åˆ
 *
 * keyï¼šURL
 */
private static final ConcurrentMap<String, RpcStatus> SERVICE_STATISTICS = new ConcurrentHashMap<String, RpcStatus>();
/**
 * åŸºäºæœåŠ¡ URL + æ–¹æ³•ç»´åº¦çš„ RpcStatus é›†åˆ
 *
 * key1ï¼šURL
 * key2ï¼šæ–¹æ³•å
 */
private static final ConcurrentMap<String, ConcurrentMap<String, RpcStatus>> METHOD_STATISTICS = new ConcurrentHashMap<String, ConcurrentMap<String, RpcStatus>>();

// ç›®å‰æ²¡æœ‰ç”¨åˆ°
private final ConcurrentMap<String, Object> values = new ConcurrentHashMap<String, Object>();
/**
 * è°ƒç”¨ä¸­çš„æ¬¡æ•°
 */
private final AtomicInteger active = new AtomicInteger();
/**
 * æ€»è°ƒç”¨æ¬¡æ•°
 */
private final AtomicLong total = new AtomicLong();
/**
 * æ€»è°ƒç”¨å¤±è´¥æ¬¡æ•°
 */
private final AtomicInteger failed = new AtomicInteger();
/**
 * æ€»è°ƒç”¨æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
 */
private final AtomicLong totalElapsed = new AtomicLong();
/**
 * æ€»è°ƒç”¨å¤±è´¥æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
 */
private final AtomicLong failedElapsed = new AtomicLong();
/**
 * æœ€å¤§è°ƒç”¨æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
 */
private final AtomicLong maxElapsed = new AtomicLong();
/**
 * æœ€å¤§è°ƒç”¨å¤±è´¥æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
 */
private final AtomicLong failedMaxElapsed = new AtomicLong();
/**
 * æœ€å¤§è°ƒç”¨æˆåŠŸæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
 */
private final AtomicLong succeededMaxElapsed = new AtomicLong();

/**
 * Semaphore used to control concurrency limit set by `executes`
 *
 * æœåŠ¡æ‰§è¡Œä¿¡å·é‡ï¼Œåœ¨ {@link com.alibaba.dubbo.rpc.filter.ExecuteLimitFilter} ä¸­ä½¿ç”¨
 */
private volatile Semaphore executesLimit;
/**
 * æœåŠ¡æ‰§è¡Œä¿¡å·é‡å¤§å°
 */
private volatile int executesPermits;
```

- ========== é™æ€å±æ€§ ==========

- `SERVICE_STATISTICS` å±æ€§ï¼ŒåŸºäº**æœåŠ¡ URL** ä¸ºç»´åº¦çš„ **RpcStatus** é›†åˆã€‚`#getStatus(url)` **é™æ€**æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  public static RpcStatus getStatus(URL url) {
      String uri = url.toIdentityString();
      // è·å¾—
      RpcStatus status = SERVICE_STATISTICS.get(uri);
      // ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»º
      if (status == null) {
          SERVICE_STATISTICS.putIfAbsent(uri, new RpcStatus());
          status = SERVICE_STATISTICS.get(uri);
      }
      return status;
  }
  ```

- `METHOD_STATISTICS` å±æ€§ï¼ŒåŸºäº**æœåŠ¡ URL** + **æ–¹æ³•**ä¸ºç»´åº¦çš„ **RpcStatus** é›†åˆã€‚`#getStatus(url, methodName)` **é™æ€**æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  public static RpcStatus getStatus(URL url, String methodName) {
      String uri = url.toIdentityString();
      // è·å¾—æ–¹æ³•é›†åˆ
      ConcurrentMap<String, RpcStatus> map = METHOD_STATISTICS.get(uri);
      // ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–¹æ³•é›†åˆ
      if (map == null) {
          METHOD_STATISTICS.putIfAbsent(uri, new ConcurrentHashMap<String, RpcStatus>());
          map = METHOD_STATISTICS.get(uri);
      }
  
      // è·å¾— RpcStatus å¯¹è±¡
      RpcStatus status = map.get(methodName);
      // ä¸å­˜åœ¨ï¼Œåˆ›å»º RpcStatus å¯¹è±¡
      if (status == null) {
          map.putIfAbsent(methodName, new RpcStatus());
          status = map.get(methodName);
      }
      return status;
  }
  ```

- ========== å¯¹è±¡å±æ€§ ==========

- æ¬¡æ•°ç›¸å…³

  - `active` ï¼Œ**è°ƒç”¨ä¸­**çš„æ¬¡æ•°ã€‚è¿™ä¸ªå±æ€§åœ¨ ActiveLimitFilter ä¸­**éå¸¸å…³é”®**ã€‚
  - `total` `failed`

- æ—¶é•¿ç›¸å…³

  - `totalElapsed` `failedElapsed`
  - `failedElapsed` `failedMaxElapsed` `succeededMaxElapsed`

- ä¿¡å·é‡ç›¸å…³

  - `executesLimit` ï¼ŒæœåŠ¡æ‰§è¡Œä¿¡å·é‡ã€‚è¿™ä¸ªå±æ€§åœ¨ ExecuteLimitFilter ä¸­**éå¸¸å…³é”®**ã€‚
  - `executesPermits` ï¼ŒæœåŠ¡æ‰§è¡Œä¿¡å·é‡å¤§å°ã€‚

#### 2.2 beginCount

```
/**
 * æœåŠ¡è°ƒç”¨å¼€å§‹çš„è®¡æ•°
 *
 * @param url URL å¯¹è±¡
 * @param methodName æ–¹æ³•å
 */
public static void beginCount(URL url, String methodName) {
    // `SERVICE_STATISTICS` çš„è®¡æ•°
    beginCount(getStatus(url));
    // `METHOD_STATISTICS` çš„è®¡æ•°
    beginCount(getStatus(url, methodName));
}
```

- **é™æ€æ–¹æ³•**ï¼Œåœ¨å…¶å†…éƒ¨ï¼Œä¼šè°ƒç”¨ä¸¤æ¬¡ `#beginCount(RpcStatus)` æ–¹æ³•ï¼Œåˆ†åˆ«è®¡æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  private static void beginCount(RpcStatus status) {
      // è°ƒç”¨ä¸­çš„æ¬¡æ•°
      status.active.incrementAndGet();
  }
  ```

#### 2.3 endCount

```
/**
 * æœåŠ¡è°ƒç”¨ç»“æŸçš„è®¡æ•°
 *
 * @param url URL å¯¹è±¡
 * @param elapsed æ—¶é•¿ï¼Œæ¯«ç§’
 * @param succeeded æ˜¯å¦æˆåŠŸ
 */
public static void endCount(URL url, String methodName, long elapsed, boolean succeeded) {
    // `SERVICE_STATISTICS` çš„è®¡æ•°
    endCount(getStatus(url), elapsed, succeeded);
    // `METHOD_STATISTICS` çš„è®¡æ•°
    endCount(getStatus(url, methodName), elapsed, succeeded);
}
```

- **é™æ€æ–¹æ³•**ï¼Œåœ¨å…¶å†…éƒ¨ï¼Œä¼šè°ƒç”¨ä¸¤æ¬¡ `#endCount(RpcStatus)` æ–¹æ³•ï¼Œåˆ†åˆ«è®¡æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  private static void endCount(RpcStatus status, long elapsed, boolean succeeded) {
      // æ¬¡æ•°è®¡æ•°
      status.active.decrementAndGet();
      status.total.incrementAndGet();
      status.totalElapsed.addAndGet(elapsed);
      // æ—¶é•¿è®¡æ•°
      if (status.maxElapsed.get() < elapsed) {
          status.maxElapsed.set(elapsed);
      }
      if (succeeded) {
          if (status.succeededMaxElapsed.get() < elapsed) {
              status.succeededMaxElapsed.set(elapsed);
          }
      } else {
          status.failed.incrementAndGet(); // å¤±è´¥æ¬¡æ•°
          status.failedElapsed.addAndGet(elapsed);
          if (status.failedMaxElapsed.get() < elapsed) {
              status.failedMaxElapsed.set(elapsed);
          }
      }
  }
  ```

#### 2.4 getSemaphore

```
public Semaphore getSemaphore(int maxThreadNum) {
    if(maxThreadNum <= 0) {
        return null;
    }
    // è‹¥ä¿¡å·é‡ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¿¡å·é‡å¤§å°æ”¹å˜ï¼Œåˆ›å»ºæ–°çš„ä¿¡å·é‡
    if (executesLimit == null || executesPermits != maxThreadNum) {
        synchronized (this) {
            if (executesLimit == null || executesPermits != maxThreadNum) {
                executesLimit = new Semaphore(maxThreadNum);
                executesPermits = maxThreadNum;
            }
        }
    }
    // è¿”å›ä¿¡å·é‡
    return executesLimit;
}
```

- **å¯¹è±¡**æ–¹æ³•ï¼Œè·å¾—ä¿¡å·é‡ `executesPermits` å±æ€§ã€‚
- åˆ›å»ºä¿¡å·é‡çš„**æ¡ä»¶**ï¼Œä¿¡å·é‡ `executesPermits` ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¿¡å·é‡å¤§å° `executesLimit` å‘ç”Ÿæ”¹å˜ã€‚æˆ‘ä»¬ä¼šå‘ç”Ÿæ¯”è¾ƒâ€œç¥å¥‡â€çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯**ç›´æ¥**è¿”å› Semaphore å¯¹è±¡ã€‚è€ƒè™‘åˆ°æœ‰ä¿¡å·é‡å¤§å°æ”¹å˜çš„éœ€æ±‚ï¼Œä½†æ˜¯ä¿¡å·é‡ä¸æ”¯æŒ**æ‰¹é‡**ä¿®æ”¹å¤§å°ï¼Œé‚£ä¹ˆå‰©ä½™çš„ä¸€ç§åˆé€‚çš„æ–¹å¼ï¼Œåˆ›å»º**æ–°çš„**ä¿¡å·é‡å¯¹è±¡ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ–¹æ³•å°±é€‰æ‹©äº†ç›´æ¥è¿”å› Semaphore å¯¹è±¡ã€‚
- åœ¨ [ã€ŠDubboæºä»£ç åˆ†æä¸ƒï¼šä½¿ç”¨executeså±æ€§çš„ä¸€ä¸ªé—®é¢˜ã€‹](http://manzhizhen.iteye.com/blog/2386408) ä¸­ï¼Œåˆ†äº«çš„å¾ˆä¸é”™ã€‚

## 3. ActiveLimitFilter

`com.alibaba.dubbo.rpc.filter.ActiveLimitFilter` ï¼Œå®ç° Filter æ¥å£ï¼Œæ¯æœåŠ¡æ¶ˆè´¹è€…**æ¯æœåŠ¡**ã€**æ¯æ–¹æ³•**çš„**æœ€å¤§å¯å¹¶è¡Œ**è°ƒç”¨æ•°é™åˆ¶çš„è¿‡æ»¤å™¨å®ç°ç±»ã€‚

```
 1: @Activate(group = Constants.CONSUMER, value = Constants.ACTIVES_KEY)
 2: public class ActiveLimitFilter implements Filter {
 3: 
 4:     @Override
 5:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
 6:         URL url = invoker.getUrl();
 7:         String methodName = invocation.getMethodName();
 8:         // è·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°
 9:         int max = invoker.getUrl().getMethodParameter(methodName, Constants.ACTIVES_KEY, 0);
10:         // è·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäºæœåŠ¡ URL + æ–¹æ³•ç»´åº¦
11:         RpcStatus count = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName());
12:         if (max > 0) {
13:             // è·å¾—è¶…æ—¶å€¼
14:             long timeout = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.TIMEOUT_KEY, 0);
15:             long start = System.currentTimeMillis();
16:             long remain = timeout; // å‰©ä½™å¯ç­‰å¾…æ—¶é—´
17:             int active = count.getActive();
18:             // è¶…è¿‡æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ï¼Œç­‰å¾…
19:             if (active >= max) {
20:                 synchronized (count) { // é€šè¿‡é”ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªåœ¨ç­‰å¾…ã€‚
21:                     // å¾ªç¯ï¼Œç­‰å¾…å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°
22:                     while ((active = count.getActive()) >= max) {
23:                         // ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ï¼Œæˆ–è€…è¢«å”¤é†’
24:                         try {
25:                             count.wait(remain);
26:                         } catch (InterruptedException e) {
27:                         }
28:                         // åˆ¤æ–­æ˜¯å¦æ²¡æœ‰å‰©ä½™æ—¶é•¿äº†ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸
29:                         long elapsed = System.currentTimeMillis() - start; // æœ¬åœ°ç­‰å¾…æ—¶é•¿
30:                         remain = timeout - elapsed;
31:                         if (remain <= 0) {
32:                             throw new RpcException("Waiting concurrent invoke timeout in client-side for service:  "
33:                                     + invoker.getInterface().getName() + ", method: "
34:                                     + invocation.getMethodName() + ", elapsed: " + elapsed
35:                                     + ", timeout: " + timeout + ". concurrent invokes: " + active
36:                                     + ". max concurrent invoke limit: " + max);
37:                         }
38:                     }
39:                 }
40:             }
41:         }
42:         try {
43:             long begin = System.currentTimeMillis();
44:             // è°ƒç”¨å¼€å§‹çš„è®¡æ•°
45:             RpcStatus.beginCount(url, methodName);
46:             try {
47:                 // æœåŠ¡è°ƒç”¨
48:                 Result result = invoker.invoke(invocation);
49:                 // è°ƒç”¨ç»“æŸçš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰
50:                 RpcStatus.endCount(url, methodName, System.currentTimeMillis() - begin, true);
51:                 return result;
52:             } catch (RuntimeException t) {
53:                 // è°ƒç”¨ç»“æŸçš„è®¡æ•°ï¼ˆå¤±è´¥ï¼‰
54:                 RpcStatus.endCount(url, methodName, System.currentTimeMillis() - begin, false);
55:                 throw t;
56:             }
57:         } finally {
58:             // å”¤é†’ç­‰å¾…çš„ç›¸åŒæœåŠ¡çš„ç›¸åŒæ–¹æ³•çš„è¯·æ±‚
59:             if (max > 0) {
60:                 synchronized (count) {
61:                     count.notify();
62:                 }
63:             }
64:         }
65:     }
66: 
67: }
```

- ActiveLimitFilter åŸºäº `RpcStatus.active` å±æ€§ï¼Œåˆ¤æ–­å½“å‰**æ­£åœ¨è°ƒç”¨ä¸­**çš„æœåŠ¡çš„æ–¹æ³•çš„æ¬¡æ•°æ¥åˆ¤æ–­ã€‚å› ä¸ºï¼Œéœ€è¦æœ‰**ç­‰å¾…è¶…æ—¶**çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨ `RpcStatus.semaphore` **ä¿¡å·é‡**çš„æ–¹å¼æ¥å®ç°ã€‚
- ç¬¬ 9 è¡Œï¼šè°ƒç”¨ `URL#getMethodParameter(methodName, key, defaultValue)` æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚ä¼˜å…ˆ `<dubbo: method />` ï¼Œå…¶æ¬¡ `<dubbo:reference />` ã€‚
- ç¬¬ 11 è¡Œï¼šè°ƒç”¨ `RpcStatus#getStatus(url, methodName)` æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäº**æœåŠ¡ URL + æ–¹æ³•**ä¸ºç»´åº¦ã€‚
- ç¬¬ 14 è¡Œï¼šè·å¾—**è¶…æ—¶å€¼**ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œæ­¤å¤„äº§ç”Ÿçš„**ç­‰å¾…**æ—¶é•¿ï¼Œ**ä¸**å ç”¨è°ƒç”¨æœåŠ¡çš„**è¶…æ—¶**æ—¶é•¿ã€‚æ‰€ä»¥ï¼Œ**æç«¯æƒ…å†µ**ä¸‹çš„æœåŠ¡è¶…æ—¶ï¼Œçº¦ç­‰äº 2 * `timeout` ã€‚
- ç¬¬ 19 è¡Œï¼šè¶…è¿‡æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ï¼Œ**éœ€è¦ç­‰å¾…**ã€‚
- ç¬¬ 20 è¡Œï¼šé€šè¿‡**é”å®š** `synchronized` ï¼Œ**æœ‰ä¸”ä»…æœ‰**ä¸€ä¸ªåœ¨ç­‰å¾…ã€‚åŒæ—¶ï¼Œä¹Ÿä¿è¯å…ˆè°ƒç”¨çš„å¯ä»¥å…ˆæ‰§è¡Œã€‚
- ç¬¬ 22 è¡Œï¼š**å¾ªç¯**ï¼Œç­‰å¾…å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚ä¸ºä»€ä¹ˆéœ€è¦å¾ªç¯å‘¢ï¼Ÿæç«¯æƒ…å†µä¸‹ï¼Œæ°å¥½æœ‰ä¸€ä¸ª**æ–°çš„**è°ƒç”¨ï¼Œåœ¨ã€ç¬¬ 61 è¡Œã€‘æ‰§è¡Œçš„ä¸€ç¬é—´ï¼Œèµ°åˆ°äº†ã€ç¬¬ 19 è¡Œã€‘ï¼Œâ€œ**æŠ¢**â€èµ°äº†æ­£åœ¨é”å®šç­‰å¾…çš„è¯·æ±‚æœºä¼šã€‚
- ç¬¬ 23 è‡³ 27 è¡Œï¼šç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ï¼Œæˆ–è€…è¢«å”¤é†’ã€ç¬¬ 61 è¡Œã€‘ã€‚
- ç¬¬ 28 è‡³ 37 è¡Œï¼šåˆ¤æ–­è‹¥æ²¡æœ‰å‰©ä½™æ—¶é•¿äº†ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚
- ç¬¬ 45 è¡Œï¼šè°ƒç”¨ `RpcStaus#beginCount(url, methodName)` æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ã€‚
- ç¬¬ 48 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚
- ç¬¬ 50 è¡Œï¼šè°ƒç”¨ `RpcStaus#endCount(url, methodName, true)` æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰ã€‚
- ç¬¬ 54 è¡Œï¼šè°ƒç”¨ `RpcStaus#endCount(url, methodName, false)` æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ï¼ˆå¤±è´¥ï¼‰ã€‚
- ç¬¬ 59 è‡³ 63 è¡Œï¼šå”¤é†’ç­‰å¾…çš„ç›¸åŒæœåŠ¡çš„ç›¸åŒæ–¹æ³•çš„è¯·æ±‚ã€ç¬¬ 25 è¡Œã€‘ã€‚

## 4. ExecuteLimitFilter

`com.alibaba.dubbo.rpc.filter.ExecuteLimitFilter` ï¼Œå®ç° Filter æ¥å£ï¼ŒæœåŠ¡æä¾›è€…**æ¯æœåŠ¡**ã€**æ¯æ–¹æ³•**çš„**æœ€å¤§å¯å¹¶è¡Œ**æ‰§è¡Œè¯·æ±‚æ•°çš„è¿‡æ»¤å™¨å®ç°ç±»ã€‚

```
 1: @Activate(group = Constants.PROVIDER, value = Constants.EXECUTES_KEY)
 2: public class ExecuteLimitFilter implements Filter {
 3: 
 4:     @Override
 5:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
 6:         URL url = invoker.getUrl();
 7:         String methodName = invocation.getMethodName();
 8:         Semaphore executesLimit = null; // ä¿¡å·é‡
 9:         boolean acquireResult = false; // æ˜¯å¦è·å¾—ä¿¡å·é‡
10:         // è·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°
11:         int max = url.getMethodParameter(methodName, Constants.EXECUTES_KEY, 0);
12:         if (max > 0) {
13:             // è·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäºæœåŠ¡ URL + æ–¹æ³•ç»´åº¦
14:             RpcStatus count = RpcStatus.getStatus(url, invocation.getMethodName());
15:             // è·å¾—ä¿¡å·é‡ã€‚è‹¥è·å¾—ä¸åˆ°ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
16: //            if (count.getActive() >= max) {
17:             /**
18:              * http://manzhizhen.iteye.com/blog/2386408
19:              * use semaphore for concurrency control (to limit thread number)
20:              */
21:             executesLimit = count.getSemaphore(max);
22:             if (executesLimit != null && !(acquireResult = executesLimit.tryAcquire())) {
23:                 throw new RpcException("Failed to invoke method " + invocation.getMethodName() + " in provider " + url + ", cause: The service using threads greater than <dubbo:service executes=\"" + max + "\" /> limited.");
24:             }
25:         }
26:         long begin = System.currentTimeMillis();
27:         boolean isSuccess = true;
28:         // è°ƒç”¨å¼€å§‹çš„è®¡æ•°
29:         RpcStatus.beginCount(url, methodName);
30:         try {
31:             // æœåŠ¡è°ƒç”¨
32:             return invoker.invoke(invocation);
33:         } catch (Throwable t) {
34:             isSuccess = false; // æ ‡è®°å¤±è´¥
35:             if (t instanceof RuntimeException) {
36:                 throw (RuntimeException) t;
37:             } else {
38:                 throw new RpcException("unexpected exception when ExecuteLimitFilter", t);
39:             }
40:         } finally {
41:             // è°ƒç”¨ç»“æŸçš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰ï¼ˆå¤±è´¥ï¼‰
42:             RpcStatus.endCount(url, methodName, System.currentTimeMillis() - begin, isSuccess);
43:             // é‡Šæ”¾ä¿¡å·é‡
44:             if (acquireResult) {
45:                 executesLimit.release();
46:             }
47:         }
48:     }
49: 
50: }
```

- ActiveLimitFilter åŸºäº `RpcStatus.semaphore` **ä¿¡å·é‡**å±æ€§ï¼Œåˆ¤æ–­è‹¥è¶…è¿‡æœ€å¤§å¯å¹¶è¡Œï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚
- ç¬¬ 11 è¡Œï¼šè°ƒç”¨ `URL#getMethodParameter(methodName, key, defaultValue)` æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚ä¼˜å…ˆ `<dubbo: method />` ï¼Œå…¶æ¬¡ `<dubbo:service />` ã€‚
- ç¬¬ 13 è¡Œï¼šè°ƒç”¨ `RpcStatus#getStatus(url, methodName)` æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäº**æœåŠ¡ URL + æ–¹æ³•**ä¸ºç»´åº¦ã€‚
- ç¬¬ 21 è‡³ 21 è¡Œï¼šè°ƒç”¨ `RpcStatus#getSemaphore(max)` æ–¹æ³•ï¼Œè·å¾— Semaphore å¯¹è±¡ã€‚
- ç¬¬ 22 è‡³ 24 è¡Œï¼šè°ƒç”¨ `Semaphore#tryAcquire()` æ–¹æ³•ï¼Œè‹¥è·å¾—ä¸åˆ°ä¿¡å·é‡ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚
- ç¬¬ 29 è¡Œï¼šè°ƒç”¨ `RpcStaus#beginCount(url, methodName)` æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ã€‚
- ç¬¬ 32 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚
- ç¬¬ 34 è¡Œï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œæ ‡è®° `isSuccess = false` ï¼Œè¡¨ç¤ºè°ƒç”¨å¤±è´¥ã€‚
- ç¬¬ 42 è¡Œï¼šè°ƒç”¨ `RpcStaus#endCount(url, methodName, success)` æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰ï¼ˆå¤±è´¥ï¼‰ã€‚
- ç¬¬ 43 è‡³ 46 è¡Œï¼šè°ƒç”¨ `Semaphore#release()` æ–¹æ³•ï¼Œé‡Šæ”¾ä¿¡å·é‡ã€‚

# 5ã€TimeoutFilter

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«è¿‡æ»¤å™¨ TimeoutFilter ï¼Œç”¨äºæœåŠ¡**æä¾›è€…**ä¸­ã€‚

## 2. TimeoutFilter

`com.alibaba.dubbo.rpc.filter.TimeoutFilter` ï¼Œå®ç° Filter æ¥å£ï¼Œè¶…æ—¶è¿‡æ»¤å™¨ã€‚å¦‚æœæœåŠ¡è°ƒç”¨**è¶…æ—¶**ï¼Œè®°å½•**å‘Šè­¦**æ—¥å¿—ï¼Œ**ä¸å¹²æ¶‰**æœåŠ¡çš„è¿è¡Œã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: @Activate(group = Constants.PROVIDER)
 2: public class TimeoutFilter implements Filter {
 3: 
 4:     private static final Logger logger = LoggerFactory.getLogger(TimeoutFilter.class);
 5: 
 6:     @Override
 7:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
 8:         long start = System.currentTimeMillis();
 9:         // æœåŠ¡è°ƒç”¨
10:         Result result = invoker.invoke(invocation);
11:         // è®¡ç®—è°ƒç”¨æ—¶é•¿
12:         long elapsed = System.currentTimeMillis() - start;
13:         // è¶…è¿‡æ—¶é•¿ï¼Œæ‰“å°å‘Šè­¦æ—¥å¿—
14:         if (invoker.getUrl() != null
15:                 && elapsed > invoker.getUrl().getMethodParameter(invocation.getMethodName(), "timeout", Integer.MAX_VALUE)) {
16:             if (logger.isWarnEnabled()) {
17:                 logger.warn("invoke time out. method: " + invocation.getMethodName()
18:                         + " arguments: " + Arrays.toString(invocation.getArguments()) + " , url is "
19:                         + invoker.getUrl() + ", invoke elapsed " + elapsed + " ms.");
20:             }
21:         }
22:         return result;
23:     }
24: 
25: }
```

- ç¬¬ 10 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚
- ç¬¬ 12 è¡Œï¼šè®¡ç®—è°ƒç”¨æ—¶é•¿ã€‚
- ç¬¬ 13 è‡³ 21 è¡Œï¼šè¶…è¿‡æ—¶é•¿ï¼Œæ‰“å°**å‘Šè­¦**æ—¥å¿—ã€‚æ³¨æ„ï¼Œæ­¤å¤„çš„ `"timeout"` å–å¾—çš„æ˜¯æœåŠ¡**æä¾›è€…**çš„é…ç½®ï¼Œä¸åŒäºæœåŠ¡**æ¶ˆè´¹è€…**çš„é…ç½®ã€‚
- ç¬¬ 22 è¡Œï¼šè¿”å›è°ƒç”¨ç»“æœã€‚
- ğŸ™‚ å†æ³¨æ„ï¼Œåœ¨æœåŠ¡**æä¾›è€…**ï¼Œæ‰§è¡ŒæœåŠ¡è°ƒç”¨æ—¶ï¼Œå³ä½¿**è¶…è¿‡äº†è¶…æ—¶æ—¶é—´**ï¼Œä¹Ÿä¸ä¼šå–æ¶ˆæ‰§è¡Œã€‚è™½ç„¶ï¼ŒæœåŠ¡**æ¶ˆè´¹è€…**ï¼Œå·²ç»ç»“æŸè°ƒç”¨ï¼Œè¿”å›è°ƒç”¨è¶…æ—¶ã€‚

# 6ã€DeprecatedFilter

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«è¿‡æ»¤å™¨ DeprecatedFilter ï¼Œç”¨äºæœåŠ¡**æ¶ˆè´¹è€…**ä¸­ï¼Œé€šè¿‡ `<dubbo: service />` æˆ– `<dubbo:reference />` æˆ– `<dubbo:method />` çš„ `"deprecated"` é…ç½®é¡¹ä¸º `true` æ¥å¼€å¯ã€‚

## 2. DeprecatedFilter

`com.alibaba.dubbo.rpc.filter.DeprecatedFilter` ï¼Œå®ç° Filter æ¥å£ï¼ŒåºŸå¼ƒè°ƒç”¨çš„è¿‡æ»¤å™¨å®ç°ç±»ã€‚å½“è°ƒç”¨åºŸå¼ƒçš„æœåŠ¡æ–¹æ³•æ—¶ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—æé†’ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: @Activate(group = Constants.CONSUMER, value = Constants.DEPRECATED_KEY)
 2: public class DeprecatedFilter implements Filter {
 3: 
 4:     private static final Logger LOGGER = LoggerFactory.getLogger(DeprecatedFilter.class);
 5: 
 6:     /**
 7:      * å·²ç»æ‰“å°æ—¥å¿—çš„æ–¹æ³•é›†åˆ
 8:      */
 9:     private static final Set<String> logged = new ConcurrentHashSet<String>();
10: 
11:     @Override
12:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
13:         // è·å¾—æ–¹æ³•å
14:         String key = invoker.getInterface().getName() + "." + invocation.getMethodName();
15:         // æ‰“å°å‘Šè­¦æ—¥å¿—
16:         if (!logged.contains(key)) {
17:             logged.add(key);
18:             if (invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.DEPRECATED_KEY, false)) {
19:                 LOGGER.error("The service method " + invoker.getInterface().getName() + "." + getMethodSignature(invocation) + " is DEPRECATED! Declare from " + invoker.getUrl());
20:             }
21:         }
22:         return invoker.invoke(invocation);
23:     }
24: 
25:     
26:     // çœç•¥ getMethodSignature æ–¹æ³•
27: 
28: }
```

- `logged` **é™æ€**å±æ€§ï¼Œå·²ç»æ‰“å°æ—¥å¿—çš„æ–¹æ³•é›†åˆã€‚

- ç¬¬ 14 è¡Œï¼šè·å¾—æ–¹æ³•åã€‚

- ç¬¬ 16 è‡³ 21 è¡Œï¼šæ‰“å°å‘Šè­¦æ—¥å¿—ã€‚ä¸€ä¸ªæœåŠ¡çš„æ–¹æ³•ï¼Œ**æœ‰ä¸”ä»…æœ‰**æ‰“å°ä¸€æ¬¡ã€‚ä¾‹å¦‚ï¼š

  ```
  [14/04/18 11:51:35:035 CST] main ERROR filter.DeprecatedFilter:  [DUBBO] The service method com.alibaba.dubbo.demo.DemoService.say01(String) is DEPRECATED! Declare from dubbo://192.168.3.17:20880/com.alibaba.dubbo.demo.DemoService?accesslog=true&anyhost=true&application=demo-consumer&callbacks=1000&check=false&client=netty4&default.delay=-1&default.retries=0&delay=-1&deprecated=false&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello,callbackParam,say03,say04,say01,bye,say02&payload=1000&pid=16820&qos.port=33333&register.ip=192.168.3.17&remote.timestamp=1523720843597&say01.deprecated=true&sayHello.async=true&server=netty4&service.filter=demo&side=consumer&timeout=100000&timestamp=1523721049491, dubbo version: 2.0.0, current host: 192.168.3.17
  ```

  - æ³¨æ„ï¼Œã€ç¬¬ 18 è¡Œã€‘ä¼šæ ¹æ®æ–¹æ³•åœ¨åˆ¤æ–­ã€‚å› ä¸ºï¼Œä¸€ä¸ªæœåŠ¡é‡Œï¼Œå¯èƒ½åªæœ‰**éƒ¨åˆ†**æ–¹æ³•åºŸå¼ƒã€‚

- ç¬¬ 22 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

## 3. DeprecatedInvokerListener

åŠŸèƒ½**ç±»ä¼¼**ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡å¼•ç”¨ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°å¼•ç”¨ï¼ˆInjvmï¼‰ã€‹ã€Œ5.2 DeprecatedInvokerListenerã€](http://svip.iocoder.cn/Dubbo/reference-refer-local/?self) ä¸­ï¼Œå·²ç»æœ‰è¯¦ç»†è§£æã€‚

# 7ã€ExceptionFilter

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«å¼‚å¸¸è¿‡æ»¤å™¨ ExceptionFilter ï¼Œç”¨äºæœåŠ¡**æä¾›è€…**ä¸­ã€‚ç”¨é€”å¦‚ä¸‹ï¼š

> FROM ExceptionFilter ä¸Šçš„æ³¨é‡Šï¼š
>
> 1. ä¸æœŸæœ›çš„å¼‚å¸¸æ‰“ ERROR æ—¥å¿—( Providerç«¯ )ã€‚ä¸æœŸæœ›çš„æ—¥å¿—å³æ˜¯ï¼Œæ²¡æœ‰çš„æ¥å£ä¸Šå£°æ˜çš„Uncheckedå¼‚å¸¸ã€‚
> 2. å¼‚å¸¸ä¸åœ¨ API åŒ…ä¸­ï¼Œåˆ™ Wrap ä¸€å±‚ RuntimeException ã€‚RPC å¯¹äºç¬¬ä¸€å±‚å¼‚å¸¸ä¼šç›´æ¥åºåˆ—åŒ–ä¼ è¾“( Cause å¼‚å¸¸ä¼š String åŒ–) ï¼Œé¿å…å¼‚å¸¸åœ¨ Client å‡ºä¸èƒ½**ååºåˆ—åŒ–**é—®é¢˜ã€‚

ğŸ™‚ å’Œæˆ‘ä»¬å¹³æ—¶ä¸šåŠ¡å†™çš„ç”¨äº**æ•æ‰å¼‚å¸¸**çš„è¿‡æ»¤å™¨æˆ–è€…æ‹¦æˆªå™¨**ä¸å¤ªä¸€æ ·**ï¼Œè€Œæ˜¯å…³æ³¨ç‚¹åœ¨æœåŠ¡æ¶ˆè´¹è€…ä¼šä¸ä¼šå‡ºç°ä¸å­˜åœ¨è¯¥å¼‚å¸¸ç±»ï¼Œå¯¼è‡´ååºåˆ—åŒ–çš„é—®é¢˜ã€‚

## 2. ExceptionFilter

`com.alibaba.dubbo.rpc.filter.ExceptionFilter` ï¼Œå®ç° Filter æ¥å£ï¼Œå¼‚å¸¸è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: @Activate(group = Constants.PROVIDER)
 2: public class ExceptionFilter implements Filter {
 3: 
 4:     private final Logger logger;
 5: 
 6:     public ExceptionFilter() {
 7:         this(LoggerFactory.getLogger(ExceptionFilter.class));
 8:     }
 9: 
10:     public ExceptionFilter(Logger logger) {
11:         this.logger = logger;
12:     }
13: 
14:     @Override
15:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
16:         try {
17:             // æœåŠ¡è°ƒç”¨
18:             Result result = invoker.invoke(invocation);
19:             // æœ‰å¼‚å¸¸ï¼Œå¹¶ä¸”éæ³›åŒ–è°ƒç”¨
20:             if (result.hasException() && GenericService.class != invoker.getInterface()) {
21:                 try {
22:                     Throwable exception = result.getException();
23: 
24:                     // directly throw if it's checked exception
25:                     // å¦‚æœæ˜¯checkedå¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
26:                     if (!(exception instanceof RuntimeException) && (exception instanceof Exception)) {
27:                         return result;
28:                     }
29:                     // directly throw if the exception appears in the signature
30:                     // åœ¨æ–¹æ³•ç­¾åä¸Šæœ‰å£°æ˜ï¼Œç›´æ¥æŠ›å‡º
31:                     try {
32:                         Method method = invoker.getInterface().getMethod(invocation.getMethodName(), invocation.getParameterTypes());
33:                         Class<?>[] exceptionClassses = method.getExceptionTypes();
34:                         for (Class<?> exceptionClass : exceptionClassses) {
35:                             if (exception.getClass().equals(exceptionClass)) {
36:                                 return result;
37:                             }
38:                         }
39:                     } catch (NoSuchMethodException e) {
40:                         return result;
41:                     }
42: 
43:                     // æœªåœ¨æ–¹æ³•ç­¾åä¸Šå®šä¹‰çš„å¼‚å¸¸ï¼Œåœ¨æœåŠ¡å™¨ç«¯æ‰“å° ERROR æ—¥å¿—
44:                     // for the exception not found in method's signature, print ERROR message in server's log.
45:                     logger.error("Got unchecked and undeclared exception which called by " + RpcContext.getContext().getRemoteHost()
46:                             + ". service: " + invoker.getInterface().getName() + ", method: " + invocation.getMethodName()
47:                             + ", exception: " + exception.getClass().getName() + ": " + exception.getMessage(), exception);
48: 
49:                     // å¼‚å¸¸ç±»å’Œæ¥å£ç±»åœ¨åŒä¸€ jar åŒ…é‡Œï¼Œç›´æ¥æŠ›å‡º
50:                     // directly throw if exception class and interface class are in the same jar file.
51:                     String serviceFile = ReflectUtils.getCodeBase(invoker.getInterface());
52:                     String exceptionFile = ReflectUtils.getCodeBase(exception.getClass());
53:                     if (serviceFile == null || exceptionFile == null || serviceFile.equals(exceptionFile)) {
54:                         return result;
55:                     }
56:                     // æ˜¯JDKè‡ªå¸¦çš„å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
57:                     // directly throw if it's JDK exception
58:                     String className = exception.getClass().getName();
59:                     if (className.startsWith("java.") || className.startsWith("javax.")) {
60:                         return result;
61:                     }
62:                     // æ˜¯Dubboæœ¬èº«çš„å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
63:                     // directly throw if it's dubbo exception
64:                     if (exception instanceof RpcException) {
65:                         return result;
66:                     }
67: 
68:                     // å¦åˆ™ï¼ŒåŒ…è£…æˆRuntimeExceptionæŠ›ç»™å®¢æˆ·ç«¯
69:                     // otherwise, wrap with RuntimeException and throw back to the client
70:                     return new RpcResult(new RuntimeException(StringUtils.toString(exception)));
71:                 } catch (Throwable e) {
72:                     logger.warn("Fail to ExceptionFilter when called by " + RpcContext.getContext().getRemoteHost()
73:                             + ". service: " + invoker.getInterface().getName() + ", method: " + invocation.getMethodName()
74:                             + ", exception: " + e.getClass().getName() + ": " + e.getMessage(), e);
75:                     return result;
76:                 }
77:             }
78:             // è¿”å›
79:             return result;
80:         } catch (RuntimeException e) {
81:             logger.error("Got unchecked and undeclared exception which called by " + RpcContext.getContext().getRemoteHost()
82:                     + ". service: " + invoker.getInterface().getName() + ", method: " + invocation.getMethodName()
83:                     + ", exception: " + e.getClass().getName() + ": " + e.getMessage(), e);
84:             throw e;
85:         }
86:     }
87: 
88: }
```

- ç¬¬ 18 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 21 è¡Œï¼šè°ƒç”¨ç»“æœæœ‰å¼‚å¸¸ï¼Œå¹¶ä¸”é**æ³›åŒ–è°ƒç”¨**ã€‚

- ç¬¬ 24 è‡³ 28 è¡Œï¼šå¦‚æœæ˜¯ checked å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ã€‚å› ä¸ºï¼Œchecked å¼‚å¸¸ï¼Œè‚¯å®šå®šä¹‰åœ¨æ¥å£ä¸Šäº†ã€‚

- ç¬¬ 29 è‡³ 41 è¡Œï¼šåœ¨æ¥å£æ–¹æ³•çš„ç­¾åæœ‰ç”Ÿå‘½ï¼Œç›´æ¥è¿”å›ç»“æœã€‚

- ç¬¬ 45 è‡³ 47 è¡Œï¼šæœªåœ¨æ–¹æ³•ç­¾åä¸Šå®šä¹‰çš„å¼‚å¸¸ï¼Œåœ¨æœåŠ¡å™¨ç«¯æ‰“å° ERROR æ—¥å¿—ã€‚

- ç¬¬ 49 è‡³ 55 è¡Œï¼šå¼‚å¸¸ç±»å’Œæ¥å£ç±»åœ¨åŒä¸€ **jar** åŒ…é‡Œï¼Œç›´æ¥è¿”å›ç»“æœã€‚å› ä¸ºï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯ä»¥ååºåˆ—åŒ–è¯¥å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  public static String getCodeBase(Class<?> cls) {
      if (cls == null) {
          return null;
      }
      ProtectionDomain domain = cls.getProtectionDomain();
      if (domain == null) {
          return null;
      }
      CodeSource source = domain.getCodeSource();
      if (source == null) {
          return null;
      }
      URL location = source.getLocation();
      if (location == null) {
          return null;
      }
      return location.getFile();
  }
  ```

- ç¬¬ 56 è‡³ 61 è¡Œï¼šæ˜¯ JDK è‡ªå¸¦çš„å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ç»“æœã€‚

- ç¬¬ 62 è‡³ 66 è¡Œï¼šæ˜¯ Dubbo æœ¬èº«çš„å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ç»“æœã€‚

- ç¬¬ 70 è¡Œï¼šå¦åˆ™ï¼ŒåŒ…è£…æˆ RuntimeException å¼‚å¸¸è¿”å›ç»™æœåŠ¡æ¶ˆè´¹è€…ï¼ŒåŒæ—¶æŠŠå¼‚å¸¸å †æ ˆç»™åŒ…è¿›å»ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  public static String toString(Throwable e) {
      UnsafeStringWriter w = new UnsafeStringWriter();
      PrintWriter p = new PrintWriter(w);
      p.print(e.getClass().getName());
      if (e.getMessage() != null) {
          p.print(": " + e.getMessage());
      }
      p.println();
      try {
          e.printStackTrace(p);
          return w.toString();
      } finally {
          p.close();
      }
  }
  ```

- å¢™è£‚æ¨è [ã€ŠDubbo(å››) å¼‚å¸¸å¤„ç†ã€‹](https://blog.csdn.net/qq315737546/article/details/53915067)

- [ã€Šæµ…è°ˆ Dubbo çš„ ExceptionFilter å¼‚å¸¸å¤„ç†ã€‹](https://blog.csdn.net/mj158518/article/details/51228649)

# 8ã€TokenFilter

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº« TokenFilter è¿‡æ»¤å™¨ï¼Œç”¨äºæœåŠ¡**æä¾›è€…**ä¸­ï¼Œæä¾› **ä»¤ç‰ŒéªŒè¯** çš„åŠŸèƒ½ã€‚åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ä»¤ç‰ŒéªŒè¯ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/token-authorization.html) å®šä¹‰å¦‚ä¸‹ï¼š

> é€šè¿‡ä»¤ç‰ŒéªŒè¯åœ¨**æ³¨å†Œä¸­å¿ƒ**æ§åˆ¶æƒé™ï¼Œä»¥å†³å®šè¦ä¸è¦ä¸‹å‘ä»¤ç‰Œç»™æ¶ˆè´¹è€…ï¼Œå¯ä»¥é˜²æ­¢æ¶ˆè´¹è€…ç»•è¿‡æ³¨å†Œä¸­å¿ƒè®¿é—®æä¾›è€…ã€‚
>
> å¦å¤–é€šè¿‡æ³¨å†Œä¸­å¿ƒå¯çµæ´»æ”¹å˜æˆæƒæ–¹å¼ï¼Œè€Œä¸éœ€ä¿®æ”¹æˆ–å‡çº§æä¾›è€…ã€‚
>
> ![è®¤è¯æµç¨‹](http://static.iocoder.cn/images/Dubbo/2018_11_19/01.png)

- å®˜æ–¹æ–‡æ¡£å†™çš„å¾ˆå…¨ï¼Œèƒ–å‹è¯·ç‚¹å‡»é“¾æ¥çœ‹å®Œå“ˆã€‚

So ï¼Œå¯èƒ½å’Œå¤§å¤šæ•°èƒ–å‹ï¼ˆåŒ…æ‹¬æˆ‘ï¼‰ï¼Œä¸€å¼€å§‹ç†è§£å’ŒæœŸæœ›çš„ä¸å¤ªä¸€æ · ğŸ™‚ ã€‚

## 2.ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘éšæœº Token

åœ¨ ServiceConfig çš„ `#doExportUrlsFor1Protocol(protocolConfig, registryURLs)` æ–¹æ³•ä¸­ï¼Œéšæœºç”Ÿæˆ Token ï¼š

```
// token ï¼Œå‚è§ã€Šä»¤ç‰Œæ ¡éªŒã€‹http://dubbo.apache.org/zh-cn/docs/user/demos/token-authorization.html
if (!ConfigUtils.isEmpty(token)) {
    if (ConfigUtils.isDefault(token)) { // true || default æ—¶ï¼ŒUUID éšæœºç”Ÿæˆ
        map.put("token", UUID.randomUUID().toString());
    } else {
        map.put("token", token);
    }
}
```

## 3.ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘æ¥æ”¶ Token

æœåŠ¡**æ¶ˆè´¹è€…**ï¼Œä»æ³¨å†Œä¸­å¿ƒï¼Œè·å–æœåŠ¡æä¾›è€…çš„ **URL** ï¼Œä»è€Œè·å¾—è¯¥æœåŠ¡ç€çš„ Token ã€‚
æ‰€ä»¥ï¼Œå³ä½¿æœåŠ¡æä¾›è€…éšæœºç”Ÿæˆ Token ï¼Œæ¶ˆè´¹è€…ä¸€æ ·å¯ä»¥æ‹¿åˆ°ã€‚

## 3.ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘å‘é€ Token

RpcInvocation åœ¨åˆ›å»ºæ—¶ï¼Œâ€œ**è‡ªåŠ¨**â€å¸¦ä¸Š Token ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![RpcInvocation](http://static.iocoder.cn/images/Dubbo/2018_11_19/02.png)

## 4.ã€æœåŠ¡æä¾›è€…ã€‘è®¤è¯ Token

`com.alibaba.dubbo.rpc.filter.TokenFilter` ï¼Œå®ç° Filter æ¥å£ï¼Œ**ä»¤ç‰ŒéªŒè¯** Filter å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Activate(group = Constants.PROVIDER, value = Constants.TOKEN_KEY)
public class TokenFilter implements Filter {

    @Override
    public Result invoke(Invoker<?> invoker, Invocation inv) throws RpcException {
        // è·å¾—æœåŠ¡æä¾›è€…é…ç½®çš„ Token å€¼
        String token = invoker.getUrl().getParameter(Constants.TOKEN_KEY);
        if (ConfigUtils.isNotEmpty(token)) {
            // ä»éšå¼å‚æ•°ä¸­ï¼Œè·å¾— Token å€¼ã€‚
            Class<?> serviceType = invoker.getInterface();
            Map<String, String> attachments = inv.getAttachments();
            String remoteToken = attachments == null ? null : attachments.get(Constants.TOKEN_KEY);
            // å¯¹æ¯”ï¼Œè‹¥ä¸ä¸€è‡´ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸
            if (!token.equals(remoteToken)) {
                throw new RpcException("Invalid token! Forbid invoke remote service " + serviceType + " method " + inv.getMethodName() + "() from consumer " + RpcContext.getContext().getRemoteHost() + " to provider " + RpcContext.getContext().getLocalHost());
            }
        }
        // æœåŠ¡è°ƒç”¨
        return invoker.invoke(inv);
    }

}
```

# 9ã€TpsLimitFilter

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº« TpsLimitFilter è¿‡æ»¤å™¨ï¼Œç”¨äºæœåŠ¡**æä¾›è€…**ä¸­ï¼Œæä¾› **é™æµ** çš„åŠŸèƒ½ã€‚

**é…ç½®æ–¹å¼**

â‘  é€šè¿‡ `<dubbo:parameter key="tps" value="" />` é…ç½®é¡¹ï¼Œæ·»åŠ åˆ° `<dubbo:service />` æˆ– `<dubbo:provider />` æˆ– `<dubbo:protocol />` ä¸­å¼€å¯ï¼Œä¾‹å¦‚ï¼š

```
<dubbo:service interface="com.alibaba.dubbo.demo.DemoService" ref="demoServiceImpl" protocol="injvm" >
    <dubbo:parameter key="tps" value="100" />
</dubbo:service>
```

â‘¡ é€šè¿‡ `<dubbo:parameter key="tps.interval" value="" />` é…ç½®é¡¹ï¼Œè®¾ç½® TPS **å‘¨æœŸ**ã€‚

**æ³¨æ„**

ç¬”è€…é˜…è¯»çš„ Dubbo ç‰ˆæœ¬ï¼Œç›®å‰æš‚æœªé…ç½® TpsLimitFilter åˆ° Dubbo SPI æ–‡ä»¶é‡Œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ åˆ° `com.alibaba.dubbo.rpc.Filter` ä¸­ï¼Œä¾‹å¦‚ï¼š

```
tps=com.alibaba.dubbo.rpc.filter.TpsLimitFilter
```

## 2. TpsLimitFilter

`com.alibaba.dubbo.rpc.filter.TpsLimitFilter` ï¼Œå®ç° Filter æ¥å£ï¼ŒTPS é™æµè¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: @Activate(group = Constants.PROVIDER, value = Constants.TPS_LIMIT_RATE_KEY)
 2: public class TpsLimitFilter implements Filter {
 3: 
 4:     private final TPSLimiter tpsLimiter = new DefaultTPSLimiter();
 5: 
 6:     @Override
 7:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
 8:         if (!tpsLimiter.isAllowable(invoker.getUrl(), invocation)) {
 9:             throw new RpcException(
10:                     new StringBuilder(64)
11:                             .append("Failed to invoke service ")
12:                             .append(invoker.getInterface().getName())
13:                             .append(".")
14:                             .append(invocation.getMethodName())
15:                             .append(" because exceed max service tps.")
16:                             .toString());
17:         }
18:         // æœåŠ¡è°ƒç”¨
19:         return invoker.invoke(invocation);
20:     }
21: 
22: }
```

- ç¬¬ 8 è‡³ 17 è¡Œï¼šè°ƒç”¨ `TPSLimiter#isAllowable(url, invocation)` æ–¹æ³•ï¼Œæ ¹æ® tps é™æµè§„åˆ™åˆ¤æ–­æ˜¯å¦é™åˆ¶æ­¤æ¬¡è°ƒç”¨ã€‚è‹¥æ˜¯ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚ç›®å‰ä½¿ç”¨ TPSLimiter ä½œä¸ºé™æµå™¨çš„å®ç°ç±»ã€‚
- ç¬¬ 19 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

## 3. TPSLimiter

`com.alibaba.dubbo.rpc.filter.tps.TPSLimiter` ï¼ŒTPS é™åˆ¶å™¨æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public interface TPSLimiter {

    /**
     * judge if the current invocation is allowed by TPS rule
     *
     * æ ¹æ® tps é™æµè§„åˆ™åˆ¤æ–­æ˜¯å¦é™åˆ¶æ­¤æ¬¡è°ƒç”¨.
     *
     * @param url        url
     * @param invocation invocation
     * @return true allow the current invocation, otherwise, return false
     */
    boolean isAllowable(URL url, Invocation invocation);

}
```

#### 3.1 DefaultTPSLimiter

`com.alibaba.dubbo.rpc.filter.tps.DefaultTPSLimiter` ï¼Œå®ç° TPSLimiter æ¥å£ï¼Œ**é»˜è®¤** TPS é™åˆ¶å™¨å®ç°ç±»ï¼Œ**ä»¥æœåŠ¡ä¸ºç»´åº¦**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: public class DefaultTPSLimiter implements TPSLimiter {
 2: 
 3:     /**
 4:      * StatItem é›†åˆ
 5:      *
 6:      * keyï¼šæœåŠ¡å
 7:      */
 8:     private final ConcurrentMap<String, StatItem> stats = new ConcurrentHashMap<String, StatItem>();
 9: 
10:     @Override
11:     public boolean isAllowable(URL url, Invocation invocation) {
12:         // è·å¾— TPS å¤§å°é…ç½®é¡¹
13:         int rate = url.getParameter(Constants.TPS_LIMIT_RATE_KEY, -1);
14:         // è·å¾— TPS å‘¨æœŸé…ç½®é¡¹ï¼Œé»˜è®¤ 60 ç§’
15:         long interval = url.getParameter(Constants.TPS_LIMIT_INTERVAL_KEY, Constants.DEFAULT_TPS_LIMIT_INTERVAL);
16:         String serviceKey = url.getServiceKey();
17:         // è¦é™æµ
18:         if (rate > 0) {
19:             // è·å¾— StatItem å¯¹è±¡
20:             StatItem statItem = stats.get(serviceKey);
21:             // ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»º
22:             if (statItem == null) {
23:                 stats.putIfAbsent(serviceKey, new StatItem(serviceKey, rate, interval));
24:                 statItem = stats.get(serviceKey);
25:             }
26:             // æ ¹æ® TPS é™æµè§„åˆ™åˆ¤æ–­æ˜¯å¦é™åˆ¶æ­¤æ¬¡è°ƒç”¨.
27:             return statItem.isAllowable(url, invocation);
28:         // ä¸é™æµ
29:         } else {
30:             // ç§»é™¤ StatItem
31:             StatItem statItem = stats.get(serviceKey);
32:             if (statItem != null) {
33:                 stats.remove(serviceKey);
34:             }
35:             // è¿”å›é€šè¿‡
36:             return true;
37:         }
38:     }
39: 
40: }
```

- `stats` å±æ€§ï¼ŒStatItem é›†åˆï¼ŒKey ä¸º æœåŠ¡åï¼Œ**å³ä»¥æœåŠ¡ä¸ºç»´åº¦**ã€‚
- ç¬¬ 13 è¡Œï¼šè·å¾— TPS å¤§å°é…ç½®é¡¹ `"tps"`ã€‚
- ç¬¬ 15 è¡Œï¼šè·å¾— TPS å‘¨æœŸé…ç½®é¡¹ `"tps.interval"`ï¼Œé»˜è®¤ 60 * 1000 æ¯«ç§’ã€‚
- ç¬¬ 17 è‡³ 27 è¡Œï¼šè‹¥è¦é™æµï¼Œè°ƒç”¨ `StatItem#isAllowable(url, invocation)` æ–¹æ³•ï¼Œæ ¹æ® TPS é™æµè§„åˆ™åˆ¤æ–­æ˜¯å¦é™åˆ¶æ­¤æ¬¡è°ƒç”¨ã€‚
- ç¬¬ 28 è‡³ 37 è¡Œï¼šè‹¥ä¸é™æµï¼Œç§»é™¤ StatItem å¯¹è±¡ã€‚

#### 3.2 StatItem

`com.alibaba.dubbo.rpc.filter.tps.StatItem` ï¼Œç»Ÿè®¡é¡¹ã€‚

###### 3.2.1 æ„é€ æ–¹æ³•

```
/**
 * ç»Ÿè®¡åï¼Œç›®å‰ä½¿ç”¨æœåŠ¡å
 */
private String name;
/**
 * å‘¨æœŸ
 */
private long interval;
/**
 * é™åˆ¶å¤§å°
 */
private int rate;
/**
 * æœ€åé‡ç½®æ—¶é—´
 */
private long lastResetTime;
/**
 * å½“å‰å‘¨æœŸï¼Œå‰©ä½™ç§å­æ•°
 */
private AtomicInteger token;

StatItem(String name, int rate, long interval) {
    this.name = name;
    this.rate = rate;
    this.interval = interval;
    this.lastResetTime = System.currentTimeMillis();
    this.token = new AtomicInteger(rate);
}
```

###### 3.2.2 isAllowable

```
public boolean isAllowable(URL url, Invocation invocation) {
    // è‹¥åˆ°è¾¾ä¸‹ä¸€ä¸ªå‘¨æœŸï¼Œæ¢å¤å¯ç”¨ç§å­æ•°ï¼Œè®¾ç½®æœ€åé‡ç½®æ—¶é—´ã€‚
    long now = System.currentTimeMillis();
    if (now > lastResetTime + interval) {
        token.set(rate); // å›å¤å¯ç”¨ç§å­æ•°
        lastResetTime = now; // æœ€åé‡ç½®æ—¶é—´
    }

    // CAS ï¼Œç›´åˆ°æˆ–å¾—åˆ°ä¸€ä¸ªç§å­ï¼Œæˆ–è€…æ²¡æœ‰è¶³å¤Ÿç§å­
    int value = token.get();
    boolean flag = false;
    while (value > 0 && !flag) {
        flag = token.compareAndSet(value, value - 1);
        value = token.get();
    }

    // æ˜¯å¦æˆåŠŸ
    return flag;
}
```

# 10ã€CacheFilter

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº« `dubbo-filter-cache` é¡¹ç›®çš„ CacheFilter è¿‡æ»¤å™¨ï¼Œç”¨äºæœåŠ¡**æ¶ˆè´¹è€…**å’Œ**æä¾›è€…**ä¸­ï¼Œæä¾› **ç»“æœç¼“å­˜** çš„åŠŸèƒ½ã€‚åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ç»“æœç¼“å­˜ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/result-cache.html) å®šä¹‰å¦‚ä¸‹ï¼š

> ç»“æœç¼“å­˜ ï¼Œç”¨äºåŠ é€Ÿçƒ­é—¨æ•°æ®çš„è®¿é—®é€Ÿåº¦ï¼ŒDubbo æä¾›å£°æ˜å¼ç¼“å­˜ï¼Œä»¥å‡å°‘ç”¨æˆ·åŠ ç¼“å­˜çš„å·¥ä½œé‡ã€‚

Dubbo æä¾›äº†**ä¸‰ç§**å®ç°ï¼š

> - `lru` ï¼šåŸºäºæœ€è¿‘æœ€å°‘ä½¿ç”¨åŸåˆ™åˆ é™¤å¤šä½™ç¼“å­˜ï¼Œä¿æŒæœ€çƒ­çš„æ•°æ®è¢«ç¼“å­˜ã€‚
> - `threadlocal` ï¼šå½“å‰çº¿ç¨‹ç¼“å­˜ï¼Œæ¯”å¦‚ä¸€ä¸ªé¡µé¢æ¸²æŸ“ï¼Œç”¨åˆ°å¾ˆå¤š portalï¼Œæ¯ä¸ª portal éƒ½è¦å»æŸ¥ç”¨æˆ·ä¿¡æ¯ï¼Œé€šè¿‡çº¿ç¨‹ç¼“å­˜ï¼Œå¯ä»¥å‡å°‘è¿™ç§å¤šä½™è®¿é—®ã€‚
> - `jcache` ï¼šä¸ [JSR107](https://jcp.org/en/jsr/detail?id=107) é›†æˆï¼Œå¯ä»¥æ¡¥æ¥å„ç§ç¼“å­˜å®ç°ã€‚

- å…·ä½“çš„é…ç½®æ–¹å¼ï¼Œåœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ç»“æœç¼“å­˜ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/result-cache.html) æ–‡æ¡£ä¸­ï¼Œå·²ç»è¯¦ç»†åˆ†äº«ã€‚

æœ¬æ–‡æ¶‰åŠçš„ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![ç±»å›¾](http://static.iocoder.cn/images/Dubbo/2018_11_21/01.png)](http://static.iocoder.cn/images/Dubbo/2018_11_21/01.png)ç±»å›¾

## 2. CacheFilter

`com.alibaba.dubbo.cache.filter.CacheFilter` ï¼Œå®ç° Filter æ¥å£ï¼Œç¼“å­˜è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: @Activate(group = {Constants.CONSUMER, Constants.PROVIDER}, value = Constants.CACHE_KEY)
 2: public class CacheFilter implements Filter {
 3: 
 4:     /**
 5:      * CacheFactory$Adaptive å¯¹è±¡ã€‚
 6:      *
 7:      * é€šè¿‡ Dubbo SPI æœºåˆ¶ï¼Œè°ƒç”¨ {@link #setCacheFactory(CacheFactory)} æ–¹æ³•ï¼Œè¿›è¡Œæ³¨å…¥
 8:      */
 9:     private CacheFactory cacheFactory;
10: 
11:     public void setCacheFactory(CacheFactory cacheFactory) {
12:         this.cacheFactory = cacheFactory;
13:     }
14: 
15:     @Override
16:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
17:         // æ–¹æ³•å¼€å¯ Cache åŠŸèƒ½
18:         if (cacheFactory != null && ConfigUtils.isNotEmpty(invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.CACHE_KEY))) {
19:             // åŸºäº URL + Method ä¸ºç»´åº¦ï¼Œè·å¾— Cache å¯¹è±¡ã€‚
20:             Cache cache = cacheFactory.getCache(invoker.getUrl().addParameter(Constants.METHOD_KEY, invocation.getMethodName())); // æ·»åŠ  `method` å±æ€§ï¼Œæ˜¯å› ä¸º JCache éœ€è¦ã€‚
21:             if (cache != null) {
22:                 // è·å¾— Cache Key
23:                 String key = StringUtils.toArgumentString(invocation.getArguments());
24:                 // ä»ç¼“å­˜ä¸­è·å¾—ç»“æœã€‚è‹¥å­˜åœ¨ï¼Œåˆ›å»º RpcResult å¯¹è±¡ã€‚
25:                 Object value = cache.get(key);
26:                 if (value != null) {
27:                     return new RpcResult(value);
28:                 }
29:                 // æœåŠ¡è°ƒç”¨
30:                 Result result = invoker.invoke(invocation);
31:                 // è‹¥éå¼‚å¸¸ç»“æœï¼Œç¼“å­˜ç»“æœ
32:                 if (!result.hasException()) {
33:                     cache.put(key, result.getValue());
34:                 }
35:                 return result;
36:             }
37:         }
38:         // æœåŠ¡è°ƒç”¨
39:         return invoker.invoke(invocation);
40:     }
41: 
42: }
```

- ç¬¬ 18 è¡Œï¼šåˆ¤æ–­æ–¹æ³•**å¼€å¯** Cache åŠŸèƒ½ã€‚å› ä¸ºï¼Œä¸€ä¸ªæœåŠ¡é‡Œï¼Œå¯èƒ½åªæœ‰**éƒ¨åˆ†**æ–¹æ³•å¼€å¯äº† Cache åŠŸèƒ½ã€‚

- ç¬¬ 20 è¡Œï¼šè°ƒç”¨ `CacheFactory$Adaptive#getCache(url)` æ–¹æ³•ï¼ŒåŸºäº **URL + Method** ä¸ºç»´åº¦ï¼Œè·å¾— Cache å¯¹è±¡ã€‚

- ç¬¬ 23 è¡Œï¼šè°ƒç”¨ `StringUtils#toArgumentString(Object[] args)` æ–¹æ³•ï¼Œè·å¾— Cache Key ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  /**
   * å°†å‚æ•°æ•°ç»„ï¼Œæ‹¼æ¥æˆå­—ç¬¦ä¸²ã€‚
   *
   * 1. ä½¿ç”¨é€—å·åˆ†éš”
   * 2. ä½¿ç”¨ JSON æ ¼å¼åŒ–å¯¹è±¡
   *
   * @param args å‚æ•°æ•°ç»„
   * @return å­—ç¬¦ä¸²
   */
  public static String toArgumentString(Object[] args) {
      StringBuilder buf = new StringBuilder();
      for (Object arg : args) {
          if (buf.length() > 0) {
              buf.append(Constants.COMMA_SEPARATOR); // åˆ†éš”
          }
          // æ‹¼æ¥å‚æ•°
          if (arg == null || ReflectUtils.isPrimitives(arg.getClass())) {
              buf.append(arg);
          } else {
              try {
                  buf.append(JSON.toJSONString(arg)); // ä½¿ç”¨ JSON æ ¼å¼åŒ–å¯¹è±¡
              } catch (Exception e) {
                  logger.warn(e.getMessage(), e);
                  buf.append(arg);
              }
          }
      }
      return buf.toString();
  }
  ```

- ç¬¬ 24 è‡³ 28 è¡Œï¼šè°ƒç”¨ `Cache#get(key)` æ–¹æ³•ï¼Œä»ç¼“å­˜ä¸­è·å¾—ç»“æœã€‚è‹¥**å­˜åœ¨**ï¼Œåˆ›å»º RpcResult å¯¹è±¡å¹¶è¿”å›ã€‚

- ç¬¬ 30 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 31 è‡³ 34 è¡Œï¼šè‹¥**éå¼‚å¸¸**ï¼Œè°ƒç”¨ `Cache#put(key, value)` æ–¹æ³•ï¼Œç¼“å­˜**æ­£å¸¸çš„**ç»“æœã€‚

- ç¬¬ 35 è¡Œï¼šè¿”å›è°ƒç”¨ç»“æœã€‚

- ç¬¬ 39 è¡Œï¼šè‹¥**ä¸ä½¿ç”¨** Cache åŠŸèƒ½ï¼Œ**ç›´æ¥**è°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

## 3. API å®šä¹‰

#### 3.1 Cache

`com.alibaba.dubbo.cache.Cache` ï¼Œç¼“å­˜**å®¹å™¨**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
public interface Cache {

    /**
     * æ·»åŠ é”®å€¼
     *
     * @param key é”®
     * @param value å€¼
     */
    void put(Object key, Object value);

    /**
     * è·å¾—å€¼
     *
     * @param key é”®
     * @return å€¼
     */
    Object get(Object key);

}
```

- Cache æ˜¯ä¸ªç¼“å­˜**å®¹å™¨**ï¼Œå†…éƒ¨å¯ä»¥**ç®¡ç†**ç¼“å­˜çš„é”®å€¼ã€‚

#### 3.2 CacheFactory

`com.alibaba.dubbo.cache.CacheFactory` ï¼ŒCache å·¥å‚**æ¥å£**ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
@SPI("lru")
public interface CacheFactory {

    /**
     * è·å¾—ç¼“å­˜å¯¹è±¡
     *
     * @param url URL å¯¹è±¡
     * @return ç¼“å­˜å¯¹è±¡
     */
    @Adaptive("cache")
    Cache getCache(URL url);

}
```

- `@SPI("lru")` æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œé»˜è®¤ä¸º `"lru"` ã€‚
- `@Adaptive("cache")` æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Cache å®ç°ï¼Œä½¿ç”¨ `URL.cache` å±æ€§ã€‚

###### 3.2.1 AbstractCacheFactory

`com.alibaba.dubbo.cache.support.AbstractCacheFactory` ï¼ŒCache å·¥å‚**æŠ½è±¡ç±»**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public abstract class AbstractCacheFactory implements CacheFactory {

    /**
     * Cache é›†åˆ
     *
     * keyï¼šURL
     */
    private final ConcurrentMap<String, Cache> caches = new ConcurrentHashMap<String, Cache>();

    @Override
    public Cache getCache(URL url) {
        // è·å¾— Cache å¯¹è±¡
        String key = url.toFullString();
        Cache cache = caches.get(key);
        // ä¸å­˜åœ¨ï¼Œåˆ›å»º Cache å¯¹è±¡ï¼Œå¹¶ç¼“å­˜
        if (cache == null) {
            caches.put(key, createCache(url));
            cache = caches.get(key);
        }
        return cache;
    }

    /**
     * åˆ›å»º Cache å¯¹è±¡
     *
     * @param url URL
     * @return Cache å¯¹è±¡
     */
    protected abstract Cache createCache(URL url);

}
```

## 4. LRU å®ç°

`lru` ï¼ŒåŸºäºæœ€è¿‘æœ€å°‘ä½¿ç”¨åŸåˆ™åˆ é™¤å¤šä½™ç¼“å­˜ï¼Œä¿æŒæœ€çƒ­çš„æ•°æ®è¢«ç¼“å­˜ã€‚

#### 4.1 LruCache

`com.alibaba.dubbo.cache.support.lru.LruCache` ï¼Œå®ç° Cache æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class LruCache implements Cache {

    /**
     * ç¼“å­˜é›†åˆ
     */
    private final Map<Object, Object> store;

    public LruCache(URL url) {
        // `"cache.size"` é…ç½®é¡¹ï¼Œè®¾ç½®ç¼“å­˜å¤§å°
        final int max = url.getParameter("cache.size", 1000);
        // åˆ›å»º LRUCache å¯¹è±¡
        this.store = new LRUCache<Object, Object>(max);
    }

    @Override
    public void put(Object key, Object value) {
        store.put(key, value);
    }

    @Override
    public Object get(Object key) {
        return store.get(key);
    }

}
```

- `"cache.size"` é…ç½®é¡¹ï¼Œè®¾ç½®ç¼“å­˜**å¤§å°**ã€‚
- åŸºäº `com.alibaba.dubbo.common.utils.LRUCache` å®ç°ã€‚

###### 4.1.1 LRUCache

[`com.alibaba.dubbo.common.utils.LRUCache`](https://github.com/YunaiV/dubbo/blob/26d2f1811c23096224fc9a973b3526f01aabeb28/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/LRUCache.java) ï¼Œå®ç° LinkedHashMap ç±»ï¼ŒLRU ç¼“å­˜å®ç°ç±»ã€‚ä»£ç æ¯”è¾ƒå¤šï¼Œèƒ–å‹ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚ç¬”è€…è¯´å‡ ä¸ªå…³é”®ç‚¹ï¼š

- æ„é€ æ–¹æ³•ï¼Œè®¾ç½® LRUCache ä¸º**æŒ‰è®¿é—®é¡ºåº(è°ƒç”¨getæ–¹æ³•)**çš„é“¾è¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  public LRUCache(int maxCapacity) {
      super(16, DEFAULT_LOAD_FACTOR, true); // æœ€åä¸€ä¸ªå‚æ•°ï¼ŒæŒ‰è®¿é—®é¡ºåº(è°ƒç”¨getæ–¹æ³•)çš„é“¾è¡¨
      this.maxCapacity = maxCapacity;
  }
  ```

- é‡å†™ removeEldestEntry æ–¹æ³•è¿”å› true å€¼ï¼ŒæŒ‡å®šæ’å…¥å…ƒç´ æ—¶ç§»é™¤æœ€è€çš„å…ƒç´ ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  @Override
  protected boolean removeEldestEntry(java.util.Map.Entry<K, V> eldest) {
      return size() > maxCapacity;
  }
  ```

  - æ ¹æ®é“¾è¡¨ä¸­å…ƒç´ çš„é¡ºåºå¯ä»¥åˆ†ä¸ºï¼šæŒ‰æ’å…¥é¡ºåºçš„é“¾è¡¨ï¼Œå’ŒæŒ‰è®¿é—®é¡ºåº(è°ƒç”¨getæ–¹æ³•)çš„é“¾è¡¨ã€‚é»˜è®¤æ˜¯æŒ‰æ’å…¥é¡ºåºæ’åºï¼Œå¦‚æœæŒ‡å®šæŒ‰è®¿é—®é¡ºåºæ’åºï¼Œé‚£ä¹ˆè°ƒç”¨getæ–¹æ³•åï¼Œä¼šå°†è¿™æ¬¡è®¿é—®çš„å…ƒç´ ç§»è‡³é“¾è¡¨å°¾éƒ¨ï¼Œä¸æ–­è®¿é—®å¯ä»¥å½¢æˆæŒ‰è®¿é—®é¡ºåºæ’åºçš„é“¾è¡¨ã€‚

- `lock` å±æ€§ï¼Œé”ã€‚é¿å…å¹¶å‘è¯»å†™ï¼Œå¯¼è‡´æ­»é”ã€‚å‚è§ [ã€Šç–«è‹—ï¼šJAVA HashMap çš„æ­»å¾ªç¯ã€‹](https://coolshell.cn/articles/9606.html) ã€‚æ¶‰åŠè¯¥å±æ€§çš„æ–¹æ³•ç¤ºä¾‹ï¼š

  ```
  @Override
  public V put(K key, V value) {
      try {
          lock.lock();
          return super.put(key, value);
      } finally {
          lock.unlock();
      }
  }
  
  @Override
  public V remove(Object key) {
      try {
          lock.lock();
          return super.remove(key);
      } finally {
          lock.unlock();
      }
  }
  ```

#### 4.2 LruCacheFactory

`com.alibaba.dubbo.cache.support.lru.LruCacheFactory` ï¼Œå®ç° AbstractCacheFactory æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class LruCacheFactory extends AbstractCacheFactory {

    @Override
    protected Cache createCache(URL url) {
        return new LruCache(url);
    }

}
```

## 5. ThreadLocal å®ç°

åŸºäº **ThreadLocal** ï¼Œå½“å‰çº¿ç¨‹ç¼“å­˜ï¼Œæ¯”å¦‚ä¸€ä¸ªé¡µé¢æ¸²æŸ“ï¼Œç”¨åˆ°å¾ˆå¤š portalï¼Œæ¯ä¸ª portal éƒ½è¦å»æŸ¥ç”¨æˆ·ä¿¡æ¯ï¼Œé€šè¿‡çº¿ç¨‹ç¼“å­˜ï¼Œå¯ä»¥å‡å°‘è¿™ç§å¤šä½™è®¿é—®ã€‚

#### 5.1 ThreadLocalCache

`com.alibaba.dubbo.cache.support.threadlocal.ThreadLocalCache` ï¼Œå®ç° Cache æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class ThreadLocalCache implements Cache {

    private final ThreadLocal<Map<Object, Object>> store; // çº¿ç¨‹å˜é‡

    public ThreadLocalCache(URL url) {
        this.store = new ThreadLocal<Map<Object, Object>>() {

            @Override
            protected Map<Object, Object> initialValue() {
                return new HashMap<Object, Object>();
            }

        };
    }

    @Override
    public void put(Object key, Object value) {
        store.get().put(key, value);
    }

    @Override
    public Object get(Object key) {
        return store.get().get(key);
    }

}
```

- åŸºäº ThreadLocal å®ç°ï¼Œç›¸å½“äºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ª ThreadLocalCache å¯¹è±¡ã€‚
- ğŸ™‚ ThreadLocalCache ç›®å‰æ²¡æœ‰è¿‡æœŸæˆ–æ¸…ç†æœºåˆ¶ï¼Œæ‰€ä»¥**éœ€è¦æ³¨æ„**ã€‚

#### 5.2 ThreadLocalCacheFactory

`com.alibaba.dubbo.cache.support.threadlocal.ThreadLocalCacheFactory` ï¼Œå®ç° AbstractCacheFactory æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class ThreadLocalCacheFactory extends AbstractCacheFactory {

    @Override
    protected Cache createCache(URL url) {
        return new ThreadLocalCache(url);
    }

}
```

## 6. JCache å®ç°

ä¸ [JSR107](https://jcp.org/en/jsr/detail?id=107) é›†æˆï¼Œå¯ä»¥æ¡¥æ¥å„ç§ç¼“å­˜å®ç°ã€‚

#### 6.1 JCache

`com.alibaba.dubbo.cache.support.jcache.JCache` ï¼Œå®ç° Cache æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class JCache implements com.alibaba.dubbo.cache.Cache {

    private final Cache<Object, Object> store;

    public JCache(URL url) {
        // è·å¾— Cache Key
        String method = url.getParameter(Constants.METHOD_KEY, "");
        String key = url.getAddress() + "." + url.getServiceKey() + "." + method;
        // `"jcache"` é…ç½®é¡¹ï¼Œä¸º Java SPI å®ç°çš„å…¨é™å®šç±»å
        // jcache parameter is the full-qualified class name of SPI implementation
        String type = url.getParameter("jcache");

        // åŸºäºç±»å‹ï¼Œè·å¾— javax.cache.CachingProvider å¯¹è±¡ï¼Œ
        CachingProvider provider = type == null || type.length() == 0 ? Caching.getCachingProvider() : Caching.getCachingProvider(type);
        // è·å¾— javax.cache.CacheManager å¯¹è±¡
        CacheManager cacheManager = provider.getCacheManager();
        // è·å¾— javax.cache.Cache å¯¹è±¡
        Cache<Object, Object> cache = cacheManager.getCache(key);
        // ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»º
        if (cache == null) {
            try {
                // è®¾ç½® Cache é…ç½®é¡¹
                // configure the cache
                MutableConfiguration config =
                        new MutableConfiguration<Object, Object>()
                                // ç±»å‹
                                .setTypes(Object.class, Object.class)
                                // è¿‡æœŸç­–ç•¥ï¼ŒæŒ‰ç…§å†™å…¥æ—¶é—´è¿‡æœŸã€‚é€šè¿‡ `"cache.write.expire"` é…ç½®é¡¹è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ä¸º 1 åˆ†é’Ÿã€‚
                                .setExpiryPolicyFactory(CreatedExpiryPolicy.factoryOf(new Duration(TimeUnit.MILLISECONDS, url.getMethodParameter(method, "cache.write.expire", 60 * 1000))))
                                .setStoreByValue(false)
                                // è®¾ç½® MBean
                                .setManagementEnabled(true)
                                .setStatisticsEnabled(true);
                // åˆ›å»º javax.cache.Cache å¯¹è±¡
                cache = cacheManager.createCache(key, config);
            } catch (CacheException e) {
                // åˆå§‹åŒ– cache çš„å¹¶å‘æƒ…å†µ
                // concurrent cache initialization
                cache = cacheManager.getCache(key);
            }
        }

        this.store = cache;
    }

    @Override
    public void put(Object key, Object value) {
        store.put(key, value);
    }

    @Override
    public Object get(Object key) {
        return store.get(key);
    }

}
```

- å·²ç»æ·»åŠ è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚
- ç¬”è€…å¯¹ JCache äº†è§£ä¸å¤šï¼Œæ¨èé˜…è¯» [ã€Š Java Caching(ç¼“å­˜)-ç­–ç•¥å’ŒJCache APIã€‹](https://blog.csdn.net/boonya/article/details/54632129)

#### 6.2 JCacheFactory

`com.alibaba.dubbo.cache.support.jcache.JCacheFactory` ï¼Œå®ç° AbstractCacheFactory æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class JCacheFactory extends AbstractCacheFactory {

    @Override
    protected Cache createCache(URL url) {
        return new JCache(url);
    }

}
```

# 11ã€ValidationFilter

## 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº« `dubbo-filter-validation` é¡¹ç›®çš„ ValidationFilter è¿‡æ»¤å™¨ï¼Œç”¨äºæœåŠ¡**æ¶ˆè´¹è€…**å’Œ**æä¾›è€…**ä¸­ï¼Œæä¾› **å‚æ•°éªŒè¯** çš„åŠŸèƒ½ã€‚åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” å‚æ•°éªŒè¯ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/parameter-validation.html) å®šä¹‰å¦‚ä¸‹ï¼š

> å‚æ•°éªŒè¯åŠŸèƒ½ï¼Œæ˜¯åŸºäº [JSR303](https://jcp.org/en/jsr/detail?id=303) Bean Validation å®ç°çš„ï¼Œç”¨æˆ·åªéœ€æ ‡è¯† JSR303 æ ‡å‡†çš„éªŒè¯ annotationï¼Œå¹¶é€šè¿‡å£°æ˜ filter æ¥å®ç°éªŒè¯ã€‚

- **é…ç½®**å’Œ**ç¤ºä¾‹**ï¼Œå®˜æ–¹æ–‡æ¡£å·²ç»å†™çš„å¾ˆé½å…¨ï¼Œç¬”è€…å°±ä¸å¤šå“”å“”äº†ã€‚

- å¦‚ä¸‹æ˜¯æ–°ç‰ˆæœ¬çš„ Maven ä¾èµ–çš„ä¾‹å­ï¼š

  ```
  <!-- JSR 303 - Bean Validation begin -->
  <dependency>
      <groupId>javax.validation</groupId>
      <artifactId>validation-api</artifactId>
      <version>1.1.0.Final</version>
  </dependency>
  <dependency>
      <groupId>org.hibernate</groupId>
      <artifactId>hibernate-validator</artifactId>
      <version>5.3.4.Final</version>
  </dependency>
  <dependency>
      <groupId>javax.el</groupId>
      <artifactId>javax.el-api</artifactId>
      <version>2.2.4</version>
  </dependency>
  <dependency>
      <groupId>org.glassfish.web</groupId>
      <artifactId>javax.el</artifactId>
      <version>2.2.4</version>
  </dependency>
  <!-- JSR 303 - Bean Validation end -->
  ```

æœ¬æ–‡æ¶‰åŠçš„ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![ç±»å›¾](http://static.iocoder.cn/images/Dubbo/2018_11_22/02.png)](http://static.iocoder.cn/images/Dubbo/2018_11_22/02.png)ç±»å›¾

## 2. ValidationFilter

`com.alibaba.dubbo.validation.filter.ValidationFilter` ï¼Œå®ç° Filter æ¥å£ï¼Œå‚æ•°éªŒè¯è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
 1: @Activate(group = {Constants.CONSUMER, Constants.PROVIDER}, value = Constants.VALIDATION_KEY, order = 10000)
 2: public class ValidationFilter implements Filter {
 3: 
 4:     /**
 5:      * Validation$Adaptive å¯¹è±¡
 6:      *
 7:      * é€šè¿‡ Dubbo SPI æœºåˆ¶ï¼Œè°ƒç”¨ {@link #setValidation(Validation)} æ–¹æ³•ï¼Œè¿›è¡Œæ³¨å…¥
 8:      */
 9:     private Validation validation;
10: 
11:     public void setValidation(Validation validation) {
12:         this.validation = validation;
13:     }
14: 
15:     @Override
16:     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {
17:         if (validation != null && !invocation.getMethodName().startsWith("$") // éæ³›åŒ–è°ƒç”¨å’Œå›éŸ³è°ƒç”¨ç­‰æ–¹æ³•
18:                 && ConfigUtils.isNotEmpty(invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.VALIDATION_KEY))) { // æ–¹æ³•å¼€å¯ Validation åŠŸèƒ½
19:             try {
20:                 // è·å¾— Validator å¯¹è±¡
21:                 Validator validator = validation.getValidator(invoker.getUrl());
22:                 // ä½¿ç”¨ Validator ï¼ŒéªŒè¯æ–¹æ³•å‚æ•°ã€‚è‹¥ä¸åˆæ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
23:                 if (validator != null) {
24:                     validator.validate(invocation.getMethodName(), invocation.getParameterTypes(), invocation.getArguments());
25:                 }
26:             } catch (RpcException e) {
27:                 throw e;
28:             } catch (Throwable t) {
29:                 return new RpcResult(t);
30:             }
31:         }
32:         // æœåŠ¡è°ƒç”¨
33:         return invoker.invoke(invocation);
34:     }
35: 
36: }
```

- ç¬¬ 17 è¡Œï¼šéæ³›åŒ–è°ƒç”¨å’Œå›éŸ³è°ƒç”¨ç­‰æ–¹æ³•ã€‚
- ç¬¬ 18 è¡Œï¼šåˆ¤æ–­æ–¹æ³•**å¼€å¯** Validation åŠŸèƒ½ã€‚å› ä¸ºï¼Œä¸€ä¸ªæœåŠ¡é‡Œï¼Œå¯èƒ½åªæœ‰**éƒ¨åˆ†**æ–¹æ³•å¼€å¯äº† Validation åŠŸèƒ½ã€‚
- ç¬¬ 21 è¡Œï¼šè°ƒç”¨ `Validation$Adaptive#getValidator(url)` æ–¹æ³•ï¼ŒåŸºäº **URL** ä¸ºç»´åº¦ï¼Œè·å¾— Validator å¯¹è±¡ã€‚
- ç¬¬ 22 è‡³ 25 è¡Œï¼šè°ƒç”¨ `Validator#validate(String methodName, Class<?>[] parameterTypes, Object[] arguments)` æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°éªŒè¯ã€‚è‹¥ä¸åˆæ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
- ç¬¬ 33 è¡Œï¼šè°ƒç”¨ `Invoker#invoke(invocation)` æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

## 3. API å®šä¹‰

#### 3.1 Validator

`com.alibaba.dubbo.validation.Validator` ï¼ŒéªŒè¯å™¨æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public interface Validator {

    /**
     * æ–¹æ³•å‚æ•°éªŒè¯
     *
     * @param methodName æ–¹æ³•å
     * @param parameterTypes å‚æ•°ç±»å‹æ•°ç»„
     * @param arguments å‚æ•°å€¼æ•°ç»„
     * @throws Exception å½“å‘ç”Ÿå¼‚å¸¸æ—¶
     */
    void validate(String methodName, Class<?>[] parameterTypes, Object[] arguments) throws Exception;

}
```

#### 3.2 Validation

`com.alibaba.dubbo.validation.Validation` ï¼ŒValidator å·¥å‚**æ¥å£**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@SPI("jvalidation")
public interface Validation {

    /**
     * è·å¾— Validator å¯¹è±¡
     *
     * @param url URL
     * @return Validator
     */
    @Adaptive(Constants.VALIDATION_KEY)
    Validator getValidator(URL url);

}
```

- `@SPI("jvalidation")` æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œé»˜è®¤ä¸º `"jvalidation"` ã€‚
- `@Adaptive("validation")` æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Validator å®ç°ï¼Œä½¿ç”¨ `URL.validation` å±æ€§ã€‚

###### 3.2.1 AbstractValidation

`com.alibaba.dubbo.validation.support.AbstractValidation` ï¼Œå®ç° Validation æ¥å£ï¼ŒValidator å·¥å‚**æŠ½è±¡ç±»**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public abstract class AbstractValidation implements Validation {

    /**
     * Validator é›†åˆ
     *
     * keyï¼šURL
     */
    private final ConcurrentMap<String, Validator> validators = new ConcurrentHashMap<String, Validator>();

    @Override
    public Validator getValidator(URL url) {
        // è·å¾— Validator å¯¹è±¡
        String key = url.toFullString();
        Validator validator = validators.get(key);
        // ä¸å­˜åœ¨ï¼Œåˆ›å»º Validator å¯¹è±¡ï¼Œå¹¶ç¼“å­˜
        if (validator == null) {
            validators.put(key, createValidator(url));
            validator = validators.get(key);
        }
        return validator;
    }

    /**
     * åˆ›å»º Validator å¯¹è±¡
     *
     * @param url URL
     * @return Validator å¯¹è±¡
     */
    protected abstract Validator createValidator(URL url);

}
```

## 3.3 @MethodValidated

`com.alibaba.dubbo.validation.@MethodValidated` ï¼Œæ–¹æ³•åˆ†ç»„éªŒè¯**æ³¨è§£**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface MethodValidated {

    /**
     * @return åˆ†ç»„é›†åˆ
     */
    Class<?>[] value() default {};

}
```

- ä½¿ç”¨åœºæ™¯ï¼šå½“è°ƒç”¨æŸä¸ªæ–¹æ³•æ—¶ï¼Œéœ€è¦æ£€æŸ¥å¤šä¸ªåˆ†ç»„ï¼Œå¯ä»¥åœ¨æ¥å£æ–¹æ³•ä¸ŠåŠ ä¸Šè¯¥æ³¨è§£ã€‚

- ç”¨æ³•ï¼š

  ```
  @MethodValidated({Save.class, Update.class})
  void relatedQuery(ValidationParameter parameter);
  ```

  - åœ¨æ¥å£æ–¹æ³•ä¸Šå¢åŠ æ³¨è§£ï¼Œè¡¨ç¤º `#relatedQuery(ValidationParameter)` è¿™ä¸ªæ–¹æ³•ï¼Œéœ€è¦åŒæ—¶æ£€æŸ¥ Save å’Œ Update è¿™ä¸¤ä¸ªåˆ†ç»„ã€‚
  - å¦‚æœèƒ–å‹å¯¹ Java Bean Validation åˆ†ç»„ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥ç†è§£èµ·æ¥æ¯”è¾ƒç»•ã€‚å¯ä»¥è·‘ä¸‹å®˜æ–¹æä¾›çš„ [`com.alibaba.dubbo.config.validation`](https://github.com/YunaiV/dubbo/tree/f4216485f5641ea5cf406d1e58503c5651f86432/dubbo-config/dubbo-config-api/src/test/java/com/alibaba/dubbo/config/validation) çš„ç«‹è¶³ã€‚[![relatedQuery](http://static.iocoder.cn/images/Dubbo/2018_11_22/01.png)](http://static.iocoder.cn/images/Dubbo/2018_11_22/01.png)relatedQuery

## 4. JSR303 å®ç°

åŸºäº [JSR303](https://jcp.org/en/jsr/detail?id=303) Bean Validation å®ç°çš„ï¼Œç”¨æˆ·åªéœ€æ ‡è¯† JSR303 æ ‡å‡†çš„éªŒè¯ annotation ã€‚

#### 4.1 JValidator

`com.alibaba.dubbo.validation.support.jvalidation.JValidator` ï¼Œå®ç° Validator æ¥å£ï¼ŒåŸºäº [JSR303](https://jcp.org/en/jsr/detail?id=303) çš„éªŒè¯å™¨å®ç°ç±»ã€‚

###### 4.1.1 æ„é€ æ–¹æ³•

```
/**
 * æœåŠ¡æ¥å£ç±»
 */
private final Class<?> clazz;
/**
 * Validator å¯¹è±¡
 */
private final javax.validation.Validator validator;

@SuppressWarnings({"unchecked", "rawtypes"})
public JValidator(URL url) {
    // è·å¾—æœåŠ¡æ¥å£ç±»
    this.clazz = ReflectUtils.forName(url.getServiceInterface());
    // è·å¾— `"jvalidation"` é…ç½®é¡¹
    String jvalidation = url.getParameter("jvalidation");
    // è·å¾— ValidatorFactory å¯¹è±¡
    ValidatorFactory factory;
    if (jvalidation != null && jvalidation.length() > 0) { // æŒ‡å®šå®ç°
        factory = Validation.byProvider((Class) ReflectUtils.forName(jvalidation)).configure().buildValidatorFactory();
    } else { // é»˜è®¤
        factory = Validation.buildDefaultValidatorFactory();
    }
    // è·å¾— javax Validator å¯¹è±¡
    this.validator = factory.getValidator();
}
```

- `"jvalidation"` é…ç½®é¡¹ï¼Œå¯**æŒ‡å®š**å…·ä½“çš„ JSR303 çš„å®ç°ç±»ã€‚
- å¦‚æœæˆ‘ä»¬**æœªé…ç½®**ï¼Œå¹¶ä¸”å¼•å…¥ Hibernate Validator ï¼Œåˆ™ä½¿ç”¨çš„æ˜¯ HibernateValidatorFactory ã€‚

###### 4.1.2 validate

```
 1: @Override
 2: public void validate(String methodName, Class<?>[] parameterTypes, Object[] arguments) throws Exception {
 3:     // éªŒè¯åˆ†ç»„é›†åˆ
 4:     List<Class<?>> groups = new ArrayList<Class<?>>();
 5:     // ã€ç¬¬ä¸€ç§ã€‘æ·»åŠ ä»¥æ–¹æ³•å‘½åçš„å†…éƒ¨æ¥å£ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚ä¾‹å¦‚ `ValidationService#save(...)` æ–¹æ³•ï¼Œå¯¹åº” `ValidationService.Save` æ¥å£ã€‚
 6:     String methodClassName = clazz.getName() + "$" + toUpperMethodName(methodName);
 7:     Class<?> methodClass;
 8:     try {
 9:         methodClass = Class.forName(methodClassName, false, Thread.currentThread().getContextClassLoader());
10:         groups.add(methodClass);
11:     } catch (ClassNotFoundException e) {
12:     }
13:     // ã€ç¬¬äºŒç§ã€‘æ·»åŠ æ–¹æ³•çš„ @MethodValidated æ³¨è§£çš„å€¼å¯¹åº”çš„ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚
14:     Method method = clazz.getMethod(methodName, parameterTypes);
15:     Class<?>[] methodClasses;
16:     if (method.isAnnotationPresent(MethodValidated.class)){
17:         methodClasses = method.getAnnotation(MethodValidated.class).value();
18:         groups.addAll(Arrays.asList(methodClasses));
19:     }
20:     // ã€ç¬¬ä¸‰ç§ã€‘æ·»åŠ  Default.class ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚åœ¨ JSR 303 ä¸­ï¼Œæœªè®¾ç½®åˆ†ç»„çš„éªŒè¯æ³¨è§£ï¼Œä½¿ç”¨ Default.class ã€‚
21:     // add into default group
22:     groups.add(0, Default.class);
23:     // ã€ç¬¬å››ç§ã€‘æ·»åŠ æœåŠ¡æ¥å£ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚
24:     groups.add(1, clazz);
25:     // convert list to array
26:     Class<?>[] classGroups = groups.toArray(new Class[0]);
27: 
28:     // éªŒè¯é”™è¯¯é›†åˆ
29:     Set<ConstraintViolation<?>> violations = new HashSet<ConstraintViolation<?>>();
30:     // ã€ç¬¬ä¸€æ­¥ã€‘è·å¾—æ–¹æ³•å‚æ•°çš„ Bean å¯¹è±¡ã€‚å› ä¸ºï¼ŒJSR 303 æ˜¯ Java Bean Validation ï¼Œä»¥ Bean ä¸ºç»´åº¦ã€‚
31:     Object parameterBean = getMethodParameterBean(clazz, method, arguments);
32:     // ã€ç¬¬ä¸€æ­¥ã€‘éªŒè¯ Bean å¯¹è±¡ã€‚
33:     if (parameterBean != null) {
34:         violations.addAll(validator.validate(parameterBean, classGroups));
35:     }
36:     // ã€ç¬¬äºŒæ­¥ã€‘éªŒè¯é›†åˆå‚æ•°
37:     for (Object arg : arguments) {
38:         validate(violations, arg, classGroups);
39:     }
40:     // è‹¥æœ‰é”™è¯¯ï¼ŒæŠ›å‡º ConstraintViolationException å¼‚å¸¸ã€‚
41:     if (!violations.isEmpty()) {
42:         logger.error("Failed to validate service: " + clazz.getName() + ", method: " + methodName + ", cause: " + violations);
43:         throw new ConstraintViolationException("Failed to validate service: " + clazz.getName() + ", method: " + methodName + ", cause: " + violations, violations);
44:     }
45: }
```

- ============ ã€ç¬¬ä¸€æ­¥ã€‘è·å¾—éªŒè¯åˆ†ç»„é›†åˆ ============

- ç¬¬ 4 è¡Œï¼šéªŒè¯åˆ†ç»„é›†åˆ `group` ï¼Œç›®å‰æœ‰å››ç§æ¥æºã€‚

- ã€ç¬¬ä¸€ç§ã€‘ç¬¬ 5 è‡³ 12 è¡Œï¼šæ·»åŠ ä»¥æ–¹æ³•å‘½åçš„å†…éƒ¨æ¥å£ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚ä¾‹å¦‚ `ValidationService#save(...)` æ–¹æ³•ï¼Œå¯¹åº” `ValidationService.Save` æ¥å£ã€‚

- ã€ç¬¬äºŒç§ã€‘ç¬¬ 13 è‡³ 19 è¡Œï¼šæ·»åŠ æ–¹æ³•çš„ `@MethodValidated` æ³¨è§£çš„å€¼å¯¹åº”çš„ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚

- ã€ç¬¬ä¸‰ç§ã€‘ç¬¬ 22 è¡Œï¼šæ·»åŠ  Default.class ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚åœ¨ JSR 303 ä¸­ï¼Œæœªè®¾ç½®åˆ†ç»„çš„éªŒè¯æ³¨è§£ï¼Œä½¿ç”¨ Default.class ã€‚

- ã€ç¬¬å››ç§ã€‘ç¬¬ 24 è¡Œï¼šæ·»åŠ æœåŠ¡æ¥å£ç±» `clazz` ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚

- æœ€ç»ˆç”Ÿæˆçš„éªŒè¯åˆ†ç»„é›†åˆçš„é¡ºåºä¸ºï¼šã€ç¬¬ä¸‰ç§ã€‘ã€‹ã€ç¬¬å››ç§ã€‘ã€‹ã€ç¬¬ä¸€ç§ã€‘ã€‹ã€ç¬¬äºŒç§ã€‘ã€‚

- ============ ã€ç¬¬äºŒæ­¥ã€‘éªŒè¯æ–¹æ³•å‚æ•° ============

- ç¬¬ 29 è¡Œï¼šéªŒè¯é”™è¯¯é›†åˆ `violations` ã€‚

- ã€ç¬¬ä¸€æ­¥ã€‘è°ƒç”¨ `#getMethodParameterBean(Class<?> clazz, Method method, Object[] args)` æ–¹æ³•ï¼Œè·å¾—æ–¹æ³•å‚æ•°çš„ Bean å¯¹è±¡ã€‚å› ä¸ºï¼ŒJSR 303 æ˜¯ Java Bean Validation ï¼Œä»¥ Bean ä¸ºç»´åº¦ã€‚å…·ä½“çš„å®ç°ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ4.1.3 getMethodParameterBeanã€](http://svip.iocoder.cn/Dubbo/filter-validation-filter/#) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

- ã€ç¬¬ä¸€æ­¥ã€‘è°ƒç”¨ `Validator#validate(T object, Class<?>... groups)` æ–¹æ³•ï¼ŒéªŒè¯ **Bean** å¯¹è±¡ã€‚

- ã€ç¬¬äºŒæ­¥ã€‘å¾ªç¯æ–¹æ³•å‚æ•°ï¼Œè°ƒç”¨ `#validate(violations, arg, classGroups)` æ–¹æ³•ï¼ŒéªŒè¯**é›†åˆ**å‚æ•°ã€‚**ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸€æ­¥**ï¼Ÿå› ä¸ºï¼Œåœ¨ã€ç¬¬ä¸€æ­¥ã€‘ä¸­ï¼Œæ ¡éªŒçš„æ˜¯ Constraint æ³¨è§£çš„å‚æ•°( ä¾‹å¦‚ `@NotNull` ) ï¼Œä½†æ˜¯å‘¢ï¼Œè‹¥æ˜¯é›†åˆå‚æ•°ï¼Œ**ä¸ä¼šæ ¡éªŒé›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ **ã€‚æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ï¼š

  ```
  void saves(@NotNull(message = "è‡³å°‘éœ€è¦ä¿å­˜ä¸€ä¸ªç”¨æˆ·") User[] users);
  ```

  - ã€ç¬¬ä¸€æ­¥ã€‘æ ¡éªŒ `users` å‚æ•°çš„ `@NotNull` çº¦æŸã€‚
  - ã€ç¬¬äºŒæ­¥ã€‘æ ¡éªŒ `users` å‚æ•°ä¸­çš„**æ¯ä¸ª User** çš„çº¦æŸã€‚

- ç¬¬ 40 è‡³ 44 è¡Œï¼šè‹¥æœ‰éªŒè¯é”™è¯¯ï¼ŒæŠ›å‡º ConstraintViolationException å¼‚å¸¸ã€‚

------

`#validate(Set<ConstraintViolation<?>> violations, Object arg, Class<?>... groups)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
 1: /**
 2:  * éªŒè¯é›†åˆå‚æ•°
 3:  *
 4:  * @param violations éªŒè¯é”™è¯¯é›†åˆ
 5:  * @param arg å‚æ•°
 6:  * @param groups éªŒè¯åˆ†ç»„é›†åˆ
 7:  */
 8: private void validate(Set<ConstraintViolation<?>> violations, Object arg, Class<?>... groups) {
 9:     if (arg != null && !isPrimitives(arg.getClass())) {
10:         // [] æ•°ç»„
11:         if (Object[].class.isInstance(arg)) {
12:             for (Object item : (Object[]) arg) {
13:                 validate(violations, item, groups); // å•ä¸ªå…ƒç´ 
14:             }
15:         // Collection
16:         } else if (Collection.class.isInstance(arg)) {
17:             for (Object item : (Collection<?>) arg) {
18:                 validate(violations, item, groups); // å•ä¸ªå…ƒç´ 
19:             }
20:         // Map
21:         } else if (Map.class.isInstance(arg)) {
22:             for (Map.Entry<?, ?> entry : ((Map<?, ?>) arg).entrySet()) {
23:                 validate(violations, entry.getKey(), groups); // å•ä¸ªå…ƒç´ 
24:                 validate(violations, entry.getValue(), groups); // å•ä¸ªå…ƒç´ 
25:             }
26:         // å•ä¸ªå…ƒç´ 
27:         } else {
28:             violations.addAll(validator.validate(arg, groups));
29:         }
30:     }
31: }
```

- ç¬¬ 9 è¡Œï¼šè°ƒç”¨ `#isPrimitives(Class<?> cls)` æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º**åŸºæœ¬ç±»å‹**ã€‚è‹¥æ˜¯åŸºæœ¬ç±»å‹ï¼Œå·²ç»è¢«ã€**ç¬¬ä¸€æ­¥**ã€‘ç»™éªŒè¯äº†ï¼Œé¿å…é‡å¤éªŒè¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  private static boolean isPrimitives(Class<?> cls) {
      // [] æ•°ç»„ï¼Œä½¿ç”¨å†…éƒ¨çš„ç±»æ¥åˆ¤æ–­
      if (cls.isArray()) {
          return isPrimitive(cls.getComponentType());
      }
      // ç›´æ¥åˆ¤æ–­
      return isPrimitive(cls);
  }
  
  private static boolean isPrimitive(Class<?> cls) {
      return cls.isPrimitive() || cls == String.class || cls == Boolean.class || cls == Character.class
              || Number.class.isAssignableFrom(cls) || Date.class.isAssignableFrom(cls);
  }
  ```

- ç¬¬ 10 è‡³ 14 è¡Œï¼šéªŒè¯ `[ ]` æ•°ç»„å‚æ•°ï¼Œå¾ªç¯è°ƒç”¨ã€ç¬¬ 26 è‡³ 29ã€‘çš„éªŒè¯ã€‚

- ç¬¬ 15 è‡³ 19 è¡Œï¼šéªŒè¯ Collection å‚æ•°ï¼Œå¾ªç¯è°ƒç”¨ã€ç¬¬ 26 è‡³ 29ã€‘çš„éªŒè¯ã€‚

- ç¬¬ 20 è‡³ 25 è¡Œï¼šéªŒè¯ Map å‚æ•°ï¼Œå¾ªç¯è°ƒç”¨ã€ç¬¬ 26 è‡³ 29ã€‘çš„éªŒè¯ã€‚

- **ç¬¬ 26 è‡³ 29 è¡Œ**ï¼šéªŒè¯**å•ä¸ª**å‚æ•°ã€‚

###### 4.1.3 getMethodParameterBean

åœ¨çœ‹ `#getMethodParameterBean(Class<?> clazz, Method method, Object[] args)` çš„å…·ä½“å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒï¼Œæ ¹æ®æ–¹æ³•ï¼Œ**è‡ªåŠ¨ç”Ÿæˆ** Bean ç±»çš„ä¾‹å­ã€‚

- æ¥å£æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  void demo(@NotNull(message = "åå­—ä¸èƒ½ä¸ºç©º") @Min(value = 6, message = "æ˜µç§°ä¸èƒ½å¤ªçŸ­") String name,
            String password, // ä¸æ ¡éªŒ
            @NotNull(message = "è‡³å°‘éœ€è¦ä¿å­˜ä¸€ä¸ªç”¨æˆ·") User user);
  ```

- ç”Ÿæˆ Bean ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  package com.alibaba.dubbo.demo.DemoService_DemoParameter_java.lang.String_java.lang.String_com.alibaba.dubbo.demo.entity;
  
  public class User {
  
      @NotNull(message = "åå­—ä¸èƒ½ä¸ºç©º") 
      @Min(value = 6, message = "æ˜µç§°ä¸èƒ½å¤ªçŸ­")
      public java.lang.String name;
      
      public java.lang.String password;
      
      @NotNull(message = "è‡³å°‘éœ€è¦ä¿å­˜ä¸€ä¸ªç”¨æˆ·")
      public com.alibaba.dubbo.demo.entity.User user;
      
      public User() {}
  
  }
  ```

  - ğŸ˜ˆ Javassist ç”Ÿæˆçš„ç±»ï¼Œä½¿ç”¨ JD-GUI åç¼–è¯‘ä¸€ç›´æŠ¥é”™ã€‚æ‰€ä»¥ï¼Œè¯¥ç±»æ˜¯ç¬”è€…ï¼Œ**æ‰‹å·¥**ç”Ÿæˆçš„ã€‚å“ˆå“ˆå“ˆï¼Œæ„æ€èƒ½è¾¾åˆ°å°±å¥½ã€‚

------

`#getMethodParameterBean(Class<?> clazz, Method method, Object[] args)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
 1: /**
 2:  * ä½¿ç”¨æ–¹æ³•å‚æ•°ï¼Œåˆ›å»º Bean å¯¹è±¡ã€‚
 3:  *
 4:  * å› ä¸ºè¯¥ Bean å¯¹è±¡ï¼Œå®é™…ä¸å­˜åœ¨å¯¹åº”ç±»ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç”Ÿæˆã€‚
 5:  *
 6:  * @param clazz æœåŠ¡æ¥å£ç±»
 7:  * @param method æ–¹æ³•
 8:  * @param args å‚æ•°æ•°ç»„
 9:  * @return Bean å¯¹è±¡
10:  */
11: private static Object getMethodParameterBean(Class<?> clazz, Method method, Object[] args) {
12:     // æ—  Constraint æ³¨è§£çš„æ–¹æ³•å‚æ•°ï¼Œæ— éœ€åˆ›å»º Bean å¯¹è±¡ã€‚
13:     if (!hasConstraintParameter(method)) {
14:         return null;
15:     }
16:     try {
17:         // è·å¾— Bean ç±»å
18:         String parameterClassName = generateMethodParameterClassName(clazz, method);
19:         Class<?> parameterClass;
20:         try {
21:             // è·å¾— Bean ç±»
22:             parameterClass = Class.forName(parameterClassName, true, clazz.getClassLoader());
23:         } catch (ClassNotFoundException e) { // ç±»ä¸å­˜åœ¨ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç”Ÿæˆ
24:             // åˆ›å»º ClassPool å¯¹è±¡
25:             ClassPool pool = ClassGenerator.getClassPool(clazz.getClassLoader());
26:             // åˆ›å»º CtClass å¯¹è±¡
27:             CtClass ctClass = pool.makeClass(parameterClassName);
28:             // è®¾ç½® Java ç‰ˆæœ¬ä¸º 5
29:             ClassFile classFile = ctClass.getClassFile();
30:             classFile.setVersionToJava5();
31:             // æ·»åŠ é»˜è®¤æ„é€ æ–¹æ³•
32:             ctClass.addConstructor(CtNewConstructor.defaultConstructor(pool.getCtClass(parameterClassName)));
33:             // å¾ªç¯æ¯ä¸ªæ–¹æ³•å‚æ•°ï¼Œç”Ÿæˆå¯¹åº”çš„ç±»çš„å±æ€§
34:             // parameter fields
35:             Class<?>[] parameterTypes = method.getParameterTypes();
36:             Annotation[][] parameterAnnotations = method.getParameterAnnotations();
37:             for (int i = 0; i < parameterTypes.length; i++) {
38:                 Class<?> type = parameterTypes[i];
39:                 Annotation[] annotations = parameterAnnotations[i];
40:                 // åˆ›å»ºæ³¨è§£å±æ€§
41:                 AnnotationsAttribute attribute = new AnnotationsAttribute(classFile.getConstPool(), AnnotationsAttribute.visibleTag);
42:                 // å¾ªç¯æ¯ä¸ªæ–¹æ³•å‚æ•°çš„æ¯ä¸ªæ³¨è§£
43:                 for (Annotation annotation : annotations) {
44:                     if (annotation.annotationType().isAnnotationPresent(Constraint.class)) { // çº¦æŸæ¡ä»¶çš„æ³¨è§£ï¼Œä¾‹å¦‚ @NotNull
45:                         javassist.bytecode.annotation.Annotation ja = new javassist.bytecode.annotation.Annotation(
46:                                 classFile.getConstPool(), pool.getCtClass(annotation.annotationType().getName()));
47:                         // å¾ªç¯æ³¨è§£çš„æ¯ä¸ªæ–¹æ³•
48:                         Method[] members = annotation.annotationType().getMethods();
49:                         for (Method member : members) {
50:                             if (Modifier.isPublic(member.getModifiers())
51:                                     && member.getParameterTypes().length == 0
52:                                     && member.getDeclaringClass() == annotation.annotationType()) {
53:                                 // å°†æ³¨è§£ï¼Œæ·»åŠ åˆ°ç±»çš„å±æ€§ä¸Š
54:                                 Object value = member.invoke(annotation);
55:                                 if (null != value) {
56:                                     MemberValue memberValue = createMemberValue(
57:                                             classFile.getConstPool(), pool.get(member.getReturnType().getName()), value);
58:                                     ja.addMemberValue(member.getName(), memberValue);
59:                                 }
60:                             }
61:                         }
62:                         attribute.addAnnotation(ja);
63:                     }
64:                 }
65:                 // åˆ›å»ºå±æ€§
66:                 String fieldName = method.getName() + "Argument" + i;
67:                 CtField ctField = CtField.make("public " + type.getCanonicalName() + " " + fieldName + ";", pool.getCtClass(parameterClassName));
68:                 ctField.getFieldInfo().addAttribute(attribute);
69:                 // æ·»åŠ å±æ€§
70:                 ctClass.addField(ctField);
71:             }
72:             // ç”Ÿæˆç±»
73:             parameterClass = ctClass.toClass(clazz.getClassLoader(), null);
74:         }
75:         // åˆ›å»º Bean å¯¹è±¡
76:         Object parameterBean = parameterClass.newInstance();
77:         // è®¾ç½® Bean å¯¹è±¡çš„æ¯ä¸ªå±æ€§çš„å€¼
78:         for (int i = 0; i < args.length; i++) {
79:             Field field = parameterClass.getField(method.getName() + "Argument" + i);
80:             field.set(parameterBean, args[i]);
81:         }
82:         return parameterBean;
83:     } catch (Throwable e) {
84:         logger.warn(e.getMessage(), e);
85:         return null;
86:     }
87: }
```

- ç¬¬ 13 è‡³ 15 è¡Œï¼šè°ƒç”¨ `#hasConstraintParameter(method)` æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ **Constraint** æ³¨è§£( ä¾‹å¦‚ï¼Œ`@NotNull` )çš„æ–¹æ³•å‚æ•°ã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ— éœ€åˆ›å»º Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  private static boolean hasConstraintParameter(Method method) {
      Annotation[][] parameterAnnotations = method.getParameterAnnotations();
      // å¾ªç¯æ‰€æœ‰æ–¹æ³•å‚æ•°çš„æ³¨è§£
      if (parameterAnnotations != null && parameterAnnotations.length > 0) {
          // å¾ªç¯æ¯ä¸ªæ–¹æ³•å‚æ•°çš„æ³¨è§£æ•°ç»„
          for (Annotation[] annotations : parameterAnnotations) {
              // æ˜¯å¦æœ‰ Constraint æ³¨è§£
              for (Annotation annotation : annotations) {
                  if (annotation.annotationType().isAnnotationPresent(Constraint.class)) {
                      return true;
                  }
              }
          }
      }
      return false;
  }
  ```

- ç¬¬ 17 è‡³ 22 è¡Œï¼šè·å¾— Bean ç±»ã€‚

- ç¬¬ 23 è‡³ 73 è¡Œï¼šè‹¥ Bean ç±»**ä¸å­˜åœ¨**ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç”Ÿæˆã€‚ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šï¼Œèƒ–å‹è€å¿ƒçœ‹çœ‹å“ˆã€‚å…¶ä¸­ï¼Œ`#createMemberValue(ConstPool cp, CtClass type, Object value)` æ–¹æ³•ï¼Œè·å¾—æ³¨è§£**æ¯ä¸ªå±æ€§çš„å€¼**ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  // Copy from javassist.bytecode.annotation.Annotation.createMemberValue(ConstPool, CtClass);
  private static MemberValue createMemberValue(ConstPool cp, CtClass type, Object value) throws NotFoundException {
      MemberValue memberValue = javassist.bytecode.annotation.Annotation.createMemberValue(cp, type);
      if (memberValue instanceof BooleanMemberValue) // Boolean
          ((BooleanMemberValue) memberValue).setValue((Boolean) value);
      else if (memberValue instanceof ByteMemberValue) // Byte
          ((ByteMemberValue) memberValue).setValue((Byte) value);
      else if (memberValue instanceof CharMemberValue) // Char
          ((CharMemberValue) memberValue).setValue((Character) value);
      else if (memberValue instanceof ShortMemberValue) // Short
          ((ShortMemberValue) memberValue).setValue((Short) value);
      else if (memberValue instanceof IntegerMemberValue) // Integer
          ((IntegerMemberValue) memberValue).setValue((Integer) value);
      else if (memberValue instanceof LongMemberValue) // Long
          ((LongMemberValue) memberValue).setValue((Long) value);
      else if (memberValue instanceof FloatMemberValue) // Float
          ((FloatMemberValue) memberValue).setValue((Float) value);
      else if (memberValue instanceof DoubleMemberValue)
          ((DoubleMemberValue) memberValue).setValue((Double) value);
      else if (memberValue instanceof ClassMemberValue) // Class
          ((ClassMemberValue) memberValue).setValue(((Class<?>) value).getName());
      else if (memberValue instanceof StringMemberValue) // String
          ((StringMemberValue) memberValue).setValue((String) value);
      else if (memberValue instanceof EnumMemberValue) // Enum
          ((EnumMemberValue) memberValue).setValue(((Enum<?>) value).name());
      /* else if (memberValue instanceof AnnotationMemberValue) */
      else if (memberValue instanceof ArrayMemberValue) { // æ•°ç»„
          CtClass arrayType = type.getComponentType();
          int len = Array.getLength(value);
          // å¾ªç¯ï¼Œé€’å½’
          MemberValue[] members = new MemberValue[len];
          for (int i = 0; i < len; i++) {
              members[i] = createMemberValue(cp, arrayType, Array.get(value, i));
          }
          ((ArrayMemberValue) memberValue).setValue(members);
      }
      return memberValue;
  }
  ```

- ç¬¬ 75 è‡³ 81 è¡Œï¼šåˆ›å»º Bean å¯¹è±¡ï¼Œ**è®¾ç½® Bean å¯¹è±¡çš„æ¯ä¸ªå±æ€§çš„å€¼**ã€‚

ğŸ˜ˆ åˆæ˜¯ä¸€å¤„ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç±»çš„ä»£ç ã€‚å¥½ç”¨ï¼ï¼ï¼

#### 4.2 JValidation

`com.alibaba.dubbo.validation.support.jvalidation.JValidation` ï¼Œå®ç° AbstractValidation æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class JValidation extends AbstractValidation {

    @Override
    protected Validator createValidator(URL url) {
        return new JValidator(url);
    }

}
```

## 

ç»ˆäºå¼„æ‡‚ï¼Œä¸ºä»€ä¹ˆ JSR303 æ˜¯ Java Bean Validation ï¼Œç»“æœæ¥å£æ–¹æ³•ä¸Šï¼Œæ¯ä¸ªå‚æ•°éƒ½æ·»åŠ  Constraint çš„æ³¨è§£ï¼Œç»“æœä¹Ÿå¯ä»¥åšæ ¡éªŒã€‚

æ¨èä¸¤ç¯‡æ–‡ç« ï¼š

- [ã€ŠJSR 303 - Bean Validation ä»‹ç»åŠæœ€ä½³å®è·µã€‹](https://www.ibm.com/developerworks/cn/java/j-lo-jsr303/)
- [ã€ŠSpring4æ–°ç‰¹æ€§â€”â€”é›†æˆBean Validation 1.1(JSR-349)åˆ°SpringMVCã€‹](http://jinnianshilongnian.iteye.com/blog/1990081)

