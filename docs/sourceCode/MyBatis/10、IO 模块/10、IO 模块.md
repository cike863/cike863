# 1. æ¦‚è¿°

æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« MyBatis çš„ IO æ¨¡å—ï¼Œå¯¹åº” `io` åŒ…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![`io` åŒ…](http://static.iocoder.cn/images/MyBatis/2020_01_28/01.png)](http://static.iocoder.cn/images/MyBatis/2020_01_28/01.png)`io` åŒ…

åœ¨ [ã€Šç²¾å°½ MyBatis æºç è§£æ â€”â€” é¡¹ç›®ç»“æ„ä¸€è§ˆã€‹](http://svip.iocoder.cn/MyBatis/intro) ä¸­ï¼Œç®€å•ä»‹ç»äº†è¿™ä¸ªæ¨¡å—å¦‚ä¸‹ï¼š

> èµ„æºåŠ è½½æ¨¡å—ï¼Œä¸»è¦æ˜¯å¯¹ç±»åŠ è½½å™¨è¿›è¡Œå°è£…ï¼Œç¡®å®šç±»åŠ è½½å™¨çš„ä½¿ç”¨é¡ºåºï¼Œå¹¶æä¾›äº†åŠ è½½ç±»æ–‡ä»¶ä»¥åŠå…¶ä»–èµ„æºæ–‡ä»¶çš„åŠŸèƒ½ ã€‚

æœ¬æ–‡æ¶‰åŠçš„ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![ç±»å›¾](http://static.iocoder.cn/images/MyBatis/2020_01_28/02.png)](http://static.iocoder.cn/images/MyBatis/2020_01_28/02.png)ç±»å›¾

# 2. ClassLoaderWrapper

`org.apache.ibatis.io.ClassLoaderWrapper` ï¼ŒClassLoader åŒ…è£…å™¨ã€‚å¯ä½¿ç”¨å¤šä¸ª ClassLoader åŠ è½½å¯¹åº”çš„èµ„æºï¼Œç›´åˆ°æœ‰ä¸€æˆåŠŸåè¿”å›èµ„æºã€‚

## 2.1 æ„é€ æ–¹æ³•

```
// ClassLoaderWrapper.java

/**
 * é»˜è®¤ ClassLoader å¯¹è±¡
 */
ClassLoader defaultClassLoader;
/**
 * ç³»ç»Ÿ ClassLoader å¯¹è±¡
 */
ClassLoader systemClassLoader;

ClassLoaderWrapper() {
    try {
        systemClassLoader = ClassLoader.getSystemClassLoader();
    } catch (SecurityException ignored) {
        // AccessControlException on Google App Engine
    }
}
```

- `defaultClassLoader` å±æ€§ï¼Œé»˜è®¤ ClassLoader å¯¹è±¡ã€‚ç›®å‰ä¸å­˜åœ¨åˆå§‹åŒ–è¯¥å±æ€§çš„æ„é€ æ–¹æ³•ã€‚å¯é€šè¿‡ `ClassLoaderWrapper.defaultClassLoader = xxx` çš„æ–¹å¼ï¼Œè¿›è¡Œè®¾ç½®ã€‚
- `systemClassLoader` å±æ€§ï¼Œç³»ç»Ÿ ClassLoader å¯¹è±¡ã€‚åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå·²ç»åˆå§‹åŒ–ã€‚

## 2.2 getClassLoaders

`#getClassLoaders(ClassLoader classLoader)` æ–¹æ³•ï¼Œè·å¾— ClassLoader æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ClassLoaderWrapper.java

ClassLoader[] getClassLoaders(ClassLoader classLoader) {
    return new ClassLoader[]{
            classLoader,
            defaultClassLoader,
            Thread.currentThread().getContextClassLoader(),
            getClass().getClassLoader(),
            systemClassLoader};
}
```

## 2.3 getResourceAsURL

`#getResourceAsURL(String resource, ...)` æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šèµ„æºçš„ URL ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ClassLoaderWrapper.java

/**
 * Get a resource as a URL using the current class path
 *
 * @param resource - the resource to locate
 * @return the resource or null
 */
public URL getResourceAsURL(String resource) {
    return getResourceAsURL(resource, getClassLoaders(null));
}
 
/**
 * Get a resource from the classpath, starting with a specific class loader
 *
 * @param resource    - the resource to find
 * @param classLoader - the first classloader to try
 * @return the stream or null
 */
public URL getResourceAsURL(String resource, ClassLoader classLoader) {
    return getResourceAsURL(resource, getClassLoaders(classLoader));
}
```

- å…ˆè°ƒç”¨ `#getClassLoaders(ClassLoader classLoader)` æ–¹æ³•ï¼Œè·å¾— ClassLoader æ•°ç»„ã€‚

- å†è°ƒç”¨ `#getResourceAsURL(String resource, ClassLoader[] classLoader)` æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šèµ„æºçš„ InputStream ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ClassLoaderWrapper.java
  
  /**
   * Get a resource as a URL using the current class path
   *
   * @param resource    - the resource to locate
   * @param classLoader - the class loaders to examine
   * @return the resource or null
   */
  URL getResourceAsURL(String resource, ClassLoader[] classLoader) {
      URL url;
      // éå† ClassLoader æ•°ç»„
      for (ClassLoader cl : classLoader) {
          if (null != cl) {
              // è·å¾— URL ï¼Œä¸å¸¦ /
              // look for the resource as passed in...
              url = cl.getResource(resource);
              // è·å¾— URL ï¼Œå¸¦ /
              // ...but some class loaders want this leading "/", so we'll add it
              // and try again if we didn't find the resource
              if (null == url) {
                  url = cl.getResource("/" + resource);
              }
  
              // "It's always in the last place I look for it!"
              // ... because only an idiot would keep looking for it after finding it, so stop looking already.
              // æˆåŠŸè·å¾—åˆ°ï¼Œè¿”å›
              if (null != url) {
                  return url;
              }
  
          }
      }
      // didn't find it anywhere.
      return null;
  }
  ```

## 2.4 getResourceAsStream

`#getResourceAsStream(String resource, ...)` æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šèµ„æºçš„ InputStream å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ClassLoaderWrapper.java

/**
 * Get a resource from the classpath
 *
 * @param resource - the resource to find
 * @return the stream or null
 */
public InputStream getResourceAsStream(String resource) {
    return getResourceAsStream(resource, getClassLoaders(null));
}

/**
 * Get a resource from the classpath, starting with a specific class loader
 *
 * @param resource    - the resource to find
 * @param classLoader - the first class loader to try
 * @return the stream or null
 */
public InputStream getResourceAsStream(String resource, ClassLoader classLoader) {
    return getResourceAsStream(resource, getClassLoaders(classLoader));
}
```

- å…ˆè°ƒç”¨ `#getClassLoaders(ClassLoader classLoader)` æ–¹æ³•ï¼Œè·å¾— ClassLoader æ•°ç»„ã€‚

- å†è°ƒç”¨ `#getResourceAsStream(String resource, ClassLoader[] classLoader)` æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šèµ„æºçš„ InputStream ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ClassLoaderWrapper.java
  
  InputStream getResourceAsStream(String resource, ClassLoader[] classLoader) {
      // éå† ClassLoader æ•°ç»„
      for (ClassLoader cl : classLoader) {
          if (null != cl) {
              // è·å¾— InputStream ï¼Œä¸å¸¦ /
              // try to find the resource as passed
              InputStream returnValue = cl.getResourceAsStream(resource);
              // now, some class loaders want this leading "/", so we'll add it and try again if we didn't find the resource
              // è·å¾— InputStream ï¼Œå¸¦ /
              if (null == returnValue) {
                  returnValue = cl.getResourceAsStream("/" + resource);
              }
  
              // æˆåŠŸè·å¾—åˆ°ï¼Œè¿”å›
              if (null != returnValue) {
                  return returnValue;
              }
          }
      }
      return null;
  }
  ```

  - å¯ä½¿ç”¨å¤šä¸ª ClassLoader åŠ è½½å¯¹åº”çš„èµ„æºï¼Œç›´åˆ°æœ‰ä¸€æˆåŠŸåè¿”å›èµ„æºã€‚

## 2.5 classForName

`#classForName(String name, ...)` æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šç±»åå¯¹åº”çš„ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ClassLoaderWrapper.java

/**
 * Find a class on the classpath (or die trying)
 *
 * @param name - the class to look for
 * @return - the class
 * @throws ClassNotFoundException Duh.
 */
public Class<?> classForName(String name) throws ClassNotFoundException {
    return classForName(name, getClassLoaders(null));
}

/**
 * Find a class on the classpath, starting with a specific classloader (or die trying)
 *
 * @param name        - the class to look for
 * @param classLoader - the first classloader to try
 * @return - the class
 * @throws ClassNotFoundException Duh.
 */
public Class<?> classForName(String name, ClassLoader classLoader) throws ClassNotFoundException {
    return classForName(name, getClassLoaders(classLoader));
}
```

- å…ˆè°ƒç”¨ `#getClassLoaders(ClassLoader classLoader)` æ–¹æ³•ï¼Œè·å¾— ClassLoader æ•°ç»„ã€‚

- å†è°ƒç”¨ `#classForName(String name, ClassLoader[] classLoader)` æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šç±»åå¯¹åº”çš„ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ClassLoaderWrapper.java
  
  Class<?> classForName(String name, ClassLoader[] classLoader) throws ClassNotFoundException {
      // éå† ClassLoader æ•°ç»„
      for (ClassLoader cl : classLoader) {
          if (null != cl) {
              try {
                  // è·å¾—ç±»
                  Class<?> c = Class.forName(name, true, cl);
  
                  // æˆåŠŸè·å¾—åˆ°ï¼Œè¿”å›
                  if (null != c) {
                      return c;
                  }
              } catch (ClassNotFoundException e) {
                  // we'll ignore this until all classloaders fail to locate the class
              }
          }
      }
      // è·å¾—ä¸åˆ°ï¼ŒæŠ›å‡º ClassNotFoundException å¼‚å¸¸
      throw new ClassNotFoundException("Cannot find class: " + name);
  }
  ```

  - å¯ä½¿ç”¨å¤šä¸ª ClassLoader åŠ è½½å¯¹åº”çš„ç±»ï¼Œç›´åˆ°æœ‰ä¸€æˆåŠŸåè¿”å›ç±»ã€‚

# 3. Resources

`org.apache.ibatis.io.Resources` ï¼ŒResource å·¥å…·ç±»ã€‚

## 3.1 æ„é€ æ–¹æ³•

```
// Resources.java

/**
 * ClassLoaderWrapper å¯¹è±¡
 */
private static ClassLoaderWrapper classLoaderWrapper = new ClassLoaderWrapper();

/**
 * å­—ç¬¦é›†
 */
private static Charset charset;

Resources() {
}

public static void setDefaultClassLoader(ClassLoader defaultClassLoader) {defaultClassLoader
    classLoaderWrapper.defaultClassLoader = defaultClassLoader; // ä¿®æ”¹ ClassLoaderWrapper.
}

public static void setCharset(Charset charset) {
    Resources.charset = charset;
}
```

## 3.2 getResource

åŸºäº `classLoaderWrapper` å±æ€§çš„å°è£…ã€‚

### 3.2.1 getResourceURL

`#getResourceURL(String resource)` **é™æ€**æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šèµ„æºçš„ URL ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Resources.java

public static URL getResourceURL(String resource) throws IOException {
    // issue #625
    return getResourceURL(null, resource);
}

public static URL getResourceURL(ClassLoader loader, String resource) throws IOException {
    URL url = classLoaderWrapper.getResourceAsURL(resource, loader);
    if (url == null) {
        throw new IOException("Could not find resource " + resource);
    }
    return url;
}
```

### 3.2.2 getResourceAsStream

`#getResourceAsStream(String resource)` **é™æ€**æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šèµ„æºçš„ InputStream ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Resources.java

public static InputStream getResourceAsStream(String resource) throws IOException {
    return getResourceAsStream(null, resource);
}

public static InputStream getResourceAsStream(ClassLoader loader, String resource) throws IOException {
    InputStream in = classLoaderWrapper.getResourceAsStream(resource, loader);
    if (in == null) {
        throw new IOException("Could not find resource " + resource);
    }
    return in;
}
```

### 3.2.3 getResourceAsReader

`#getResourceAsReader(String resource)` **é™æ€**æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šèµ„æºçš„ Reader ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Resources.java

public static Reader getResourceAsReader(String resource) throws IOException {
    Reader reader;
    if (charset == null) {
        reader = new InputStreamReader(getResourceAsStream(resource));
    } else {
        reader = new InputStreamReader(getResourceAsStream(resource), charset);
    }
    return reader;
}

public static Reader getResourceAsReader(ClassLoader loader, String resource) throws IOException {
    Reader reader;
    if (charset == null) {
        reader = new InputStreamReader(getResourceAsStream(loader, resource));
    } else {
        reader = new InputStreamReader(getResourceAsStream(loader, resource), charset);
    }
    return reader;
}
```

### 3.2.4 getResourceAsFile

`#getResourceAsFile(String resource)` **é™æ€**æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šèµ„æºçš„ File ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Resources.java

public static File getResourceAsFile(String resource) throws IOException {
    return new File(getResourceURL(resource).getFile());
}

public static File getResourceAsFile(ClassLoader loader, String resource) throws IOException {
    return new File(getResourceURL(loader, resource).getFile());
}
```

- åŸºäº `classLoaderWrapper` å±æ€§çš„å°è£…ã€‚

### 3.2.5 getResourceAsProperties

`#getResourceAsProperties(ClassLoader loader)` **é™æ€**æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šèµ„æºçš„ Properties ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Resources.java

public static Properties getResourceAsProperties(String resource) throws IOException {
    Properties props = new Properties();
    // è¯»å–
    try (InputStream in = getResourceAsStream(resource)) {
        props.load(in);
    }
    return props;
}

public static Properties getResourceAsProperties(ClassLoader loader, String resource) throws IOException {
    Properties props = new Properties();
    // è¯»å–
    try (InputStream in = getResourceAsStream(loader, resource)) {
        props.load(in);
    }
    return props;
}
```

## 3.3 getUrl

### 3.3.1 getUrlAsStream

`#getUrlAsStream(String urlString)` **é™æ€**æ–¹æ³•ï¼Œè·å¾—æŒ‡å®š URL ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Resources.java

public static InputStream getUrlAsStream(String urlString) throws IOException {
    URL url = new URL(urlString);
    // æ‰“å¼€ URLConnection
    URLConnection conn = url.openConnection();
    return conn.getInputStream();
}
```

### 3.3.2 getUrlAsReader

`#getUrlAsReader(String urlString)` **é™æ€**æ–¹æ³•ï¼ŒæŒ‡å®š URL çš„ Reader ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Resources.java

public static Reader getUrlAsReader(String urlString) throws IOException {
    Reader reader;
    if (charset == null) {
        reader = new InputStreamReader(getUrlAsStream(urlString));
    } else {
        reader = new InputStreamReader(getUrlAsStream(urlString), charset);
    }
    return reader;
}
```

### 3.3.3 getUrlAsProperties

`#getUrlAsReader(String urlString)` **é™æ€**æ–¹æ³•ï¼ŒæŒ‡å®š URL çš„ Properties ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Resources.java

public static Properties getUrlAsProperties(String urlString) throws IOException {
    Properties props = new Properties();
    try (InputStream in = getUrlAsStream(urlString)) {
        props.load(in);
    }
    return props;
}
```

## 3.4 classForName

`#classForName(String className)` **é™æ€**æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šç±»åå¯¹åº”çš„ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Resources.java

public static Class<?> classForName(String className) throws ClassNotFoundException {
    return classLoaderWrapper.classForName(className);
}
```

# 4. ResolverUtil

`org.apache.ibatis.io.ResolverUtil` ï¼Œè§£æå™¨å·¥å…·ç±»ï¼Œç”¨äºè·å¾—æŒ‡å®šç›®å½•**ç¬¦åˆæ¡ä»¶**çš„ç±»ä»¬ã€‚

## 4.1 Test

Test ï¼ŒåŒ¹é…åˆ¤æ–­æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ResolverUtil.java å†…éƒ¨ç±»

/**
 * A simple interface that specifies how to test classes to determine if they
 * are to be included in the results produced by the ResolverUtil.
 */
public interface Test {

    /**
     * Will be called repeatedly with candidate classes. Must return True if a class
     * is to be included in the results, false otherwise.
     */
    boolean matches(Class<?> type);

}
```

### 4.1.1 IsA

IsA ï¼Œå®ç° Test æ¥å£ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæŒ‡å®šç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ResolverUtil.java å†…éƒ¨ç±»

/**
 * A Test that checks to see if each class is assignable to the provided class. Note
 * that this test will match the parent type itself if it is presented for matching.
 */
public static class IsA implements Test {

    /**
     * æŒ‡å®šç±»
     */
    private Class<?> parent;

    /** Constructs an IsA test using the supplied Class as the parent class/interface. */
    public IsA(Class<?> parentType) {
        this.parent = parentType;
    }

    /** Returns true if type is assignable to the parent type supplied in the constructor. */
    @Override
    public boolean matches(Class<?> type) {
        return type != null && parent.isAssignableFrom(type);
    }

}
```

### 4.1.2 AnnotatedWith

AnnotatedWith ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æŒ‡å®šæ³¨è§£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ResolverUtil.java å†…éƒ¨ç±»

/**
 * A Test that checks to see if each class is annotated with a specific annotation. If it
 * is, then the test returns true, otherwise false.
 */
public static class AnnotatedWith implements Test {

    /**
     * æ³¨è§£
     */
    private Class<? extends Annotation> annotation;

    /** Constructs an AnnotatedWith test for the specified annotation type. */
    public AnnotatedWith(Class<? extends Annotation> annotation) {
        this.annotation = annotation;
    }

    /** Returns true if the type is annotated with the class provided to the constructor. */
    @Override
    public boolean matches(Class<?> type) {
        return type != null && type.isAnnotationPresent(annotation);
    }

}
```

## 4.2 æ„é€ æ–¹æ³•

```
// ResolverUtil.java

/** The set of matches being accumulated. */
private Set<Class<? extends T>> matches = new HashSet<>(); // ç¬¦åˆæ¡ä»¶çš„ç±»çš„é›†åˆ

private ClassLoader classloader;

public Set<Class<? extends T>> getClasses() {
    return matches;
}

public ClassLoader getClassLoader() {
    return classloader == null ? Thread.currentThread().getContextClassLoader() : classloader;
}
public void setClassLoader(ClassLoader classloader) {
    this.classloader = classloader;
}
```

## 4.3 find

`#find(Test test, String packageName)` æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šåŒ…ä¸‹ï¼Œç¬¦åˆæ¡ä»¶çš„ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ResolverUtil.java

public ResolverUtil<T> find(Test test, String packageName) {
    // <1> è·å¾—åŒ…çš„è·¯å¾„
    String path = getPackagePath(packageName);

    try {
        // <2> è·å¾—è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
        List<String> children = VFS.getInstance().list(path);
        // <3> éå†
        for (String child : children) {
            // æ˜¯ Java Class
            if (child.endsWith(".class")) {
                // å¦‚æœåŒ¹é…ï¼Œåˆ™æ·»åŠ åˆ°ç»“æœé›†
                addIfMatching(test, child);
            }
        }
    } catch (IOException ioe) {
        log.error("Could not read package: " + packageName, ioe);
    }

    return this;
}
```

- `<1>` å¤„ï¼Œè°ƒç”¨ `#getPackagePath(String packageName)` æ–¹æ³•ï¼Œè·å¾—åŒ…çš„è·¯å¾„ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ResolverUtil.java
  
  protected String getPackagePath(String packageName) {
      return packageName == null ? null : packageName.replace('.', '/');
  }
  ```

- `<2>` å¤„ï¼Œè·å¾—è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ5. VFSã€](http://svip.iocoder.cn/MyBatis/io-package/#) ã€‚

- `<3>` å¤„ï¼Œéå† Java Class æ–‡ä»¶ï¼Œè°ƒç”¨ `#addIfMatching(Test test, String fqn)` æ–¹æ³•ï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™æ·»åŠ åˆ°ç»“æœé›†ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // ResolverUtil.java
  
  protected void addIfMatching(Test test, String fqn) {
      try {
          // è·å¾—å…¨ç±»å
          String externalName = fqn.substring(0, fqn.indexOf('.')).replace('/', '.');
          ClassLoader loader = getClassLoader();
          if (log.isDebugEnabled()) {
              log.debug("Checking to see if class " + externalName + " matches criteria [" + test + "]");
          }
  
          // åŠ è½½ç±»
          Class<?> type = loader.loadClass(externalName);
  
          // åˆ¤æ–­æ˜¯å¦åŒ¹é…
          if (test.matches(type)) {
              matches.add((Class<T>) type);
          }
      } catch (Throwable t) {
          log.warn("Could not examine class '" + fqn + "'" + " due to a " +
                  t.getClass().getName() + " with message: " + t.getMessage());
      }
  }
  ```

```
* ä½¿ç”¨å¯¹åº”çš„ `test` çš„è¿›è¡ŒåŒ¹é…ã€‚
```

### 4.3.1 findImplementations

`#findImplementations(Class<?> parent, String... packageNames)` æ–¹æ³•ï¼Œåˆ¤æ–­æŒ‡å®šç›®å½•ä¸‹**ä»¬**ï¼Œç¬¦åˆ**æŒ‡å®šç±»**çš„ç±»ä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ResolverUtil.java

public ResolverUtil<T> findImplementations(Class<?> parent, String... packageNames) {
    if (packageNames == null) {
        return this;
    }

    Test test = new IsA(parent);
    for (String pkg : packageNames) {
        find(test, pkg);
    }

    return this;
}
```

### 4.3.2 findAnnotated

`#findAnnotated(Class<? extends Annotation> annotation, String... packageNames)` æ–¹æ³•ï¼Œåˆ¤æ–­æŒ‡å®šç›®å½•ä¸‹**ä»¬**ï¼Œç¬¦åˆ**æŒ‡å®šæ³¨è§£**çš„ç±»ä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ResolverUtil.java

public ResolverUtil<T> findAnnotated(Class<? extends Annotation> annotation, String... packageNames) {
    if (packageNames == null) {
        return this;
    }

    Test test = new AnnotatedWith(annotation);
    for (String pkg : packageNames) {
        find(test, pkg);
    }

    return this;
}
```

# 5. VFS

`org.apache.ibatis.io.VFS` ï¼Œè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ( Virtual File System )**æŠ½è±¡ç±»**ï¼Œç”¨æ¥æŸ¥æ‰¾æŒ‡å®šè·¯å¾„ä¸‹çš„çš„æ–‡ä»¶ä»¬ã€‚

## 5.1 é™æ€å±æ€§

```
// VFS.java

/** The built-in implementations. */
public static final Class<?>[] IMPLEMENTATIONS = {JBoss6VFS.class, DefaultVFS.class}; // å†…ç½®çš„ VFS å®ç°ç±»çš„æ•°ç»„

/** The list to which implementations are added by {@link #addImplClass(Class)}. */
public static final List<Class<? extends VFS>> USER_IMPLEMENTATIONS = new ArrayList<>(); // è‡ªå®šä¹‰çš„ VFS å®ç°ç±»çš„æ•°ç»„

public static void addImplClass(Class<? extends VFS> clazz) {
    if (clazz != null) {
        USER_IMPLEMENTATIONS.add(clazz);
    }
}
```

- `IMPLEMENTATIONS` **é™æ€**å±æ€§ï¼Œå†…ç½®çš„ VFS å®ç°ç±»çš„æ•°ç»„ã€‚ç›®å‰ VFS æœ‰ JBoss6VFS å’Œ DefaultVFS ä¸¤ä¸ªå®ç°ç±»ã€‚
- `USER_IMPLEMENTATIONS` **é™æ€**å±æ€§ï¼Œè‡ªå®šä¹‰çš„ VFS å®ç°ç±»çš„æ•°ç»„ã€‚å¯é€šè¿‡ `#addImplClass(Class<? extends VFS> clazz)` æ–¹æ³•ï¼Œè¿›è¡Œæ·»åŠ ã€‚

## 5.2 getInstance

`#getInstance()` æ–¹æ³•ï¼Œè·å¾— VFS å•ä¾‹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// VFS.java

public static VFS getInstance() {
    return VFSHolder.INSTANCE;
}

private static class VFSHolder {

    static final VFS INSTANCE = createVFS();

    @SuppressWarnings("unchecked")
    static VFS createVFS() {
        // Try the user implementations first, then the built-ins
        List<Class<? extends VFS>> impls = new ArrayList<>();
        impls.addAll(USER_IMPLEMENTATIONS);
        impls.addAll(Arrays.asList((Class<? extends VFS>[]) IMPLEMENTATIONS));

        // Try each implementation class until a valid one is found
        // åˆ›å»º VFS å¯¹è±¡ï¼Œé€‰æ‹©æœ€åä¸€ä¸ªç¬¦åˆçš„
        VFS vfs = null;
        for (int i = 0; vfs == null || !vfs.isValid(); i++) {
            Class<? extends VFS> impl = impls.get(i);
            try {
                vfs = impl.newInstance();
                if (vfs == null || !vfs.isValid()) {
                    if (log.isDebugEnabled()) {
                        log.debug("VFS implementation " + impl.getName() +
                                " is not valid in this environment.");
                    }
                }
            } catch (InstantiationException | IllegalAccessException e) {
                log.error("Failed to instantiate " + impl, e);
                return null;
            }
        }

        if (log.isDebugEnabled()) {
            log.debug("Using VFS adapter " + vfs.getClass().getName());
        }

        return vfs;
    }
}
```

- å•ä¾‹æœ‰å¤šç§å®ç°æ–¹å¼ï¼Œè¯¥ç±»é‡‡ç”¨çš„æ˜¯â€œæ‡’æ±‰å¼ï¼Œçº¿ç¨‹å®‰å…¨â€ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [ã€Šå•ä¾‹æ¨¡å¼çš„ä¸ƒç§å†™æ³•ã€‹](http://cantellow.iteye.com/blog/838473) ã€‚
- `INSTANCE` å±æ€§ï¼Œæœ€åé€šè¿‡ `#createVFS()` **é™æ€**æ–¹æ³•æ¥åˆ›å»ºï¼Œè™½ç„¶ `USER_IMPLEMENTATIONS` å’Œ `IMPLEMENTATIONS` æœ‰å¤šç§ VFS çš„å®ç°ç±»ï¼Œä½†æ˜¯æœ€ç»ˆé€‰æ‹©çš„æ˜¯ï¼Œ**æœ€åä¸€ä¸ªç¬¦åˆ**çš„åˆ›å»ºçš„ VFS å¯¹è±¡ã€‚

## 5.3 åå°„ç›¸å…³æ–¹æ³•

å› ä¸º VFS è‡ªå·±æœ‰åå°„è°ƒç”¨æ–¹æ³•çš„éœ€æ±‚ï¼Œæ‰€ä»¥è‡ªå·±å®ç°äº†ä¸‰ä¸ªæ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// VFS.java

protected static Class<?> getClass(String className) {
    try {
        return Thread.currentThread().getContextClassLoader().loadClass(className);
    } catch (ClassNotFoundException e) {
        if (log.isDebugEnabled()) {
            log.debug("Class not found: " + className);
        }
        return null;
    }
}

protected static Method getMethod(Class<?> clazz, String methodName, Class<?>... parameterTypes) {
    if (clazz == null) {
        return null;
    }
    try {
        return clazz.getMethod(methodName, parameterTypes);
    } catch (SecurityException e) {
        log.error("Security exception looking for method " + clazz.getName() + "." + methodName + ".  Cause: " + e);
        return null;
    } catch (NoSuchMethodException e) {
        log.error("Method not found " + clazz.getName() + "." + methodName + "." + methodName + ".  Cause: " + e);
        return null;
    }
}

protected static <T> T invoke(Method method, Object object, Object... parameters)
        throws IOException, RuntimeException {
    try {
        return (T) method.invoke(object, parameters);
    } catch (IllegalArgumentException | IllegalAccessException e) {
        throw new RuntimeException(e);
    } catch (InvocationTargetException e) {
        if (e.getTargetException() instanceof IOException) {
            throw (IOException) e.getTargetException();
        } else {
            throw new RuntimeException(e);
        }
    }
}
```

## 5.4 isValid

`#isValid()` **æŠ½è±¡**æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºåˆæ³•çš„ VFS ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// VFS.java

/** Return true if the {@link VFS} implementation is valid for the current environment. */
public abstract boolean isValid();
```

- è¯¥æ–¹æ³•ç”±å­ç±»å®ç°ã€‚

## 5.5 list

`#list(String path)` æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šè·¯å¾„ä¸‹çš„æ‰€æœ‰èµ„æºã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// VFS.java

public List<String> list(String path) throws IOException {
    List<String> names = new ArrayList<>();
    for (URL url : getResources(path)) {
        names.addAll(list(url, path));
    }
    return names;
}
```

- å…ˆè°ƒç”¨ `#getResources(String path)` **é™æ€**æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šè·¯å¾„ä¸‹çš„ URL æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // VFS.java
  
  protected static List<URL> getResources(String path) throws IOException {
      return Collections.list(Thread.currentThread().getContextClassLoader().getResources(path));
  }
  ```

- åéå† URL æ•°ç»„ï¼Œè°ƒç”¨ `#list(URL url, String forPath)` æ–¹æ³•ï¼Œ**é€’å½’**çš„åˆ—å‡ºæ‰€æœ‰çš„èµ„æºä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // VFS.java
  
  /**
   * Recursively list the full resource path of all the resources that are children of the
   * resource identified by a URL.
   *
   * @param url The URL that identifies the resource to list.
   * @param forPath The path to the resource that is identified by the URL. Generally, this is the
   *            value passed to {@link #getResources(String)} to get the resource URL.
   * @return A list containing the names of the child resources.
   * @throws IOException If I/O errors occur
   */
  protected abstract List<String> list(URL url, String forPath) throws IOException;
  ```

  - è¯¥æ–¹æ³•ç”±å­ç±»è¿›è¡Œå®ç°ã€‚

## 5.5 DefaultVFS

`org.apache.ibatis.io.DefaultVFS` ï¼Œç»§æ‰¿ VFS æŠ½è±¡ç±»ï¼Œé»˜è®¤çš„ VFS å®ç°ç±»ã€‚

### 5.5.1 isValid

```
// DefaultVFS.java

@Override
public boolean isValid() {
    return true;
}
```

- éƒ½è¿”å› `true` ï¼Œå› ä¸ºé»˜è®¤æ”¯æŒã€‚

### 5.5.2 list

`#list(URL url, String path)` æ–¹æ³•ï¼Œ**é€’å½’**çš„åˆ—å‡ºæ‰€æœ‰çš„èµ„æºä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DefaultVFS.java

@Override
public List<String> list(URL url, String path) throws IOException {
    InputStream is = null;
    try {
        List<String> resources = new ArrayList<>();

        // First, try to find the URL of a JAR file containing the requested resource. If a JAR
        // file is found, then we'll list child resources by reading the JAR.
        // å¦‚æœ url æŒ‡å‘çš„æ˜¯ Jar Resource ï¼Œåˆ™è¿”å›è¯¥ Jar Resource ï¼Œå¦åˆ™è¿”å› null
        URL jarUrl = findJarForResource(url);
        if (jarUrl != null) {
            is = jarUrl.openStream();
            if (log.isDebugEnabled()) {
                log.debug("Listing " + url);
            }
            // éå† Jar Resource
            resources = listResources(new JarInputStream(is), path);
        } else {
            List<String> children = new ArrayList<>();
            try {
                // åˆ¤æ–­ä¸º JAR URL
                if (isJar(url)) {
                    // Some versions of JBoss VFS might give a JAR stream even if the resource
                    // referenced by the URL isn't actually a JAR
                    is = url.openStream();
                    try (JarInputStream jarInput = new JarInputStream(is)) {
                        if (log.isDebugEnabled()) {
                            log.debug("Listing " + url);
                        }
                        for (JarEntry entry; (entry = jarInput.getNextJarEntry()) != null; ) {
                            if (log.isDebugEnabled()) {
                                log.debug("Jar entry: " + entry.getName());
                            }
                            children.add(entry.getName());
                        }
                    }
                } else {
                    /*
                     * Some servlet containers allow reading from directory resources like a
                     * text file, listing the child resources one per line. However, there is no
                     * way to differentiate between directory and file resources just by reading
                     * them. To work around that, as each line is read, try to look it up via
                     * the class loader as a child of the current resource. If any line fails
                     * then we assume the current resource is not a directory.
                     */
                    // ã€é‡ç‚¹ã€‘<1> è·å¾—è·¯å¾„ä¸‹çš„æ‰€æœ‰èµ„æº
                    is = url.openStream();
                    BufferedReader reader = new BufferedReader(new InputStreamReader(is));
                    List<String> lines = new ArrayList<>();
                    for (String line; (line = reader.readLine()) != null; ) {
                        if (log.isDebugEnabled()) {
                            log.debug("Reader entry: " + line);
                        }
                        lines.add(line);
                        if (getResources(path + "/" + line).isEmpty()) {
                            lines.clear();
                            break;
                        }
                    }

                    if (!lines.isEmpty()) {
                        if (log.isDebugEnabled()) {
                            log.debug("Listing " + url);
                        }
                        children.addAll(lines);
                    }
                }
            } catch (FileNotFoundException e) {
                /*
                 * For file URLs the openStream() call might fail, depending on the servlet
                 * container, because directories can't be opened for reading. If that happens,
                 * then list the directory directly instead.
                 */
                if ("file".equals(url.getProtocol())) {
                    File file = new File(url.getFile());
                    if (log.isDebugEnabled()) {
                        log.debug("Listing directory " + file.getAbsolutePath());
                    }
                    if (file.isDirectory()) {
                        if (log.isDebugEnabled()) {
                            log.debug("Listing " + url);
                        }
                        children = Arrays.asList(file.list());
                    }
                } else {
                    // No idea where the exception came from so rethrow it
                    throw e;
                }
            }

            // The URL prefix to use when recursively listing child resources
            // ã€é‡ç‚¹ã€‘<2> è®¡ç®— prefix
            String prefix = url.toExternalForm();
            if (!prefix.endsWith("/")) {
                prefix = prefix + "/";
            }

            // Iterate over immediate children, adding files and recursing into directories
            // ã€é‡ç‚¹ã€‘ <2> éå†å­è·¯å¾„
            for (String child : children) {
                // æ·»åŠ åˆ° resources ä¸­
                String resourcePath = path + "/" + child;
                resources.add(resourcePath);
                // é€’å½’éå†å­è·¯å¾„ï¼Œå¹¶å°†ç»“æœæ·»åŠ åˆ° resources ä¸­
                URL childUrl = new URL(prefix + child);
                resources.addAll(list(childUrl, resourcePath));
            }
        }

        return resources;
    } finally {
        // å…³é—­æ–‡ä»¶æµ
        if (is != null) {
            try {
                is.close();
            } catch (Exception e) {
                // Ignore
            }
        }
    }
}
```

- ä»£ç æœ‰ç‚¹é•¿ï¼Œé‡ç‚¹è¯»æ‡‚ `<1>` å’Œ `<2>` å¤„çš„ä»£ç ï¼ŒåŸºæœ¬å°±å¯ä»¥äº†ã€‚å¤§ä½“é€»è¾‘å°±æ˜¯ï¼Œä¸æ–­é€’å½’æ–‡ä»¶å¤¹ï¼Œè·å¾—åˆ°æ‰€æœ‰æ–‡ä»¶ã€‚è®¾è®¡åˆ°å¯¹ Jar çš„å¤„ç†ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±ç†è§£ä¸‹ã€‚ğŸ˜ˆ è‰¿è‰¿æš‚æ—¶æ²¡çœ‹çš„ç‰¹åˆ«ç»†ã€‚

- `#findJarForResource(URL url)` æ–¹æ³•ï¼Œå¦‚æœ `url` æŒ‡å‘çš„æ˜¯ Jar Resource ï¼Œåˆ™è¿”å›è¯¥ Jar Resource ï¼Œå¦åˆ™è¿”å› `null` ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // DefaultVFS.java
  
  protected URL findJarForResource(URL url) throws MalformedURLException {
      if (log.isDebugEnabled()) {
          log.debug("Find JAR URL: " + url);
      }
  
      // If the file part of the URL is itself a URL, then that URL probably points to the JAR
      // è¿™æ®µä»£ç çœ‹èµ·æ¥æ¯”è¾ƒç¥å¥‡ï¼Œè™½ç„¶çœ‹èµ·æ¥æ²¡æœ‰ break çš„æ¡ä»¶ï¼Œä½†æ˜¯æ˜¯é€šè¿‡ MalformedURLException å¼‚å¸¸è¿›è¡Œ
      // æ­£å¦‚ä¸Šé¢è‹±æ–‡æ³¨é‡Šï¼Œå¦‚æœ URL çš„æ–‡ä»¶éƒ¨åˆ†æœ¬èº«å°±æ˜¯ URL ï¼Œé‚£ä¹ˆè¯¥ URL å¯èƒ½æŒ‡å‘ JAR
      try {
          for (; ; ) {
              url = new URL(url.getFile());
              if (log.isDebugEnabled()) {
                  log.debug("Inner URL: " + url);
              }
          }
      } catch (MalformedURLException e) {
          // This will happen at some point and serves as a break in the loop
      }
  
      // Look for the .jar extension and chop off everything after that
      // åˆ¤æ–­æ˜¯å¦æ„ .jar ç»“å°¾
      StringBuilder jarUrl = new StringBuilder(url.toExternalForm());
      int index = jarUrl.lastIndexOf(".jar");
      if (index >= 0) {
          jarUrl.setLength(index + 4);
          if (log.isDebugEnabled()) {
              log.debug("Extracted JAR URL: " + jarUrl);
          }
      } else {
          if (log.isDebugEnabled()) {
              log.debug("Not a JAR: " + jarUrl);
          }
          return null; // å¦‚æœä¸ä»¥ .jar ç»“å°¾ï¼Œåˆ™ç›´æ¥è¿”å› null
      }
  
      // Try to open and test it
      try {
          URL testUrl = new URL(jarUrl.toString());
          // åˆ¤æ–­æ˜¯å¦ä¸º Jar æ–‡ä»¶
          if (isJar(testUrl)) {
              return testUrl;
          } else {
              // WebLogic fix: check if the URL's file exists in the filesystem.
              if (log.isDebugEnabled()) {
                  log.debug("Not a JAR: " + jarUrl);
              }
              // è·å¾—æ–‡ä»¶
              jarUrl.replace(0, jarUrl.length(), testUrl.getFile()); // æ›¿æ¢
              File file = new File(jarUrl.toString());
              // File name might be URL-encoded
              if (!file.exists()) { // å¤„ç†è·¯å¾„ç¼–ç é—®é¢˜
                  try {
                      file = new File(URLEncoder.encode(jarUrl.toString(), "UTF-8"));
                  } catch (UnsupportedEncodingException e) {
                      throw new RuntimeException("Unsupported encoding?  UTF-8?  That's unpossible.");
                  }
              }
  
              // åˆ¤æ–­æ–‡ä»¶å­˜åœ¨
              if (file.exists()) {
                  if (log.isDebugEnabled()) {
                      log.debug("Trying real file: " + file.getAbsolutePath());
                  }
                  testUrl = file.toURI().toURL();
                  // åˆ¤æ–­æ˜¯å¦ä¸º Jar æ–‡ä»¶
                  if (isJar(testUrl)) {
                      return testUrl;
                  }
              }
          }
      } catch (MalformedURLException e) {
          log.warn("Invalid JAR URL: " + jarUrl);
      }
  
      if (log.isDebugEnabled()) {
          log.debug("Not a JAR: " + jarUrl);
      }
      return null;
  }
  ```

  - ä¼šåˆ¤æ–­è¦æ±‚ï¼Œ`url` ä»¥ `.jar` ç»“å°¾ã€‚

- `#isJar(URL url)` æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º JAR URL ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // DefaultVFS.java
  
  /** The magic header that indicates a JAR (ZIP) file. */
  private static final byte[] JAR_MAGIC = {'P', 'K', 3, 4};
  
  protected boolean isJar(URL url) {
      return isJar(url, new byte[JAR_MAGIC.length]);
  }
  
  protected boolean isJar(URL url, byte[] buffer) {
      InputStream is = null;
      try {
          is = url.openStream();
          // è¯»å–æ–‡ä»¶å¤´
          is.read(buffer, 0, JAR_MAGIC.length);
          // åˆ¤æ–­æ–‡ä»¶å¤´çš„ magic number æ˜¯å¦ç¬¦åˆ JAR
          if (Arrays.equals(buffer, JAR_MAGIC)) {
              if (log.isDebugEnabled()) {
                  log.debug("Found JAR: " + url);
              }
              return true;
          }
      } catch (Exception e) {
          // Failure to read the stream means this is not a JAR
      } finally {
          if (is != null) {
              try {
                  is.close();
              } catch (Exception e) {
                  // Ignore
              }
          }
      }
      return false;
  }
  ```

- `#listResources(JarInputStream jar, String path)` æ–¹æ³•ï¼Œéå† Jar Resource ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // DefaultVFS.java
  
  protected List<String> listResources(JarInputStream jar, String path) throws IOException {
      // Include the leading and trailing slash when matching names
      // ä¿è¯å¤´å°¾éƒ½æ˜¯ /
      if (!path.startsWith("/")) {
          path = "/" + path;
      }
      if (!path.endsWith("/")) {
          path = path + "/";
      }
  
      // Iterate over the entries and collect those that begin with the requested path
      // éå†æ¡ç›®å¹¶æ”¶é›†ä»¥è¯·æ±‚è·¯å¾„å¼€å¤´çš„æ¡ç›®
      List<String> resources = new ArrayList<>();
      for (JarEntry entry; (entry = jar.getNextJarEntry()) != null; ) {
          if (!entry.isDirectory()) {
              // Add leading slash if it's missing
              String name = entry.getName();
              if (!name.startsWith("/")) {
                  name = "/" + name;
              }
  
              // Check file name
              if (name.startsWith(path)) {
                  if (log.isDebugEnabled()) {
                      log.debug("Found resource: " + name);
                  }
                  // Trim leading slash
                  resources.add(name.substring(1));
              }
          }
      }
      return resources;
  }
  ```

## 5.6 JBoss6VFS

`org.apache.ibatis.io.JBoss6VFS` ï¼Œç»§æ‰¿ VFS æŠ½è±¡ç±»ï¼ŒåŸºäº JBoss çš„ VFS å®ç°ç±»ã€‚ä½¿ç”¨æ—¶ï¼Œéœ€è¦å¼•å…¥å¦‚ä¸‹ï¼š

```
<dependency>
    <groupId>org.jboss</groupId>
    <artifactId>jboss-vfs</artifactId>
    <version>${version></version>
</dependency>
```

å› ä¸ºå®é™…åŸºæœ¬æ²¡ä½¿ç”¨åˆ°ï¼Œæ‰€ä»¥æš‚æ—¶ä¸åˆ†æè¿™ä¸ªç±»ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±ç…ç…ã€‚è¿˜æ˜¯ç®€å•çš„ã€‚åæ­£è‰¿è‰¿æš‚æ—¶ä¸æ„Ÿå…´è¶£ï¼Œå“ˆå“ˆå“ˆã€‚

# æ€»ç»“

å‚è€ƒå’Œæ¨èå¦‚ä¸‹æ–‡ç« ï¼š

- æ— å¿Œ [ã€ŠMyBatis æºç è§£è¯»ä¹‹å·¥å…·ç±»ã€‹](https://my.oschina.net/wenjinglian/blog/1631911)
- å¾éƒ¡æ˜ [ã€ŠMyBatis æŠ€æœ¯å†…å¹•ã€‹](https://item.jd.com/12125531.html) çš„ [ã€Œ2.5 èµ„æºåŠ è½½ã€](http://svip.iocoder.cn/MyBatis/io-package/#) å°èŠ‚