# 1. æ¦‚è¿°

æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« MyBatis çš„æ—¥å¿—æ¨¡å—ï¼Œå¯¹åº” `logging` åŒ…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![`logging` åŒ…](http://static.iocoder.cn/images/MyBatis/2020_01_31/01.png)](http://static.iocoder.cn/images/MyBatis/2020_01_31/01.png)`logging` åŒ…

åœ¨ [ã€Šç²¾å°½ MyBatis æºç è§£æ â€”â€” é¡¹ç›®ç»“æ„ä¸€è§ˆã€‹](http://svip.iocoder.cn/MyBatis/intro) ä¸­ï¼Œç®€å•ä»‹ç»äº†è¿™ä¸ªæ¨¡å—å¦‚ä¸‹ï¼š

> æ— è®ºåœ¨å¼€å‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œè¿˜æ˜¯åœ¨çº¿ä¸Šç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ—¥å¿—åœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„åœ°ä½éƒ½æ˜¯éå¸¸é‡è¦çš„ã€‚è‰¯å¥½çš„æ—¥å¿—åŠŸèƒ½å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜å¿«é€Ÿå®šä½ Bug ä»£ç ï¼Œä¹Ÿå¯ä»¥å¸®åŠ©è¿ç»´äººå‘˜å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆç­‰é—®é¢˜ã€‚ç›®å‰çš„ Java ä¸–ç•Œä¸­å­˜åœ¨å¾ˆå¤šä¼˜ç§€çš„æ—¥å¿—æ¡†æ¶ï¼Œä¾‹å¦‚ Log4jã€ Log4j2ã€Slf4j ç­‰ã€‚
>
> MyBatis ä½œä¸ºä¸€ä¸ªè®¾è®¡ä¼˜è‰¯çš„æ¡†æ¶ï¼Œé™¤äº†æä¾›è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¿¡æ¯ï¼Œè¿˜è¦èƒ½å¤Ÿé›†æˆå¤šç§æ—¥å¿—æ¡†æ¶ï¼Œå…¶æ—¥å¿—æ¨¡å—çš„ä¸€ä¸ªä¸»è¦åŠŸèƒ½å°±æ˜¯**é›†æˆç¬¬ä¸‰æ–¹æ—¥å¿—æ¡†æ¶**ã€‚

æœ¬æ–‡æ¶‰åŠçš„ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![ç±»å›¾](http://static.iocoder.cn/images/MyBatis/2020_01_31/02.png)](http://static.iocoder.cn/images/MyBatis/2020_01_31/02.png)ç±»å›¾

- ä»å›¾çš„**ä¸Šé¢**éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°éå¸¸å¤šçš„ Logger ç±»çš„å®ç°ï¼Œåˆ†åˆ«å¯¹åº”æˆ‘ä»¬å¸¸ç”¨çš„æ—¥å¿—æ¡†æ¶ Log4jã€Slf4j ï¼Œè¿™å°±æ˜¯ MyBatis å¯¹è¿™äº›æ—¥å¿—æ¡†æ¶çš„é€‚é…ã€‚
- ä»å›¾çš„**ä¸‹é¢**éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° BaseJdbcLogger ä»¥åŠå…¶å››ä¸ªå­ç±»ï¼Œè¿™ä¸ªå¹¶ä¸æ˜¯å°†æ—¥å¿—æ‰“å°åˆ°æ•°æ®åº“ï¼Œè€Œæ˜¯ MyBatis é€šè¿‡ JDK åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œå°† JDBC çš„æ“ä½œï¼Œæ‰“å°åˆ°æ—¥å¿—ä¸­ã€‚å³ [ã€Šè®¾ç½®Mybatisæ‰“å°è°ƒè¯•sqlçš„ä¸¤ç§æ–¹å¼ã€‹](https://blog.csdn.net/gao36951/article/details/53641432) ã€‚

å¦å¤–ï¼Œ[ã€ŠMyBatis æ–‡æ¡£ â€”â€” æ—¥å¿—ã€‹](http://www.mybatis.org/mybatis-3/zh/logging.html) ä¸€æ–‡ï¼Œä¹Ÿå¯¹æ—¥å¿—æ¨¡å—åšäº†ç®€å•çš„ä»‹ç»ï¼Œä¸ç†Ÿæ‚‰è¿™å—çš„èƒ–å‹ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹ã€‚

ä¸‹é¢ï¼Œè®©æˆ‘ä»¬å¼€å§‹å¹²æºç å§ã€‚

# 2. LogFactory

`org.apache.ibatis.logging.LogFactory` ï¼ŒLog å·¥å‚ç±»ã€‚

## 2.1 æ„é€ æ–¹æ³•

```
// LogFactory.java

/**
 * Marker to be used by logging implementations that support markers
 */
public static final String MARKER = "MYBATIS";

/**
 * ä½¿ç”¨çš„ Log çš„æ„é€ æ–¹æ³•
 */
private static Constructor<? extends Log> logConstructor;

static {
    // <1> é€ä¸ªå°è¯•ï¼Œåˆ¤æ–­ä½¿ç”¨å“ªä¸ª Log çš„å®ç°ç±»ï¼Œå³åˆå§‹åŒ– logConstructor å±æ€§
    tryImplementation(LogFactory::useSlf4jLogging);
    tryImplementation(LogFactory::useCommonsLogging);
    tryImplementation(LogFactory::useLog4J2Logging);
    tryImplementation(LogFactory::useLog4JLogging);
    tryImplementation(LogFactory::useJdkLogging);
    tryImplementation(LogFactory::useNoLogging);
}

private LogFactory() {
    // disable construction
}
```

- `<1>` å¤„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‰ç…§ Slf4jã€CommonsLoggingã€Log4J2Loggingã€Log4JLoggingã€JdkLoggingã€NoLogging çš„é¡ºåºï¼Œé€ä¸ªå°è¯•ï¼Œåˆ¤æ–­ä½¿ç”¨å“ªä¸ª Log çš„å®ç°ç±»ï¼Œå³åˆå§‹åŒ– `logConstructor` å±æ€§ã€‚

- `#tryImplementation(Runnable runnable)` æ–¹æ³•ï¼Œåˆ¤æ–­ä½¿ç”¨å“ªä¸ª Log çš„å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // LogFactory.java
  
  private static void tryImplementation(Runnable runnable) {
      if (logConstructor == null) {
          try {
              runnable.run();
          } catch (Throwable t) {
              // ignore
          }
      }
  }
  ```

  - å½“ `logConstructor` ä¸ºç©ºæ—¶ï¼Œæ‰§è¡Œ `runnable` çš„æ–¹æ³•ã€‚é‚£ä¹ˆï¼Œ`runnable` æ€ä¹ˆæ¥çš„å‘¢ã€‚å®é™…ä¸Šï¼Œ`<1>` å¤„ï¼Œä½¿ç”¨äº† Lambda è¡¨è¾¾å¼ï¼Œæ‰€ä»¥çœ‹èµ·æ¥ä¸æ˜¯å¾ˆæ¸…æ™°ã€‚å³ `tryImplementation(LogFactory::useSlf4jLogging)` ä»£ç å—ï¼Œå¯¹åº”ä¸ºï¼š

    ```
    tryImplementation(new Runnable() {
        @Override
        public void run() {
            LogFactory.useSlf4jLogging();
        }
    });
    ```

    - è¿™æ ·ï¼Œçœ‹èµ·æ¥æ˜¯ä¸æ˜¯å°±æ¸…æ™°å¤šäº†ã€‚

- `#useSlf4jLogging()` æ–¹æ³•ï¼Œå°è¯•ä½¿ç”¨ Slf4j ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // LogFactory.java
  
  public static synchronized void useSlf4jLogging() {
      setImplementation(org.apache.ibatis.logging.slf4j.Slf4jImpl.class);
  }
  ```

  - åœ¨è¯¥æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨ `#setImplementation(Class<? extends Log> implClass)` æ–¹æ³•ï¼Œå°è¯•ä½¿ç”¨æŒ‡å®šçš„ Log å®ç°ç±»ï¼Œä¾‹å¦‚æ­¤å¤„ä¸º `org.apache.ibatis.logging.slf4j.Slf4jImpl` ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```
    // LogFactory.java
    
    private static void setImplementation(Class<? extends Log> implClass) {
        try {
            // è·å¾—å‚æ•°ä¸º String çš„æ„é€ æ–¹æ³•
            Constructor<? extends Log> candidate = implClass.getConstructor(String.class);
            // åˆ›å»º Log å¯¹è±¡
            Log log = candidate.newInstance(LogFactory.class.getName());
            if (log.isDebugEnabled()) {
                log.debug("Logging initialized using '" + implClass + "' adapter.");
            }
            // åˆ›å»ºæˆåŠŸï¼Œæ„å‘³ç€å¯ä»¥ä½¿ç”¨ï¼Œè®¾ç½®ä¸º logConstructor
            logConstructor = candidate;
        } catch (Throwable t) {
            throw new LogException("Error setting Log implementation.  Cause: " + t, t);
        }
    }
    ```

    - å¦‚æœå¯¹åº”çš„ç±»èƒ½åˆ›å»ºæˆåŠŸï¼Œæ„å‘³ç€å¯ä»¥ä½¿ç”¨ï¼Œè®¾ç½®ä¸º `logConstructor` ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶å®ƒç±»ï¼Œå°±ä¸ä¼šæ‰§è¡Œåˆ°è¯¥æ–¹æ³•å•¦ã€‚

- å…¶å®ƒ Log ç±»çš„è¯¥æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```
  // LogFactory.java
  
  public static synchronized void useCommonsLogging() {
      setImplementation(org.apache.ibatis.logging.commons.JakartaCommonsLoggingImpl.class);
  }
  
  public static synchronized void useLog4JLogging() {
      setImplementation(org.apache.ibatis.logging.log4j.Log4jImpl.class);
  }
  
  public static synchronized void useLog4J2Logging() {
      setImplementation(org.apache.ibatis.logging.log4j2.Log4j2Impl.class);
  }
  
  public static synchronized void useJdkLogging() {
      setImplementation(org.apache.ibatis.logging.jdk14.Jdk14LoggingImpl.class);
  }
  
  public static synchronized void useStdOutLogging() {
      setImplementation(org.apache.ibatis.logging.stdout.StdOutImpl.class);
  }
  
  public static synchronized void useNoLogging() {
      setImplementation(org.apache.ibatis.logging.nologging.NoLoggingImpl.class);
  }
  ```

- å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `#useCustomLogging(Class<? extends Log> clazz)` æ–¹æ³•ï¼Œè®¾ç½®è‡ªå®šä¹‰çš„ Log å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // LogFactory.java
  
  public static synchronized void useCustomLogging(Class<? extends Log> clazz) {
      setImplementation(clazz);
  }
  ```

  - è¿™é‡Œçš„è‡ªå®šä¹‰ï¼Œå¯ä»¥æ˜¯ä½ è‡ªå·±å®ç°çš„ Log ç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸Šè¿°çš„ MyBatis å†…ç½®çš„ Log å®ç°ç±»ã€‚

## 2.2 getLog

`#getLog(...)` æ–¹æ³•ï¼Œè·å¾— Log å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// LogFactory.java

public static Log getLog(Class<?> aClass) {
    return getLog(aClass.getName());
}

public static Log getLog(String logger) {
    try {
        return logConstructor.newInstance(logger);
    } catch (Throwable t) {
        throw new LogException("Error creating logger for logger " + logger + ".  Cause: " + t, t);
    }
}
```

# 3. Log

`org.apache.ibatis.logging.Log` ï¼ŒMyBatis Log æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Log.java

public interface Log {

    boolean isDebugEnabled();

    boolean isTraceEnabled();

    void error(String s, Throwable e);

    void error(String s);

    void debug(String s);

    void trace(String s);

    void warn(String s);

}
```

Log çš„å®ç°ç±»è¾ƒå¤šï¼Œæˆ‘ä»¬å°±çœ‹çœ‹ Slf4jImpl å’Œ StdOutImpl è¿™ä¸¤ä¸ªå®ç°ç±»ã€‚

## 3.1 StdOutImpl

`org.apache.ibatis.logging.stdout.StdOutImpl` ï¼Œå®ç° Log æ¥å£ï¼ŒStdOut å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// StdOutImpl.java

public class StdOutImpl implements Log {

    public StdOutImpl(String clazz) {
        // Do Nothing
    }

    @Override
    public boolean isDebugEnabled() {
        return true;
    }

    @Override
    public boolean isTraceEnabled() {
        return true;
    }

    @Override
    public void error(String s, Throwable e) {
        System.err.println(s);
        e.printStackTrace(System.err);
    }

    @Override
    public void error(String s) {
        System.err.println(s);
    }

    @Override
    public void debug(String s) {
        System.out.println(s);
    }

    @Override
    public void trace(String s) {
        System.out.println(s);
    }

    @Override
    public void warn(String s) {
        System.out.println(s);
    }
}
```

- æ¯”è¾ƒç®€å•ï¼ŒåŸºäº `System.out` å’Œ `System.err` æ¥å®ç°ã€‚

## 3.2 Slf4jImpl

`org.apache.ibatis.logging.slf4j.Slf4jImpl` ï¼Œå®ç° Log æ¥å£ï¼ŒSlf4j å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// Slf4jImpl.java

public class Slf4jImpl implements Log {

    private Log log;

    public Slf4jImpl(String clazz) {
        // ä½¿ç”¨ SLF LoggerFactory è·å¾— SLF Logger å¯¹è±¡
        Logger logger = LoggerFactory.getLogger(clazz);

        // å¦‚æœæ˜¯ LocationAwareLogger ï¼Œåˆ™åˆ›å»º Slf4jLocationAwareLoggerImpl å¯¹è±¡
        if (logger instanceof LocationAwareLogger) {
            try {
                // check for slf4j >= 1.6 method signature
                logger.getClass().getMethod("log", Marker.class, String.class, int.class, String.class, Object[].class, Throwable.class);
                log = new Slf4jLocationAwareLoggerImpl((LocationAwareLogger) logger);
                return;
            } catch (SecurityException | NoSuchMethodException e) {
                // fail-back to Slf4jLoggerImpl
            }
        }

        // Logger is not LocationAwareLogger or slf4j version < 1.6
        // å¦åˆ™ï¼Œåˆ›å»º Slf4jLoggerImpl å¯¹è±¡
        log = new Slf4jLoggerImpl(logger);
    }

    @Override
    public boolean isDebugEnabled() {
        return log.isDebugEnabled();
    }

    @Override
    public boolean isTraceEnabled() {
        return log.isTraceEnabled();
    }

    @Override
    public void error(String s, Throwable e) {
        log.error(s, e);
    }

    @Override
    public void error(String s) {
        log.error(s);
    }

    @Override
    public void debug(String s) {
        log.debug(s);
    }

    @Override
    public void trace(String s) {
        log.trace(s);
    }

    @Override
    public void warn(String s) {
        log.warn(s);
    }

}
```

- åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œé€‚é…ä¸åŒçš„ SLF4J çš„ç‰ˆæœ¬ï¼Œåˆ†åˆ«ä½¿ç”¨ `org.apache.ibatis.logging.slf4j.Slf4jLocationAwareLoggerImpl` å’Œ `org.apache.ibatis.logging.slf4j.Slf4jLoggerImpl` ç±»ã€‚
- å…·ä½“çš„æ–¹æ³•å®ç°ï¼Œå§”æ‰˜è°ƒç”¨å¯¹åº”çš„ SLF4J çš„æ–¹æ³•ã€‚

# 4. BaseJdbcLogger

åœ¨ `org.apache.ibatis.logging` åŒ…ä¸‹çš„ `jdbc` åŒ…ï¼Œæœ‰å¦‚ä¸‹äº”ä¸ªç±»ï¼š

- BaseJdbcLogger
  - ConnectionLogger
  - PreparedStatementLogger
  - StatementLogger
  - ResultSetLogger

å’Œ [ã€Šç²¾å°½ MyBatis æºç åˆ†æ â€”â€” æ•°æ®æºæ¨¡å—ã€‹](http://svip.iocoder.cn/MyBatis/datasource-package) ç±»ä¼¼ï¼Œåˆæ˜¯ä¸€ä¸ªåŸºäº JDBC æ¥å£å®ç°**å¢å¼º**çš„æ¡ˆä¾‹ï¼Œè€ŒåŸç†ä¸Šï¼Œä¹Ÿæ˜¯åŸºäº JDK å®ç°åŠ¨æ€ä»£ç†ã€‚

ä»£ç æ¯”è¾ƒç®€å•ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œè‡ªå·±ç®€å•çœ‹çœ‹å³å¯ã€‚ğŸ˜ˆ æœ‰æœ¨æœ‰å‘ç°ï¼ŒMyBatis å¤§é‡çš„ä½¿ç”¨ JDK å®ç°åŠ¨æ€ä»£ç†ã€‚

# æ€»ç»“

å‚è€ƒå’Œæ¨èå¦‚ä¸‹æ–‡ç« ï¼š

- å¾éƒ¡æ˜ [ã€ŠMyBatis æŠ€æœ¯å†…å¹•ã€‹](https://item.jd.com/12125531.html) çš„ [ã€Œ2.4 æ—¥å¿—æ¨¡å—ã€](http://svip.iocoder.cn/MyBatis/logging-package/#) å°èŠ‚