

> æœ¬æ–‡ç« ä»…ç”¨äºæœ¬äººå­¦ä¹ ç¬”è®°è®°å½•
> å¾®ä¿¡ï¼šwxid_ygj58saenbjh22ï¼ˆå¦‚æœ¬æ–‡æ¡£å†…å®¹ä¾µæƒäº†æ‚¨çš„æƒç›Šï¼Œè¯·æ‚¨é€šè¿‡å¾®ä¿¡è”ç³»åˆ°æˆ‘ï¼‰

## è§‚å¯Ÿè€…æ¨¡å¼ä»‹ç»

ç®€å•æ¥è®²è§‚å¯Ÿè€…ğŸ•µæ¨¡å¼ï¼Œå°±æ˜¯å½“ä¸€ä¸ªè¡Œä¸ºå‘ç”Ÿæ—¶ä¼ é€’ä¿¡æ¯ç»™å¦å¤–ä¸€ä¸ªç”¨æˆ·æ¥æ”¶åšå‡ºç›¸åº”çš„å¤„ç†ï¼Œä¸¤è€…ä¹‹é—´æ²¡æœ‰ç›´æ¥çš„è€¦åˆå…³è”ã€‚


é™¤äº†ç”Ÿæ´»ä¸­çš„åœºæ™¯å¤–ï¼Œåœ¨æˆ‘ä»¬ç¼–ç¨‹å¼€å‘ä¸­ä¹Ÿä¼šå¸¸ç”¨åˆ°ä¸€äº›è§‚å¯Ÿè€…çš„æ¨¡å¼æˆ–è€…ç»„ä»¶ï¼Œä¾‹å¦‚æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„MQæœåŠ¡ï¼Œè™½ç„¶MQæœåŠ¡æ˜¯æœ‰ä¸€ä¸ªé€šçŸ¥ä¸­å¿ƒå¹¶ä¸æ˜¯æ¯ä¸€ä¸ªç±»æœåŠ¡è¿›è¡Œé€šçŸ¥ï¼Œä½†æ•´ä½“ä¸Šä¹Ÿå¯ä»¥ç®—ä½œæ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„æ€è·¯è®¾è®¡ã€‚å†æ¯”å¦‚å¯èƒ½æœ‰åšè¿‡çš„ä¸€äº›ç±»ä¼¼äº‹ä»¶ç›‘å¬æ€»çº¿ï¼Œè®©ä¸»çº¿æœåŠ¡ä¸å…¶ä»–è¾…çº¿ä¸šåŠ¡æœåŠ¡åˆ†ç¦»ï¼Œä¸ºäº†ä½¿ç³»ç»Ÿé™ä½è€¦åˆå’Œå¢å¼ºæ‰©å±•æ€§ï¼Œä¹Ÿä¼šä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼è¿›è¡Œå¤„ç†ã€‚



## ç®€å•ä¾‹å­

```
itstack-demo-design-18-00
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.design
                â””â”€â”€ MinibusTargetService.java

```

### åœºæ™¯ç®€è¿°

#### æ‘‡å·æœåŠ¡æ¥å£

```
public class MinibusTargetService {

    /**
     * æ¨¡æ‹Ÿæ‘‡å·ï¼Œä½†ä¸æ˜¯æ‘‡å·ç®—æ³•
     *
     * @param uId ç”¨æˆ·ç¼–å·
     * @return ç»“æœ
     */
    public String lottery(String uId) {
        return Math.abs(uId.hashCode()) % 2 == 0 ? "æ­å–œä½ ï¼Œç¼–ç ".concat(uId).concat("åœ¨æœ¬æ¬¡æ‘‡å·ä¸­ç­¾") : "å¾ˆé—æ†¾ï¼Œç¼–ç ".concat(uId).concat("åœ¨æœ¬æ¬¡æ‘‡å·æœªä¸­ç­¾æˆ–æ‘‡å·èµ„æ ¼å·²è¿‡æœŸ");
    }

}

```

## ç”¨ä¸€å¨å¨ä»£ç å®ç°

æŒ‰ç…§éœ€æ±‚éœ€è¦åœ¨åŸæœ‰çš„æ‘‡å·æ¥å£ä¸­æ·»åŠ MQæ¶ˆæ¯å‘é€ä»¥åŠçŸ­æ¶ˆæ¯é€šçŸ¥åŠŸèƒ½ï¼Œå¦‚æœæ˜¯æœ€ç›´æ¥çš„æ–¹å¼é‚£ä¹ˆå¯ä»¥ç›´æ¥åœ¨æ–¹æ³•ä¸­è¡¥å……åŠŸèƒ½å³å¯ã€‚

### å·¥ç¨‹ç»“æ„

```
itstack-demo-design-18-01
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.design
                â”œâ”€â”€ LotteryResult.java
                â”œâ”€â”€ LotteryService.java
                â””â”€â”€ LotteryServiceImpl.java

```

è¿™æ®µä»£ç æ¥å£ä¸­åŒ…æ‹¬äº†ä¸‰éƒ¨åˆ†å†…å®¹ï¼›è¿”å›å¯¹è±¡(LotteryResult)ã€å®šä¹‰æ¥å£(LotteryService)ã€å…·ä½“å®ç°(LotteryServiceImpl)ã€‚

### ä»£ç å®ç°

```
public class LotteryServiceImpl implements LotteryService {

    private Logger logger = LoggerFactory.getLogger(LotteryServiceImpl.class);

    private MinibusTargetService minibusTargetService = new MinibusTargetService();

    public LotteryResult doDraw(String uId) {
        // æ‘‡å·
        String lottery = minibusTargetService.lottery(uId);
        // å‘çŸ­ä¿¡
        logger.info("ç»™ç”¨æˆ· {} å‘é€çŸ­ä¿¡é€šçŸ¥(çŸ­ä¿¡)ï¼š{}", uId, lottery);
        // å‘MQæ¶ˆæ¯
        logger.info("è®°å½•ç”¨æˆ· {} æ‘‡å·ç»“æœ(MQ)ï¼š{}", uId, lottery);
        // ç»“æœ
        return new LotteryResult(uId, lottery, new Date());
    }

}

```

## è§‚å¯Ÿè€…æ¨¡å¼é‡æ„ä»£ç 

### å·¥ç¨‹ç»“æ„

```
itstack-demo-design-18-02
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
            â””â”€â”€ org.itstack.demo.design
                â”œâ”€â”€ event
                â”‚    â”œâ”€â”€ listener
                â”‚    â”‚    â”œâ”€â”€ EventListener.java
                â”‚    â”‚    â”œâ”€â”€ MessageEventListener.java
                â”‚    â”‚    â””â”€â”€ MQEventListener.java
                â”‚    â””â”€â”€ EventManager.java
                â”œâ”€â”€ LotteryResult.java
                â”œâ”€â”€ LotteryService.java
                â””â”€â”€ LotteryServiceImpl.java

```

è§‚å¯Ÿè€…æ¨¡å¼æ¨¡å‹ç»“æ„

![](2021-04-18-design-è§‚å¯Ÿè€…/itstack-demo-design-18-04.png)

- ä»ä¸Šå›¾å¯ä»¥åˆ†ä¸ºä¸‰å¤§å—çœ‹ï¼›äº‹ä»¶ç›‘å¬ã€äº‹ä»¶å¤„ç†ã€å…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼Œå¦å¤–åœ¨ä¸šåŠ¡æµç¨‹ä¸­ LotteryService å®šä¹‰çš„æ˜¯æŠ½è±¡ç±»ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥é€šè¿‡æŠ½è±¡ç±»å°†äº‹ä»¶åŠŸèƒ½å±è”½ï¼Œå¤–éƒ¨ä¸šåŠ¡æµç¨‹å¼€å‘è€…ä¸éœ€è¦çŸ¥é“å…·ä½“çš„é€šçŸ¥æ“ä½œã€‚
- å³ä¸‹è§’åœ†åœˆå›¾è¡¨ç¤ºçš„æ˜¯æ ¸å¿ƒæµç¨‹ä¸éæ ¸å¿ƒæµç¨‹çš„ç»“æ„ï¼Œä¸€èˆ¬åœ¨å¼€å‘ä¸­ä¼šæŠŠä¸»çº¿æµç¨‹å¼€å‘å®Œæˆåï¼Œå†ä½¿ç”¨é€šçŸ¥çš„æ–¹å¼å¤„ç†è¾…åŠ©æµç¨‹ã€‚ä»–ä»¬å¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œåœ¨MQä»¥åŠå®šæ—¶ä»»åŠ¡çš„å¤„ç†ä¸‹ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚

### ä»£ç å®ç°

#### äº‹ä»¶ç›‘å¬æ¥å£å®šä¹‰

```
public interface EventListener {

    void doEvent(LotteryResult result);

}

```

æ¥å£ä¸­å®šä¹‰äº†åŸºæœ¬çš„äº‹ä»¶ç±»ï¼Œè¿™é‡Œå¦‚æœæ–¹æ³•çš„å…¥å‚ä¿¡æ¯ç±»å‹æ˜¯å˜åŒ–çš„å¯ä»¥ä½¿ç”¨æ³›å‹<T>

#### çŸ­æ¶ˆæ¯äº‹ä»¶

```
public class MessageEventListener implements EventListener {

    private Logger logger = LoggerFactory.getLogger(MessageEventListener.class);

    @Override
    public void doEvent(LotteryResult result) {
        logger.info("ç»™ç”¨æˆ· {} å‘é€çŸ­ä¿¡é€šçŸ¥(çŸ­ä¿¡)ï¼š{}", result.getuId(), result.getMsg());
    }

}

```

#### MQå‘é€äº‹ä»¶

```
public class MQEventListener implements EventListener {

    private Logger logger = LoggerFactory.getLogger(MQEventListener.class);

    @Override
    public void doEvent(LotteryResult result) {
        logger.info("è®°å½•ç”¨æˆ· {} æ‘‡å·ç»“æœ(MQ)ï¼š{}", result.getuId(), result.getMsg());
    }

}

```

#### äº‹ä»¶å¤„ç†ç±»

```
public class EventManager {

    Map<Enum<EventType>, List<EventListener>> listeners = new HashMap<>();

    public EventManager(Enum<EventType>... operations) {
        for (Enum<EventType> operation : operations) {
            this.listeners.put(operation, new ArrayList<>());
        }
    }

    public enum EventType {
        MQ, Message
    }

    /**
     * è®¢é˜…
     * @param eventType äº‹ä»¶ç±»å‹
     * @param listener  ç›‘å¬
     */
    public void subscribe(Enum<EventType> eventType, EventListener listener) {
        List<EventListener> users = listeners.get(eventType);
        users.add(listener);
    }

    /**
     * å–æ¶ˆè®¢é˜…
     * @param eventType äº‹ä»¶ç±»å‹
     * @param listener  ç›‘å¬
     */
    public void unsubscribe(Enum<EventType> eventType, EventListener listener) {
        List<EventListener> users = listeners.get(eventType);
        users.remove(listener);
    }

    /**
     * é€šçŸ¥
     * @param eventType äº‹ä»¶ç±»å‹
     * @param result    ç»“æœ
     */
    public void notify(Enum<EventType> eventType, LotteryResult result) {
        List<EventListener> users = listeners.get(eventType);
        for (EventListener listener : users) {
            listener.doEvent(result);
        }
    }

}

```

- æ•´ä¸ªå¤„ç†çš„å®ç°ä¸Šæä¾›äº†ä¸‰ä¸ªä¸»è¦æ–¹æ³•ï¼›è®¢é˜…(subscribe)ã€å–æ¶ˆè®¢é˜…(unsubscribe)ã€é€šçŸ¥(notify)ã€‚è¿™ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«ç”¨äºå¯¹ç›‘å¬æ—¶é—´çš„æ·»åŠ å’Œä½¿ç”¨ã€‚
- å¦å¤–å› ä¸ºäº‹ä»¶æœ‰ä¸åŒçš„ç±»å‹ï¼Œè¿™é‡Œä½¿ç”¨äº†æšä¸¾çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œä¹Ÿæ–¹ä¾¿è®©å¤–éƒ¨åœ¨è§„å®šä¸‹ä½¿ç”¨äº‹ä»¶ï¼Œè€Œä¸è‡³äºä¹±ä¼ ä¿¡æ¯(EventType.MQã€EventType.Message)ã€‚

#### ä¸šåŠ¡æŠ½è±¡ç±»æ¥å£

```
public abstract class LotteryService {

    private EventManager eventManager;

    public LotteryService() {
        eventManager = new EventManager(EventManager.EventType.MQ, EventManager.EventType.Message);
        eventManager.subscribe(EventManager.EventType.MQ, new MQEventListener());
        eventManager.subscribe(EventManager.EventType.Message, new MessageEventListener());
    }

    public LotteryResult draw(String uId) {
        LotteryResult lotteryResult = doDraw(uId);
        // éœ€è¦ä»€ä¹ˆé€šçŸ¥å°±ç»™è°ƒç”¨ä»€ä¹ˆæ–¹æ³•
        eventManager.notify(EventManager.EventType.MQ, lotteryResult);
        eventManager.notify(EventManager.EventType.Message, lotteryResult);
        return lotteryResult;
    }

    protected abstract LotteryResult doDraw(String uId);

}

```

#### ä¸šåŠ¡æ¥å£å®ç°ç±»

```
public class LotteryServiceImpl extends LotteryService {

    private MinibusTargetService minibusTargetService = new MinibusTargetService();

    @Override
    protected LotteryResult doDraw(String uId) {
        // æ‘‡å·
        String lottery = minibusTargetService.lottery(uId);
        // ç»“æœ
        return new LotteryResult(uId, lottery, new Date());
    }

}

```

#### æµ‹è¯•éªŒè¯

```
@Test
public void test() {
    LotteryService lotteryService = new LotteryServiceImpl();
    LotteryResult result = lotteryService.draw("2765789109876");
    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(result));
}

```

## æ€»ç»“

ç®€å•æ¥è®²è§‚å¯Ÿè€…ğŸ•µæ¨¡å¼ï¼Œå°±æ˜¯å½“ä¸€ä¸ªè¡Œä¸ºå‘ç”Ÿæ—¶ä¼ é€’ä¿¡æ¯ç»™å¦å¤–ä¸€ä¸ªç”¨æˆ·æ¥æ”¶åšå‡ºç›¸åº”çš„å¤„ç†ï¼Œä¸¤è€…ä¹‹é—´æ²¡æœ‰ç›´æ¥çš„è€¦åˆå…³è”ã€‚